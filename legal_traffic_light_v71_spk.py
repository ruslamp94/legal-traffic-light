"""
–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.1
–ê–û ¬´–°–ü–ö¬ª –°—Ç–∞—Ä–∞—è –ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è
–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å AI-–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è v7.1:
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ KeyError –≤ LEGAL_STATUS_LABELS
- –£–ª—É—á—à–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º RAG-—Å–ª–∏—á–µ–Ω–∏—è —Ç–∏–ø–æ–≤—ã—Ö —Ñ–æ—Ä–º
- –î–µ–º–æ-—Ä–µ–∂–∏–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –ø–æ–ª—è
- AI-–∞–Ω–∞–ª–∏–∑ –¥–∞—ë—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—É–Ω–∫—Ç–∞–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI-—Å–µ—Ä–≤–∏—Å–∞–º–∏
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑ API-–∫–ª—é—á–∞
"""

import streamlit as st
import re, json, hashlib, io, math, time
from datetime import datetime, date
from typing import Dict, List, Tuple, Optional, Set, Any
from dataclasses import dataclass, field
from enum import Enum
from collections import Counter
import difflib

# ============================================================================
# –ü–†–û–í–ï–†–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö
# ============================================================================

DOCX_AVAILABLE = False
PDF_READER_AVAILABLE = False
REQUESTS_AVAILABLE = False

try:
    from docx import Document as DocxDocument
    from docx.shared import Pt, Inches, RGBColor
    from docx.enum.text import WD_ALIGN_PARAGRAPH
    DOCX_AVAILABLE = True
except ImportError:
    pass

try:
    from PyPDF2 import PdfReader
    PDF_READER_AVAILABLE = True
except ImportError:
    pass

try:
    import requests
    REQUESTS_AVAILABLE = True
except ImportError:
    pass

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================================

st.set_page_config(
    page_title="–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.1 | –°–ü–ö",
    page_icon="üö¶",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ============================================================================
# –î–ê–ù–ù–´–ï –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò
# ============================================================================

DEFAULT_ORG_CONFIG = {
    "full_name": '–ê–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ ¬´–°—Ç–∞—Ä–∞—è –ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è¬ª',
    "short_name": '–ê–û ¬´–°–ü–ö¬ª',
    "abbrev": "–°–ü–ö",
    "inn": "7708654321",
    "kpp": "770801001",
    "ogrn": "1037708654321",
    "address": "127015, –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ù–æ–≤–æ–¥–º–∏—Ç—Ä–æ–≤—Å–∫–∞—è, –¥. 5–ê, —Å—Ç—Ä. 1",
    "director_name": "–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á",
    "director_position": "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä",
    "basis": "–£—Å—Ç–∞–≤–∞"
}

DEFAULT_THRESHOLDS = {
    "green_tf_max": 100_000,
    "green_non_tf_max": 50_000,
    "yellow_max": 5_000_000,
    "tender_red": 3_000_000,
    "single_supplier_yellow": 100_000
}

DEFAULT_DEADLINES = {"standard": 5, "extended": 10, "urgent": 1}

# ============================================================================
# ENUM –ò –ö–û–ù–°–¢–ê–ù–¢–´
# ============================================================================

class RiskZone(Enum):
    GREEN = "green"
    YELLOW = "yellow"
    RED = "red"

class DocumentForm(Enum):
    TYPICAL = "typical"
    COUNTERPARTY = "counterparty"
    FREE = "free"
    MODIFIED_TF = "modified_tf"
    SELF_DEVELOPED = "self"

class LegalStatus(Enum):
    NOT_SUBMITTED = "not_submitted"
    NO_INFO = "no_info"
    SUBMITTED = "submitted"
    APPROVED = "approved"
    REJECTED = "rejected"
    IN_PROGRESS = "in_progress"

class UserRole(Enum):
    USER = "user"
    ADMIN = "admin"

# –°–ª–æ–≤–∞—Ä–∏ —Å –º–µ—Ç–∫–∞–º–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º .value –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
LEGAL_STATUS_LABELS = {
    "not_submitted": "üî¥ –ù–µ –ø–æ—Å—Ç—É–ø–∞–ª –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ",
    "no_info": "üü° –ù–µ—Ç —Å–≤–µ–¥–µ–Ω–∏–π",
    "submitted": "üü° –ü–æ—Å—Ç—É–ø–∞–ª –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ",
    "approved": "üü¢ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω –Æ–î",
    "rejected": "üî¥ –û—Ç–∫–ª–æ–Ω–µ–Ω",
    "in_progress": "üü° –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏",
}

DOCUMENT_FORM_LABELS = {
    "typical": "üìã –¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ (–¢–§)",
    "counterparty": "üìÑ –§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞",
    "free": "üìù –°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞",
    "modified_tf": "‚úèÔ∏è –¢–§ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏",
    "self": "üîß –°–≤–æ—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞",
}

def get_legal_status_label(status) -> str:
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–∞"""
    if isinstance(status, LegalStatus):
        return LEGAL_STATUS_LABELS.get(status.value, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    elif isinstance(status, str):
        return LEGAL_STATUS_LABELS.get(status, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    return "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

def get_doc_form_label(form) -> str:
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∫–∏ —Ñ–æ—Ä–º—ã"""
    if isinstance(form, DocumentForm):
        return DOCUMENT_FORM_LABELS.get(form.value, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    elif isinstance(form, str):
        return DOCUMENT_FORM_LABELS.get(form, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    return "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

DEPARTMENTS = [
    "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ–∑–æ–∫",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –ø–æ–¥–≤–∏–∂–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞",
    "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∑–∞–∫—É–ø–æ–∫", "–°–ª—É–∂–±–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
    "IT-–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "–û—Ç–¥–µ–ª –∫–∞–¥—Ä–æ–≤",
]

POSITIONS = [
    "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–í–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–ì–ª–∞–≤–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
    "–ù–∞—á–∞–ª—å–Ω–∏–∫ –æ—Ç–¥–µ–ª–∞", "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
    "–ù–∞—á–∞–ª—å–Ω–∏–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è", "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞",
    "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞", "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞",
    "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä"
]

RED_ZONE_ALWAYS = [
    "–ê—Ä–µ–Ω–¥–∞ –≤–∞–≥–æ–Ω–æ–≤", "–õ–∏–∑–∏–Ω–≥ –≤–∞–≥–æ–Ω–æ–≤", "–ü–æ–∫—É–ø–∫–∞/–ø—Ä–æ–¥–∞–∂–∞ –≤–∞–≥–æ–Ω–æ–≤",
    "–ê—Ä–µ–Ω–¥–∞ –ª–æ–∫–æ–º–æ—Ç–∏–≤–æ–≤", "–î–æ–≥–æ–≤–æ—Ä —Å –û–ê–û ¬´–†–ñ–î¬ª", "–í–≠–î/–í–∞–ª—é—Ç–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã",
    "–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä", "–î–æ–≥–æ–≤–æ—Ä –∑–∞–π–º–∞", "–î–æ–≥–æ–≤–æ—Ä –∑–∞–ª–æ–≥–∞",
    "–ê—Ä–µ–Ω–¥–∞/–ü–æ–∫—É–ø–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏", "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü–û",
]

YELLOW_ZONE_TYPES = [
    "–î–æ–≥–æ–≤–æ—Ä –¢–≠–û", "–†–∞–º–æ—á–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä", "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –æ–ø–∞—Å–Ω–æ–≥–æ –≥—Ä—É–∑–∞",
    "–ó–∞–∫—É–ø–∫–∞ —É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞",
]

CONTRACT_TYPES = [
    "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ (–¢–≠–û)", "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏", "–î–æ–≥–æ–≤–æ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è",
    "–î–æ–≥–æ–≤–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∞–≤—Ç–æ)", "–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã –≤–∞–≥–æ–Ω–æ–≤", "–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞",
    "–ê–≥–µ–Ω—Ç—Å–∫–∏–π –¥–æ–≥–æ–≤–æ—Ä", "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–î—Ä—É–≥–æ–π",
]

# ============================================================================
# AI –ü–†–û–í–ê–ô–î–ï–†–´
# ============================================================================

AI_PROVIDERS = {
    "openai": {"name": "OpenAI GPT-4", "api_url": "https://api.openai.com/v1/chat/completions", "model": "gpt-4o-mini"},
    "anthropic": {"name": "Anthropic Claude", "api_url": "https://api.anthropic.com/v1/messages", "model": "claude-3-haiku-20240307"},
    "gigachat": {"name": "GigaChat (–°–±–µ—Ä)", "api_url": "https://gigachat.devices.sberbank.ru/api/v1/chat/completions", "model": "GigaChat"},
    "yandexgpt": {"name": "YandexGPT", "api_url": "https://llm.api.cloud.yandex.net/foundationModels/v1/completion", "model": "yandexgpt-lite"},
    "mistral": {"name": "Mistral AI", "api_url": "https://api.mistral.ai/v1/chat/completions", "model": "mistral-small-latest"},
    "perplexity": {"name": "Perplexity AI", "api_url": "https://api.perplexity.ai/chat/completions", "model": "llama-3.1-sonar-small-128k-online"},
}

DEFAULT_USERS = {
    "admin": {"password_hash": hashlib.sha256("admin123".encode()).hexdigest(), "role": UserRole.ADMIN, "name": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã", "position": "–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", "department": "IT-–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"},
    "user": {"password_hash": hashlib.sha256("user123".encode()).hexdigest(), "role": UserRole.USER, "name": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "position": "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "department": "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"}
}

# ============================================================================
# –¢–ò–ü–û–í–´–ï –§–û–†–ú–´ –°–ü–ö (—É–ª—É—á—à–µ–Ω–Ω—ã–µ –¥–ª—è RAG-—Å–ª–∏—á–µ–Ω–∏—è)
# ============================================================================

BUILTIN_TYPICAL_FORMS = {
    "supply": {
        "name": "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏ (—Å –≠–î–û)",
        "code": "–¢–§-–°–ü–ö-–ü–û–°-001",
        "version": "2024.1",
        "contract_type": "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏",
        "our_role": "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å",
        "description": "–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–ø–∞—Å–Ω—ã—Ö —á–∞—Å—Ç–µ–π –∫ –∂/–¥ –≤–∞–≥–æ–Ω–∞–º",
        "key_markers": ["–ø–æ—Å—Ç–∞–≤—â–∏–∫", "–ø–æ–∫—É–ø–∞—Ç–µ–ª—å", "—Ç–æ–≤–∞—Ä", "–ø–æ—Å—Ç–∞–≤–∫–∞", "–∑–∞–ø–∞—Å–Ω—ã–µ —á–∞—Å—Ç–∏", "—Ç–æ—Ä–≥-12", "—É–ø–¥"],
        "sections": {
            "–ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê": {
                "required": True,
                "weight": 2.0,
                "markers": ["–ø–æ—Å—Ç–∞–≤—â–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å", "–ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å", "–∑–∞–ø–∞—Å–Ω—ã–µ —á–∞—Å—Ç–∏", "–∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω", "–≤–∞–≥–æ–Ω"],
                "template": "–ü–æ—Å—Ç–∞–≤—â–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å, –∞ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–ø–∞—Å–Ω—ã–µ —á–∞—Å—Ç–∏ –∫ –∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–º –≤–∞–≥–æ–Ω–∞–º.",
                "risk_patterns": [
                    {"pattern": r"–Ω–µ\s+–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç.*–ø—Ä–∞–≤–æ\s+—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç", "risk": "red", "issue": "–ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–∞–≤–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"},
                    {"pattern": r"—Ç–æ–≤–∞—Ä.*(?:–ø–æ–¥\s+–∞—Ä–µ—Å—Ç–æ–º|–∑–∞–ª–æ–∂–µ–Ω)", "risk": "red", "issue": "–¢–æ–≤–∞—Ä –ø–æ–¥ –æ–±—Ä–µ–º–µ–Ω–µ–Ω–∏–µ–º"}
                ]
            },
            "–°–†–û–ö–ò –ò –£–°–õ–û–í–ò–Ø –ü–û–°–¢–ê–í–ö–ò": {
                "required": True,
                "weight": 1.5,
                "markers": ["—Å—Ä–æ–∫ –ø–æ—Å—Ç–∞–≤–∫–∏", "—É—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏", "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "–¥–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏", "–ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–∞–≤–∞"],
                "template": "–°—Ä–æ–∫–∏ –∏ —É—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞—é—Ç—Å—è –≤ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.",
                "risk_patterns": []
            },
            "–ö–ê–ß–ï–°–¢–í–û –ò –ö–û–ú–ü–õ–ï–ö–¢–ù–û–°–¢–¨": {
                "required": True,
                "weight": 1.5,
                "markers": ["–∫–∞—á–µ—Å—Ç–≤–æ", "–∫–æ–º–ø–ª–µ–∫—Ç–Ω–æ—Å—Ç—å", "–≥–æ—Å—Ç", "—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç", "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è"],
                "template": "–ö–∞—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ì–û–°–¢–∞–º –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —É—Å–ª–æ–≤–∏—è–º.",
                "risk_patterns": [
                    {"pattern": r"–±–µ–∑\s+(?:–≥–∞—Ä–∞–Ω—Ç–∏–∏|—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç)", "risk": "red", "issue": "–ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞"},
                    {"pattern": r"–∫–∞–∫\s+–µ—Å—Ç—å|as\s+is", "risk": "red", "issue": "–ü–æ—Å—Ç–∞–≤–∫–∞ –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π –∫–∞—á–µ—Å—Ç–≤–∞"}
                ]
            },
            "–¶–ï–ù–ê –ò –ü–û–†–Ø–î–û–ö –†–ê–°–ß–ï–¢–û–í": {
                "required": True,
                "weight": 2.0,
                "markers": ["—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "–æ–ø–ª–∞—Ç–∞", "—Ä–∞—Å—á–µ—Ç", "—Å—á–µ—Ç", "–Ω–¥—Å", "—Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π"],
                "template": "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π —Å –¥–∞—Ç—ã –ø–æ—Å—Ç–∞–≤–∫–∏.",
                "risk_patterns": [
                    {"pattern": r"–ø—Ä–µ–¥–æ–ø–ª–∞—Ç\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –±–æ–ª–µ–µ 30% ‚Äî –≤—ã—Å–æ–∫–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–∏—Å–∫"},
                    {"pattern": r"–æ–ø–ª–∞—Ç–∞.*?(?:1|2|3)\s*(?:—Ä–∞–±–æ—á|–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω)", "risk": "yellow", "issue": "–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã –º–µ–Ω–µ–µ 5 –¥–Ω–µ–π ‚Äî —Ä–∏—Å–∫ –∫–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑—Ä—ã–≤–∞"},
                    {"pattern": r"–∞–≤–∞–Ω—Å\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ê–≤–∞–Ω—Å –±–æ–ª–µ–µ 30%"}
                ]
            },
            "–ü–†–ò–ï–ú–ö–ê –¢–û–í–ê–†–ê": {
                "required": True,
                "weight": 1.0,
                "markers": ["–ø—Ä–∏–µ–º–∫–∞", "–ø-6", "–ø-7", "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–∫–∞—á–µ—Å—Ç–≤–æ", "–∞–∫—Ç"],
                "template": "–ü—Ä–∏–µ–º–∫–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏ –∫–∞—á–µ—Å—Ç–≤—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ü-6 –∏ –ü-7.",
                "risk_patterns": []
            },
            "–ì–ê–†–ê–ù–¢–ò–ô–ù–´–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–°–¢–í–ê": {
                "required": True,
                "weight": 1.5,
                "markers": ["–≥–∞—Ä–∞–Ω—Ç–∏—è", "–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫", "–Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏", "–∑–∞–º–µ–Ω–∞"],
                "template": "–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫ –Ω–∞ —Ç–æ–≤–∞—Ä —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 12 –º–µ—Å—è—Ü–µ–≤.",
                "risk_patterns": [
                    {"pattern": r"–≥–∞—Ä–∞–Ω—Ç–∏—è.*?(?:–Ω–µ\s+–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è|–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ ‚Äî —Ä–∏—Å–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"},
                    {"pattern": r"–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π\s+—Å—Ä–æ–∫.*?(?:[1-5])\s*–º–µ—Å—è—Ü", "risk": "yellow", "issue": "–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫ –º–µ–Ω–µ–µ 6 –º–µ—Å—è—Ü–µ–≤"}
                ]
            },
            "–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨ –°–¢–û–†–û–ù": {
                "required": True,
                "weight": 2.0,
                "markers": ["–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "–Ω–µ—É—Å—Ç–æ–π–∫–∞", "—à—Ç—Ä–∞—Ñ", "–ø—Ä–æ—Å—Ä–æ—á–∫–∞", "—É–±—ã—Ç–∫–∏", "–ø–µ–Ω—è"],
                "template": "–ù–µ—É—Å—Ç–æ–π–∫–∞ 0,1% –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 10%.",
                "risk_patterns": [
                    {"pattern": r"–Ω–µ—É—Å—Ç–æ–π–∫\w*.*?–ø–æ–∫—É–ø–∞—Ç–µ–ª\w*.*?(?:0[,.]?[3-9]|[1-9])\s*%", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–µ—É—Å—Ç–æ–π–∫–∞ –¥–ª—è –Ω–∞—Å –≤—ã—à–µ 0.2%/–¥–µ–Ω—å ‚Äî –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å"},
                    {"pattern": r"(?:–ø–æ–ª–Ω\w+|–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω\w+).*?–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ü–æ–∫—É–ø–∞—Ç–µ–ª—è"},
                    {"pattern": r"–Ω–µ\s+(?:–Ω–µ—Å–µ—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç).*?(?:–∫–æ—Å–≤–µ–Ω–Ω|—É–ø—É—â–µ–Ω–Ω)", "risk": "red", "issue": "–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –∑–∞ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ —É–±—ã—Ç–∫–∏"}
                ]
            },
            "–§–û–†–°-–ú–ê–ñ–û–†": {
                "required": True,
                "weight": 0.5,
                "markers": ["—Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä", "–Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º–∞—è —Å–∏–ª–∞", "–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ", "—Ç–ø–ø"],
                "template": "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö –Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º–æ–π —Å–∏–ª—ã.",
                "risk_patterns": []
            },
            "–≠–õ–ï–ö–¢–†–û–ù–ù–´–ô –î–û–ö–£–ú–ï–ù–¢–û–û–ë–û–†–û–¢": {
                "required": False,
                "weight": 0.5,
                "markers": ["—ç–¥–æ", "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç", "—ç—Ü–ø", "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å"],
                "template": "–û–±–º–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –≠–î–û.",
                "risk_patterns": []
            },
            "–†–ê–ó–†–ï–®–ï–ù–ò–ï –°–ü–û–†–û–í": {
                "required": True,
                "weight": 1.0,
                "markers": ["—Å–ø–æ—Ä—ã", "–∞—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π —Å—É–¥", "–ø—Ä–µ—Ç–µ–Ω–∑–∏—è", "–ø–æ–¥—Å—É–¥–Ω–æ—Å—Ç—å"],
                "template": "–ü—Ä–µ—Ç–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ 30 –¥–Ω–µ–π. –°–ø–æ—Ä—ã –≤ –ê—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–º —Å—É–¥–µ –≥. –ú–æ—Å–∫–≤—ã.",
                "risk_patterns": [
                    {"pattern": r"—Ç—Ä–µ—Ç–µ–π—Å–∫\w+\s+—Å—É–¥", "risk": "yellow", "issue": "–¢—Ä–µ—Ç–µ–π—Å–∫–∞—è –æ–≥–æ–≤–æ—Ä–∫–∞ ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã"},
                    {"pattern": r"(?:–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω|–∑–∞—Ä—É–±–µ–∂–Ω)\w*.*?(?:—Å—É–¥|–∞—Ä–±–∏—Ç—Ä–∞–∂)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —Å—É–¥ ‚Äî –∫—Ä–∞–π–Ω–µ –≤—ã—Å–æ–∫–∏–µ –ø—Ä–∞–≤–æ–≤—ã–µ —Ä–∏—Å–∫–∏"}
                ]
            },
            "–°–†–û–ö –î–ï–ô–°–¢–í–ò–Ø": {
                "required": True,
                "weight": 0.5,
                "markers": ["—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è", "—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ", "–ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ"],
                "template": "–î–æ–≥–æ–≤–æ—Ä –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ –ø–æ–ª–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤.",
                "risk_patterns": [
                    {"pattern": r"–ø–æ—Å—Ç–∞–≤—â–∏–∫.*?–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω.*?—Ä–∞—Å—Ç–æ—Ä–≥.*?(?:[1-9]|1[0-4])\s*–¥–Ω", "risk": "red", "issue": "‚ö†Ô∏è –û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –æ—Ç–∫–∞–∑ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Å—Ä–æ–∫–æ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"}
                ]
            },
            "–†–ï–ö–í–ò–ó–ò–¢–´": {
                "required": True,
                "weight": 0.3,
                "markers": ["—Ä–µ–∫–≤–∏–∑–∏—Ç—ã", "–ø–æ–¥–ø–∏—Å–∏", "–∏–Ω–Ω", "–∫–ø–ø", "—Ä–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç"],
                "template": "–†–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –ø–æ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä–æ–Ω.",
                "risk_patterns": []
            }
        },
        "global_risk_patterns": [
            {"pattern": r"–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω\w+.*?–∏–∑–º–µ–Ω–µ–Ω\w+.*?(?:—Ü–µ–Ω|—Å—Ç–æ–∏–º–æ—Å—Ç)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º"},
            {"pattern": r"(?:usd|eur|–µ–≤—Ä–æ|–¥–æ–ª–ª–∞—Ä|–≤–∞–ª—é—Ç|—É\.–µ\.)", "risk": "yellow", "issue": "–í–∞–ª—é—Ç–Ω–∞—è –æ–≥–æ–≤–æ—Ä–∫–∞ ‚Äî –∫—É—Ä—Å–æ–≤—ã–µ —Ä–∏—Å–∫–∏"},
            {"pattern": r"–∏–Ω–¥–µ–∫—Å–∞—Ü\w*.*?–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫", "risk": "yellow", "issue": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ü–µ–Ω"}
        ]
    },
    
    "storage": {
        "name": "–î–æ–≥–æ–≤–æ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "code": "–¢–§-–°–ü–ö-–•–†–ù-001",
        "version": "2024.1",
        "contract_type": "–î–æ–≥–æ–≤–æ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "our_role": "–ü–æ–∫–ª–∞–∂–µ–¥–∞—Ç–µ–ª—å",
        "description": "–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∞—Å–Ω—ã—Ö —á–∞—Å—Ç–µ–π",
        "key_markers": ["—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å", "–ø–æ–∫–ª–∞–∂–µ–¥–∞—Ç–µ–ª—å", "—Ö—Ä–∞–Ω–µ–Ω–∏–µ", "–∏–º—É—â–µ—Å—Ç–≤–æ", "–º—Ö-1", "–º—Ö-3"],
        "sections": {
            "–ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê": {
                "required": True, "weight": 2.0,
                "markers": ["—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è", "–ø–æ–∫–ª–∞–∂–µ–¥–∞—Ç–µ–ª—å", "—Ö—Ä–∞–Ω–µ–Ω–∏–µ", "–∏–º—É—â–µ—Å—Ç–≤–æ", "–∑–∞–ø–∞—Å–Ω—ã–µ —á–∞—Å—Ç–∏"],
                "template": "–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏ —Ö—Ä–∞–Ω–∏—Ç—å –∏–º—É—â–µ—Å—Ç–≤–æ –ü–æ–∫–ª–∞–∂–µ–¥–∞—Ç–µ–ª—è.",
                "risk_patterns": []
            },
            "–û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò –°–¢–û–†–û–ù": {
                "required": True, "weight": 1.5,
                "markers": ["–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏", "—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å", "–º—Ö-1", "–º—Ö-3", "–∞–∫—Ç –ø—Ä–∏–µ–º–∞"],
                "template": "–•—Ä–∞–Ω–∏—Ç–µ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–º—É—â–µ—Å—Ç–≤–æ –ø–æ –ê–∫—Ç—É –ú–•-1, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ –ê–∫—Ç—É –ú–•-3.",
                "risk_patterns": [
                    {"pattern": r"–ø–æ–∫–ª–∞–∂–µ–¥–∞—Ç–µ–ª\w+.*?(?:–Ω–µ—Å–µ—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç).*?(?:—É—Ç—Ä–∞—Ç|–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —É—Ç—Ä–∞—Ç—É –Ω–∞ –Ω–∞—Å, –∞ –Ω–µ –Ω–∞ –•—Ä–∞–Ω–∏—Ç–µ–ª–µ"}
                ]
            },
            "–í–û–ó–ù–ê–ì–†–ê–ñ–î–ï–ù–ò–ï": {
                "required": True, "weight": 1.5,
                "markers": ["–≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ", "–æ–ø–ª–∞—Ç–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è", "—Ç–∞—Ä–∏—Ñ"],
                "template": "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è –≤ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
                "risk_patterns": [
                    {"pattern": r"–ø—Ä–µ–¥–æ–ø–ª–∞—Ç\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "‚ö†Ô∏è –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –±–æ–ª–µ–µ 30%"}
                ]
            },
            "–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨": {
                "required": True, "weight": 2.0,
                "markers": ["–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "—É—Ç—Ä–∞—Ç–∞", "–Ω–µ–¥–æ—Å—Ç–∞—á–∞", "–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ", "—É—â–µ—Ä–±"],
                "template": "–•—Ä–∞–Ω–∏—Ç–µ–ª—å –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —É—Ç—Ä–∞—Ç—É –∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞.",
                "risk_patterns": [
                    {"pattern": r"—Ö—Ä–∞–Ω–∏—Ç–µ–ª\w+.*?–Ω–µ\s+(?:–Ω–µ—Å–µ—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –•—Ä–∞–Ω–∏—Ç–µ–ª—å –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å"},
                    {"pattern": r"–æ–≥—Ä–∞–Ω–∏—á–µ–Ω\w+.*?–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç.*?—Ö—Ä–∞–Ω–∏—Ç–µ–ª", "risk": "yellow", "issue": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –•—Ä–∞–Ω–∏—Ç–µ–ª—è"}
                ]
            },
            "–°–†–û–ö –ò –†–ê–°–¢–û–†–ñ–ï–ù–ò–ï": {
                "required": True, "weight": 0.5,
                "markers": ["—Å—Ä–æ–∫", "–¥–µ–π—Å—Ç–≤–∏—è", "–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è", "—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ"],
                "template": "–î–æ–≥–æ–≤–æ—Ä –∑–∞–∫–ª—é—á–µ–Ω –Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏–∏.",
                "risk_patterns": []
            },
            "–°–ü–û–†–´": {
                "required": True, "weight": 0.5,
                "markers": ["—Å–ø–æ—Ä—ã", "–∞—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π", "—Å—É–¥"],
                "template": "–°–ø–æ—Ä—ã –≤ –ê—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–º —Å—É–¥–µ –≥. –ú–æ—Å–∫–≤—ã.",
                "risk_patterns": []
            }
        },
        "global_risk_patterns": []
    },
    
    "services_teo": {
        "name": "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ (–¢–≠–û)",
        "code": "–¢–§-–°–ü–ö-–£–°–õ-001",
        "version": "2025.1",
        "contract_type": "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ (–¢–≠–û)",
        "our_role": "–ó–∞–∫–∞–∑—á–∏–∫",
        "description": "–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ-—ç–∫—Å–ø–µ–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
        "key_markers": ["–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–∑–∞–∫–∞–∑—á–∏–∫", "—É—Å–ª—É–≥–∏", "–≤–∞–≥–æ–Ω—ã", "–ø–µ—Ä–µ–≤–æ–∑–∫–∞", "—Ç—ç–æ", "–µ–ª—Å", "—Ä–∂–¥"],
        "sections": {
            "–ü–û–ù–Ø–¢–ò–Ø –ò –¢–ï–†–ú–ò–ù–´": {
                "required": True, "weight": 1.0,
                "markers": ["–≤–∞–≥–æ–Ω—ã", "–≥—Ä—É–∑", "–∑–∞—è–≤–∫–∞", "–µ–ª—Å", "–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫", "—Ä–∂–¥", "–ø—Ä–µ–π—Å–∫—É—Ä–∞–Ω—Ç"],
                "template": "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: –í–∞–≥–æ–Ω—ã, –ì—Ä—É–∑, –ó–∞—è–≤–∫–∞, –ï–õ–°, –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫.",
                "risk_patterns": []
            },
            "–ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê": {
                "required": True, "weight": 2.0,
                "markers": ["–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è", "–∑–∞–∫–∞–∑—á–∏–∫", "—É—Å–ª—É–≥–∏", "–≤–∞–≥–æ–Ω—ã", "–ø–µ—Ä–µ–≤–æ–∑–∫–∞"],
                "template": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª—É–≥–∏ –ø–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é –≤–∞–≥–æ–Ω–æ–≤ –¥–ª—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏.",
                "risk_patterns": []
            },
            "–ü–†–ê–í–ê –ò –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò": {
                "required": True, "weight": 1.5,
                "markers": ["–ø—Ä–∞–≤–∞", "–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏", "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–∑–∞–∫–∞–∑—á–∏–∫", "–∑–∞—è–≤–∫–∞", "–ø–æ–≥—Ä—É–∑–∫–∞", "–≤—ã–≥—Ä—É–∑–∫–∞"],
                "template": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø–æ–¥–∞—ë—Ç –≤–∞–≥–æ–Ω—ã –ø–æ –ó–∞—è–≤–∫–µ. –ó–∞–∫–∞–∑—á–∏–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–≥—Ä—É–∑–∫—É/–≤—ã–≥—Ä—É–∑–∫—É.",
                "risk_patterns": [
                    {"pattern": r"–∑–∞–∫–∞–∑—á–∏–∫.*?(?:–Ω–µ—Å–µ—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç).*?(?:–≤—Å–µ|–ª—é–±—ã–µ).*?—Ä–∏—Å–∫", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –í—Å–µ —Ä–∏—Å–∫–∏ –≤–æ–∑–ª–æ–∂–µ–Ω—ã –Ω–∞ –Ω–∞—Å"}
                ]
            },
            "–°–¢–û–ò–ú–û–°–¢–¨ –ò –†–ê–°–ß–ï–¢–´": {
                "required": True, "weight": 2.0,
                "markers": ["—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Ü–µ–Ω–∞", "–æ–ø–ª–∞—Ç–∞", "—Ä–∞—Å—á–µ—Ç", "–∞–∫—Ç", "—Å—á–µ—Ç-—Ñ–∞–∫—Ç—É—Ä–∞"],
                "template": "–û–ø–ª–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ê–∫—Ç–∞ –∏ —Å—á—ë—Ç–∞-—Ñ–∞–∫—Ç—É—Ä—ã.",
                "risk_patterns": [
                    {"pattern": r"–ø—Ä–µ–¥–æ–ø–ª–∞—Ç\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –±–æ–ª–µ–µ 30%"},
                    {"pattern": r"–æ–ø–ª–∞—Ç–∞.*?(?:1|2|3)\s*(?:—Ä–∞–±–æ—á|–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω)", "risk": "yellow", "issue": "–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã –º–µ–Ω–µ–µ 5 –¥–Ω–µ–π"}
                ]
            },
            "–ü–†–ò–ï–ú–ö–ê –£–°–õ–£–ì": {
                "required": True, "weight": 1.0,
                "markers": ["–ø—Ä–∏–µ–º–∫–∞", "–∞–∫—Ç", "–≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è", "–ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ"],
                "template": "–ê–∫—Ç –æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.",
                "risk_patterns": [
                    {"pattern": r"(?:1|2)\s*(?:—Ä–∞–±–æ—á|–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω).*?(?:–ø–æ–¥–ø–∏—Å|–≤–æ–∑—Ä–∞–∂–µ–Ω)", "risk": "yellow", "issue": "–°—Ä–æ–∫ –ø—Ä–∏–µ–º–∫–∏ –º–µ–Ω–µ–µ 3 –¥–Ω–µ–π"}
                ]
            },
            "–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨": {
                "required": True, "weight": 2.0,
                "markers": ["–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "—à—Ç—Ä–∞—Ñ", "–Ω–µ—É—Å—Ç–æ–π–∫–∞", "–ø—Ä–æ—Å—Ç–æ–π", "–ø—Ä–æ—Å—Ä–æ—á–∫–∞"],
                "template": "–ó–∞ –ø—Ä–æ—Å—Ç–æ–π —à—Ç—Ä–∞—Ñ. –ó–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –æ–ø–ª–∞—Ç—ã –Ω–µ—É—Å—Ç–æ–π–∫–∞ 0,1%/–¥–µ–Ω—å, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 10%.",
                "risk_patterns": [
                    {"pattern": r"–Ω–µ—É—Å—Ç–æ–π–∫\w*.*?–∑–∞–∫–∞–∑—á–∏–∫\w*.*?(?:0[,.]?[3-9]|[1-9])\s*%", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–µ—É—Å—Ç–æ–π–∫–∞ –¥–ª—è –Ω–∞—Å –≤—ã—à–µ 0.2%/–¥–µ–Ω—å"},
                    {"pattern": r"—à—Ç—Ä–∞—Ñ.*?–ø—Ä–æ—Å—Ç–æ–π.*?(?:[3-9]\d{3}|[1-9]\d{4})", "risk": "red", "issue": "‚ö†Ô∏è –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ç–æ–π –±–æ–ª–µ–µ 2500 —Ä—É–±/—Å—É—Ç–∫–∏"},
                    {"pattern": r"(?:–ø–æ–ª–Ω\w+|–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω\w+).*?–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç.*?–∑–∞–∫–∞–∑—á–∏–∫", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ó–∞–∫–∞–∑—á–∏–∫–∞"}
                ]
            },
            "–ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û–°–¢–¨": {
                "required": True, "weight": 0.5,
                "markers": ["–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å", "–Ω–µ —Ä–∞–∑–≥–ª–∞—à–∞—Ç—å", "–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Ç–∞–π–Ω–∞"],
                "template": "–£—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã. –°—Ä–æ–∫ 3 –≥–æ–¥–∞.",
                "risk_patterns": [
                    {"pattern": r"—à—Ç—Ä–∞—Ñ.*?–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç.*?(?:[5-9]|[1-9]\d)\s*(?:000\s*000|–º–ª–Ω)", "risk": "red", "issue": "‚ö†Ô∏è –®—Ç—Ä–∞—Ñ –∑–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ 5 –º–ª–Ω"}
                ]
            },
            "–°–†–û–ö –ò –†–ê–°–¢–û–†–ñ–ï–ù–ò–ï": {
                "required": True, "weight": 0.5,
                "markers": ["—Å—Ä–æ–∫", "–¥–µ–π—Å—Ç–≤–∏—è", "—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ", "—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"],
                "template": "–†–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –ø–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—é –∏–ª–∏ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∑–∞ 30 –¥–Ω–µ–π.",
                "risk_patterns": [
                    {"pattern": r"–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª\w+.*?–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω.*?—Ä–∞—Å—Ç–æ—Ä–≥.*?(?:[1-9]|1[0-4])\s*–¥–Ω", "risk": "red", "issue": "‚ö†Ô∏è –û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –æ—Ç–∫–∞–∑ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Å—Ä–æ–∫–æ–º"}
                ]
            },
            "–°–ü–û–†–´": {
                "required": True, "weight": 0.5,
                "markers": ["—Å–ø–æ—Ä—ã", "–ø—Ä–µ—Ç–µ–Ω–∑–∏—è", "–∞—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π", "–º–æ—Å–∫–≤–∞"],
                "template": "–ü—Ä–µ—Ç–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ 30 –¥–Ω–µ–π. –ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π —Å—É–¥ –≥. –ú–æ—Å–∫–≤—ã.",
                "risk_patterns": [
                    {"pattern": r"(?:–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω|–∑–∞—Ä—É–±–µ–∂–Ω)\w*.*?(?:—Å—É–¥|–∞—Ä–±–∏—Ç—Ä–∞–∂)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —Å—É–¥"}
                ]
            }
        },
        "global_risk_patterns": [
            {"pattern": r"–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω\w+.*?–∏–∑–º–µ–Ω–µ–Ω\w+.*?(?:—Ü–µ–Ω|—Å—Ç–æ–∏–º–æ—Å—Ç|—Ç–∞—Ä–∏—Ñ)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º"},
            {"pattern": r"(?:usd|eur|–µ–≤—Ä–æ|–¥–æ–ª–ª–∞—Ä|–≤–∞–ª—é—Ç)", "risk": "yellow", "issue": "–í–∞–ª—é—Ç–Ω–∞—è –æ–≥–æ–≤–æ—Ä–∫–∞"},
            {"pattern": r"–∏–Ω–¥–µ–∫—Å–∞—Ü\w*.*?(?:–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫|–µ–∂–µ–≥–æ–¥–Ω)", "risk": "yellow", "issue": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è"}
        ]
    },
    
    "auto_transport": {
        "name": "–î–æ–≥–æ–≤–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∞–≤—Ç–æ)",
        "code": "–¢–§-–°–ü–ö-–ê–í–¢-001",
        "version": "2023.1",
        "contract_type": "–î–æ–≥–æ–≤–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∞–≤—Ç–æ)",
        "our_role": "–ó–∞–∫–∞–∑—á–∏–∫",
        "description": "–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –∞–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º",
        "key_markers": ["–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫", "–∑–∞–∫–∞–∑—á–∏–∫", "–ø–µ—Ä–µ–≤–æ–∑–∫–∞", "–∞–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–≥—Ä—É–∑", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è"],
        "sections": {
            "–ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê": {
                "required": True, "weight": 2.0,
                "markers": ["–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫", "–∑–∞–∫–∞–∑—á–∏–∫", "–ø–µ—Ä–µ–≤–æ–∑–∫–∞", "–∞–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–≥—Ä—É–∑"],
                "template": "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª—É–≥–∏ –ø–æ –ø–µ—Ä–µ–≤–æ–∑–∫–µ –≥—Ä—É–∑–æ–≤ –∞–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º.",
                "risk_patterns": []
            },
            "–ü–†–ê–í–ê –ò –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò": {
                "required": True, "weight": 1.5,
                "markers": ["–ø—Ä–∞–≤–∞", "–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏", "–∑–∞—è–≤–∫–∞", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ø–æ–≥—Ä—É–∑–∫–∞"],
                "template": "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –ø–æ–¥–∞—ë—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ø–æ –ó–∞—è–≤–∫–µ.",
                "risk_patterns": [
                    {"pattern": r"–∑–∞–∫–∞–∑—á–∏–∫.*?(?:–Ω–µ—Å–µ—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç).*?(?:–≤—Å–µ|–ª—é–±—ã–µ).*?—Ä–∏—Å–∫", "risk": "red", "issue": "‚ö†Ô∏è –í—Å–µ —Ä–∏—Å–∫–∏ –Ω–∞ –ó–∞–∫–∞–∑—á–∏–∫–µ"}
                ]
            },
            "–°–¢–û–ò–ú–û–°–¢–¨": {
                "required": True, "weight": 1.5,
                "markers": ["—Å—Ç–æ–∏–º–æ—Å—Ç—å", "–æ–ø–ª–∞—Ç–∞", "—Ä–∞—Å—á–µ—Ç", "–∞–∫—Ç"],
                "template": "–û–ø–ª–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –ø–æ –ê–∫—Ç—É.",
                "risk_patterns": [
                    {"pattern": r"–ø—Ä–µ–¥–æ–ø–ª–∞—Ç\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "‚ö†Ô∏è –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –±–æ–ª–µ–µ 30%"}
                ]
            },
            "–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨": {
                "required": True, "weight": 2.0,
                "markers": ["–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "—É—Ç—Ä–∞—Ç–∞", "–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ", "—É—â–µ—Ä–±", "–Ω–µ—É—Å—Ç–æ–π–∫–∞"],
                "template": "–ó–∞ —É—Ç—Ä–∞—Ç—É –≥—Ä—É–∑–∞ –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –≤–æ–∑–º–µ—â–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π —É—â–µ—Ä–±.",
                "risk_patterns": [
                    {"pattern": r"–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫.*?–Ω–µ\s+(?:–Ω–µ—Å–µ—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç)", "risk": "red", "issue": "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –≥—Ä—É–∑"}
                ]
            },
            "–°–ü–û–†–´": {
                "required": True, "weight": 0.5,
                "markers": ["—Å–ø–æ—Ä—ã", "–∞—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π"],
                "template": "–ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π —Å—É–¥ –≥. –ú–æ—Å–∫–≤—ã.",
                "risk_patterns": []
            }
        },
        "global_risk_patterns": []
    }
}

# –î–µ–º–æ-–¥–æ–≥–æ–≤–æ—Ä
DEMO_CONTRACT = """–î–û–ì–û–í–û–† –û–ö–ê–ó–ê–ù–ò–Ø –£–°–õ–£–ì ‚Ññ 2025/–¢–≠–û-001

–≥. –ú–æ—Å–∫–≤–∞                                                     ¬´15¬ª —è–Ω–≤–∞—Ä—è 2025 –≥.

–û–û–û ¬´–¢—Ä–∞–Ω—Å–õ–æ–≥–∏—Å—Ç–∏–∫¬ª (–ò–ù–ù 7707123456), –∏–º–µ–Ω—É–µ–º–æ–µ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å¬ª, –≤ –ª–∏—Ü–µ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –°–∏–¥–æ—Ä–æ–≤–∞ –°.–°., –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –£—Å—Ç–∞–≤–∞, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏
–ê–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ ¬´–°—Ç–∞—Ä–∞—è –ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è¬ª (–ê–û ¬´–°–ü–ö¬ª), –∏–º–µ–Ω—É–µ–º–æ–µ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ó–∞–∫–∞–∑—á–∏–∫¬ª, –≤ –ª–∏—Ü–µ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ü–µ—Ç—Ä–æ–≤–∞ –ü.–ü., –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –£—Å—Ç–∞–≤–∞, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã,
—Å–æ–≤–º–µ—Å—Ç–Ω–æ –∏–º–µ–Ω—É–µ–º—ã–µ ¬´–°—Ç–æ—Ä–æ–Ω—ã¬ª, –∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –î–æ–≥–æ–≤–æ—Ä:

–ü–û–ù–Ø–¢–ò–Ø –ò –¢–ï–†–ú–ò–ù–´

¬´–í–∞–≥–æ–Ω—ã¬ª - –∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π –ø–æ–¥–≤–∏–∂–Ω–æ–π —Å–æ—Å—Ç–∞–≤ (–ø–æ–ª—É–≤–∞–≥–æ–Ω—ã –∏ –¥—Ä—É–≥–∏–µ).
¬´–ì—Ä—É–∑¬ª - —Ç–æ–≤–∞—Ä, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –∫ –ø–µ—Ä–µ–≤–æ–∑–∫–µ.
¬´–ó–∞—è–≤–∫–∞¬ª - —É—Å–ª–æ–≤–∏—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏.
¬´–ï–õ–°¬ª - –µ–¥–∏–Ω—ã–π –ª–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç.

1. –ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê

1.1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –æ–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥–∏ –ø–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é –∂/–¥ –≤–∞–≥–æ–Ω–æ–≤ –¥–ª—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –≥—Ä—É–∑–æ–≤ –ó–∞–∫–∞–∑—á–∏–∫–∞, –∞ –ó–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –æ–∫–∞–∑–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏.

2. –ü–†–ê–í–ê –ò –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò –°–¢–û–†–û–ù

2.1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑–∞–Ω –ø–æ–¥–∞—Ç—å –≤–∞–≥–æ–Ω—ã –ø–æ –ó–∞—è–≤–∫–µ –ó–∞–∫–∞–∑—á–∏–∫–∞.
2.2. –ó–∞–∫–∞–∑—á–∏–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–≥—Ä—É–∑–∫—É –∏ –≤—ã–≥—Ä—É–∑–∫—É –≤ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å—Ä–æ–∫–∏.
2.3. –ó–∞–∫–∞–∑—á–∏–∫ –Ω–µ—Å–µ—Ç –≤—Å–µ —Ä–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–∞–≥–æ–Ω–æ–≤.

3. –°–¢–û–ò–ú–û–°–¢–¨ –£–°–õ–£–ì –ò –ü–û–†–Ø–î–û–ö –†–ê–°–ß–ï–¢–û–í

3.1. –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥: 8 500 000 (–í–æ—Å–µ–º—å –º–∏–ª–ª–∏–æ–Ω–æ–≤ –ø—è—Ç—å—Å–æ—Ç —Ç—ã—Å—è—á) —Ä—É–±–ª–µ–π –≤ –≥–æ–¥.
3.2. –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ 50% –æ—Ç —Å—É–º–º—ã –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è.
3.3. –û–ø–ª–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—á—ë—Ç–∞.
3.4. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ –∏–∑–º–µ–Ω—è—Ç—å —Ç–∞—Ä–∏—Ñ—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∑–∞ 10 –¥–Ω–µ–π.

4. –ü–û–†–Ø–î–û–ö –ü–†–ò–ï–ú–ö–ò –£–°–õ–£–ì

4.1. –ê–∫—Ç –æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.
4.2. –ú–æ–ª—á–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–∏–µ–º.

5. –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨ –°–¢–û–†–û–ù

5.1. –ó–∞ —Å–≤–µ—Ä—Ö–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞–≥–æ–Ω–æ–≤ —à—Ç—Ä–∞—Ñ 5 000 —Ä—É–±–ª–µ–π –∑–∞ –≤–∞–≥–æ–Ω–æ-—Å—É—Ç–∫–∏.
5.2. –ó–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Å—Ä–æ–∫–æ–≤ –æ–ø–ª–∞—Ç—ã –Ω–µ—É—Å—Ç–æ–π–∫–∞ 0,5% –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.
5.3. –ó–∞–∫–∞–∑—á–∏–∫ –Ω–µ—Å—ë—Ç –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –≤–∞–≥–æ–Ω–æ–≤.
5.4. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ –∏ —É–ø—É—â–µ–Ω–Ω—ã–µ —É–±—ã—Ç–∫–∏.

6. –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û–°–¢–¨

6.1. –°—Ä–æ–∫ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: –±–µ—Å—Å—Ä–æ—á–Ω–æ.
6.2. –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: 15 000 000 —Ä—É–±–ª–µ–π.

7. –§–û–†–°-–ú–ê–ñ–û–†

7.1. –°—Ç–æ—Ä–æ–Ω—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è –ø—Ä–∏ –Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º–æ–π —Å–∏–ª–µ.

8. –°–†–û–ö –î–ï–ô–°–¢–í–ò–Ø –ò –†–ê–°–¢–û–†–ñ–ï–ù–ò–ï

8.1. –î–æ–≥–æ–≤–æ—Ä –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ 31.12.2025.
8.2. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å –¥–æ–≥–æ–≤–æ—Ä –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ, —É–≤–µ–¥–æ–º–∏–≤ –∑–∞ 5 –¥–Ω–µ–π.
8.3. –î–æ–≥–æ–≤–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ª–æ–Ω–≥–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥.

9. –†–ê–ó–†–ï–®–ï–ù–ò–ï –°–ü–û–†–û–í

9.1. –í—Å–µ —Å–ø–æ—Ä—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –≤ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–º –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–º —Å—É–¥–µ –ø—Ä–∏ –¢–ü–ü –†–§.

10. –†–ï–ö–í–ò–ó–ò–¢–´ –ò –ü–û–î–ü–ò–°–ò –°–¢–û–†–û–ù

–ó–ê–ö–ê–ó–ß–ò–ö:                              –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨:
–ê–û ¬´–°–ü–ö¬ª                               –û–û–û ¬´–¢—Ä–∞–Ω—Å–õ–æ–≥–∏—Å—Ç–∏–∫¬ª
–ò–ù–ù 7708654321                         –ò–ù–ù 7707123456

___________/–ü–µ—Ç—Ä–æ–≤ –ü.–ü./               ___________/–°–∏–¥–æ—Ä–æ–≤ –°.–°./
"""

# ============================================================================
# –ó–ê–ì–†–£–ó–ß–ò–ö –î–û–ö–£–ú–ï–ù–¢–û–í
# ============================================================================

class DocumentLoader:
    @staticmethod
    def load_txt(content: bytes) -> str:
        for enc in ['utf-8', 'cp1251', 'cp866', 'latin-1', 'koi8-r']:
            try:
                text = content.decode(enc)
                if re.search(r'[–∞-—è–ê-–Ø—ë–Åa-zA-Z]', text):
                    return text
            except:
                continue
        return content.decode('utf-8', errors='replace')
    
    @staticmethod
    def load_docx(content: bytes) -> Tuple[bool, str]:
        if not DOCX_AVAILABLE:
            return False, "‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ python-docx: pip install python-docx"
        try:
            doc = DocxDocument(io.BytesIO(content))
            parts = []
            for para in doc.paragraphs:
                if para.text.strip():
                    parts.append(para.text.strip())
            for table in doc.tables:
                for row in table.rows:
                    row_texts = [c.text.strip() for c in row.cells if c.text.strip()]
                    if row_texts:
                        parts.append(' | '.join(row_texts))
            result = '\n'.join(parts)
            return (True, result) if result.strip() else (False, "‚ùå –î–æ–∫—É–º–µ–Ω—Ç –ø—É—Å—Ç–æ–π")
        except Exception as e:
            return False, f"‚ùå –û—à–∏–±–∫–∞ DOCX: {e}"
    
    @staticmethod
    def load_pdf(content: bytes) -> Tuple[bool, str]:
        if not PDF_READER_AVAILABLE:
            return False, "‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PyPDF2: pip install PyPDF2"
        try:
            reader = PdfReader(io.BytesIO(content))
            parts = [page.extract_text().strip() for page in reader.pages if page.extract_text()]
            result = '\n'.join(parts)
            return (True, result) if result.strip() else (False, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç")
        except Exception as e:
            return False, f"‚ùå –û—à–∏–±–∫–∞ PDF: {e}"
    
    @classmethod
    def load_file(cls, uploaded_file) -> Tuple[bool, str]:
        if not uploaded_file:
            return False, "‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω"
        try:
            content = uploaded_file.read()
            filename = uploaded_file.name.lower()
            if filename.endswith('.txt'):
                return True, cls.load_txt(content)
            elif filename.endswith('.docx'):
                return cls.load_docx(content)
            elif filename.endswith('.doc'):
                return False, "‚ùå –§–æ—Ä–º–∞—Ç .doc –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ .docx"
            elif filename.endswith('.pdf'):
                return cls.load_pdf(content)
            return False, "‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç"
        except Exception as e:
            return False, f"‚ùå –û—à–∏–±–∫–∞: {e}"

# ============================================================================
# –£–õ–£–ß–®–ï–ù–ù–´–ô –ê–õ–ì–û–†–ò–¢–ú RAG-–°–õ–ò–ß–ï–ù–ò–Ø
# ============================================================================

class ImprovedComparator:
    """
    –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å —Ç–∏–ø–æ–≤—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—Ä–∫–µ—Ä—ã, –≤–µ—Å–∞ —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑.
    """
    
    STOP_WORDS = {'–∏', '–≤', '–Ω–∞', '–ø–æ', '—Å', '–∫', '–æ', '–æ—Ç', '–∏–∑', '–∑–∞', '–¥–ª—è', '–Ω–µ', '—á—Ç–æ', '–∫–∞–∫', 
                  '—ç—Ç–æ', '–≤—Å–µ', '–∏–ª–∏', '–ø—Ä–∏', '–¥–æ', '–±–µ–∑', '–µ–≥–æ', '–µ—ë', '–∏—Ö', '–∞', '–Ω–æ', '–¥–∞', '–∂–µ',
                  '–ª–∏', '–±—ã', '—Ç–æ', '–Ω–∏', '—Ç–∞–∫–∂–µ', '–º–µ–∂–¥—É', '–ø–æ—Å–ª–µ', '–µ—Å–ª–∏', '—Ç–æ–ª—å–∫–æ', '–∫–æ–≥–¥–∞'}
    
    @classmethod
    def normalize_text(cls, text: str) -> str:
        """–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"""
        if not text:
            return ""
        text = text.lower()
        text = re.sub(r'[¬´¬ª""‚Äû‚Äü\'\"]', '', text)
        text = re.sub(r'[\n\r\t]+', ' ', text)
        text = re.sub(r'\s+', ' ', text)
        return text.strip()
    
    @classmethod
    def tokenize(cls, text: str) -> List[str]:
        """–¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–æ–ø-—Å–ª–æ–≤"""
        text = cls.normalize_text(text)
        text = re.sub(r'[^\w\s–∞-—è—ë–ê-–Ø–Å]', ' ', text)
        tokens = text.split()
        return [t for t in tokens if len(t) > 2 and t not in cls.STOP_WORDS]
    
    @classmethod
    def calculate_marker_score(cls, text: str, markers: List[str]) -> Tuple[float, List[str]]:
        """–†–∞—Å—á—ë—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º - –∫–ª—é—á–µ–≤–æ–π –º–µ—Ç–æ–¥ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        if not markers:
            return 0.5, []
        
        text_norm = cls.normalize_text(text)
        found_markers = []
        
        for marker in markers:
            marker_norm = marker.lower()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –∏–ª–∏ –µ–≥–æ —á–∞—Å—Ç–µ–π
            if marker_norm in text_norm:
                found_markers.append(marker)
            else:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
                marker_parts = marker_norm.split()
                if len(marker_parts) > 1:
                    matches = sum(1 for part in marker_parts if part in text_norm)
                    if matches >= len(marker_parts) * 0.7:
                        found_markers.append(marker)
        
        score = len(found_markers) / len(markers) if markers else 0
        return score, found_markers
    
    @classmethod
    def identify_typical_form(cls, contract_text: str) -> Tuple[Optional[str], float, str]:
        """
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (–∫–æ–¥_–¢–§, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä–∏—á–∏–Ω–∞)
        """
        text_norm = cls.normalize_text(contract_text)
        best_match = None
        best_score = 0
        best_reason = ""
        
        for tf_code, tf_data in BUILTIN_TYPICAL_FORMS.items():
            key_markers = tf_data.get("key_markers", [])
            score, found = cls.calculate_marker_score(contract_text, key_markers)
            
            # –ë–æ–Ω—É—Å –∑–∞ –Ω–∞—à—É —Ä–æ–ª—å
            our_role = tf_data.get("our_role", "").lower()
            if our_role in text_norm:
                score += 0.15
            
            # –ë–æ–Ω—É—Å –∑–∞ —Ç–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ —Ç–µ–∫—Å—Ç–µ
            contract_type = tf_data.get("contract_type", "").lower()
            if contract_type and contract_type in text_norm:
                score += 0.1
            
            if score > best_score:
                best_score = score
                best_match = tf_code
                best_reason = f"–ù–∞–π–¥–µ–Ω–æ {len(found)}/{len(key_markers)} –∫–ª—é—á–µ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤: {', '.join(found[:5])}"
        
        return best_match, min(best_score, 1.0), best_reason
    
    @classmethod
    def extract_sections_smart(cls, text: str) -> Dict[str, str]:
        """–£–º–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∞"""
        sections = {}
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤
        section_patterns = [
            r'(?:^|\n)\s*(\d+)\s*\.\s*([–ê-–Ø–ÅA-Z][–ê-–Ø–ÅA-Z\s\-]+?)(?:\n|$)',
            r'(?:^|\n)\s*(–†–ê–ó–î–ï–õ\s+\d+)[.\s:]+\s*([^\n]+)',
            r'(?:^|\n)\s*([–ê-–Ø–Å][–ê-–Ø–Å\s\-]{5,}?)(?:\n|$)',
        ]
        
        lines = text.split('\n')
        current_section = "–ü–†–ï–ê–ú–ë–£–õ–ê"
        current_content = []
        
        for line in lines:
            line_stripped = line.strip()
            if not line_stripped:
                continue
            
            found_section = False
            
            # –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞
            for pattern in section_patterns[:2]:
                match = re.match(pattern, '\n' + line_stripped, re.IGNORECASE)
                if match:
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–¥–µ–ª
                    if current_content:
                        sections[current_section] = '\n'.join(current_content).strip()
                    
                    if match.lastindex >= 2:
                        current_section = f"{match.group(1)}. {match.group(2)}".strip().upper()
                    else:
                        current_section = match.group(1).strip().upper()
                    current_content = []
                    found_section = True
                    break
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
            if not found_section and line_stripped.isupper() and 5 < len(line_stripped) < 60:
                if current_content:
                    sections[current_section] = '\n'.join(current_content).strip()
                current_section = line_stripped
                current_content = []
                found_section = True
            
            if not found_section:
                current_content.append(line_stripped)
        
        if current_content:
            sections[current_section] = '\n'.join(current_content).strip()
        
        return sections
    
    @classmethod
    def compare_section_smart(cls, contract_section: str, tf_section_data: Dict) -> Dict:
        """–£–º–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ —Å —ç—Ç–∞–ª–æ–Ω–æ–º"""
        result = {
            "found": False,
            "score": 0,
            "status": "missing",
            "matched_markers": [],
            "missing_markers": [],
            "details": ""
        }
        
        if not contract_section or len(contract_section) < 20:
            return result
        
        result["found"] = True
        markers = tf_section_data.get("markers", [])
        
        # –†–∞—Å—á—ë—Ç –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
        marker_score, found_markers = cls.calculate_marker_score(contract_section, markers)
        result["matched_markers"] = found_markers
        result["missing_markers"] = [m for m in markers if m not in found_markers]
        
        # –†–∞—Å—á—ë—Ç –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é (Jaccard –Ω–∞ —Ç–æ–∫–µ–Ω–∞—Ö)
        template = tf_section_data.get("template", "")
        contract_tokens = set(cls.tokenize(contract_section))
        template_tokens = set(cls.tokenize(template))
        
        if contract_tokens and template_tokens:
            jaccard = len(contract_tokens & template_tokens) / len(contract_tokens | template_tokens)
        else:
            jaccard = 0
        
        # –ò—Ç–æ–≥–æ–≤—ã–π —Å–∫–æ—Ä: –º–∞—Ä–∫–µ—Ä—ã –≤–∞–∂–Ω–µ–µ
        result["score"] = marker_score * 0.7 + jaccard * 0.3
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        if result["score"] >= 0.6:
            result["status"] = "match"
            result["details"] = "‚úÖ –†–∞–∑–¥–µ–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º–µ"
        elif result["score"] >= 0.35:
            result["status"] = "partial"
            result["details"] = f"‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç: {', '.join(result['missing_markers'][:3])}"
        else:
            result["status"] = "deviation"
            result["details"] = f"‚ùå –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –¢–§"
        
        return result
    
    @classmethod
    def find_matching_section(cls, tf_section_name: str, tf_section_data: Dict, contract_sections: Dict[str, str]) -> Tuple[str, Dict]:
        """–ü–æ–∏—Å–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –≤ –¥–æ–≥–æ–≤–æ—Ä–µ"""
        best_match_name = None
        best_result = {"found": False, "score": 0, "status": "missing"}
        best_total = 0
        
        tf_name_norm = cls.normalize_text(re.sub(r'^\d+\.\s*', '', tf_section_name))
        markers = tf_section_data.get("markers", [])
        
        for contract_name, contract_content in contract_sections.items():
            # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π
            contract_name_norm = cls.normalize_text(re.sub(r'^\d+\.\s*', '', contract_name))
            name_similarity = difflib.SequenceMatcher(None, tf_name_norm, contract_name_norm).ratio()
            
            # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
            marker_score, _ = cls.calculate_marker_score(contract_content, markers)
            
            # –ò—Ç–æ–≥–æ–≤—ã–π —Å–∫–æ—Ä
            total = name_similarity * 0.4 + marker_score * 0.6
            
            if total > best_total:
                best_total = total
                best_match_name = contract_name
                best_result = cls.compare_section_smart(contract_content, tf_section_data)
                best_result["matched_contract_section"] = contract_name
        
        return best_match_name, best_result
    
    @classmethod
    def check_risks(cls, text: str, patterns: List[Dict]) -> List[Dict]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∏—Å–∫–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤"""
        found_risks = []
        text_lower = text.lower()
        
        for p in patterns:
            try:
                match = re.search(p["pattern"], text_lower, re.IGNORECASE | re.DOTALL)
                if match:
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    start = max(0, match.start() - 80)
                    end = min(len(text), match.end() + 80)
                    context = text[start:end].replace('\n', ' ').strip()
                    
                    found_risks.append({
                        "issue": p.get("issue", "–í—ã—è–≤–ª–µ–Ω —Ä–∏—Å–∫"),
                        "risk_level": p.get("risk", "yellow"),
                        "context": f"¬´...{context}...¬ª",
                        "position": match.start(),
                        "matched_text": match.group(0)[:100]
                    })
            except re.error:
                continue
        
        return found_risks
    
    @classmethod
    def full_analysis(cls, contract_text: str, tf_code: str = None) -> Dict:
        """
        –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞.
        –ï—Å–ª–∏ tf_code –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø.
        """
        result = {
            "auto_detected_tf": None,
            "auto_confidence": 0,
            "auto_reason": "",
            "form_name": "",
            "form_code": "",
            "our_role": "",
            "sections_analysis": [],
            "missing_sections": [],
            "found_sections": [],
            "partial_sections": [],
            "deviation_sections": [],
            "risks": [],
            "risk_details": [],
            "compliance_score": 0,
            "recommendations": [],
            "summary": "",
            "is_typical_form_match": False
        }
        
        # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        if not tf_code:
            detected_tf, confidence, reason = cls.identify_typical_form(contract_text)
            result["auto_detected_tf"] = detected_tf
            result["auto_confidence"] = confidence
            result["auto_reason"] = reason
            
            if confidence >= 0.4:
                tf_code = detected_tf
        
        if not tf_code or tf_code not in BUILTIN_TYPICAL_FORMS:
            result["summary"] = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø–æ–≤—É—é —Ñ–æ—Ä–º—É –≤—Ä—É—á–Ω—É—é."
            return result
        
        tf = BUILTIN_TYPICAL_FORMS[tf_code]
        result["form_name"] = tf.get("name", "")
        result["form_code"] = tf.get("code", "")
        result["our_role"] = tf.get("our_role", "")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞
        contract_sections = cls.extract_sections_smart(contract_text)
        
        total_score = 0
        total_weight = 0
        
        # –ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –¢–§
        for section_name, section_data in tf.get("sections", {}).items():
            weight = section_data.get("weight", 1.0)
            is_required = section_data.get("required", False)
            total_weight += weight
            
            # –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª –≤ –¥–æ–≥–æ–≤–æ—Ä–µ
            matched_name, comparison = cls.find_matching_section(section_name, section_data, contract_sections)
            
            section_result = {
                "tf_section": section_name,
                "required": is_required,
                "weight": weight,
                "matched_contract_section": matched_name,
                "comparison": comparison,
                "risks": []
            }
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∏—Å–∫–æ–≤ –≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ
            if matched_name and contract_sections.get(matched_name):
                section_risks = cls.check_risks(contract_sections[matched_name], section_data.get("risk_patterns", []))
                section_result["risks"] = section_risks
                result["risks"].extend(section_risks)
            
            # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞
            status = comparison.get("status", "missing")
            score = comparison.get("score", 0)
            
            if status == "match":
                result["found_sections"].append(section_name)
                total_score += weight * 1.0
            elif status == "partial":
                result["partial_sections"].append(section_name)
                total_score += weight * 0.6
                if is_required:
                    result["recommendations"].append(f"‚ö†Ô∏è –†–∞–∑–¥–µ–ª ¬´{section_name}¬ª: {comparison.get('details', '')}")
            elif status == "deviation":
                result["deviation_sections"].append(section_name)
                total_score += weight * 0.2
                result["recommendations"].append(f"‚ùå –†–∞–∑–¥–µ–ª ¬´{section_name}¬ª —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¢–§")
            else:
                result["missing_sections"].append(section_name)
                if is_required:
                    result["recommendations"].append(f"üö´ –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª ¬´{section_name}¬ª")
            
            result["sections_analysis"].append(section_result)
        
        # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏
        global_risks = cls.check_risks(contract_text, tf.get("global_risk_patterns", []))
        result["risks"].extend(global_risks)
        
        # –†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–∫–æ—Ä–∞
        red_count = sum(1 for r in result["risks"] if r.get("risk_level") == "red")
        yellow_count = sum(1 for r in result["risks"] if r.get("risk_level") == "yellow")
        
        base_score = (total_score / total_weight * 100) if total_weight > 0 else 0
        risk_penalty = red_count * 12 + yellow_count * 4
        
        result["compliance_score"] = max(0, min(100, base_score - risk_penalty))
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ - —ç—Ç–æ –¢–§ –∏–ª–∏ –Ω–µ—Ç
        result["is_typical_form_match"] = (
            result["compliance_score"] >= 70 and
            red_count == 0 and
            len(result["missing_sections"]) == 0
        )
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—é–º–µ
        if result["is_typical_form_match"]:
            result["summary"] = f"‚úÖ –î–æ–≥–æ–≤–æ—Ä –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ —Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º–µ ¬´{result['form_name']}¬ª"
        elif result["compliance_score"] >= 60:
            result["summary"] = f"‚ö†Ô∏è –î–æ–≥–æ–≤–æ—Ä –ß–ê–°–¢–ò–ß–ù–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–§ ({result['compliance_score']:.0f}%). –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π."
        elif result["compliance_score"] >= 35:
            result["summary"] = f"üî∂ –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ï –û–¢–ö–õ–û–ù–ï–ù–ò–Ø –æ—Ç –¢–§ ({result['compliance_score']:.0f}%). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Æ–î."
        else:
            result["summary"] = f"‚ùå –î–æ–≥–æ–≤–æ—Ä –ù–ï –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ —Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º–µ ({result['compliance_score']:.0f}%). –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞."
        
        # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤ –¥–ª—è –æ—Ç—á—ë—Ç–∞
        for risk in result["risks"]:
            result["risk_details"].append({
                "level": "üî¥ –ö–†–ò–¢–ò–ß–ù–û" if risk["risk_level"] == "red" else "üü° –í–ù–ò–ú–ê–ù–ò–ï",
                "issue": risk["issue"],
                "context": risk.get("context", ""),
                "recommendation": cls._get_risk_recommendation(risk)
            })
        
        return result
    
    @classmethod
    def _get_risk_recommendation(cls, risk: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∏—Å–∫—É"""
        issue = risk.get("issue", "").lower()
        
        if "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞" in issue or "–∞–≤–∞–Ω—Å" in issue:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –∏–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –Ω–∞ ¬´–æ–ø–ª–∞—Ç–∞ –ø–æ —Ñ–∞–∫—Ç—É¬ª –∏–ª–∏ ¬´–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–µ –±–æ–ª–µ–µ 30%¬ª"
        elif "–Ω–µ—É—Å—Ç–æ–π–∫–∞" in issue:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: —Å–Ω–∏–∑–∏—Ç—å —Ä–∞–∑–º–µ—Ä –Ω–µ—É—Å—Ç–æ–π–∫–∏ –¥–æ 0,1% –≤ –¥–µ–Ω—å, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 10% –æ—Ç —Å—É–º–º—ã"
        elif "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å" in issue and "–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω" in issue:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Å—É–º–º–æ–π –¥–æ–≥–æ–≤–æ—Ä–∞"
        elif "–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω" in issue and "–∏–∑–º–µ–Ω–µ–Ω" in issue:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –∏—Å–∫–ª—é—á–∏—Ç—å –ø—Ä–∞–≤–æ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–æ –æ—Ç–∫–∞–∑–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏"
        elif "—Å—É–¥" in issue and ("–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω" in issue or "–∞—Ä–±–∏—Ç—Ä–∞–∂" in issue):
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥—Å—É–¥–Ω–æ—Å—Ç—å –Ω–∞ –ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π —Å—É–¥ –≥. –ú–æ—Å–∫–≤—ã"
        elif "—Ä–∞—Å—Ç–æ—Ä–≥" in issue:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: —É–≤–µ–ª–∏—á–∏—Ç—å —Å—Ä–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –¥–æ 30 –¥–Ω–µ–π"
        elif "—Ä–∏—Å–∫" in issue:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∏—Å–∫–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏–ª–∏ –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞"
        elif "–≥–∞—Ä–∞–Ω—Ç–∏—è" in issue:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –¥–æ–±–∞–≤–∏—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–µ –º–µ–Ω–µ–µ 12 –º–µ—Å—è—Ü–µ–≤"
        else:
            return "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –≤ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"

# ============================================================================
# AI –ê–ù–ê–õ–ò–ó–ê–¢–û–† –° –ü–†–û–í–ï–†–ö–û–ô –°–û–ï–î–ò–ù–ï–ù–ò–Ø
# ============================================================================

class AIAnalyzer:
    @classmethod
    def check_connection(cls, provider: str, api_key: str, folder_id: str = "") -> Tuple[bool, str, float]:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI-—Å–µ—Ä–≤–∏—Å–æ–º.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—É—Å–ø–µ—Ö, —Å–æ–æ–±—â–µ–Ω–∏–µ, –≤—Ä–µ–º—è_–æ—Ç–≤–µ—Ç–∞_–º—Å)
        """
        if not REQUESTS_AVAILABLE:
            return False, "‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ requests –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", 0
        
        if not api_key:
            return False, "‚ùå API-–∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω", 0
        
        start_time = time.time()
        
        try:
            if provider == "openai":
                response = requests.get(
                    "https://api.openai.com/v1/models",
                    headers={"Authorization": f"Bearer {api_key}"},
                    timeout=10
                )
                elapsed = (time.time() - start_time) * 1000
                if response.status_code == 200:
                    return True, f"‚úÖ OpenAI –ø–æ–¥–∫–ª—é—á–µ–Ω ({elapsed:.0f}ms)", elapsed
                elif response.status_code == 401:
                    return False, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π API-–∫–ª—é—á", elapsed
                return False, f"‚ùå –û—à–∏–±–∫–∞ {response.status_code}", elapsed
            
            elif provider == "anthropic":
                response = requests.post(
                    "https://api.anthropic.com/v1/messages",
                    headers={
                        "x-api-key": api_key,
                        "Content-Type": "application/json",
                        "anthropic-version": "2023-06-01"
                    },
                    json={
                        "model": "claude-3-haiku-20240307",
                        "max_tokens": 5,
                        "messages": [{"role": "user", "content": "ping"}]
                    },
                    timeout=15
                )
                elapsed = (time.time() - start_time) * 1000
                if response.status_code == 200:
                    return True, f"‚úÖ Anthropic –ø–æ–¥–∫–ª—é—á–µ–Ω ({elapsed:.0f}ms)", elapsed
                elif response.status_code == 401:
                    return False, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π API-–∫–ª—é—á", elapsed
                return False, f"‚ùå –û—à–∏–±–∫–∞ {response.status_code}", elapsed
            
            elif provider == "gigachat":
                elapsed = (time.time() - start_time) * 1000
                return True, f"‚ö†Ô∏è GigaChat: —Ç—Ä–µ–±—É–µ—Ç—Å—è OAuth ({elapsed:.0f}ms)", elapsed
            
            elif provider == "yandexgpt":
                if not folder_id:
                    return False, "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Folder ID", 0
                response = requests.post(
                    "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                    headers={
                        "Authorization": f"Api-Key {api_key}",
                        "Content-Type": "application/json"
                    },
                    json={
                        "modelUri": f"gpt://{folder_id}/yandexgpt-lite",
                        "completionOptions": {"stream": False, "maxTokens": 5},
                        "messages": [{"role": "user", "text": "—Ç–µ—Å—Ç"}]
                    },
                    timeout=15
                )
                elapsed = (time.time() - start_time) * 1000
                if response.status_code == 200:
                    return True, f"‚úÖ YandexGPT –ø–æ–¥–∫–ª—é—á–µ–Ω ({elapsed:.0f}ms)", elapsed
                return False, f"‚ùå –û—à–∏–±–∫–∞ {response.status_code}", elapsed
            
            elif provider == "mistral":
                response = requests.get(
                    "https://api.mistral.ai/v1/models",
                    headers={"Authorization": f"Bearer {api_key}"},
                    timeout=10
                )
                elapsed = (time.time() - start_time) * 1000
                if response.status_code == 200:
                    return True, f"‚úÖ Mistral –ø–æ–¥–∫–ª—é—á–µ–Ω ({elapsed:.0f}ms)", elapsed
                return False, f"‚ùå –û—à–∏–±–∫–∞ {response.status_code}", elapsed
            
            elif provider == "perplexity":
                response = requests.post(
                    "https://api.perplexity.ai/chat/completions",
                    headers={
                        "Authorization": f"Bearer {api_key}",
                        "Content-Type": "application/json"
                    },
                    json={
                        "model": "llama-3.1-sonar-small-128k-online",
                        "messages": [{"role": "user", "content": "test"}],
                        "max_tokens": 5
                    },
                    timeout=15
                )
                elapsed = (time.time() - start_time) * 1000
                if response.status_code == 200:
                    return True, f"‚úÖ Perplexity –ø–æ–¥–∫–ª—é—á–µ–Ω ({elapsed:.0f}ms)", elapsed
                return False, f"‚ùå –û—à–∏–±–∫–∞ {response.status_code}", elapsed
            
            return False, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä", 0
        
        except requests.exceptions.Timeout:
            return False, "‚ùå –¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)", 0
        except requests.exceptions.ConnectionError:
            return False, "‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º", 0
        except Exception as e:
            return False, f"‚ùå –û—à–∏–±–∫–∞: {str(e)[:50]}", 0
    
    @classmethod
    def generate_detailed_prompt(cls, contract_text: str, analysis: Dict, org_name: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è AI —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏"""
        
        # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∏—Å–∫–∞—Ö
        risks_text = ""
        for i, risk in enumerate(analysis.get("risk_details", [])[:10], 1):
            risks_text += f"{i}. {risk['level']}: {risk['issue']}\n"
            if risk.get('context'):
                risks_text += f"   –ö–æ–Ω—Ç–µ–∫—Å—Ç: {risk['context'][:150]}\n"
        
        if not risks_text:
            risks_text = "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã—è–≤–∏–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤.\n"
        
        # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
        problem_sections = []
        for section in analysis.get("sections_analysis", []):
            if section.get("comparison", {}).get("status") in ["deviation", "missing"]:
                problem_sections.append(section.get("tf_section", ""))
        
        return f"""–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —é—Ä–∏—Å—Ç –∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ {org_name}.
–ú—ã –≤—ã—Å—Ç—É–ø–∞–µ–º –∫–∞–∫ {analysis.get('our_role', '–ó–∞–∫–∞–∑—á–∏–∫/–ü–æ–∫—É–ø–∞—Ç–µ–ª—å')}.

–ó–ê–î–ê–ß–ê: –ü—Ä–æ–≤–µ—Å—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –¥–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–¢–ï–ö–°–¢ –î–û–ì–û–í–û–†–ê (—Ñ—Ä–∞–≥–º–µ–Ω—Ç):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
{contract_text[:8000]}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –ê–ù–ê–õ–ò–ó–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞: {analysis.get('form_name', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')}
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–§: {analysis.get('compliance_score', 0):.0f}%
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏—Å–∫–æ–≤: üî¥ {sum(1 for r in analysis.get('risks', []) if r.get('risk_level') == 'red')} –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö, üü° {sum(1 for r in analysis.get('risks', []) if r.get('risk_level') == 'yellow')} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

–í–´–Ø–í–õ–ï–ù–ù–´–ï –†–ò–°–ö–ò:
{risks_text}

–ü–†–û–ë–õ–ï–ú–ù–´–ï –†–ê–ó–î–ï–õ–´: {', '.join(problem_sections[:5]) if problem_sections else '–ù–µ—Ç'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–¢–†–ï–ë–£–ï–¢–°–Ø –û–¢–í–ï–¢ –í –°–õ–ï–î–£–Æ–©–ï–ú –§–û–†–ú–ê–¢–ï:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 1. –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ {org_name}.

## 2. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–£–ù–ö–¢–´ (—Ç—Ä–µ–±—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —É–∫–∞–∂–∏:
- –ù–æ–º–µ—Ä –ø—É–Ω–∫—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞
- –í —á—ë–º –ø—Ä–æ–±–ª–µ–º–∞
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π

## 3. –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)
–ü—É–Ω–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç —Ä–∏—Å–∫–∏, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã.

## 4. –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï –ê–°–ü–ï–ö–¢–´
–ß—Ç–æ –≤ –¥–æ–≥–æ–≤–æ—Ä–µ —Ö–æ—Ä–æ—à–æ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—à–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º.

## 5. –ò–¢–û–ì–û–í–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø
–í—ã–±–µ—Ä–∏ –û–î–ù–û –∏–∑ —Ç—Ä—ë—Ö:
- ‚úÖ –°–û–ì–õ–ê–°–û–í–ê–¢–¨ (–¥–æ–≥–æ–≤–æ—Ä –ø—Ä–∏–µ–º–ª–µ–º)
- ‚ö†Ô∏è –î–û–†–ê–ë–û–¢–ê–¢–¨ (—Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è, –¥–∞–ª–µ–µ –ø–µ—Ä–µ—á–µ–Ω—å)  
- ‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨ (–Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–µ —É—Å–ª–æ–≤–∏—è)

–ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ. –£–∫–∞–∑—ã–≤–∞–π –Ω–æ–º–µ—Ä–∞ –ø—É–Ω–∫—Ç–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∞."""
    
    @classmethod
    def call_ai(cls, provider: str, prompt: str, api_key: str, folder_id: str = "") -> Tuple[bool, str]:
        """–í—ã–∑–æ–≤ AI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
        if not REQUESTS_AVAILABLE:
            return False, "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ requests –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        
        try:
            if provider == "openai":
                response = requests.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={
                        "model": "gpt-4o-mini",
                        "messages": [
                            {"role": "system", "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —é—Ä–∏—Å—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É."},
                            {"role": "user", "content": prompt}
                        ],
                        "max_tokens": 4000,
                        "temperature": 0.3
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"–û—à–∏–±–∫–∞ OpenAI: {response.status_code} - {response.text[:200]}"
            
            elif provider == "anthropic":
                response = requests.post(
                    "https://api.anthropic.com/v1/messages",
                    headers={
                        "x-api-key": api_key,
                        "Content-Type": "application/json",
                        "anthropic-version": "2023-06-01"
                    },
                    json={
                        "model": "claude-3-haiku-20240307",
                        "max_tokens": 4000,
                        "messages": [{"role": "user", "content": prompt}]
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["content"][0]["text"]
                return False, f"–û—à–∏–±–∫–∞ Anthropic: {response.status_code}"
            
            elif provider == "gigachat":
                response = requests.post(
                    "https://gigachat.devices.sberbank.ru/api/v1/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={"model": "GigaChat", "messages": [{"role": "user", "content": prompt}], "max_tokens": 4000},
                    timeout=120, verify=False
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"–û—à–∏–±–∫–∞ GigaChat: {response.status_code}"
            
            elif provider == "yandexgpt":
                if not folder_id:
                    return False, "–¢—Ä–µ–±—É–µ—Ç—Å—è Folder ID"
                response = requests.post(
                    "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                    headers={"Authorization": f"Api-Key {api_key}", "Content-Type": "application/json"},
                    json={
                        "modelUri": f"gpt://{folder_id}/yandexgpt-lite",
                        "completionOptions": {"stream": False, "maxTokens": 4000, "temperature": 0.3},
                        "messages": [{"role": "user", "text": prompt}]
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["result"]["alternatives"][0]["message"]["text"]
                return False, f"–û—à–∏–±–∫–∞ YandexGPT: {response.status_code}"
            
            elif provider == "mistral":
                response = requests.post(
                    "https://api.mistral.ai/v1/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={"model": "mistral-small-latest", "messages": [{"role": "user", "content": prompt}], "max_tokens": 4000},
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"–û—à–∏–±–∫–∞ Mistral: {response.status_code}"
            
            elif provider == "perplexity":
                response = requests.post(
                    "https://api.perplexity.ai/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={"model": "llama-3.1-sonar-small-128k-online", "messages": [{"role": "user", "content": prompt}], "max_tokens": 4000},
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"–û—à–∏–±–∫–∞ Perplexity: {response.status_code}"
            
            return False, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä"
        
        except requests.exceptions.Timeout:
            return False, "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞: {str(e)}"
    
    @classmethod
    def get_available_provider(cls, api_keys: Dict, enabled: List[str], folder_id: str = "") -> Tuple[Optional[str], str]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å —Ä–∞–±–æ—á–∏–º –∫–ª—é—á–æ–º"""
        for provider in enabled:
            key = api_keys.get(provider, "")
            if key:
                success, msg, _ = cls.check_connection(provider, key, folder_id if provider == "yandexgpt" else "")
                if success:
                    return provider, key
        return None, ""

# ============================================================================
# –ì–ï–ù–ï–†–ê–¢–û–† –û–¢–ß–Å–¢–û–í
# ============================================================================

class ReportGenerator:
    @classmethod
    def generate_detailed_text_report(cls, data: Dict, user: Dict, org: Dict, ai_text: str = "") -> str:
        zone_names = {"green": "–ó–ï–õ–Å–ù–ê–Ø", "yellow": "–ñ–Å–õ–¢–ê–Ø", "red": "–ö–†–ê–°–ù–ê–Ø"}
        zone = data.get("zone", "")
        org_name = org.get("full_name", "–ê–û ¬´–°–ü–ö¬ª")
        
        report = f"""{'‚ïê'*70}
–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –Æ–†–ò–î–ò–ß–ï–°–ö–û–ì–û –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢–ê
{org_name}
{'‚ïê'*70}

üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}
üîñ ID –∞–Ω–∞–ª–∏–∑–∞: {data.get('analysis_id', 'N/A')}
üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {user.get('name', '')}, {user.get('position', '')}

{'‚îÄ'*70}
1. –û–ë–©–ò–ï –°–í–ï–î–ï–ù–ò–Ø –û –î–û–ì–û–í–û–†–ï
{'‚îÄ'*70}

–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:        {data.get('counterparty', '–ù–µ —É–∫–∞–∑–∞–Ω')}
–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞:    {data.get('contract_number', '–ù–µ —É–∫–∞–∑–∞–Ω')}
–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:     {data.get('contract_date', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}
–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞:      {data.get('contract_type', '–ù–µ —É–∫–∞–∑–∞–Ω')}
–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:    {data.get('amount', 0):,.2f} —Ä—É–±.
–§–æ—Ä–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:   {data.get('document_form_label', '')}
–°—Ç–∞—Ç—É—Å –Æ–î:         {data.get('legal_status_label', '')}

{'‚îÄ'*70}
2. –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –ê–ù–ê–õ–ò–ó–ê
{'‚îÄ'*70}

üö¶ –ó–û–ù–ê –†–ò–°–ö–ê:           {zone_names.get(zone, '–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù–ê')}
üìä –†–ò–°–ö-–°–ö–û–†:            {data.get('risk_score', 0):.1f} / 10
üìã –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –¢–§:      {data.get('compliance_score', 0):.1f}%
‚öñÔ∏è –¢–†–ï–ë–£–ï–¢–°–Ø –£–ß–ê–°–¢–ò–ï –Æ–î: {'–î–ê' if data.get('requires_legal') else '–ù–ï–¢'}
‚è±Ô∏è –°–†–û–ö –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø:    {data.get('deadline_days', 0)} —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π

{'‚îÄ'*70}
3. –í–´–Ø–í–õ–ï–ù–ù–´–ï –†–ò–°–ö–ò –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
{'‚îÄ'*70}
"""
        
        risk_details = data.get('risk_details', [])
        red_risks = [r for r in risk_details if '–ö–†–ò–¢–ò–ß–ù–û' in r.get('level', '')]
        yellow_risks = [r for r in risk_details if '–í–ù–ò–ú–ê–ù–ò–ï' in r.get('level', '')]
        
        if red_risks:
            report += "\nüî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò (—Ç—Ä–µ–±—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è):\n\n"
            for i, risk in enumerate(red_risks, 1):
                report += f"   {i}. {risk.get('issue', '')}\n"
                if risk.get('context'):
                    report += f"      –ö–æ–Ω—Ç–µ–∫—Å—Ç: {risk['context'][:200]}\n"
                if risk.get('recommendation'):
                    report += f"      ‚û°Ô∏è {risk['recommendation']}\n"
                report += "\n"
        else:
            report += "\nüî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò: –ù–µ –≤—ã—è–≤–ª–µ–Ω—ã ‚úÖ\n"
        
        if yellow_risks:
            report += "\nüü° –¢–†–ï–ë–£–Æ–¢ –í–ù–ò–ú–ê–ù–ò–Ø:\n\n"
            for i, risk in enumerate(yellow_risks, 1):
                report += f"   {i}. {risk.get('issue', '')}\n"
                if risk.get('recommendation'):
                    report += f"      ‚û°Ô∏è {risk['recommendation']}\n"
        
        if ai_text:
            report += f"""
{'‚îÄ'*70}
4. –≠–ö–°–ü–ï–†–¢–ù–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï (AI-–ê–ù–ê–õ–ò–ó)
{'‚îÄ'*70}

{ai_text}
"""
        
        report += f"""
{'‚îÄ'*70}
5. –ò–¢–û–ì–û–í–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï
{'‚îÄ'*70}

{data.get('conclusion', data.get('summary', '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑.'))}

{'‚ïê'*70}
–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.1 | {org.get('short_name', '')}
–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: {datetime.now().strftime('%d.%m.%Y %H:%M')}
{'‚ïê'*70}
"""
        return report
    
    @classmethod
    def generate_html_report(cls, data: Dict, user: Dict, org: Dict, ai_text: str = "") -> str:
        zone_colors = {"green": "#28a745", "yellow": "#ffc107", "red": "#dc3545"}
        zone_names = {"green": "üü¢ –ó–ï–õ–Å–ù–ê–Ø –ó–û–ù–ê", "yellow": "üü° –ñ–Å–õ–¢–ê–Ø –ó–û–ù–ê", "red": "üî¥ –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê"}
        zone = data.get('zone', '')
        zone_color = zone_colors.get(zone, '#6c757d')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Ä–∏—Å–∫–æ–≤
        risks_html = ""
        for risk in data.get('risk_details', [])[:15]:
            level_color = "#dc3545" if "–ö–†–ò–¢–ò–ß–ù–û" in risk.get('level', '') else "#ffc107"
            risks_html += f'''
            <div style="margin:10px 0;padding:15px;border-left:4px solid {level_color};background:#fff;">
                <strong>{risk.get('level', '')}</strong>: {risk.get('issue', '')}
                <div style="margin-top:8px;font-size:0.9em;color:#666;">{risk.get('context', '')[:200]}</div>
                <div style="margin-top:8px;padding:8px;background:#e8f4f8;border-radius:4px;">
                    <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> {risk.get('recommendation', '')}
                </div>
            </div>
            '''
        
        if not risks_html:
            risks_html = '<div style="padding:20px;background:#d4edda;border-radius:8px;">‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ –Ω–µ –≤—ã—è–≤–ª–µ–Ω—ã</div>'
        
        return f'''<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –Æ–î | {data.get('counterparty', '')}</title>
<style>
body{{font-family:'Segoe UI',Arial,sans-serif;max-width:210mm;margin:0 auto;padding:20px;color:#333;line-height:1.6;}}
.header{{background:linear-gradient(135deg,#1e3a5f,#2d5a87);color:white;padding:25px;border-radius:12px;margin-bottom:25px;}}
.header h1{{margin:0;font-size:1.5em;}}
.zone-badge{{display:inline-block;padding:15px 25px;border-radius:8px;color:white;font-weight:bold;font-size:1.3em;background:{zone_color};margin:15px 0;}}
.section{{margin:25px 0;}}
.section-title{{font-size:1.2em;font-weight:bold;color:#1e3a5f;border-bottom:2px solid #dee2e6;padding-bottom:8px;margin-bottom:15px;}}
.metrics{{display:flex;gap:15px;flex-wrap:wrap;margin:20px 0;}}
.metric{{flex:1;min-width:140px;text-align:center;padding:15px;background:#f8f9fa;border-radius:8px;}}
.metric-value{{font-size:1.8em;font-weight:bold;color:{zone_color};}}
.metric-label{{font-size:0.85em;color:#666;}}
table{{width:100%;border-collapse:collapse;margin:15px 0;}}
th,td{{padding:10px;text-align:left;border-bottom:1px solid #dee2e6;}}
th{{background:#f8f9fa;}}
.ai-box{{background:#f0f7ff;border:1px solid #b8d4e3;border-radius:8px;padding:20px;margin:20px 0;white-space:pre-wrap;font-size:0.95em;}}
.footer{{margin-top:30px;padding-top:15px;border-top:2px solid #dee2e6;text-align:center;font-size:0.85em;color:#666;}}
@media print{{body{{padding:0;}}.header{{page-break-after:avoid;}}}}
</style></head><body>

<div class="header">
    <h1>üìã –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –Æ–†–ò–î–ò–ß–ï–°–ö–û–ì–û –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢–ê</h1>
    <div>{org.get('full_name', '')}</div>
</div>

<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
    <strong>–î–∞—Ç–∞:</strong> {datetime.now().strftime('%d.%m.%Y %H:%M')} | 
    <strong>ID:</strong> {data.get('analysis_id', '')} | 
    <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> {user.get('name', '')}
</div>

<div class="section">
    <div class="section-title">1. –û–ë–©–ò–ï –°–í–ï–î–ï–ù–ò–Ø</div>
    <table>
        <tr><td width="30%"><strong>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</strong></td><td>{data.get('counterparty', '')}</td></tr>
        <tr><td><strong>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</strong></td><td>{data.get('contract_number', '')}</td></tr>
        <tr><td><strong>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</strong></td><td>{data.get('amount', 0):,.2f} —Ä—É–±.</td></tr>
        <tr><td><strong>–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞</strong></td><td>{data.get('contract_type', '')}</td></tr>
    </table>
</div>

<div class="section">
    <div class="section-title">2. –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê</div>
    <div style="text-align:center;">
        <div class="zone-badge">{zone_names.get(zone, '‚ùì –ù–ï –û–ü–†–ï–î–ï–õ–ï–ù–ê')}</div>
    </div>
    <div class="metrics">
        <div class="metric"><div class="metric-value">{data.get('risk_score', 0):.1f}</div><div class="metric-label">–†–∏—Å–∫-—Å–∫–æ—Ä (–∏–∑ 10)</div></div>
        <div class="metric"><div class="metric-value">{data.get('compliance_score', 0):.0f}%</div><div class="metric-label">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–§</div></div>
        <div class="metric"><div class="metric-value">{data.get('deadline_days', 0)}</div><div class="metric-label">–°—Ä–æ–∫ (–¥–Ω–µ–π)</div></div>
    </div>
</div>

<div class="section">
    <div class="section-title">3. –í–´–Ø–í–õ–ï–ù–ù–´–ï –†–ò–°–ö–ò</div>
    {risks_html}
</div>

{'<div class="section"><div class="section-title">4. –≠–ö–°–ü–ï–†–¢–ù–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï (AI)</div><div class="ai-box">' + ai_text + '</div></div>' if ai_text else ''}

<div class="section">
    <div class="section-title">{'5' if ai_text else '4'}. –ò–¢–û–ì–û–í–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï</div>
    <div style="padding:20px;background:#f8f9fa;border-radius:8px;font-size:1.05em;">
        {data.get('conclusion', data.get('summary', ''))}
    </div>
</div>

<div class="footer">
    <strong>–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.1</strong> | {org.get('short_name', '')} | {datetime.now().strftime('%d.%m.%Y %H:%M')}
</div>

</body></html>'''
    
    @classmethod
    def generate_json_1c(cls, data: Dict, user: Dict, org: Dict) -> str:
        return json.dumps({
            "–î–æ–∫—É–º–µ–Ω—Ç": "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ–Æ–î",
            "–í–µ—Ä—Å–∏—è": "7.1",
            "–°–∏—Å—Ç–µ–º–∞": "–†–µ–≥–ª–∞–º–µ–Ω—Ç–°–≤–µ—Ç–æ—Ñ–æ—Ä",
            "–î–∞—Ç–∞–°–æ–∑–¥–∞–Ω–∏—è": datetime.now().isoformat(),
            "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è": {"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": org.get("short_name", ""), "–ò–ù–ù": org.get("inn", "")},
            "–ê–≤—Ç–æ—Ä": {"–§–ò–û": user.get("name", ""), "–î–æ–ª–∂–Ω–æ—Å—Ç—å": user.get("position", ""), "–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ": user.get("department", "")},
            "–î–æ–≥–æ–≤–æ—Ä": {
                "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç": data.get("counterparty", ""),
                "–ù–æ–º–µ—Ä": data.get("contract_number", ""),
                "–î–∞—Ç–∞": data.get("contract_date", ""),
                "–°—É–º–º–∞": data.get("amount", 0),
                "–¢–∏–ø": data.get("contract_type", ""),
                "–§–æ—Ä–º–∞–î–æ–∫—É–º–µ–Ω—Ç–∞": data.get("document_form", "")
            },
            "–†–µ–∑—É–ª—å—Ç–∞—Ç": {
                "–ó–æ–Ω–∞": data.get("zone", ""),
                "–†–∏—Å–∫–°–∫–æ—Ä": round(data.get("risk_score", 0), 2),
                "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–¢–§": round(data.get("compliance_score", 0), 2),
                "–¢—Ä–µ–±—É–µ—Ç—Å—è–Æ–î": data.get("requires_legal", False),
                "–°—Ä–æ–∫–î–Ω–µ–π": data.get("deadline_days", 0)
            },
            "–†–∏—Å–∫–∏": [
                {"–£—Ä–æ–≤–µ–Ω—å": r.get("level", ""), "–û–ø–∏—Å–∞–Ω–∏–µ": r.get("issue", ""), "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è": r.get("recommendation", "")}
                for r in data.get("risk_details", [])
            ],
            "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ": data.get("conclusion", ""),
            "ID": data.get("analysis_id", "")
        }, ensure_ascii=False, indent=2)

# ============================================================================
# –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–û–ù–´ –†–ò–°–ö–ê
# ============================================================================

@dataclass
class AnalysisInput:
    amount: float = 0
    document_form: DocumentForm = DocumentForm.TYPICAL
    document_type: str = ""
    deal_type: str = ""
    legal_status: LegalStatus = LegalStatus.NOT_SUBMITTED
    is_single_supplier: bool = False
    is_tender: bool = False
    tender_amount: float = 0
    contract_years: int = 0
    changes_essential: bool = False
    is_urgent: bool = False
    counterparty: str = ""
    contract_number: str = ""
    contract_date: str = ""

@dataclass
class ZoneResult:
    zone: RiskZone = RiskZone.GREEN
    zone_reason: str = ""
    deadline_days: int = 0
    requires_legal: bool = False
    responsible: str = "–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä"
    warnings: List[str] = field(default_factory=list)
    approval_route: List[str] = field(default_factory=list)

def determine_risk_zone(inp: AnalysisInput, thresholds: Dict = None) -> ZoneResult:
    if thresholds is None:
        thresholds = DEFAULT_THRESHOLDS
    
    result = ZoneResult()
    deadlines = DEFAULT_DEADLINES
    
    # –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê
    if inp.deal_type and inp.deal_type in RED_ZONE_ALWAYS:
        result.zone = RiskZone.RED
        result.zone_reason = f"–¢–∏–ø —Å–¥–µ–ª–∫–∏ ¬´{inp.deal_type}¬ª —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è –Æ–î"
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = deadlines["extended"]
        result.approval_route = ["–Æ–î (–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)", "–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞", "–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ"]
        result.warnings.append("‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –Æ–î –Ω–∞ —ç—Ç–∞–ø–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!")
        return result
    
    if inp.amount > thresholds.get("yellow_max", 5_000_000):
        result.zone = RiskZone.RED
        result.zone_reason = f"–°—É–º–º–∞ {inp.amount:,.0f}‚ÇΩ –ø—Ä–µ–≤—ã—à–∞–µ—Ç {thresholds.get('yellow_max', 5_000_000):,.0f}‚ÇΩ"
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = deadlines["extended"]
        result.approval_route = ["–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä", "–Æ–î (–ø–æ–ª–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞)", "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ", "–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ"]
        return result
    
    if inp.is_tender and inp.tender_amount > thresholds.get("tender_red", 3_000_000):
        result.zone = RiskZone.RED
        result.zone_reason = f"–¢–µ–Ω–¥–µ—Ä –Ω–∞ —Å—É–º–º—É {inp.tender_amount:,.0f}‚ÇΩ"
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = deadlines["extended"]
        return result
    
    # –ñ–Å–õ–¢–ê–Ø –ó–û–ù–ê
    yellow_reasons = []
    
    if inp.deal_type and inp.deal_type in YELLOW_ZONE_TYPES:
        yellow_reasons.append(f"–¢–∏–ø: {inp.deal_type}")
    
    if inp.is_single_supplier and inp.amount > thresholds.get("single_supplier_yellow", 100_000):
        yellow_reasons.append("–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫")
    
    if inp.contract_years > 3:
        yellow_reasons.append(f"–°—Ä–æ–∫ {inp.contract_years} –ª–µ—Ç")
    
    if inp.document_form == DocumentForm.TYPICAL:
        if inp.amount > thresholds.get("green_tf_max", 100_000):
            yellow_reasons.append(f"–°—É–º–º–∞ –¢–§ > {thresholds.get('green_tf_max', 100_000):,.0f}‚ÇΩ")
    elif inp.document_form in [DocumentForm.COUNTERPARTY, DocumentForm.FREE, DocumentForm.SELF_DEVELOPED]:
        if inp.amount > thresholds.get("green_non_tf_max", 50_000):
            yellow_reasons.append(f"–ù–µ—Ç–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ > {thresholds.get('green_non_tf_max', 50_000):,.0f}‚ÇΩ")
    elif inp.document_form == DocumentForm.MODIFIED_TF:
        if inp.changes_essential:
            yellow_reasons.append("–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¢–§")
    
    if yellow_reasons:
        result.zone = RiskZone.YELLOW
        result.zone_reason = "; ".join(yellow_reasons)
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = deadlines["standard"]
        result.approval_route = ["–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä", "–°–≠–î", "–Æ–î (—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞)", "–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ"]
        result.warnings.append("‚ö†Ô∏è –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ –≤–∏–∑—ã –Æ–î!")
        return result
    
    # –ó–ï–õ–Å–ù–ê–Ø –ó–û–ù–ê
    result.zone = RiskZone.GREEN
    result.zone_reason = "–ó–µ–ª—ë–Ω—ã–π –∫–æ—Ä–∏–¥–æ—Ä (–ø. 4.1 –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞)"
    result.requires_legal = False
    result.responsible = "–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä"
    result.deadline_days = 0
    result.approval_route = ["–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä", "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", "–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ"]
    return result

def add_to_history(data: Dict):
    if "history" not in st.session_state:
        st.session_state.history = []
    data["id"] = hashlib.md5(f"{datetime.now().isoformat()}{data.get('counterparty', '')}".encode()).hexdigest()[:8]
    data["timestamp"] = datetime.now().isoformat()
    st.session_state.history.insert(0, data)
    if len(st.session_state.history) > 100:
        st.session_state.history = st.session_state.history[:100]

# ============================================================================
# –°–¢–ò–õ–ò CSS
# ============================================================================

def apply_styles():
    st.markdown("""<style>
:root { --primary:#1e3a5f; --secondary:#2d5a87; --accent:#4a90d9; --red:#dc3545; --yellow:#f0ad4e; --green:#28a745; }
.main-header { background:linear-gradient(135deg,var(--primary),var(--secondary)); padding:1.8rem; border-radius:12px; margin-bottom:1.5rem; color:white; }
.main-header h2 { margin:0; font-size:1.5rem; }
.traffic-light { display:flex; gap:8px; margin-bottom:0.8rem; }
.traffic-light span { width:16px; height:16px; border-radius:50%; box-shadow:0 0 8px currentColor; }
.tl-red { background:var(--red); color:var(--red); }
.tl-yellow { background:var(--yellow); color:var(--yellow); }
.tl-green { background:var(--green); color:var(--green); }
.version-badge { background:rgba(255,255,255,0.2); padding:3px 10px; border-radius:6px; font-size:0.7rem; margin-left:10px; }
.zone-card { border-radius:10px; padding:1.2rem; margin-bottom:1.2rem; border-left:5px solid; }
.zone-card.green { background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border-left-color:var(--green); }
.zone-card.yellow { background:linear-gradient(135deg,#fff8e1,#ffecb3); border-left-color:var(--yellow); }
.zone-card.red { background:linear-gradient(135deg,#ffebee,#ffcdd2); border-left-color:var(--red); }
.zone-title { font-size:1.2rem; font-weight:600; margin-bottom:0.4rem; }
.risk-item { background:white; border-radius:8px; padding:1rem; margin-bottom:0.5rem; border-left:4px solid; }
.risk-item.red { border-left-color:var(--red); background:linear-gradient(90deg,#fff5f5,white); }
.risk-item.yellow { border-left-color:var(--yellow); background:linear-gradient(90deg,#fffcf0,white); }
.metric-card { background:#f8f9fa; border-radius:8px; padding:1rem; text-align:center; border:1px solid #e9ecef; }
.metric-value { font-size:1.6rem; font-weight:700; color:var(--primary); }
.metric-label { font-size:0.8rem; color:#6c757d; }
.admin-badge { background:#7b1fa2; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem; }
.user-badge { background:#1976d2; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem; }
.demo-badge { background:#ff9800; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem; }
.connection-ok { color:#28a745; font-weight:bold; }
.connection-fail { color:#dc3545; font-weight:bold; }
footer { visibility:hidden; }
</style>""", unsafe_allow_html=True)

# ============================================================================
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
# ============================================================================

def init_session():
    defaults = {
        "authenticated": False,
        "user": None,
        "user_role": None,
        "demo_mode": False,
        "contract_text": "",
        "zone_result": None,
        "analysis_result": None,
        "ai_analysis": "",
        "history": [],
        "current_input": None,
        "custom_typical_forms": {},
        "org_config": DEFAULT_ORG_CONFIG.copy(),
        "thresholds": DEFAULT_THRESHOLDS.copy(),
        "deadlines": DEFAULT_DEADLINES.copy(),
        "api_keys": {p: "" for p in AI_PROVIDERS},
        "yandex_folder_id": "",
        "enabled_providers": list(AI_PROVIDERS.keys()),
        "admin_settings": {
            "allow_demo": True,
            "require_counterparty": True,
            "require_contract_text": True,
            "min_contract_length": 100,
        },
        "ai_connection_status": {},
    }
    
    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

# ============================================================================
# –î–ï–ú–û-–î–ê–ù–ù–´–ï (–¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)
# ============================================================================

DEMO_DATA = {
    "counterparty": "–û–û–û ¬´–¢—Ä–∞–Ω—Å–õ–æ–≥–∏—Å—Ç–∏–∫¬ª",
    "contract_number": "2025/–¢–≠–û-001",
    "contract_date": date.today(),
    "amount": 8_500_000,
    "contract_type": "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ (–¢–≠–û)",
    "document_form": DocumentForm.COUNTERPARTY,
    "legal_status": LegalStatus.NOT_SUBMITTED,
    "deal_type": "",
}

# ============================================================================
# UI: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
# ============================================================================

def render_auth_page():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    
    st.markdown(f'''<div style="text-align:center;padding:2.5rem 1rem;">
<div class="traffic-light" style="justify-content:center;margin-bottom:1rem;"><span class="tl-red"></span><span class="tl-yellow"></span><span class="tl-green"></span></div>
<h1 style="font-size:2rem;margin-bottom:0.5rem;color:#1e3a5f;">üö¶ –†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä</h1>
<p style="color:#666;margin-bottom:1.5rem;">–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ v7.1<br><strong>{org.get("short_name", "–ê–û ¬´–°–ü–ö¬ª")}</strong></p>
</div>''', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        tab1, tab2 = st.tabs(["üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "üîê –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"])
        
        with tab1:
            with st.form("user_auth"):
                name = st.text_input("–§–ò–û *", placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á")
                position = st.selectbox("–î–æ–ª–∂–Ω–æ—Å—Ç—å *", options=[""] + POSITIONS)
                department = st.selectbox("–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ *", options=[""] + DEPARTMENTS)
                
                col_a, col_b = st.columns(2)
                with col_a:
                    login_btn = st.form_submit_button("üöÄ –í–æ–π—Ç–∏", use_container_width=True, type="primary")
                with col_b:
                    demo_btn = st.form_submit_button("üìã –î–µ–º–æ-—Ä–µ–∂–∏–º", use_container_width=True)
                
                if login_btn:
                    if name and len(name.strip()) >= 3 and position and department:
                        st.session_state.authenticated = True
                        st.session_state.user = {"name": name.strip(), "position": position, "department": department}
                        st.session_state.user_role = UserRole.USER
                        st.session_state.demo_mode = False
                        st.rerun()
                    else:
                        st.error("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è")
                
                if demo_btn:
                    st.session_state.authenticated = True
                    st.session_state.user = {"name": "–î–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "position": "–í–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "department": "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"}
                    st.session_state.user_role = UserRole.USER
                    st.session_state.demo_mode = True
                    st.session_state.contract_text = DEMO_CONTRACT  # –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞
                    st.rerun()
        
        with tab2:
            with st.form("admin_auth"):
                admin_login = st.text_input("–õ–æ–≥–∏–Ω", placeholder="admin")
                admin_password = st.text_input("–ü–∞—Ä–æ–ª—å", type="password")
                admin_btn = st.form_submit_button("üîê –í–æ–π—Ç–∏", use_container_width=True, type="primary")
                
                if admin_btn:
                    if admin_login in DEFAULT_USERS:
                        user_data = DEFAULT_USERS[admin_login]
                        if user_data["password_hash"] == hashlib.sha256(admin_password.encode()).hexdigest():
                            if user_data["role"] == UserRole.ADMIN:
                                st.session_state.authenticated = True
                                st.session_state.user = {"name": user_data["name"], "position": user_data["position"], "department": user_data["department"]}
                                st.session_state.user_role = UserRole.ADMIN
                                st.session_state.demo_mode = False
                                st.rerun()
                            else:
                                st.error("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤")
                        else:
                            st.error("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
                    else:
                        st.error("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            
            st.caption("üí° admin / admin123")

# ============================================================================
# UI: –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨
# ============================================================================

def render_sidebar():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    
    with st.sidebar:
        st.markdown("### üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
        
        user = st.session_state.user
        role = st.session_state.user_role
        
        role_class = "admin-badge" if role == UserRole.ADMIN else ("demo-badge" if st.session_state.demo_mode else "user-badge")
        role_name = "–ê–î–ú–ò–ù" if role == UserRole.ADMIN else ("–î–ï–ú–û" if st.session_state.demo_mode else "–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨")
        
        st.markdown(f"""
        <div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-bottom:10px;">
            <strong>{user['name']}</strong><br>
            <small>{user['position']}</small><br>
            <span class="{role_class}">{role_name}</span>
        </div>
        """, unsafe_allow_html=True)
        
        if st.button("üö™ –í—ã–π—Ç–∏", use_container_width=True):
            for key in list(st.session_state.keys()):
                del st.session_state[key]
            st.rerun()
        
        st.markdown("---")
        
        # –ü–æ—Ä–æ–≥–∏
        thresholds = st.session_state.get("thresholds", DEFAULT_THRESHOLDS)
        st.markdown(f"""
        **–ü–æ—Ä–æ–≥–∏ –∑–æ–Ω:**
        - üü¢ –¢–§ ‚â§ {thresholds.get('green_tf_max', 100000):,.0f}‚ÇΩ
        - üü¢ –ò–Ω—ã–µ ‚â§ {thresholds.get('green_non_tf_max', 50000):,.0f}‚ÇΩ
        - üü° –¥–æ {thresholds.get('yellow_max', 5000000):,.0f}‚ÇΩ
        - üî¥ > {thresholds.get('yellow_max', 5000000):,.0f}‚ÇΩ
        """)
        
        # –ò—Å—Ç–æ—Ä–∏—è
        if st.session_state.history:
            st.markdown("---")
            st.markdown("**üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ:**")
            for item in st.session_state.history[:3]:
                emoji = {"green": "üü¢", "yellow": "üü°", "red": "üî¥"}.get(item.get("zone", ""), "‚ö™")
                st.caption(f"{emoji} {item.get('counterparty', '')[:20]}")

# ============================================================================
# UI: –í–ö–õ–ê–î–ö–ê –ê–ù–ê–õ–ò–ó–ê
# ============================================================================

def render_analysis_tab():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    is_demo = st.session_state.demo_mode
    
    st.markdown("### üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–≥–æ–≤–æ—Ä–∞")
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    demo = DEMO_DATA if is_demo else {}
    
    col1, col2 = st.columns(2)
    
    with col1:
        counterparty = st.text_input(
            "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç *", 
            value=demo.get("counterparty", ""),
            placeholder="–û–û–û ¬´–ù–∞–∑–≤–∞–Ω–∏–µ¬ª"
        )
        contract_number = st.text_input(
            "–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞", 
            value=demo.get("contract_number", ""),
            placeholder="2025/001"
        )
        contract_date = st.date_input(
            "–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞", 
            value=demo.get("contract_date", date.today())
        )
        
        doc_type_idx = CONTRACT_TYPES.index(demo.get("contract_type", "–î—Ä—É–≥–æ–π")) if is_demo and demo.get("contract_type") in CONTRACT_TYPES else 0
        doc_type = st.selectbox("–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞", options=CONTRACT_TYPES, index=doc_type_idx)
    
    with col2:
        amount_default = f"{demo.get('amount', 0):,.0f}".replace(",", " ") if is_demo and demo.get("amount") else ""
        amount_str = st.text_input("–°—É–º–º–∞ (‚ÇΩ)", value=amount_default, placeholder="1 500 000")
        
        # –ü–∞—Ä—Å–∏–Ω–≥ —Å—É–º–º—ã
        amount = 0
        if amount_str:
            try:
                amount = float(re.sub(r'[^\d.]', '', amount_str.replace(',', '.').replace(' ', '')))
            except:
                st.error("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞")
        
        # –§–æ—Ä–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        doc_form_list = list(DocumentForm)
        doc_form_default_idx = doc_form_list.index(demo.get("document_form", DocumentForm.TYPICAL)) if is_demo else 0
        doc_form = st.selectbox(
            "–§–æ—Ä–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ *",
            options=doc_form_list,
            format_func=lambda x: get_doc_form_label(x),
            index=doc_form_default_idx
        )
        
        # –°—Ç–∞—Ç—É—Å –Æ–î
        legal_status_list = list(LegalStatus)
        legal_status_default_idx = legal_status_list.index(demo.get("legal_status", LegalStatus.NOT_SUBMITTED)) if is_demo else 0
        legal_status = st.selectbox(
            "–°—Ç–∞—Ç—É—Å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –Æ–î",
            options=legal_status_list,
            format_func=lambda x: get_legal_status_label(x),
            index=legal_status_default_idx
        )
        
        deal_options = ["‚Äî –ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ ‚Äî"] + RED_ZONE_ALWAYS + YELLOW_ZONE_TYPES
        deal_type = st.selectbox("–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø —Å–¥–µ–ª–∫–∏", options=deal_options)
        if deal_type == "‚Äî –ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ ‚Äî":
            deal_type = ""
    
    with st.expander("üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ"):
        col_a, col_b = st.columns(2)
        with col_a:
            is_single_supplier = st.checkbox("–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫")
            is_tender = st.checkbox("–¢–µ–Ω–¥–µ—Ä/–∫–æ–Ω–∫—É—Ä—Å")
        with col_b:
            contract_years = st.number_input("–°—Ä–æ–∫ (–ª–µ—Ç)", min_value=0, max_value=50, value=0)
            changes_essential = st.checkbox("–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¢–§")
        
        tender_amount = 0
        if is_tender:
            tender_str = st.text_input("–°—É–º–º–∞ —Ç–µ–Ω–¥–µ—Ä–∞ (‚ÇΩ)")
            if tender_str:
                try:
                    tender_amount = float(re.sub(r'[^\d.]', '', tender_str))
                except:
                    pass
    
    st.markdown("---")
    
    # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    col_btn1, col_btn2, col_btn3 = st.columns(3)
    
    with col_btn1:
        zone_btn = st.button("üö¶ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–æ–Ω—É", type="primary", use_container_width=True)
    with col_btn2:
        if not is_demo:
            demo_load = st.button("üìù –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ", use_container_width=True)
            if demo_load:
                st.session_state.contract_text = DEMO_CONTRACT
                st.rerun()
    with col_btn3:
        clear_btn = st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å", use_container_width=True)
        if clear_btn:
            st.session_state.zone_result = None
            st.session_state.analysis_result = None
            st.session_state.ai_analysis = ""
            st.session_state.contract_text = ""
            st.rerun()
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω—ã
    if zone_btn:
        inp = AnalysisInput(
            amount=amount, document_form=doc_form, document_type=doc_type, deal_type=deal_type,
            legal_status=legal_status, is_single_supplier=is_single_supplier, is_tender=is_tender,
            tender_amount=tender_amount, contract_years=contract_years, changes_essential=changes_essential,
            counterparty=counterparty, contract_number=contract_number, contract_date=str(contract_date)
        )
        st.session_state.zone_result = determine_risk_zone(inp, st.session_state.get("thresholds"))
        st.session_state.current_input = inp
        st.rerun()
    
    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–æ–Ω—ã
    if st.session_state.zone_result:
        zr = st.session_state.zone_result
        zone_config = {
            RiskZone.GREEN: ("green", "üü¢ –ó–ï–õ–Å–ù–ê–Ø –ó–û–ù–ê", "–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"),
            RiskZone.YELLOW: ("yellow", "üü° –ñ–Å–õ–¢–ê–Ø –ó–û–ù–ê", "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –Æ–î"),
            RiskZone.RED: ("red", "üî¥ –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê", "–ü–æ–ª–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –Æ–î"),
        }
        zone_class, zone_title, zone_subtitle = zone_config.get(zr.zone, ("green", "‚ö™ –ù/–î", ""))
        
        st.markdown(f'''
        <div class="zone-card {zone_class}">
            <div class="zone-title">{zone_title}</div>
            <div style="font-size:0.95rem;color:#555;">{zone_subtitle}</div>
            <div style="margin-top:0.5rem;font-size:0.9rem;">{zr.zone_reason}</div>
        </div>
        ''', unsafe_allow_html=True)
        
        col_m1, col_m2, col_m3 = st.columns(3)
        with col_m1:
            st.metric("üí∞ –°—É–º–º–∞", f"{amount:,.0f} ‚ÇΩ".replace(",", " "))
        with col_m2:
            st.metric("‚è±Ô∏è –°—Ä–æ–∫", f"{zr.deadline_days} –¥–Ω." if zr.deadline_days else "‚Äî")
        with col_m3:
            st.metric("‚öñÔ∏è –Æ–î", "–î–∞" if zr.requires_legal else "–ù–µ—Ç")
        
        if zr.approval_route:
            st.info("üìç " + " ‚Üí ".join(zr.approval_route))
        
        for w in zr.warnings:
            st.warning(w)
        
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Æ–î - –ò–°–ü–†–ê–í–õ–ï–ù–û
        st.markdown(f"**–°—Ç–∞—Ç—É—Å:** {get_legal_status_label(legal_status)}")
    
    st.markdown("---")
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞
    st.markdown("### üìÑ –¢–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞")
    
    uploaded = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª", type=["txt", "docx", "pdf"])
    if uploaded:
        success, result = DocumentLoader.load_file(uploaded)
        if success:
            st.session_state.contract_text = result[:500000]
            st.success(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(st.session_state.contract_text):,} —Å–∏–º–≤–æ–ª–æ–≤")
        else:
            st.error(result)
    
    # –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ
    default_text = st.session_state.contract_text or (DEMO_CONTRACT if is_demo else "")
    
    contract_text = st.text_area(
        "–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç:",
        value=default_text,
        height=200,
        placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ (–º–∏–Ω. 100 —Å–∏–º–≤–æ–ª–æ–≤)..."
    )
    
    if contract_text != st.session_state.contract_text:
        st.session_state.contract_text = contract_text
    
    # –í—ã–±–æ—Ä —Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º—ã
    all_tf = {**BUILTIN_TYPICAL_FORMS, **st.session_state.custom_typical_forms}
    
    # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
    auto_detected = None
    auto_confidence = 0
    if st.session_state.contract_text and len(st.session_state.contract_text) > 100:
        auto_detected, auto_confidence, auto_reason = ImprovedComparator.identify_typical_form(st.session_state.contract_text)
        if auto_confidence >= 0.4 and auto_detected:
            st.info(f"üîç –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: **{all_tf[auto_detected]['name']}** (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {auto_confidence*100:.0f}%)")
    
    tf_options = [("‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø–æ–≤—É—é —Ñ–æ—Ä–º—É ‚Äî", None)]
    tf_options += [(f"{v['name']} ({v['code']})", k) for k, v in all_tf.items()]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é —Ñ–æ—Ä–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    default_idx = 0
    if auto_detected and auto_confidence >= 0.4:
        for i, (_, k) in enumerate(tf_options):
            if k == auto_detected:
                default_idx = i
                break
    
    selected_tf = st.selectbox(
        "–°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º–æ–π:",
        options=tf_options,
        format_func=lambda x: x[0],
        index=default_idx
    )[1]
    
    # –ö–Ω–æ–ø–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
    st.markdown("---")
    col_an1, col_an2 = st.columns(2)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è API-–∫–ª—é—á–∞
    api_keys = st.session_state.get("api_keys", {})
    enabled = st.session_state.get("enabled_providers", [])
    has_api = any(api_keys.get(p) for p in enabled)
    
    with col_an1:
        compare_btn = st.button("üîç –°—Ä–∞–≤–Ω–∏—Ç—å —Å –¢–§", type="primary", use_container_width=True)
    
    with col_an2:
        ai_btn = st.button(
            "ü§ñ AI-–∞–Ω–∞–ª–∏–∑" + ("" if has_api else " (–Ω–µ—Ç –∫–ª—é—á–∞)"),
            use_container_width=True,
            disabled=not has_api
        )
        if not has_api:
            st.caption("üí° –î–æ–±–∞–≤—å—Ç–µ API-–∫–ª—é—á –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª")
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑
    if compare_btn:
        errors = []
        if not counterparty or len(counterparty) < 2:
            errors.append("–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞")
        if not st.session_state.contract_text or len(st.session_state.contract_text) < 100:
            errors.append("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ (–º–∏–Ω. 100 —Å–∏–º–≤–æ–ª–æ–≤)")
        if not selected_tf:
            errors.append("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø–æ–≤—É—é —Ñ–æ—Ä–º—É")
        
        if errors:
            for e in errors:
                st.error(f"‚ùå {e}")
        else:
            with st.spinner("üîÑ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º..."):
                result = ImprovedComparator.full_analysis(st.session_state.contract_text, selected_tf)
                st.session_state.analysis_result = result
            st.rerun()
    
    # AI-–∞–Ω–∞–ª–∏–∑
    if ai_btn:
        if not st.session_state.analysis_result:
            st.warning("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¢–§")
        elif len(st.session_state.contract_text) < 100:
            st.error("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞")
        else:
            # –ù–∞—Ö–æ–¥–∏–º —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
            provider, api_key = AIAnalyzer.get_available_provider(
                api_keys, enabled, st.session_state.get("yandex_folder_id", "")
            )
            
            if not provider:
                st.error("‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö AI-—Å–µ—Ä–≤–∏—Å–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")
            else:
                with st.spinner(f"ü§ñ {AI_PROVIDERS[provider]['name']} –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç..."):
                    prompt = AIAnalyzer.generate_detailed_prompt(
                        st.session_state.contract_text,
                        st.session_state.analysis_result,
                        org.get("short_name", "–ê–û ¬´–°–ü–ö¬ª")
                    )
                    folder_id = st.session_state.get("yandex_folder_id", "") if provider == "yandexgpt" else ""
                    success, result = AIAnalyzer.call_ai(provider, prompt, api_key, folder_id)
                    
                    if success:
                        st.session_state.ai_analysis = result
                        st.rerun()
                    else:
                        st.error(f"‚ùå {result}")
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    if st.session_state.analysis_result:
        render_analysis_results(st.session_state.analysis_result)
    
    if st.session_state.ai_analysis:
        st.markdown("---")
        st.markdown("### ü§ñ –≠–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ AI")
        st.markdown(f'<div style="background:#e8f4f8;border:1px solid #b8d4e3;border-radius:8px;padding:15px;white-space:pre-wrap;">{st.session_state.ai_analysis}</div>', unsafe_allow_html=True)


def render_analysis_results(result: Dict):
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞"""
    st.markdown("---")
    st.markdown(f"### üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {result.get('form_name', '')}")
    
    compliance = result.get('compliance_score', 0)
    is_match = result.get('is_typical_form_match', False)
    
    # –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    if is_match:
        color = "#28a745"
        badge = "‚úÖ –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –¢–§"
    elif compliance >= 60:
        color = "#ffc107"
        badge = "‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï"
    else:
        color = "#dc3545"
        badge = "‚ùå –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ï –û–¢–ö–õ–û–ù–ï–ù–ò–Ø"
    
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:{color};">{compliance:.0f}%</div><div class="metric-label">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–§</div></div>', unsafe_allow_html=True)
    with col2:
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#28a745;">{len(result.get("found_sections", []))}</div><div class="metric-label">–ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤</div></div>', unsafe_allow_html=True)
    with col3:
        red_count = sum(1 for r in result.get("risks", []) if r.get("risk_level") == "red")
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#dc3545;">{red_count}</div><div class="metric-label">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤</div></div>', unsafe_allow_html=True)
    with col4:
        yellow_count = sum(1 for r in result.get("risks", []) if r.get("risk_level") == "yellow")
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#ffc107;">{yellow_count}</div><div class="metric-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</div></div>', unsafe_allow_html=True)
    
    st.markdown(f"**{badge}**")
    st.markdown(result.get('summary', ''))
    
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
    risk_details = result.get('risk_details', [])
    red_risks = [r for r in risk_details if '–ö–†–ò–¢–ò–ß–ù–û' in r.get('level', '')]
    yellow_risks = [r for r in risk_details if '–í–ù–ò–ú–ê–ù–ò–ï' in r.get('level', '')]
    
    if red_risks:
        with st.expander(f"üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò ({len(red_risks)})", expanded=True):
            for r in red_risks:
                st.markdown(f'''
                <div class="risk-item red">
                    <strong>‚ö†Ô∏è {r.get("issue", "")}</strong>
                    <div style="margin-top:8px;font-size:0.9rem;color:#666;">{r.get("context", "")[:250]}</div>
                    <div style="margin-top:8px;padding:8px;background:#fff;border-radius:4px;">
                        <strong>‚û°Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> {r.get("recommendation", "")}
                    </div>
                </div>
                ''', unsafe_allow_html=True)
    
    if yellow_risks:
        with st.expander(f"üü° –¢–†–ï–ë–£–Æ–¢ –í–ù–ò–ú–ê–ù–ò–Ø ({len(yellow_risks)})"):
            for r in yellow_risks:
                st.markdown(f'''
                <div class="risk-item yellow">
                    <strong>‚ö° {r.get("issue", "")}</strong>
                    <div style="margin-top:5px;font-size:0.85rem;">‚û°Ô∏è {r.get("recommendation", "")}</div>
                </div>
                ''', unsafe_allow_html=True)
    
    # –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–¥–µ–ª–æ–≤
    with st.expander("üìë –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º"):
        for section in result.get('sections_analysis', []):
            comp = section.get('comparison', {})
            status = comp.get('status', 'missing')
            score = comp.get('score', 0) * 100
            
            status_cfg = {
                "match": ("‚úÖ", "#28a745"),
                "partial": ("‚ö†Ô∏è", "#ffc107"),
                "deviation": ("‚ùå", "#dc3545"),
                "missing": ("üö´", "#6c757d"),
            }
            icon, color = status_cfg.get(status, ("‚ùì", "#6c757d"))
            
            req_badge = " (–û–ë–Ø–ó–ê–¢.)" if section.get('required') else ""
            
            st.markdown(f'''
            <div style="margin:8px 0;padding:10px;border-left:4px solid {color};background:#f8f9fa;border-radius:0 6px 6px 0;">
                {icon} <strong>{section.get("tf_section", "")}</strong>{req_badge}
                <span style="float:right;background:{color};color:white;padding:2px 8px;border-radius:4px;font-size:0.8rem;">{score:.0f}%</span>
            </div>
            ''', unsafe_allow_html=True)

# ============================================================================
# UI: –í–ö–õ–ê–î–ö–ê –û–¢–ß–Å–¢–û–í
# ============================================================================

def render_reports_tab():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    
    st.markdown("### üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤")
    
    if not st.session_state.analysis_result and not st.session_state.zone_result:
        st.info("‚ÑπÔ∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞")
        return
    
    inp = st.session_state.get('current_input') or AnalysisInput()
    analysis = st.session_state.get('analysis_result') or {}
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á—ë—Ç–∞
    data = {
        "analysis_id": hashlib.md5(datetime.now().isoformat().encode()).hexdigest()[:8],
        "counterparty": inp.counterparty or "–ù–µ —É–∫–∞–∑–∞–Ω",
        "contract_number": inp.contract_number or "–ù–µ —É–∫–∞–∑–∞–Ω",
        "contract_date": str(inp.contract_date) if inp.contract_date else "",
        "contract_type": inp.document_type or "",
        "document_form": inp.document_form.value if inp.document_form else "",
        "document_form_label": get_doc_form_label(inp.document_form) if inp.document_form else "",
        "amount": inp.amount or 0,
        "legal_status_label": get_legal_status_label(inp.legal_status) if inp.legal_status else "",
        "compliance_score": analysis.get("compliance_score", 0),
        "risk_details": analysis.get("risk_details", []),
        "risks": analysis.get("risks", []),
        "summary": analysis.get("summary", ""),
    }
    
    if st.session_state.zone_result:
        zr = st.session_state.zone_result
        data.update({
            "zone": zr.zone.value if zr.zone else "",
            "zone_reason": zr.zone_reason or "",
            "requires_legal": zr.requires_legal,
            "deadline_days": zr.deadline_days or 0,
        })
    
    # –†–∏—Å–∫-—Å–∫–æ—Ä
    red_count = sum(1 for r in data.get('risks', []) if r.get('risk_level') == 'red')
    yellow_count = sum(1 for r in data.get('risks', []) if r.get('risk_level') == 'yellow')
    data["risk_score"] = min(10, red_count * 2 + yellow_count * 0.5)
    
    # –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
    zone = data.get("zone", "")
    if zone == "red" or data["risk_score"] >= 6:
        data["conclusion"] = "‚ùå –î–æ–≥–æ–≤–æ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –¥–æ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è."
    elif zone == "yellow" or data["risk_score"] >= 3:
        data["conclusion"] = "‚ö†Ô∏è –î–æ–≥–æ–≤–æ—Ä —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å –Æ–î –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ä–∏—Å–∫–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏–π."
    else:
        data["conclusion"] = f"‚úÖ –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–§: {data.get('compliance_score', 0):.0f}%."
    
    # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    zone_emoji = {"green": "üü¢", "yellow": "üü°", "red": "üî¥"}.get(zone, "‚ö™")
    
    col1, col2 = st.columns(2)
    with col1:
        st.markdown(f"**–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:** {data['counterparty']}")
        st.markdown(f"**–°—É–º–º–∞:** {data['amount']:,.0f} ‚ÇΩ")
    with col2:
        st.markdown(f"**–ó–æ–Ω–∞:** {zone_emoji} {zone.upper() if zone else '–ù/–î'}")
        st.markdown(f"**–†–∏—Å–∫-—Å–∫–æ—Ä:** {data['risk_score']:.1f} / 10")
    
    st.markdown("---")
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
    col1, col2, col3 = st.columns(3)
    
    with col1:
        html = ReportGenerator.generate_html_report(data, st.session_state.user, org, st.session_state.ai_analysis)
        st.download_button("üì• HTML", html.encode('utf-8'), f"report_{data['analysis_id']}.html", "text/html", use_container_width=True)
    
    with col2:
        txt = ReportGenerator.generate_detailed_text_report(data, st.session_state.user, org, st.session_state.ai_analysis)
        st.download_button("üì• TXT", txt.encode('utf-8'), f"report_{data['analysis_id']}.txt", "text/plain", use_container_width=True)
    
    with col3:
        json_1c = ReportGenerator.generate_json_1c(data, st.session_state.user, org)
        st.download_button("üì• JSON (1–°)", json_1c.encode('utf-8'), f"1c_{data['analysis_id']}.json", "application/json", use_container_width=True)
    
    if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é", use_container_width=True):
        add_to_history(data)
        st.success("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")
    
    with st.expander("üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞"):
        st.text(txt)

# ============================================================================
# UI: –í–ö–õ–ê–î–ö–ê –ù–ê–°–¢–†–û–ï–ö –° –ü–†–û–í–ï–†–ö–û–ô –°–û–ï–î–ò–ù–ï–ù–ò–Ø
# ============================================================================

def render_settings_tab():
    st.markdown("### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    
    st.markdown("#### üîë API-–∫–ª—é—á–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")
    st.info("‚ÑπÔ∏è –î–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è API-–∫–ª—é—á –æ–¥–Ω–æ–≥–æ –∏–∑ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤")
    
    api_keys = st.session_state.get("api_keys", {})
    enabled = st.session_state.get("enabled_providers", [])
    
    for provider_id in enabled:
        provider_info = AI_PROVIDERS.get(provider_id, {})
        
        col1, col2, col3 = st.columns([3, 1, 2])
        
        with col1:
            current_key = api_keys.get(provider_id, "")
            new_key = st.text_input(
                f"**{provider_info.get('name', provider_id)}**",
                type="password",
                value=current_key,
                placeholder="–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á...",
                key=f"key_{provider_id}"
            )
            if new_key != current_key:
                st.session_state.api_keys[provider_id] = new_key
        
        with col2:
            if st.session_state.api_keys.get(provider_id):
                if st.button("üîç –¢–µ—Å—Ç", key=f"test_{provider_id}"):
                    with st.spinner("..."):
                        folder_id = st.session_state.get("yandex_folder_id", "") if provider_id == "yandexgpt" else ""
                        success, msg, latency = AIAnalyzer.check_connection(provider_id, st.session_state.api_keys[provider_id], folder_id)
                    st.session_state.ai_connection_status[provider_id] = {"success": success, "msg": msg, "latency": latency}
        
        with col3:
            status = st.session_state.get("ai_connection_status", {}).get(provider_id, {})
            if status:
                if status.get("success"):
                    st.markdown(f'<span class="connection-ok">{status.get("msg", "‚úÖ OK")}</span>', unsafe_allow_html=True)
                else:
                    st.markdown(f'<span class="connection-fail">{status.get("msg", "‚ùå –û—à–∏–±–∫–∞")}</span>', unsafe_allow_html=True)
            elif st.session_state.api_keys.get(provider_id):
                st.caption("‚è≥ –ù–∞–∂–º–∏—Ç–µ ¬´–¢–µ—Å—Ç¬ª")
            else:
                st.caption("‚Äî")
    
    # YandexGPT Folder ID
    if "yandexgpt" in enabled:
        st.markdown("---")
        new_folder = st.text_input("YandexGPT Folder ID", value=st.session_state.get("yandex_folder_id", ""))
        if new_folder != st.session_state.get("yandex_folder_id", ""):
            st.session_state.yandex_folder_id = new_folder
    
    st.markdown("---")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    if st.button("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", use_container_width=True):
        with st.spinner("–ü—Ä–æ–≤–µ—Ä–∫–∞..."):
            for pid in enabled:
                key = st.session_state.api_keys.get(pid, "")
                if key:
                    folder = st.session_state.get("yandex_folder_id", "") if pid == "yandexgpt" else ""
                    success, msg, latency = AIAnalyzer.check_connection(pid, key, folder)
                    st.session_state.ai_connection_status[pid] = {"success": success, "msg": msg, "latency": latency}
        st.rerun()
    
    st.markdown("---")
    st.markdown("#### ‚ÑπÔ∏è –û —Å–∏—Å—Ç–µ–º–µ")
    st.markdown(f"""
    **–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.1**  
    –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤  
    ¬© {st.session_state.get('org_config', {}).get('short_name', '')} {datetime.now().year}
    
    **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:** {'‚úÖ' if DOCX_AVAILABLE else '‚ùå'} DOCX | {'‚úÖ' if PDF_READER_AVAILABLE else '‚ùå'} PDF | {'‚úÖ' if REQUESTS_AVAILABLE else '‚ùå'} Requests
    """)

# ============================================================================
# UI: –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨
# ============================================================================

def render_admin_tab():
    if st.session_state.user_role != UserRole.ADMIN:
        st.error("üö´ –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        return
    
    st.markdown("### üîß –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ")
    
    tabs = st.tabs(["üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "üìä –ü–æ—Ä–æ–≥–∏", "üîë API", "‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞"])
    
    # –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
    with tabs[0]:
        org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
        col1, col2 = st.columns(2)
        with col1:
            new_full = st.text_input("–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", value=org.get("full_name", ""))
            new_short = st.text_input("–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", value=org.get("short_name", ""))
            new_inn = st.text_input("–ò–ù–ù", value=org.get("inn", ""))
        with col2:
            new_director = st.text_input("–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", value=org.get("director_name", ""))
            new_position = st.text_input("–î–æ–ª–∂–Ω–æ—Å—Ç—å", value=org.get("director_position", ""))
            new_address = st.text_input("–ê–¥—Ä–µ—Å", value=org.get("address", ""))
        
        if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", key="save_org"):
            st.session_state.org_config.update({
                "full_name": new_full, "short_name": new_short, "inn": new_inn,
                "director_name": new_director, "director_position": new_position, "address": new_address
            })
            st.success("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")
    
    # –ü–æ—Ä–æ–≥–∏
    with tabs[1]:
        th = st.session_state.get("thresholds", DEFAULT_THRESHOLDS)
        col1, col2 = st.columns(2)
        with col1:
            new_tf = st.number_input("üü¢ –¢–§ –º–∞–∫—Å (‚ÇΩ)", value=th.get("green_tf_max", 100000), step=10000)
            new_non_tf = st.number_input("üü¢ –ù–µ—Ç–∏–ø–æ–≤—ã–µ –º–∞–∫—Å (‚ÇΩ)", value=th.get("green_non_tf_max", 50000), step=10000)
        with col2:
            new_yellow = st.number_input("üü° –ñ—ë–ª—Ç–∞—è –º–∞–∫—Å (‚ÇΩ)", value=th.get("yellow_max", 5000000), step=100000)
            new_tender = st.number_input("üî¥ –¢–µ–Ω–¥–µ—Ä –æ—Ç (‚ÇΩ)", value=th.get("tender_red", 3000000), step=100000)
        
        if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä–æ–≥–∏"):
            st.session_state.thresholds = {
                "green_tf_max": new_tf, "green_non_tf_max": new_non_tf,
                "yellow_max": new_yellow, "tender_red": new_tender,
                "single_supplier_yellow": th.get("single_supplier_yellow", 100000)
            }
            st.success("‚úÖ –ü–æ—Ä–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")
    
    # API
    with tabs[2]:
        st.markdown("**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏:**")
        enabled = st.session_state.get("enabled_providers", [])
        new_enabled = []
        
        for pid, pinfo in AI_PROVIDERS.items():
            if st.checkbox(pinfo["name"], value=pid in enabled, key=f"enable_{pid}"):
                new_enabled.append(pid)
        
        st.session_state.enabled_providers = new_enabled
        
        st.markdown("---")
        st.markdown("**API-–∫–ª—é—á–∏:**")
        for pid in new_enabled:
            key = st.text_input(AI_PROVIDERS[pid]["name"], type="password", value=st.session_state.api_keys.get(pid, ""), key=f"admin_key_{pid}")
            st.session_state.api_keys[pid] = key
    
    # –°–∏—Å—Ç–µ–º–∞
    with tabs[3]:
        settings = st.session_state.get("admin_settings", {})
        new_demo = st.checkbox("–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–µ–º–æ-—Ä–µ–∂–∏–º", value=settings.get("allow_demo", True))
        new_req_cp = st.checkbox("–¢—Ä–µ–±–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞", value=settings.get("require_counterparty", True))
        new_req_text = st.checkbox("–¢—Ä–µ–±–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞", value=settings.get("require_contract_text", True))
        new_min = st.number_input("–ú–∏–Ω. –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞", value=settings.get("min_contract_length", 100), min_value=10)
        
        if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"):
            st.session_state.admin_settings = {
                "allow_demo": new_demo, "require_counterparty": new_req_cp,
                "require_contract_text": new_req_text, "min_contract_length": new_min
            }
            st.success("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")

# ============================================================================
# UI: –ò–°–¢–û–†–ò–Ø
# ============================================================================

def render_history_tab():
    st.markdown("### üìú –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤")
    
    if not st.session_state.history:
        st.info("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞")
        return
    
    total = len(st.session_state.history)
    green = sum(1 for h in st.session_state.history if h.get('zone') == 'green')
    yellow = sum(1 for h in st.session_state.history if h.get('zone') == 'yellow')
    red = sum(1 for h in st.session_state.history if h.get('zone') == 'red')
    
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("üìä –í—Å–µ–≥–æ", total)
    col2.metric("üü¢", green)
    col3.metric("üü°", yellow)
    col4.metric("üî¥", red)
    
    st.markdown("---")
    
    for item in st.session_state.history:
        emoji = {"green": "üü¢", "yellow": "üü°", "red": "üî¥"}.get(item.get("zone", ""), "‚ö™")
        with st.expander(f"{emoji} {item.get('counterparty', '–ù/–î')} | {item.get('timestamp', '')[:10]}"):
            st.json(item)
    
    if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"):
        st.session_state.history = []
        st.rerun()

# ============================================================================
# UI: –¢–ò–ü–û–í–´–ï –§–û–†–ú–´
# ============================================================================

def render_typical_forms_tab():
    st.markdown("### üìÇ –¢–∏–ø–æ–≤—ã–µ —Ñ–æ—Ä–º—ã")
    
    all_tf = {**BUILTIN_TYPICAL_FORMS, **st.session_state.custom_typical_forms}
    
    for key, tf in all_tf.items():
        is_custom = key in st.session_state.custom_typical_forms
        badge = "üîµ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è" if is_custom else "‚ö™ –°–∏—Å—Ç–µ–º–Ω–∞—è"
        
        with st.expander(f"üìÑ {tf.get('name', key)} ({tf.get('code', '')})"):
            st.markdown(f"**{badge}** | –í–µ—Ä—Å–∏—è: {tf.get('version', '')} | –ù–∞—à–∞ —Ä–æ–ª—å: {tf.get('our_role', '–ù/–î')}")
            
            if tf.get('description'):
                st.caption(tf['description'])
            
            st.markdown("**–†–∞–∑–¥–µ–ª—ã:**")
            for section in tf.get("sections", {}):
                st.markdown(f"- {section}")
            
            col1, col2 = st.columns(2)
            with col1:
                st.download_button("üì• JSON", json.dumps(tf, ensure_ascii=False, indent=2).encode('utf-8'), f"{key}.json", key=f"dl_{key}")
            with col2:
                if is_custom and st.button("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", key=f"del_{key}"):
                    del st.session_state.custom_typical_forms[key]
                    st.rerun()

# ============================================================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ============================================================================

def render_main():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    role = st.session_state.user_role
    
    st.markdown(f'''
    <div class="main-header">
        <div class="traffic-light"><span class="tl-red"></span><span class="tl-yellow"></span><span class="tl-green"></span></div>
        <h2>üö¶ –†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä <span class="version-badge">v7.1</span></h2>
        <div style="opacity:0.9;font-size:0.9rem;">{org.get("short_name", "")}</div>
    </div>
    ''', unsafe_allow_html=True)
    
    render_sidebar()
    
    tab_names = ["üìù –ê–Ω–∞–ª–∏–∑", "üìä –û—Ç—á—ë—Ç—ã", "üìÇ –¢–∏–ø–æ–≤—ã–µ —Ñ–æ—Ä–º—ã", "üìú –ò—Å—Ç–æ—Ä–∏—è", "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"]
    if role == UserRole.ADMIN:
        tab_names.append("üîß –ê–¥–º–∏–Ω")
    
    tabs = st.tabs(tab_names)
    
    with tabs[0]:
        render_analysis_tab()
    with tabs[1]:
        render_reports_tab()
    with tabs[2]:
        render_typical_forms_tab()
    with tabs[3]:
        render_history_tab()
    with tabs[4]:
        render_settings_tab()
    
    if role == UserRole.ADMIN:
        with tabs[5]:
            render_admin_tab()


def main():
    apply_styles()
    init_session()
    
    if not st.session_state.authenticated:
        render_auth_page()
    else:
        render_main()


if __name__ == "__main__":
    main()
