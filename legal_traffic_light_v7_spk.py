"""
Legal Traffic Light v7.0 - Professional Edition
ÐÐž Â«Ð¡ÐŸÐšÂ» Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ð¾Ñ‡Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ
Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð² Ñ AI-Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹

Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»:
- Ð¢Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹ Ð¡ÐŸÐš (Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ°, Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ, ÑƒÑÐ»ÑƒÐ³Ð¸, Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ°)
- ÐœÐ½Ð¾Ð¶ÐµÑÑ‚Ð²Ð¾ AI Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð¾Ð² (OpenAI, Anthropic, GigaChat, YandexGPT, Mistral, Perplexity)
- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ€Ð¾Ð»ÐµÐ¹ (ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ / ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ)
- Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
- Legal Design Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ
- Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ´ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð¼
"""

import streamlit as st
import re, json, hashlib, io, math, time
from datetime import datetime, date
from typing import Dict, List, Tuple, Optional, Set, Any
from dataclasses import dataclass, field
from enum import Enum
from collections import Counter
import difflib

# ============================================================================
# ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð‘Ð˜Ð‘Ð›Ð˜ÐžÐ¢Ð•Ðš
# ============================================================================

DOCX_AVAILABLE = False
PDF_READER_AVAILABLE = False

try:
    from docx import Document as DocxDocument
    from docx.shared import Pt, Inches, RGBColor
    from docx.enum.text import WD_ALIGN_PARAGRAPH
    from docx.enum.table import WD_TABLE_ALIGNMENT
    DOCX_AVAILABLE = True
except ImportError:
    pass

try:
    from PyPDF2 import PdfReader
    PDF_READER_AVAILABLE = True
except ImportError:
    pass

# ============================================================================
# ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯
# ============================================================================

st.set_page_config(
    page_title="Legal Traffic Light v7.0 | Ð¡ÐŸÐš",
    page_icon="ðŸš¦",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ============================================================================
# Ð”ÐÐÐÐ«Ð• ÐžÐ Ð“ÐÐÐ˜Ð—ÐÐ¦Ð˜Ð˜ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¼ÐµÐ½ÑÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»ÑŒ)
# ============================================================================

DEFAULT_ORG_CONFIG = {
    "full_name": 'ÐÐºÑ†Ð¸Ð¾Ð½ÐµÑ€Ð½Ð¾Ðµ Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾ Â«Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ð¾Ñ‡Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑÂ»',
    "short_name": 'ÐÐž Â«Ð¡ÐŸÐšÂ»',
    "abbrev": "Ð¡ÐŸÐš",
    "inn": "7708654321",
    "kpp": "770801001",
    "ogrn": "1037708654321",
    "address": "127015, Ð³. ÐœÐ¾ÑÐºÐ²Ð°, ÑƒÐ». ÐÐ¾Ð²Ð¾Ð´Ð¼Ð¸Ñ‚Ñ€Ð¾Ð²ÑÐºÐ°Ñ, Ð´. 5Ð, ÑÑ‚Ñ€. 1",
    "director_name": "ÐŸÐµÑ‚Ñ€Ð¾Ð² ÐŸÑ‘Ñ‚Ñ€ ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð¸Ñ‡",
    "director_position": "Ð“ÐµÐ½ÐµÑ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€",
    "basis": "Ð£ÑÑ‚Ð°Ð²Ð°"
}

# ÐŸÐ¾Ñ€Ð¾Ð³Ð¸ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ (Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼)
DEFAULT_THRESHOLDS = {
    "green_tf_max": 100_000,
    "green_non_tf_max": 50_000,
    "yellow_max": 5_000_000,
    "tender_red": 3_000_000,
    "single_supplier_yellow": 100_000
}

DEFAULT_DEADLINES = {
    "standard": 5,
    "extended": 10,
    "urgent": 1
}

# ============================================================================
# ENUM Ð˜ ÐšÐžÐÐ¡Ð¢ÐÐÐ¢Ð«
# ============================================================================

class RiskZone(Enum):
    GREEN = "green"
    YELLOW = "yellow"
    RED = "red"

class DocumentForm(Enum):
    TYPICAL = "typical"
    COUNTERPARTY = "counterparty"
    FREE = "free"
    MODIFIED_TF = "modified_tf"
    SELF_DEVELOPED = "self"

class LegalStatus(Enum):
    NOT_SUBMITTED = "not_submitted"
    NO_INFO = "no_info"
    SUBMITTED = "submitted"
    APPROVED = "approved"
    REJECTED = "rejected"
    IN_PROGRESS = "in_progress"

class UserRole(Enum):
    USER = "user"
    ADMIN = "admin"

LEGAL_STATUS_LABELS = {
    LegalStatus.NOT_SUBMITTED: "ðŸ”´ ÐÐµ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð°Ð» Ð½Ð° ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ",
    LegalStatus.NO_INFO: "ðŸŸ¡ ÐÐµÑ‚ ÑÐ²ÐµÐ´ÐµÐ½Ð¸Ð¹",
    LegalStatus.SUBMITTED: "ðŸŸ¡ ÐŸÐ¾ÑÑ‚ÑƒÐ¿Ð°Ð» Ð½Ð° ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ",
    LegalStatus.APPROVED: "ðŸŸ¢ Ð¡Ð¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½ Ð®Ð”",
    LegalStatus.REJECTED: "ðŸ”´ ÐžÑ‚ÐºÐ»Ð¾Ð½ÐµÐ½",
    LegalStatus.IN_PROGRESS: "ðŸŸ¡ ÐÐ° Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ð¸",
}

DOCUMENT_FORM_LABELS = {
    DocumentForm.TYPICAL: "ðŸ“‹ Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° (Ð¢Ð¤)",
    DocumentForm.COUNTERPARTY: "ðŸ“„ Ð¤Ð¾Ñ€Ð¼Ð° ÐºÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚Ð°",
    DocumentForm.FREE: "ðŸ“ Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð°",
    DocumentForm.MODIFIED_TF: "âœï¸ Ð¢Ð¤ Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸",
    DocumentForm.SELF_DEVELOPED: "ðŸ”§ Ð¡Ð²Ð¾Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°",
}

DEPARTMENTS = [
    "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚",
    "Ð”ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ð¾Ðº",
    "Ð”ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚ ÐºÐ¾Ð¼Ð¼ÐµÑ€Ñ‡ÐµÑÐºÐ¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹",
    "Ð”ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚ Ð¿Ð¾Ð´Ð²Ð¸Ð¶Ð½Ð¾Ð³Ð¾ ÑÐ¾ÑÑ‚Ð°Ð²Ð°",
    "Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚",
    "Ð”ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚ Ð·Ð°ÐºÑƒÐ¿Ð¾Ðº",
    "Ð¡Ð»ÑƒÐ¶Ð±Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸",
    "IT-Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚",
    "ÐžÑ‚Ð´ÐµÐ» ÐºÐ°Ð´Ñ€Ð¾Ð²",
]

POSITIONS = [
    "Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚",
    "Ð’ÐµÐ´ÑƒÑ‰Ð¸Ð¹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚", 
    "Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚",
    "ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¸Ðº Ð¾Ñ‚Ð´ÐµÐ»Ð°",
    "Ð—Ð°Ð¼ÐµÑÑ‚Ð¸Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¸ÐºÐ° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ",
    "ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¸Ðº ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ",
    "Ð—Ð°Ð¼ÐµÑÑ‚Ð¸Ñ‚ÐµÐ»ÑŒ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð°",
    "Ð ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð°",
    "Ð—Ð°Ð¼ÐµÑÑ‚Ð¸Ñ‚ÐµÐ»ÑŒ Ð³ÐµÐ½ÐµÑ€Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð°",
    "Ð“ÐµÐ½ÐµÑ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€"
]

RED_ZONE_ALWAYS = [
    "ÐÑ€ÐµÐ½Ð´Ð° Ð²Ð°Ð³Ð¾Ð½Ð¾Ð²", "Ð›Ð¸Ð·Ð¸Ð½Ð³ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð²", "ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ°/Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð° Ð²Ð°Ð³Ð¾Ð½Ð¾Ð²",
    "ÐÑ€ÐµÐ½Ð´Ð° Ð»Ð¾ÐºÐ¾Ð¼Ð¾Ñ‚Ð¸Ð²Ð¾Ð²", "ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ°/Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð° Ð»Ð¾ÐºÐ¾Ð¼Ð¾Ñ‚Ð¸Ð²Ð¾Ð²",
    "ÐÑ€ÐµÐ½Ð´Ð° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²", "ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ°/Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²",
    "ÐœÐµÐ¶Ð´ÑƒÐ½Ð°Ñ€Ð¾Ð´Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ (Ð’Ð­Ð”)", "Ð Ð°ÑÑ‡ÐµÑ‚Ñ‹ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ",
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð½Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ ÐŸÐž", "Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ",
    "ÐÑ€ÐµÐ½Ð´Ð° Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸", "ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸",
    "ÐšÑ€ÐµÐ´Ð¸Ñ‚Ð½Ñ‹Ð¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€", "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð·Ð°Ð¹Ð¼Ð°", "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð·Ð°Ð»Ð¾Ð³Ð°",
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ñ ÐžÐÐž Â«Ð Ð–Ð”Â»", "Ð¡ÐµÑ€Ð²Ð¸ÑÐ½Ñ‹Ð¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€",
]

YELLOW_ZONE_TYPES = [
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¢Ð­Ðž", "Ð Ð°Ð¼Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸",
    "ÐŸÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ° Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð°", "ÐŸÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ° Ð½ÐµÐ³Ð°Ð±Ð°Ñ€Ð¸Ñ‚Ð½Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð°",
    "Ð—Ð°ÐºÑƒÐ¿ÐºÐ° Ñƒ ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ°",
]

RED_DOCUMENTS_ALWAYS = [
    "ÐŸÑ€ÐµÑ‚ÐµÐ½Ð·Ð¸Ñ (Ð²Ñ…Ð¾Ð´ÑÑ‰Ð°Ñ)", "ÐŸÑ€ÐµÑ‚ÐµÐ½Ð·Ð¸Ñ (Ð¸ÑÑ…Ð¾Ð´ÑÑ‰Ð°Ñ)",
    "Ð˜ÑÐºÐ¾Ð²Ð¾Ðµ Ð·Ð°ÑÐ²Ð»ÐµÐ½Ð¸Ðµ", "Ð¡ÑƒÐ´ÐµÐ±Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¸ÐºÐ°Ð·",
    "Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð¤ÐÐ¡", "Ð—Ð°Ð¿Ñ€Ð¾Ñ ÐŸÑ€Ð¾ÐºÑƒÑ€Ð°Ñ‚ÑƒÑ€Ñ‹", "Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð¤ÐÐ¡",
    "Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÐ½Ð°Ð´Ð·Ð¾Ñ€Ð°", "ÐŸÑ€ÐµÐ´Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ð¾ÑÐ¾Ñ€Ð³Ð°Ð½Ð°",
]

CONTRACT_TYPES = [
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ÐºÐ°Ð·Ð°Ð½Ð¸Ñ ÑƒÑÐ»ÑƒÐ³ (Ð¢Ð­Ðž)",
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸",
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ",
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ (Ð°Ð²Ñ‚Ð¾)",
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð°Ñ€ÐµÐ½Ð´Ñ‹ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð²",
    "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¿Ð¾Ð´Ñ€ÑÐ´Ð°",
    "ÐÐ³ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€",
    "Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ",
    "Ð”Ñ€ÑƒÐ³Ð¾Ð¹",
]

# ============================================================================
# AI ÐŸÐ ÐžÐ’ÐÐ™Ð”Ð•Ð Ð«
# ============================================================================

AI_PROVIDERS = {
    "openai": {
        "name": "OpenAI GPT-4",
        "api_url": "https://api.openai.com/v1/chat/completions",
        "key_prefix": "sk-",
        "model": "gpt-4o-mini",
        "enabled": True
    },
    "anthropic": {
        "name": "Anthropic Claude",
        "api_url": "https://api.anthropic.com/v1/messages",
        "key_prefix": "sk-ant-",
        "model": "claude-3-haiku-20240307",
        "enabled": True
    },
    "gigachat": {
        "name": "GigaChat (Ð¡Ð±ÐµÑ€)",
        "api_url": "https://gigachat.devices.sberbank.ru/api/v1/chat/completions",
        "key_prefix": "",
        "model": "GigaChat",
        "enabled": True
    },
    "yandexgpt": {
        "name": "YandexGPT",
        "api_url": "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
        "key_prefix": "",
        "model": "yandexgpt-lite",
        "enabled": True
    },
    "mistral": {
        "name": "Mistral AI",
        "api_url": "https://api.mistral.ai/v1/chat/completions",
        "key_prefix": "",
        "model": "mistral-small-latest",
        "enabled": True
    },
    "perplexity": {
        "name": "Perplexity AI",
        "api_url": "https://api.perplexity.ai/chat/completions",
        "key_prefix": "pplx-",
        "model": "llama-3.1-sonar-small-128k-online",
        "enabled": True
    }
}

# ============================================================================
# Ð£Ð§Ð•Ð¢ÐÐ«Ð• Ð—ÐÐŸÐ˜Ð¡Ð˜ ÐŸÐž Ð£ÐœÐžÐ›Ð§ÐÐÐ˜Ð®
# ============================================================================

DEFAULT_USERS = {
    "admin": {
        "password_hash": hashlib.sha256("admin123".encode()).hexdigest(),
        "role": UserRole.ADMIN,
        "name": "ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹",
        "position": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€",
        "department": "IT-Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"
    },
    "user": {
        "password_hash": hashlib.sha256("user123".encode()).hexdigest(),
        "role": UserRole.USER,
        "name": "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ",
        "position": "Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚",
        "department": "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"
    }
}

# ============================================================================
# Ð¢Ð˜ÐŸÐžÐ’Ð«Ð• Ð¤ÐžÐ ÐœÐ« Ð¡ÐŸÐš (Ð¸Ð· Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²)
# ============================================================================

BUILTIN_TYPICAL_FORMS = {
    "supply": {
        "name": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ (Ñ Ð­Ð”Ðž)",
        "code": "Ð¢Ð¤-Ð¡ÐŸÐš-ÐŸÐžÐ¡-001",
        "version": "2024.1",
        "date": "01.01.2024",
        "description": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð² Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð·Ð°Ð¿Ð°ÑÐ½Ñ‹Ñ… Ñ‡Ð°ÑÑ‚ÐµÐ¹ Ðº Ð¶/Ð´ Ð²Ð°Ð³Ð¾Ð½Ð°Ð¼ Ñ ÑÐ»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð½Ñ‹Ð¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ð¾Ð¼",
        "sections": {
            "1. ÐŸÐ Ð•Ð”ÐœÐ•Ð¢ Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð": {
                "required": True,
                "template": "ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ, Ð° ÐŸÐ¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð½Ð° ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ… Ð½Ð°ÑÑ‚Ð¾ÑÑ‰ÐµÐ³Ð¾ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð½Ð¾Ð²Ñ‹Ðµ Ð¸/Ð¸Ð»Ð¸ Ð±Ñ‹Ð²ÑˆÐ¸Ðµ Ð² ÑÐºÑÐ¿Ð»ÑƒÐ°Ñ‚Ð°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð½Ñ‹Ðµ Ð¸/Ð¸Ð»Ð¸ Ð½ÐµÐ¸ÑÐ¿Ñ€Ð°Ð²Ð½Ñ‹Ðµ Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð¾Ð¿Ñ€Ð¸Ð³Ð¾Ð´Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ð°ÑÐ½Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ð¸ Ðº Ð¶ÐµÐ»ÐµÐ·Ð½Ð¾Ð´Ð¾Ñ€Ð¾Ð¶Ð½Ñ‹Ð¼ Ð²Ð°Ð³Ð¾Ð½Ð°Ð¼.",
                "keywords": ["Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚", "Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº", "Ð¿Ð¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»ÑŒ", "Ñ‚Ð¾Ð²Ð°Ñ€", "Ð·Ð°Ð¿Ð°ÑÐ½Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ð¸", "Ð²Ð°Ð³Ð¾Ð½Ñ‹", "Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ", "Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ", "Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ"],
                "risk_patterns": [
                    {"pattern": r"Ð½Ðµ\s+Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚.*?Ð¿Ñ€Ð°Ð²Ð¾\s+ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚", "risk": "red", "issue": "ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð¿Ñ€Ð°Ð²Ð° ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð½Ð° Ñ‚Ð¾Ð²Ð°Ñ€"},
                    {"pattern": r"Ñ‚Ð¾Ð²Ð°Ñ€.*?(?:Ð¿Ð¾Ð´\s+Ð°Ñ€ÐµÑÑ‚Ð¾Ð¼|Ð·Ð°Ð»Ð¾Ð¶ÐµÐ½|Ð¾Ð±Ñ€ÐµÐ¼ÐµÐ½ÐµÐ½)", "risk": "red", "issue": "Ð¢Ð¾Ð²Ð°Ñ€ Ð¿Ð¾Ð´ Ð¾Ð±Ñ€ÐµÐ¼ÐµÐ½ÐµÐ½Ð¸ÐµÐ¼"}
                ]
            },
            "2. Ð¡Ð ÐžÐšÐ˜ Ð˜ Ð£Ð¡Ð›ÐžÐ’Ð˜Ð¯ ÐŸÐžÐ¡Ð¢ÐÐ’ÐšÐ˜": {
                "required": True,
                "template": "ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº Ð¸ ÐŸÐ¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ñ‹Ð²Ð°ÑŽÑ‚ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð² ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÑ…. Ð”Ð°Ñ‚Ð¾Ð¹ Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð´Ð°Ñ‚Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¿Ð¾ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹.",
                "keywords": ["ÑÑ€Ð¾Ðº", "ÑƒÑÐ»Ð¾Ð²Ð¸Ñ", "Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ°", "Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ", "Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð°Ñ", "Ð´Ð°Ñ‚Ð°", "Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð¿Ñ€Ð°Ð²Ð°"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ñ€Ð°Ð²Ð¾\s+ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸.*?(?:Ð¾Ð¿Ð»Ð°Ñ‚|Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½)", "risk": "yellow", "issue": "ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð¿Ñ€Ð°Ð²Ð° ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½ Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ"}
                ]
            },
            "3. ÐšÐÐ§Ð•Ð¡Ð¢Ð’Ðž Ð˜ ÐšÐžÐœÐŸÐ›Ð•ÐšÐ¢ÐÐžÐ¡Ð¢Ð¬": {
                "required": True,
                "template": "ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð¾Ð»Ð¶Ð½Ð¾ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ ÑƒÑÐ»Ð¾Ð²Ð¸ÑÐ¼, Ð“ÐžÐ¡Ð¢Ð°Ð¼. ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°.",
                "keywords": ["ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾", "ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ", "Ð³Ð¾ÑÑ‚", "ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚", "Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ", "ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ"],
                "risk_patterns": [
                    {"pattern": r"Ð±ÐµÐ·\s+(?:Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸|ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚)", "risk": "red", "issue": "ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°/ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²"},
                    {"pattern": r"ÐºÐ°Ðº\s+ÐµÑÑ‚ÑŒ|as\s+is", "risk": "red", "issue": "ÐŸÐ¾ÑÑ‚Ð°Ð²ÐºÐ° 'ÐºÐ°Ðº ÐµÑÑ‚ÑŒ' Ð±ÐµÐ· Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¹"}
                ]
            },
            "4. Ð¦Ð•ÐÐ Ð˜ ÐŸÐžÐ Ð¯Ð”ÐžÐš Ð ÐÐ¡Ð§Ð•Ð¢ÐžÐ’": {
                "required": True,
                "template": "Ð¦ÐµÐ½Ð° Ñ‚Ð¾Ð²Ð°Ñ€Ð° ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÑ…. ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 10 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹ Ñ Ð´Ð°Ñ‚Ñ‹ Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ ÑÑ‡ÐµÑ‚Ð°-Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹ Ð¸ Ð£ÐŸÐ”.",
                "keywords": ["Ñ†ÐµÐ½Ð°", "Ð¾Ð¿Ð»Ð°Ñ‚Ð°", "Ñ€Ð°ÑÑ‡ÐµÑ‚", "ÑÑ‡ÐµÑ‚", "ÑƒÐ¿Ð´", "Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹", "Ð½Ð´Ñ"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð±Ð¾Ð»ÐµÐµ 30%"},
                    {"pattern": r"Ð¾Ð¿Ð»Ð°Ñ‚Ð°.*?(?:1|2|3)\s*(?:Ñ€Ð°Ð±Ð¾Ñ‡|ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ð½)", "risk": "yellow", "issue": "Ð¡Ñ€Ð¾Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð¼ÐµÐ½ÐµÐµ 5 Ð´Ð½ÐµÐ¹"},
                    {"pattern": r"Ð°Ð²Ð°Ð½Ñ\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "ÐÐ²Ð°Ð½Ñ Ð±Ð¾Ð»ÐµÐµ 30%"}
                ]
            },
            "5. ÐŸÐ Ð˜Ð•ÐœÐšÐ Ð¢ÐžÐ’ÐÐ Ð": {
                "required": True,
                "template": "ÐŸÑ€Ð¸ÐµÐ¼ÐºÐ° Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð»ÑÐµÑ‚ÑÑ Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ Ð¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ñƒ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼Ð¸ ÐŸ-6 Ð¸ ÐŸ-7 Ð“Ð¾ÑÐ°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð° Ð¡Ð¡Ð¡Ð .",
                "keywords": ["Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ°", "Ð¿-6", "Ð¿-7", "ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾", "ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾", "Ð¿Ñ€ÐµÑ‚ÐµÐ½Ð·Ð¸Ñ", "Ð°ÐºÑ‚"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ°.*?(?:1|2)\s*(?:Ñ‡Ð°Ñ|Ð´Ð½)", "risk": "yellow", "issue": "Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ ÑÑ€Ð¾Ðº Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ¸"}
                ]
            },
            "6. Ð“ÐÐ ÐÐÐ¢Ð˜Ð™ÐÐ«Ð• ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬Ð¡Ð¢Ð’Ð": {
                "required": True,
                "template": "Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¹Ð½Ñ‹Ð¹ ÑÑ€Ð¾Ðº Ð½Ð° Ñ‚Ð¾Ð²Ð°Ñ€ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ 12 Ð¼ÐµÑÑÑ†ÐµÐ². ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ ÑƒÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸ Ð¸Ð»Ð¸ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€.",
                "keywords": ["Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ", "Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¹Ð½Ñ‹Ð¹ ÑÑ€Ð¾Ðº", "Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸", "Ð·Ð°Ð¼ÐµÐ½Ð°", "Ð¼ÐµÑÑÑ†ÐµÐ²"],
                "risk_patterns": [
                    {"pattern": r"Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ.*?(?:Ð½Ðµ\s+Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ÑÑ|Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚)", "risk": "red", "issue": "ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸"},
                    {"pattern": r"Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¹Ð½Ñ‹Ð¹\s+ÑÑ€Ð¾Ðº.*?(?:[1-6])\s*Ð¼ÐµÑÑÑ†", "risk": "yellow", "issue": "Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¹Ð½Ñ‹Ð¹ ÑÑ€Ð¾Ðº Ð¼ÐµÐ½ÐµÐµ 6 Ð¼ÐµÑÑÑ†ÐµÐ²"}
                ]
            },
            "7. ÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð•ÐÐÐžÐ¡Ð¢Ð¬ Ð¡Ð¢ÐžÐ ÐžÐ": {
                "required": True,
                "template": "Ð—Ð° Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ ÑÑ€Ð¾ÐºÐ¾Ð² Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð½ÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ° 0,1% Ð·Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ¸, Ð½Ð¾ Ð½Ðµ Ð±Ð¾Ð»ÐµÐµ 10%. Ð—Ð° Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ ÑÑ€Ð¾ÐºÐ¾Ð² Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ 0,1% Ð·Ð° Ð´ÐµÐ½ÑŒ.",
                "keywords": ["Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ", "Ð½ÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ°", "ÑˆÑ‚Ñ€Ð°Ñ„", "Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ°", "ÑƒÐ±Ñ‹Ñ‚ÐºÐ¸"],
                "risk_patterns": [
                    {"pattern": r"Ð½ÐµÑƒÑÑ‚Ð¾Ð¹Ðº\w*.*?Ð¿Ð¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»\w*.*?(?:0[,.]?[3-9]|[1-9])\s*%", "risk": "red", "issue": "ÐÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ° Ð´Ð»Ñ ÐŸÐ¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»Ñ Ð²Ñ‹ÑˆÐµ 0.2% Ð² Ð´ÐµÐ½ÑŒ"},
                    {"pattern": r"(?:Ð¿Ð¾Ð»Ð½\w+|Ð½ÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½\w+).*?Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚", "risk": "red", "issue": "ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð°Ñ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ ÐŸÐ¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»Ñ"},
                    {"pattern": r"Ð½Ðµ\s+(?:Ð½ÐµÑÐµÑ‚|Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚).*?(?:ÐºÐ¾ÑÐ²ÐµÐ½Ð½|ÑƒÐ¿ÑƒÑ‰ÐµÐ½Ð½).*?Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº", "risk": "red", "issue": "Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ° Ð·Ð° ÐºÐ¾ÑÐ²ÐµÐ½Ð½Ñ‹Ðµ ÑƒÐ±Ñ‹Ñ‚ÐºÐ¸"}
                ]
            },
            "8. Ð¤ÐžÐ Ð¡-ÐœÐÐ–ÐžÐ ": {
                "required": True,
                "template": "Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°ÑŽÑ‚ÑÑ Ð¾Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸ Ð¾Ð±ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð°Ñ… Ð½ÐµÐ¿Ñ€ÐµÐ¾Ð´Ð¾Ð»Ð¸Ð¼Ð¾Ð¹ ÑÐ¸Ð»Ñ‹, Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¢ÐŸÐŸ.",
                "keywords": ["Ñ„Ð¾Ñ€Ñ-Ð¼Ð°Ð¶Ð¾Ñ€", "Ð½ÐµÐ¿Ñ€ÐµÐ¾Ð´Ð¾Ð»Ð¸Ð¼Ð°Ñ ÑÐ¸Ð»Ð°", "Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ", "Ñ‚Ð¿Ð¿"],
                "risk_patterns": []
            },
            "9. Ð­Ð›Ð•ÐšÐ¢Ð ÐžÐÐÐ«Ð™ Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢ÐžÐžÐ‘ÐžÐ ÐžÐ¢": {
                "required": False,
                "template": "Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ð»Ð¸ÑÑŒ Ð¾Ð± Ð¾Ð±Ð¼ÐµÐ½Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð­Ð”Ðž. Ð­Ð»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð½Ñ‹Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ ÑŽÑ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÐ¸Ð»Ñƒ.",
                "keywords": ["ÑÐ´Ð¾", "ÑÐ»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð½Ñ‹Ð¹", "Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚", "ÑÑ†Ð¿", "Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ"],
                "risk_patterns": []
            },
            "10. Ð ÐÐ—Ð Ð•Ð¨Ð•ÐÐ˜Ð• Ð¡ÐŸÐžÐ ÐžÐ’": {
                "required": True,
                "template": "ÐŸÑ€ÐµÑ‚ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½, ÑÑ€Ð¾Ðº Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ñ 30 Ð´Ð½ÐµÐ¹. Ð¡Ð¿Ð¾Ñ€Ñ‹ Ð² ÐÑ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ð¾Ð¼ ÑÑƒÐ´Ðµ Ð³. ÐœÐ¾ÑÐºÐ²Ñ‹.",
                "keywords": ["ÑÐ¿Ð¾Ñ€Ñ‹", "Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ñ‹Ð¹", "ÑÑƒÐ´", "Ð¿Ñ€ÐµÑ‚ÐµÐ½Ð·Ð¸Ñ", "Ð¼Ð¾ÑÐºÐ²Ð°"],
                "risk_patterns": [
                    {"pattern": r"Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½\w+\s+ÑÑƒÐ´\w*.*?(?:ÑÐ°Ð½ÐºÑ‚-Ð¿ÐµÑ‚ÐµÑ€Ð±ÑƒÑ€Ð³|ÑÐ¿Ð±)", "risk": "yellow", "issue": "ÐŸÐ¾Ð´ÑÑƒÐ´Ð½Ð¾ÑÑ‚ÑŒ Ð½Ðµ Ð² ÐœÐ¾ÑÐºÐ²Ðµ"},
                    {"pattern": r"Ñ‚Ñ€ÐµÑ‚ÐµÐ¹ÑÐº\w+\s+ÑÑƒÐ´", "risk": "yellow", "issue": "Ð¢Ñ€ÐµÑ‚ÐµÐ¹ÑÐºÐ°Ñ Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÐ°"},
                    {"pattern": r"(?:Ð¸Ð½Ð¾ÑÑ‚Ñ€Ð°Ð½Ð½|Ð·Ð°Ñ€ÑƒÐ±ÐµÐ¶Ð½)\w*.*?(?:ÑÑƒÐ´|Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶)", "risk": "red", "issue": "Ð˜Ð½Ð¾ÑÑ‚Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÑƒÐ´/Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶"}
                ]
            },
            "11. Ð¡Ð ÐžÐš Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð¯ Ð˜ Ð ÐÐ¡Ð¢ÐžÐ Ð–Ð•ÐÐ˜Ð•": {
                "required": True,
                "template": "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð². Ð Ð°ÑÑ‚Ð¾Ñ€Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸ÑŽ ÑÑ‚Ð¾Ñ€Ð¾Ð½ Ð¸Ð»Ð¸ Ð² ÑÑƒÐ´ÐµÐ±Ð½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ.",
                "keywords": ["ÑÑ€Ð¾Ðº", "Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ", "Ñ€Ð°ÑÑ‚Ð¾Ñ€Ð¶ÐµÐ½Ð¸Ðµ", "Ð¿Ñ€ÐµÐºÑ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº.*?Ð¾Ð´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½.*?Ñ€Ð°ÑÑ‚Ð¾Ñ€Ð³.*?(?:[1-9]|1[0-4])\s*Ð´Ð½", "risk": "red", "issue": "ÐžÐ´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ°Ð· ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ° Ñ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¼ ÑÑ€Ð¾ÐºÐ¾Ð¼"}
                ]
            },
            "12. Ð Ð•ÐšÐ’Ð˜Ð—Ð˜Ð¢Ð« Ð˜ ÐŸÐžÐ”ÐŸÐ˜Ð¡Ð˜": {
                "required": True,
                "template": "Ð ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ ÑÑ‚Ð¾Ñ€Ð¾Ð½.",
                "keywords": ["Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹", "Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸", "Ð¸Ð½Ð½", "ÐºÐ¿Ð¿", "Ñ€Ð°ÑÑ‡ÐµÑ‚Ð½Ñ‹Ð¹ ÑÑ‡ÐµÑ‚"],
                "risk_patterns": []
            }
        },
        "global_risk_patterns": [
            {"pattern": r"Ð¾Ð´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½\w+.*?Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½\w+.*?(?:Ñ†ÐµÐ½|ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚)", "risk": "red", "issue": "ÐžÐ´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½ÐµÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½Ñ‹ ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ¾Ð¼"},
            {"pattern": r"(?:usd|eur|ÐµÐ²Ñ€Ð¾|Ð´Ð¾Ð»Ð»Ð°Ñ€|Ð²Ð°Ð»ÑŽÑ‚|Ñƒ\.Ðµ\.)", "risk": "yellow", "issue": "Ð’Ð°Ð»ÑŽÑ‚Ð½Ð°Ñ Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÐ°"},
            {"pattern": r"Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†\w*.*?Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐº", "risk": "yellow", "issue": "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ñ Ñ†ÐµÐ½"}
        ]
    },
    
    "storage": {
        "name": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ",
        "code": "Ð¢Ð¤-Ð¡ÐŸÐš-Ð¥Ð Ð-001",
        "version": "2024.1",
        "date": "01.01.2024",
        "description": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð² Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð°ÑÐ½Ñ‹Ñ… Ñ‡Ð°ÑÑ‚ÐµÐ¹ Ðº Ð¶/Ð´ Ð²Ð°Ð³Ð¾Ð½Ð°Ð¼",
        "sections": {
            "1. ÐŸÐ Ð•Ð”ÐœÐ•Ð¢ Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð": {
                "required": True,
                "template": "Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð¸ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°ÐµÐ¼Ð¾Ðµ ÐŸÐ¾ÐºÐ»Ð°Ð¶ÐµÐ´Ð°Ñ‚ÐµÐ»ÐµÐ¼ Ð¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð¾ (Ð·Ð°Ð¿Ð°ÑÐ½Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ð¸ Ðº Ð¶/Ð´ Ð²Ð°Ð³Ð¾Ð½Ð°Ð¼), Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² ÑÐ¾Ñ…Ñ€Ð°Ð½Ð½Ð¾ÑÑ‚Ð¸.",
                "keywords": ["Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚", "Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ", "Ð¿Ð¾ÐºÐ»Ð°Ð¶ÐµÐ´Ð°Ñ‚ÐµÐ»ÑŒ", "Ð¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð¾", "Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ", "Ð·Ð°Ð¿Ð°ÑÐ½Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ð¸"],
                "risk_patterns": []
            },
            "2. ÐžÐ‘Ð¯Ð—ÐÐÐÐžÐ¡Ð¢Ð˜ Ð¡Ð¢ÐžÐ ÐžÐ": {
                "required": True,
                "template": "Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾ ÐÐºÑ‚Ñƒ ÐœÐ¥-1, Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð² Ð½Ð°Ð´Ð»ÐµÐ¶Ð°Ñ‰Ð¸Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ…, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¿Ð¾ ÐÐºÑ‚Ñƒ ÐœÐ¥-3.",
                "keywords": ["Ð¾Ð±ÑÐ·Ð°Ð½Ð½Ð¾ÑÑ‚Ð¸", "Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ", "Ð¼Ñ…-1", "Ð¼Ñ…-3", "Ð°ÐºÑ‚", "ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ð¾ÐºÐ»Ð°Ð¶ÐµÐ´Ð°Ñ‚ÐµÐ»\w+.*?(?:Ð½ÐµÑÐµÑ‚|Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚).*?(?:ÑƒÑ‚Ñ€Ð°Ñ‚|Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸)", "risk": "red", "issue": "ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð° ÑƒÑ‚Ñ€Ð°Ñ‚Ñƒ Ð½Ð° ÐŸÐ¾ÐºÐ»Ð°Ð¶ÐµÐ´Ð°Ñ‚ÐµÐ»Ðµ"}
                ]
            },
            "3. Ð’ÐžÐ—ÐÐÐ“Ð ÐÐ–Ð”Ð•ÐÐ˜Ð• Ð˜ Ð ÐÐ¡Ð§Ð•Ð¢Ð«": {
                "required": True,
                "template": "Ð’Ð¾Ð·Ð½Ð°Ð³Ñ€Ð°Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð·Ð° Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸. ÐžÐ¿Ð»Ð°Ñ‚Ð° ÐµÐ¶ÐµÐ¼ÐµÑÑÑ‡Ð½Ð¾ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ ÐÐºÑ‚Ð° Ð¾ÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑÐ»ÑƒÐ³.",
                "keywords": ["Ð²Ð¾Ð·Ð½Ð°Ð³Ñ€Ð°Ð¶Ð´ÐµÐ½Ð¸Ðµ", "Ð¾Ð¿Ð»Ð°Ñ‚Ð°", "Ñ€Ð°ÑÑ‡ÐµÑ‚", "Ð°ÐºÑ‚", "ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð±Ð¾Ð»ÐµÐµ 30%"}
                ]
            },
            "4. ÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð•ÐÐÐžÐ¡Ð¢Ð¬": {
                "required": True,
                "template": "Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð½ÐµÑÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð° ÑƒÑ‚Ñ€Ð°Ñ‚Ñƒ, Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‡Ñƒ Ð¸Ð»Ð¸ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð° Ð² Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑƒÑ‰ÐµÑ€Ð±Ð°.",
                "keywords": ["Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ", "ÑƒÑ‚Ñ€Ð°Ñ‚Ð°", "Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‡Ð°", "Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ", "ÑƒÑ‰ÐµÑ€Ð±"],
                "risk_patterns": [
                    {"pattern": r"Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»\w+.*?Ð½Ðµ\s+(?:Ð½ÐµÑÐµÑ‚|Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚).*?Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚", "risk": "red", "issue": "Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»Ñ"},
                    {"pattern": r"Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½\w+.*?Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚.*?Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»", "risk": "yellow", "issue": "ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»Ñ"}
                ]
            },
            "5. Ð¡Ð¢Ð ÐÐ¥ÐžÐ’ÐÐÐ˜Ð•": {
                "required": False,
                "template": "Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð²Ð¿Ñ€Ð°Ð²Ðµ Ð·Ð°ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð¾ Ð·Ð° ÑÑ‡ÐµÑ‚ ÐŸÐ¾ÐºÐ»Ð°Ð¶ÐµÐ´Ð°Ñ‚ÐµÐ»Ñ.",
                "keywords": ["ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ðµ", "ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²ÐºÐ°"],
                "risk_patterns": []
            },
            "6. Ð¡Ð ÐžÐš Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð": {
                "required": True,
                "template": "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð·Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½ Ð½Ð° ÑÑ€Ð¾Ðº 12 Ð¼ÐµÑÑÑ†ÐµÐ² Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¿Ñ€Ð¾Ð»Ð¾Ð½Ð³Ð°Ñ†Ð¸Ð¸.",
                "keywords": ["ÑÑ€Ð¾Ðº", "Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ", "Ð¿Ñ€Ð¾Ð»Ð¾Ð½Ð³Ð°Ñ†Ð¸Ñ"],
                "risk_patterns": []
            },
            "7. Ð¡ÐŸÐžÐ Ð«": {
                "required": True,
                "template": "Ð¡Ð¿Ð¾Ñ€Ñ‹ Ð² ÐÑ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ð¾Ð¼ ÑÑƒÐ´Ðµ Ð³. ÐœÐ¾ÑÐºÐ²Ñ‹.",
                "keywords": ["ÑÐ¿Ð¾Ñ€Ñ‹", "Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ñ‹Ð¹", "Ð¼Ð¾ÑÐºÐ²Ð°"],
                "risk_patterns": []
            },
            "8. Ð Ð•ÐšÐ’Ð˜Ð—Ð˜Ð¢Ð«": {
                "required": True,
                "template": "Ð ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ ÑÑ‚Ð¾Ñ€Ð¾Ð½.",
                "keywords": ["Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹", "Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸"],
                "risk_patterns": []
            }
        },
        "global_risk_patterns": []
    },
    
    "services_teo": {
        "name": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð¾ÐºÐ°Ð·Ð°Ð½Ð¸Ñ ÑƒÑÐ»ÑƒÐ³ (Ð¢Ð­Ðž)",
        "code": "Ð¢Ð¤-Ð¡ÐŸÐš-Ð£Ð¡Ð›-001",
        "version": "2025.1",
        "date": "01.01.2025",
        "description": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð² Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð½Ð¾-ÑÐºÑÐ¿ÐµÐ´Ð¸Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ (Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð²)",
        "sections": {
            "ÐŸÐžÐÐ¯Ð¢Ð˜Ð¯ Ð˜ Ð¢Ð•Ð ÐœÐ˜ÐÐ«": {
                "required": True,
                "template": "Ð’Ð°Ð³Ð¾Ð½Ñ‹ - Ð¶/Ð´ Ð¿Ð¾Ð´Ð²Ð¸Ð¶Ð½Ð¾Ð¹ ÑÐ¾ÑÑ‚Ð°Ð². Ð“Ñ€ÑƒÐ· - Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ð¹ Ðº Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐµ Ñ‚Ð¾Ð²Ð°Ñ€. Ð—Ð°ÑÐ²ÐºÐ° - ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸. Ð•Ð›Ð¡ - ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ð»Ð¸Ñ†ÐµÐ²Ð¾Ð¹ ÑÑ‡ÐµÑ‚.",
                "keywords": ["Ð²Ð°Ð³Ð¾Ð½Ñ‹", "Ð³Ñ€ÑƒÐ·", "Ð·Ð°ÑÐ²ÐºÐ°", "ÐµÐ»Ñ", "Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸Ðº", "Ð¾Ð°Ð¾ Ñ€Ð¶Ð´", "Ð¿Ñ€ÐµÐ¹ÑÐºÑƒÑ€Ð°Ð½Ñ‚"],
                "risk_patterns": []
            },
            "1. ÐŸÐ Ð•Ð”ÐœÐ•Ð¢ Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð": {
                "required": True,
                "template": "Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑƒÑÐ»ÑƒÐ³Ð¸ Ð¿Ð¾ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ Ð¶/Ð´ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð² Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°, Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ ÑƒÑÐ»ÑƒÐ³Ð¸.",
                "keywords": ["Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚", "Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ", "Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº", "ÑƒÑÐ»ÑƒÐ³Ð¸", "Ð²Ð°Ð³Ð¾Ð½Ñ‹", "Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ°", "Ð³Ñ€ÑƒÐ·"],
                "risk_patterns": []
            },
            "2. ÐŸÐ ÐÐ’Ð Ð˜ ÐžÐ‘Ð¯Ð—ÐÐÐÐžÐ¡Ð¢Ð˜ Ð¡Ð¢ÐžÐ ÐžÐ": {
                "required": True,
                "template": "Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¿Ð¾Ð´Ð°ÐµÑ‚ Ð²Ð°Ð³Ð¾Ð½Ñ‹ Ð¿Ð¾ Ð—Ð°ÑÐ²ÐºÐµ, Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð½Ð¾ÑÑ‚ÑŒ. Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð¿Ð¾Ð³Ñ€ÑƒÐ·ÐºÑƒ/Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð² Ð½Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ ÑÑ€Ð¾ÐºÐ¸.",
                "keywords": ["Ð¿Ñ€Ð°Ð²Ð°", "Ð¾Ð±ÑÐ·Ð°Ð½Ð½Ð¾ÑÑ‚Ð¸", "Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ", "Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº", "Ð·Ð°ÑÐ²ÐºÐ°", "Ð²Ð°Ð³Ð¾Ð½Ñ‹", "Ð¿Ð¾Ð³Ñ€ÑƒÐ·ÐºÐ°", "Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ°"],
                "risk_patterns": [
                    {"pattern": r"Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº.*?(?:Ð½ÐµÑÐµÑ‚|Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚).*?(?:Ð²ÑÐµ|Ð»ÑŽÐ±Ñ‹Ðµ).*?Ñ€Ð¸ÑÐº", "risk": "red", "issue": "Ð’ÑÐµ Ñ€Ð¸ÑÐºÐ¸ Ð½Ð° Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐµ"}
                ]
            },
            "3. Ð¡Ð¢ÐžÐ˜ÐœÐžÐ¡Ð¢Ð¬ Ð£Ð¡Ð›Ð£Ð“ Ð˜ ÐŸÐžÐ Ð¯Ð”ÐžÐš Ð ÐÐ¡Ð§Ð•Ð¢ÐžÐ’": {
                "required": True,
                "template": "Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ ÑƒÑÐ»ÑƒÐ³ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ÑÑ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ ÐŸÑ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ñƒ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ Ñ†ÐµÐ½Ñ‹. ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 5 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ ÐÐºÑ‚Ð° Ð¸ ÑÑ‡ÐµÑ‚Ð°-Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹.",
                "keywords": ["ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ", "Ñ†ÐµÐ½Ð°", "Ð¾Ð¿Ð»Ð°Ñ‚Ð°", "Ñ€Ð°ÑÑ‡ÐµÑ‚", "Ð°ÐºÑ‚", "ÑÑ‡ÐµÑ‚-Ñ„Ð°ÐºÑ‚ÑƒÑ€Ð°", "Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð±Ð¾Ð»ÐµÐµ 30%"},
                    {"pattern": r"Ð¾Ð¿Ð»Ð°Ñ‚Ð°.*?(?:1|2|3)\s*(?:Ñ€Ð°Ð±Ð¾Ñ‡|ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ð½)", "risk": "yellow", "issue": "Ð¡Ñ€Ð¾Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð¼ÐµÐ½ÐµÐµ 5 Ð´Ð½ÐµÐ¹"}
                ]
            },
            "4. ÐŸÐžÐ Ð¯Ð”ÐžÐš Ð¡Ð”ÐÐ§Ð˜-ÐŸÐ Ð˜Ð•ÐœÐšÐ˜ Ð£Ð¡Ð›Ð£Ð“": {
                "required": True,
                "template": "ÐÐºÑ‚ Ð¾ÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑÐ»ÑƒÐ³ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 5 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹. ÐœÐ¾Ñ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð² Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÑÑ€Ð¾Ðº.",
                "keywords": ["Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ°", "Ð°ÐºÑ‚", "Ð²Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ", "Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹"],
                "risk_patterns": [
                    {"pattern": r"(?:1|2)\s*(?:Ñ€Ð°Ð±Ð¾Ñ‡|ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ð½).*?(?:Ð¿Ð¾Ð´Ð¿Ð¸Ñ|Ð²Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½)", "risk": "yellow", "issue": "Ð¡Ñ€Ð¾Ðº Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ¸ Ð¼ÐµÐ½ÐµÐµ 3 Ð´Ð½ÐµÐ¹"}
                ]
            },
            "5. ÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð•ÐÐÐžÐ¡Ð¢Ð¬ Ð¡Ð¢ÐžÐ ÐžÐ": {
                "required": True,
                "template": "Ð—Ð° ÑÐ²ÐµÑ€Ñ…Ð½Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð² ÑˆÑ‚Ñ€Ð°Ñ„. Ð—Ð° Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ ÑÑ€Ð¾ÐºÐ¾Ð² Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð½ÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ° 0,1% Ð·Ð° Ð´ÐµÐ½ÑŒ, Ð½Ð¾ Ð½Ðµ Ð±Ð¾Ð»ÐµÐµ 10%.",
                "keywords": ["Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ", "ÑˆÑ‚Ñ€Ð°Ñ„", "Ð½ÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ°", "Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹", "Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ°"],
                "risk_patterns": [
                    {"pattern": r"Ð½ÐµÑƒÑÑ‚Ð¾Ð¹Ðº\w*.*?Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº\w*.*?(?:0[,.]?[3-9]|[1-9])\s*%", "risk": "red", "issue": "ÐÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ° Ð´Ð»Ñ Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ° Ð²Ñ‹ÑˆÐµ 0.2% Ð² Ð´ÐµÐ½ÑŒ"},
                    {"pattern": r"ÑˆÑ‚Ñ€Ð°Ñ„.*?Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹.*?(?:[3-9]\d{3}|[1-9]\d{4})", "risk": "red", "issue": "Ð¨Ñ‚Ñ€Ð°Ñ„ Ð·Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð±Ð¾Ð»ÐµÐµ 2500 Ñ€ÑƒÐ±/ÑÑƒÑ‚ÐºÐ¸"},
                    {"pattern": r"(?:Ð¿Ð¾Ð»Ð½\w+|Ð½ÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½\w+).*?Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚.*?Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº", "risk": "red", "issue": "ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð°Ñ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°"}
                ]
            },
            "6. ÐšÐžÐÐ¤Ð˜Ð”Ð•ÐÐ¦Ð˜ÐÐ›Ð¬ÐÐžÐ¡Ð¢Ð¬": {
                "required": True,
                "template": "Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð¾Ð±ÑÐ·ÑƒÑŽÑ‚ÑÑ Ð½Ðµ Ñ€Ð°Ð·Ð³Ð»Ð°ÑˆÐ°Ñ‚ÑŒ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°. Ð¡Ñ€Ð¾Ðº ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ 3 Ð³Ð¾Ð´Ð°.",
                "keywords": ["ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ", "Ð½Ðµ Ñ€Ð°Ð·Ð³Ð»Ð°ÑˆÐ°Ñ‚ÑŒ", "ÐºÐ¾Ð¼Ð¼ÐµÑ€Ñ‡ÐµÑÐºÐ°Ñ Ñ‚Ð°Ð¹Ð½Ð°"],
                "risk_patterns": [
                    {"pattern": r"ÑˆÑ‚Ñ€Ð°Ñ„.*?ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚.*?(?:[5-9]|[1-9]\d)\s*(?:000\s*000|Ð¼Ð»Ð½)", "risk": "red", "issue": "Ð¨Ñ‚Ñ€Ð°Ñ„ Ð·Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð±Ð¾Ð»ÐµÐµ 5 Ð¼Ð»Ð½"}
                ]
            },
            "7. Ð¤ÐžÐ Ð¡-ÐœÐÐ–ÐžÐ ": {
                "required": True,
                "template": "ÐžÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸ Ð½ÐµÐ¿Ñ€ÐµÐ¾Ð´Ð¾Ð»Ð¸Ð¼Ð¾Ð¹ ÑÐ¸Ð»Ðµ.",
                "keywords": ["Ñ„Ð¾Ñ€Ñ-Ð¼Ð°Ð¶Ð¾Ñ€", "Ð½ÐµÐ¿Ñ€ÐµÐ¾Ð´Ð¾Ð»Ð¸Ð¼Ð°Ñ ÑÐ¸Ð»Ð°"],
                "risk_patterns": []
            },
            "8. Ð¡Ð ÐžÐš Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð¯ Ð˜ Ð ÐÐ¡Ð¢ÐžÐ Ð–Ð•ÐÐ˜Ð•": {
                "required": True,
                "template": "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾ Ð¸ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð². Ð Ð°ÑÑ‚Ð¾Ñ€Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸ÑŽ Ð¸Ð»Ð¸ Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð° 30 Ð´Ð½ÐµÐ¹.",
                "keywords": ["ÑÑ€Ð¾Ðº", "Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ", "Ñ€Ð°ÑÑ‚Ð¾Ñ€Ð¶ÐµÐ½Ð¸Ðµ", "ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ"],
                "risk_patterns": [
                    {"pattern": r"Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»\w+.*?Ð¾Ð´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½.*?Ñ€Ð°ÑÑ‚Ð¾Ñ€Ð³.*?(?:[1-9]|1[0-4])\s*Ð´Ð½", "risk": "red", "issue": "ÐžÐ´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ°Ð· Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»Ñ Ñ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¼ ÑÑ€Ð¾ÐºÐ¾Ð¼"},
                    {"pattern": r"Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐº\w+\s+(?:Ð¿Ñ€Ð¾Ð»Ð¾Ð½Ð³Ð°Ñ†|Ð¿Ñ€Ð¾Ð´Ð»ÐµÐ½)", "risk": "yellow", "issue": "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð»Ð¾Ð½Ð³Ð°Ñ†Ð¸Ñ"}
                ]
            },
            "9. Ð ÐÐ—Ð Ð•Ð¨Ð•ÐÐ˜Ð• Ð¡ÐŸÐžÐ ÐžÐ’": {
                "required": True,
                "template": "ÐŸÑ€ÐµÑ‚ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº 30 Ð´Ð½ÐµÐ¹. ÐÑ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ñ‹Ð¹ ÑÑƒÐ´ Ð³. ÐœÐ¾ÑÐºÐ²Ñ‹.",
                "keywords": ["ÑÐ¿Ð¾Ñ€Ñ‹", "Ð¿Ñ€ÐµÑ‚ÐµÐ½Ð·Ð¸Ñ", "Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ñ‹Ð¹", "Ð¼Ð¾ÑÐºÐ²Ð°"],
                "risk_patterns": [
                    {"pattern": r"(?:Ð¸Ð½Ð¾ÑÑ‚Ñ€Ð°Ð½Ð½|Ð·Ð°Ñ€ÑƒÐ±ÐµÐ¶Ð½)\w*.*?(?:ÑÑƒÐ´|Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶)", "risk": "red", "issue": "Ð˜Ð½Ð¾ÑÑ‚Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÑƒÐ´"}
                ]
            },
            "10. Ð Ð•ÐšÐ’Ð˜Ð—Ð˜Ð¢Ð«": {
                "required": True,
                "template": "Ð ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ ÑÑ‚Ð¾Ñ€Ð¾Ð½.",
                "keywords": ["Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹", "Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸"],
                "risk_patterns": []
            }
        },
        "global_risk_patterns": [
            {"pattern": r"Ð¾Ð´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½\w+.*?Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½\w+.*?(?:Ñ†ÐµÐ½|ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚|Ñ‚Ð°Ñ€Ð¸Ñ„)", "risk": "red", "issue": "ÐžÐ´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½ÐµÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½Ñ‹/Ñ‚Ð°Ñ€Ð¸Ñ„Ð°"},
            {"pattern": r"(?:usd|eur|ÐµÐ²Ñ€Ð¾|Ð´Ð¾Ð»Ð»Ð°Ñ€|Ð²Ð°Ð»ÑŽÑ‚)", "risk": "yellow", "issue": "Ð’Ð°Ð»ÑŽÑ‚Ð½Ð°Ñ Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÐ°"},
            {"pattern": r"Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†\w*.*?(?:Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐº|ÐµÐ¶ÐµÐ³Ð¾Ð´Ð½)", "risk": "yellow", "issue": "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ñ"}
        ]
    },
    
    "auto_transport": {
        "name": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ (Ð°Ð²Ñ‚Ð¾)",
        "code": "Ð¢Ð¤-Ð¡ÐŸÐš-ÐÐ’Ð¢-001",
        "version": "2023.1",
        "date": "01.01.2023",
        "description": "Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð² Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð°Ð²Ñ‚Ð¾Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð¼ (Ð°Ð³ÐµÐ½Ñ‚ÑÐºÐ°Ñ ÑÑ…ÐµÐ¼Ð°)",
        "sections": {
            "1. ÐŸÐ Ð•Ð”ÐœÐ•Ð¢ Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð": {
                "required": True,
                "template": "ÐŸÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸Ðº Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¾Ð±ÑÐ·Ð°Ð½Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð»Ð¸ Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑƒÑÐ»ÑƒÐ³Ð¸ Ð¿Ð¾ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐµ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð¼.",
                "keywords": ["Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚", "Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸Ðº", "Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº", "Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ°", "Ð°Ð²Ñ‚Ð¾Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚", "Ð³Ñ€ÑƒÐ·"],
                "risk_patterns": []
            },
            "2. ÐŸÐ ÐÐ’Ð Ð˜ ÐžÐ‘Ð¯Ð—ÐÐÐÐžÐ¡Ð¢Ð˜": {
                "required": True,
                "template": "ÐŸÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸Ðº Ð¿Ð¾Ð´Ð°ÐµÑ‚ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð¿Ð¾ Ð—Ð°ÑÐ²ÐºÐµ, Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ. Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð¿Ð¾Ð³Ñ€ÑƒÐ·ÐºÑƒ/Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÑƒ.",
                "keywords": ["Ð¿Ñ€Ð°Ð²Ð°", "Ð¾Ð±ÑÐ·Ð°Ð½Ð½Ð¾ÑÑ‚Ð¸", "Ð·Ð°ÑÐ²ÐºÐ°", "Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚", "Ð¿Ð¾Ð³Ñ€ÑƒÐ·ÐºÐ°", "Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ°"],
                "risk_patterns": [
                    {"pattern": r"Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº.*?(?:Ð½ÐµÑÐµÑ‚|Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚).*?(?:Ð²ÑÐµ|Ð»ÑŽÐ±Ñ‹Ðµ).*?Ñ€Ð¸ÑÐº", "risk": "red", "issue": "Ð’ÑÐµ Ñ€Ð¸ÑÐºÐ¸ Ð½Ð° Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐµ"}
                ]
            },
            "3. Ð¡Ð¢ÐžÐ˜ÐœÐžÐ¡Ð¢Ð¬ Ð˜ Ð ÐÐ¡Ð§Ð•Ð¢Ð«": {
                "required": True,
                "template": "Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ÑÑ Ð² Ð—Ð°ÑÐ²ÐºÐµ. ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 10 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹ Ð¿Ð¾ ÐÐºÑ‚Ñƒ.",
                "keywords": ["ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ", "Ð¾Ð¿Ð»Ð°Ñ‚Ð°", "Ñ€Ð°ÑÑ‡ÐµÑ‚", "Ð°ÐºÑ‚"],
                "risk_patterns": [
                    {"pattern": r"Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚\w*.*?(?:[4-9]\d|100)\s*%", "risk": "red", "issue": "ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð±Ð¾Ð»ÐµÐµ 30%"}
                ]
            },
            "4. ÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð•ÐÐÐžÐ¡Ð¢Ð¬": {
                "required": True,
                "template": "Ð—Ð° ÑƒÑ‚Ñ€Ð°Ñ‚Ñƒ/Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° ÐŸÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸Ðº Ð²Ð¾Ð·Ð¼ÐµÑ‰Ð°ÐµÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑƒÑ‰ÐµÑ€Ð±. ÐÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ° Ð·Ð° Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÑƒ 0,1% Ð² Ð´ÐµÐ½ÑŒ.",
                "keywords": ["Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ", "ÑƒÑ‚Ñ€Ð°Ñ‚Ð°", "Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ", "ÑƒÑ‰ÐµÑ€Ð±", "Ð½ÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ°"],
                "risk_patterns": [
                    {"pattern": r"Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸Ðº.*?Ð½Ðµ\s+(?:Ð½ÐµÑÐµÑ‚|Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚)", "risk": "red", "issue": "Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ ÐŸÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸ÐºÐ°"},
                    {"pattern": r"Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½\w+.*?Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚.*?(?:Ð¿Ñ€Ð¾Ð²Ð¾Ð·Ð½|Ñ‚Ð°Ñ€Ð¸Ñ„)", "risk": "yellow", "issue": "ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ð²Ð¾Ð·Ð½Ð¾Ð¹ Ð¿Ð»Ð°Ñ‚Ð¾Ð¹"}
                ]
            },
            "5. Ð¡Ð¢Ð ÐÐ¥ÐžÐ’ÐÐÐ˜Ð•": {
                "required": False,
                "template": "Ð¡Ñ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð¿Ð¾ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸ÑŽ ÑÑ‚Ð¾Ñ€Ð¾Ð½.",
                "keywords": ["ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ðµ", "ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²ÐºÐ°"],
                "risk_patterns": []
            },
            "6. Ð¡ÐŸÐžÐ Ð«": {
                "required": True,
                "template": "ÐÑ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ñ‹Ð¹ ÑÑƒÐ´ Ð³. ÐœÐ¾ÑÐºÐ²Ñ‹.",
                "keywords": ["ÑÐ¿Ð¾Ñ€Ñ‹", "Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ñ‹Ð¹"],
                "risk_patterns": []
            },
            "7. Ð Ð•ÐšÐ’Ð˜Ð—Ð˜Ð¢Ð«": {
                "required": True,
                "template": "Ð ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ ÑÑ‚Ð¾Ñ€Ð¾Ð½.",
                "keywords": ["Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹"],
                "risk_patterns": []
            }
        },
        "global_risk_patterns": []
    }
}

# Ð”ÐµÐ¼Ð¾-Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€
DEMO_CONTRACT = """Ð”ÐžÐ“ÐžÐ’ÐžÐ  ÐžÐšÐÐ—ÐÐÐ˜Ð¯ Ð£Ð¡Ð›Ð£Ð“ â„– 2025/Ð¢Ð­Ðž-001

Ð³. ÐœÐ¾ÑÐºÐ²Ð°                                                     Â«15Â» ÑÐ½Ð²Ð°Ñ€Ñ 2025 Ð³.

ÐžÐžÐž Â«Ð¢Ñ€Ð°Ð½ÑÐ›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÂ» (Ð˜ÐÐ 7707123456), Ð¸Ð¼ÐµÐ½ÑƒÐµÐ¼Ð¾Ðµ Ð² Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ¼ Â«Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÂ», Ð² Ð»Ð¸Ñ†Ðµ Ð“ÐµÐ½ÐµÑ€Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð° Ð¡Ð¸Ð´Ð¾Ñ€Ð¾Ð²Ð° Ð¡.Ð¡., Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð£ÑÑ‚Ð°Ð²Ð°, Ñ Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹, Ð¸
ÐÐºÑ†Ð¸Ð¾Ð½ÐµÑ€Ð½Ð¾Ðµ Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾ Â«Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ð¾Ñ‡Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑÂ» (ÐÐž Â«Ð¡ÐŸÐšÂ»), Ð¸Ð¼ÐµÐ½ÑƒÐµÐ¼Ð¾Ðµ Ð² Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ¼ Â«Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÂ», Ð² Ð»Ð¸Ñ†Ðµ Ð“ÐµÐ½ÐµÑ€Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð° ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð° ÐŸ.ÐŸ., Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð£ÑÑ‚Ð°Ð²Ð°, Ñ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹,
ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð½Ð¾ Ð¸Ð¼ÐµÐ½ÑƒÐµÐ¼Ñ‹Ðµ Â«Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ñ‹Â», Ð·Ð°ÐºÐ»ÑŽÑ‡Ð¸Ð»Ð¸ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€:

ÐŸÐžÐÐ¯Ð¢Ð˜Ð¯ Ð˜ Ð¢Ð•Ð ÐœÐ˜ÐÐ«
Â«Ð’Ð°Ð³Ð¾Ð½Ñ‹Â» - Ð¶ÐµÐ»ÐµÐ·Ð½Ð¾Ð´Ð¾Ñ€Ð¾Ð¶Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ð²Ð¸Ð¶Ð½Ð¾Ð¹ ÑÐ¾ÑÑ‚Ð°Ð².
Â«Ð“Ñ€ÑƒÐ·Â» - Ñ‚Ð¾Ð²Ð°Ñ€, ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ðº Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐµ.
Â«Ð—Ð°ÑÐ²ÐºÐ°Â» - ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸.

1. ÐŸÐ Ð•Ð”ÐœÐ•Ð¢ Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð

1.1. Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑƒÑÐ»ÑƒÐ³Ð¸ Ð¿Ð¾ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ Ð¶/Ð´ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð² Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°, Ð° Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¾ÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸.

2. ÐŸÐ ÐÐ’Ð Ð˜ ÐžÐ‘Ð¯Ð—ÐÐÐÐžÐ¡Ð¢Ð˜ Ð¡Ð¢ÐžÐ ÐžÐ

2.1. Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑÐ·Ð°Ð½ Ð¿Ð¾Ð´Ð°Ñ‚ÑŒ Ð²Ð°Ð³Ð¾Ð½Ñ‹ Ð¿Ð¾ Ð—Ð°ÑÐ²ÐºÐµ Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°.
2.2. Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº Ð½ÐµÑÐµÑ‚ Ð²ÑÐµ Ñ€Ð¸ÑÐºÐ¸, ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð².

3. Ð¡Ð¢ÐžÐ˜ÐœÐžÐ¡Ð¢Ð¬ Ð£Ð¡Ð›Ð£Ð“ Ð˜ ÐŸÐžÐ Ð¯Ð”ÐžÐš Ð ÐÐ¡Ð§Ð•Ð¢ÐžÐ’

3.1. Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ ÑƒÑÐ»ÑƒÐ³: 8 500 000 (Ð’Ð¾ÑÐµÐ¼ÑŒ Ð¼Ð¸Ð»Ð»Ð¸Ð¾Ð½Ð¾Ð² Ð¿ÑÑ‚ÑŒÑÐ¾Ñ‚ Ñ‚Ñ‹ÑÑÑ‡) Ñ€ÑƒÐ±Ð»ÐµÐ¹ Ð² Ð³Ð¾Ð´.
3.2. ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð² Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ 50% Ð¾Ñ‚ ÑÑƒÐ¼Ð¼Ñ‹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°.
3.3. ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 3 ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ñ… Ð´Ð½ÐµÐ¹ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‡ÐµÑ‚Ð°.
3.4. Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð²Ð¿Ñ€Ð°Ð²Ðµ Ð² Ð¾Ð´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½ÐµÐ¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ Ð¸Ð·Ð¼ÐµÐ½ÑÑ‚ÑŒ Ñ‚Ð°Ñ€Ð¸Ñ„Ñ‹ Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð° 10 Ð´Ð½ÐµÐ¹.

4. ÐŸÐžÐ Ð¯Ð”ÐžÐš ÐŸÐ Ð˜Ð•ÐœÐšÐ˜

4.1. ÐÐºÑ‚ Ð¾ÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑÐ»ÑƒÐ³ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 2 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹.

5. ÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð•ÐÐÐžÐ¡Ð¢Ð¬

5.1. Ð—Ð° ÑÐ²ÐµÑ€Ñ…Ð½Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð² ÑˆÑ‚Ñ€Ð°Ñ„ 5 000 Ñ€ÑƒÐ±Ð»ÐµÐ¹ Ð·Ð° Ð²Ð°Ð³Ð¾Ð½Ð¾-ÑÑƒÑ‚ÐºÐ¸.
5.2. Ð—Ð° Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ ÑÑ€Ð¾ÐºÐ¾Ð² Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð½ÐµÑƒÑÑ‚Ð¾Ð¹ÐºÐ° 0,5% Ð·Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ¸.
5.3. ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ° Ð·Ð° Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð²Ð°Ð³Ð¾Ð½Ð¾Ð².
5.4. Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½ÐµÑÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð·Ð° ÐºÐ¾ÑÐ²ÐµÐ½Ð½Ñ‹Ðµ ÑƒÐ±Ñ‹Ñ‚ÐºÐ¸.

6. ÐšÐžÐÐ¤Ð˜Ð”Ð•ÐÐ¦Ð˜ÐÐ›Ð¬ÐÐžÐ¡Ð¢Ð¬

6.1. Ð¡Ñ€Ð¾Ðº ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸: Ð±ÐµÑÑÑ€Ð¾Ñ‡Ð½Ð¾.
6.2. Ð¨Ñ‚Ñ€Ð°Ñ„ Ð·Ð° Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸: 15 000 000 Ñ€ÑƒÐ±Ð»ÐµÐ¹.

7. Ð¤ÐžÐ Ð¡-ÐœÐÐ–ÐžÐ 

7.1. Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð½ÐµÐ¿Ñ€ÐµÐ¾Ð´Ð¾Ð»Ð¸Ð¼Ð¾Ð¹ ÑÐ¸Ð»Ðµ.

8. Ð¡Ð ÐžÐš Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð¯

8.1. Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾ 31.12.2025.
8.2. Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð²Ð¿Ñ€Ð°Ð²Ðµ Ñ€Ð°ÑÑ‚Ð¾Ñ€Ð³Ð½ÑƒÑ‚ÑŒ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð² Ð¾Ð´Ð½Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½ÐµÐ¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ, ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð¸Ð² Ð·Ð° 5 Ð´Ð½ÐµÐ¹.
8.3. Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¾Ð»Ð¾Ð½Ð³Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð³Ð¾Ð´.

9. Ð ÐÐ—Ð Ð•Ð¨Ð•ÐÐ˜Ð• Ð¡ÐŸÐžÐ ÐžÐ’

9.1. Ð’ÑÐµ ÑÐ¿Ð¾Ñ€Ñ‹ Ð² ÐœÐµÐ¶Ð´ÑƒÐ½Ð°Ñ€Ð¾Ð´Ð½Ð¾Ð¼ ÐºÐ¾Ð¼Ð¼ÐµÑ€Ñ‡ÐµÑÐºÐ¾Ð¼ Ð°Ñ€Ð±Ð¸Ñ‚Ñ€Ð°Ð¶Ð½Ð¾Ð¼ ÑÑƒÐ´Ðµ.

10. Ð Ð•ÐšÐ’Ð˜Ð—Ð˜Ð¢Ð«

Ð—ÐÐšÐÐ—Ð§Ð˜Ðš:                              Ð˜Ð¡ÐŸÐžÐ›ÐÐ˜Ð¢Ð•Ð›Ð¬:
ÐÐž Â«Ð¡ÐŸÐšÂ»                               ÐžÐžÐž Â«Ð¢Ñ€Ð°Ð½ÑÐ›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÂ»
Ð˜ÐÐ 7708654321                         Ð˜ÐÐ 7707123456

___________/ÐŸÐµÑ‚Ñ€Ð¾Ð² ÐŸ.ÐŸ./               ___________/Ð¡Ð¸Ð´Ð¾Ñ€Ð¾Ð² Ð¡.Ð¡./
"""

# ============================================================================
# Ð—ÐÐ“Ð Ð£Ð—Ð§Ð˜Ðš Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢ÐžÐ’
# ============================================================================

class DocumentLoader:
    @staticmethod
    def load_txt(content: bytes) -> str:
        for enc in ['utf-8', 'cp1251', 'cp866', 'latin-1', 'koi8-r']:
            try:
                text = content.decode(enc)
                if re.search(r'[Ð°-ÑÐ-Ð¯Ñ‘Ða-zA-Z]', text):
                    return text
            except:
                continue
        return content.decode('utf-8', errors='replace')
    
    @staticmethod
    def load_docx(content: bytes) -> Tuple[bool, str]:
        if not DOCX_AVAILABLE:
            return False, "âŒ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ python-docx: pip install python-docx"
        try:
            doc = DocxDocument(io.BytesIO(content))
            parts = []
            for para in doc.paragraphs:
                if para.text.strip():
                    parts.append(para.text.strip())
            for table in doc.tables:
                for row in table.rows:
                    row_texts = [c.text.strip() for c in row.cells if c.text.strip()]
                    if row_texts:
                        parts.append(' | '.join(row_texts))
            result = '\n'.join(parts)
            return (True, result) if result.strip() else (False, "âŒ Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð¿ÑƒÑÑ‚Ð¾Ð¹")
        except Exception as e:
            return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° DOCX: {e}"
    
    @staticmethod
    def load_pdf(content: bytes) -> Tuple[bool, str]:
        if not PDF_READER_AVAILABLE:
            return False, "âŒ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ PyPDF2: pip install PyPDF2"
        try:
            reader = PdfReader(io.BytesIO(content))
            parts = [page.extract_text().strip() for page in reader.pages if page.extract_text()]
            result = '\n'.join(parts)
            return (True, result) if result.strip() else (False, "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ñ‚ÐµÐºÑÑ‚")
        except Exception as e:
            return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° PDF: {e}"
    
    @classmethod
    def load_file(cls, uploaded_file) -> Tuple[bool, str]:
        if not uploaded_file:
            return False, "âŒ Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½"
        try:
            content = uploaded_file.read()
            filename = uploaded_file.name.lower()
            if filename.endswith('.txt'):
                return True, cls.load_txt(content)
            elif filename.endswith('.docx'):
                return cls.load_docx(content)
            elif filename.endswith('.doc'):
                return False, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ .doc Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ ÐºÐ°Ðº .docx"
            elif filename.endswith('.pdf'):
                return cls.load_pdf(content)
            return False, "âŒ ÐÐµÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚"
        except Exception as e:
            return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}"
    
    @classmethod
    def parse_typical_form(cls, text: str, name: str) -> Dict:
        sections = {}
        current_section, current_content = None, []
        patterns = [r'^(\d+)\.\s*([Ð-Ð¯ÐA-Z][Ð-Ð¯ÐA-Z\s\-]+)', r'^(Ð ÐÐ—Ð”Ð•Ð›\s+\d+)[.\s]+(.+)']
        
        for line in text.split('\n'):
            line = line.strip()
            if not line:
                continue
            found = False
            for pattern in patterns:
                match = re.match(pattern, line, re.IGNORECASE)
                if match:
                    if current_section and current_content:
                        section_text = '\n'.join(current_content).strip()
                        if section_text:
                            sections[current_section] = {
                                "required": True,
                                "template": section_text[:500],
                                "keywords": cls._extract_keywords(section_text),
                                "risk_patterns": []
                            }
                    current_section = f"{match.group(1)}. {match.group(2)}".strip().upper()
                    current_content = []
                    found = True
                    break
            if not found and current_section:
                current_content.append(line)
        
        if current_section and current_content:
            section_text = '\n'.join(current_content).strip()
            if section_text:
                sections[current_section] = {
                    "required": True,
                    "template": section_text[:500],
                    "keywords": cls._extract_keywords(section_text),
                    "risk_patterns": []
                }
        
        if not sections:
            sections["ÐžÐ‘Ð©Ð˜Ð• Ð£Ð¡Ð›ÐžÐ’Ð˜Ð¯"] = {
                "required": True,
                "template": text[:1000],
                "keywords": cls._extract_keywords(text),
                "risk_patterns": []
            }
        
        return {
            "name": name,
            "code": f"USER-{hashlib.md5(name.encode()).hexdigest()[:6].upper()}",
            "version": "1.0",
            "date": datetime.now().strftime("%d.%m.%Y"),
            "description": f"Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð°: {name}",
            "sections": sections,
            "global_risk_patterns": []
        }
    
    @staticmethod
    def _extract_keywords(text: str, max_kw: int = 15) -> List[str]:
        text_clean = re.sub(r'[^\w\sÐ°-ÑÑ‘Ð-Ð¯Ð]', ' ', text.lower())
        words = text_clean.split()
        stop = {'Ð¸', 'Ð²', 'Ð½Ð°', 'Ð¿Ð¾', 'Ñ', 'Ðº', 'Ð¾', 'Ð¾Ñ‚', 'Ð¸Ð·', 'Ð·Ð°', 'Ð´Ð»Ñ', 'Ð½Ðµ', 'Ñ‡Ñ‚Ð¾', 'ÐºÐ°Ðº', 'ÑÑ‚Ð¾', 'Ð²ÑÐµ', 'Ð¸Ð»Ð¸', 'Ð¿Ñ€Ð¸', 'Ð´Ð¾', 'Ð±ÐµÐ·', 'ÐµÐ³Ð¾', 'ÐµÑ‘', 'Ð¸Ñ…', 'Ð°', 'Ð½Ð¾', 'Ð´Ð°', 'Ð¶Ðµ', 'Ð»Ð¸', 'Ð±Ñ‹', 'Ñ‚Ð¾', 'Ð½Ð¸', 'Ñ‚Ð°ÐºÐ¶Ðµ', 'Ð¼ÐµÐ¶Ð´Ñƒ'}
        counts = Counter(w for w in words if len(w) > 3 and w not in stop)
        return [w for w, _ in counts.most_common(max_kw)]

# ============================================================================
# ÐÐ›Ð“ÐžÐ Ð˜Ð¢Ðœ Ð¡Ð ÐÐ’ÐÐ•ÐÐ˜Ð¯ (RAG-Ð¿Ð¾Ð´Ð¾Ð±Ð½Ñ‹Ð¹)
# ============================================================================

class AdvancedComparator:
    STOP_WORDS = {'Ð¸', 'Ð²', 'Ð½Ð°', 'Ð¿Ð¾', 'Ñ', 'Ðº', 'Ð¾', 'Ð¾Ñ‚', 'Ð¸Ð·', 'Ð·Ð°', 'Ð´Ð»Ñ', 'Ð½Ðµ', 'Ñ‡Ñ‚Ð¾', 'ÐºÐ°Ðº', 'ÑÑ‚Ð¾', 'Ð²ÑÐµ', 'Ð¸Ð»Ð¸', 'Ð¿Ñ€Ð¸', 'Ð´Ð¾', 'Ð±ÐµÐ·'}
    
    @classmethod
    def tokenize(cls, text: str) -> List[str]:
        if not text: return []
        text = re.sub(r'[^\w\sÐ°-ÑÑ‘Ð-Ð¯Ð]', ' ', text.lower())
        return [t for t in text.split() if len(t) > 2 and t not in cls.STOP_WORDS]
    
    @classmethod
    def get_ngrams(cls, tokens: List[str], n: int = 2) -> Set[Tuple]:
        if len(tokens) < n: return set()
        return set(tuple(tokens[i:i+n]) for i in range(len(tokens) - n + 1))
    
    @classmethod
    def jaccard(cls, s1: Set, s2: Set) -> float:
        if not s1 or not s2: return 0.0
        return len(s1 & s2) / len(s1 | s2)
    
    @classmethod
    def levenshtein_ratio(cls, s1: str, s2: str) -> float:
        if not s1 or not s2: return 0.0
        return difflib.SequenceMatcher(None, s1.lower()[:2000], s2.lower()[:2000]).ratio()
    
    @classmethod
    def compute_tf(cls, tokens: List[str]) -> Dict[str, float]:
        if not tokens: return {}
        counter = Counter(tokens)
        total = len(tokens)
        return {k: v / total for k, v in counter.items()}
    
    @classmethod
    def compute_idf(cls, docs: List[List[str]]) -> Dict[str, float]:
        if not docs: return {}
        n = len(docs)
        df = Counter()
        for doc in docs:
            for t in set(doc):
                df[t] += 1
        return {t: math.log((n + 1) / (c + 1)) + 1 for t, c in df.items()}
    
    @classmethod
    def cosine(cls, v1: Dict[str, float], v2: Dict[str, float]) -> float:
        if not v1 or not v2: return 0.0
        keys = set(v1.keys()) | set(v2.keys())
        dot = sum(v1.get(k, 0) * v2.get(k, 0) for k in keys)
        n1, n2 = math.sqrt(sum(v ** 2 for v in v1.values())), math.sqrt(sum(v ** 2 for v in v2.values()))
        return dot / (n1 * n2) if n1 > 0 and n2 > 0 else 0.0
    
    @classmethod
    def keyword_match(cls, text: str, keywords: List[str]) -> Tuple[float, List[str]]:
        if not keywords: return 1.0, []
        text_lower = text.lower()
        matched = [kw for kw in keywords if kw.lower() in text_lower]
        return len(matched) / len(keywords), matched
    
    @classmethod
    def extract_sections(cls, text: str) -> Dict[str, str]:
        sections = {}
        patterns = [r'^(\d+)\.\s*([Ð-Ð¯ÐA-Z][Ð-Ð¯ÐA-Z\s\-]+)', r'^(Ð ÐÐ—Ð”Ð•Ð›\s+\d+)[.\s]+(.+)']
        lines = text.split('\n')
        current_section, current_content = "ÐŸÐ Ð•ÐÐœÐ‘Ð£Ð›Ð", []
        
        for line in lines:
            line = line.strip()
            found = False
            for pattern in patterns:
                match = re.match(pattern, line, re.IGNORECASE)
                if match:
                    if current_content:
                        sections[current_section] = '\n'.join(current_content).strip()
                    current_section = f"{match.group(1)}. {match.group(2)}".strip().upper()
                    current_content = [line]
                    found = True
                    break
            if not found:
                current_content.append(line)
        if current_content:
            sections[current_section] = '\n'.join(current_content).strip()
        return sections
    
    @classmethod
    def compare_section(cls, contract_section: str, template: str, keywords: List[str]) -> Dict:
        result = {"found": False, "combined_score": 0, "status": "missing", "matched_keywords": [], "missing_keywords": []}
        if not contract_section: return result
        result["found"] = True
        
        ct, tt = cls.tokenize(contract_section), cls.tokenize(template)
        if not ct: return result
        
        cs, ts = set(ct), set(tt)
        jaccard = cls.jaccard(cs, ts)
        jaccard_bi = cls.jaccard(cls.get_ngrams(ct), cls.get_ngrams(tt))
        lev = cls.levenshtein_ratio(contract_section, template)
        
        cosine_score = 0.5
        if tt:
            idf = cls.compute_idf([ct, tt])
            ct_tf, tt_tf = cls.compute_tf(ct), cls.compute_tf(tt)
            ct_tfidf = {k: ct_tf.get(k, 0) * idf.get(k, 1) for k in cs}
            tt_tfidf = {k: tt_tf.get(k, 0) * idf.get(k, 1) for k in ts}
            cosine_score = cls.cosine(ct_tfidf, tt_tfidf)
        
        kw_score, matched = cls.keyword_match(contract_section, keywords)
        result["matched_keywords"] = matched
        result["missing_keywords"] = [k for k in keywords if k not in matched]
        
        combined = jaccard * 0.15 + jaccard_bi * 0.20 + lev * 0.20 + cosine_score * 0.20 + kw_score * 0.25
        result["combined_score"] = round(combined, 3)
        result["status"] = "match" if combined >= 0.65 else "partial" if combined >= 0.35 else "deviation"
        return result
    
    @classmethod
    def find_best_section(cls, section_name: str, contract_sections: Dict[str, str], template: str, keywords: List[str]) -> Tuple[Optional[str], Dict]:
        best_match, best_result, best_score = None, None, -1
        section_norm = re.sub(r'^\d+\.\s*', '', section_name).lower().strip()
        
        for cn, ct in contract_sections.items():
            cn_norm = re.sub(r'^\d+\.\s*', '', cn).lower().strip()
            name_sim = cls.levenshtein_ratio(section_norm, cn_norm)
            comp = cls.compare_section(ct, template, keywords)
            total = comp["combined_score"] * 0.7 + name_sim * 0.3
            
            if total > best_score:
                best_score = total
                best_match = cn
                best_result = comp.copy()
                best_result["matched_section_name"] = cn
        
        return best_match, best_result or {"found": False, "combined_score": 0, "status": "missing"}
    
    @classmethod
    def check_risks(cls, text: str, patterns: List[Dict]) -> List[Dict]:
        found = []
        text_lower = text.lower()
        for p in patterns:
            try:
                match = re.search(p["pattern"], text_lower, re.IGNORECASE | re.DOTALL)
                if match:
                    start, end = max(0, match.start() - 100), min(len(text_lower), match.end() + 100)
                    context = text_lower[start:end].replace('\n', ' ').strip()
                    found.append({
                        "issue": p.get("issue", "Ð Ð¸ÑÐº"),
                        "risk_level": p.get("risk", "yellow"),
                        "context": f"...{context}...",
                        "position": match.start()
                    })
            except re.error:
                continue
        return found
    
    @classmethod
    def full_comparison(cls, contract_text: str, tf: Dict) -> Dict:
        result = {
            "form_name": tf.get("name", "Ð¢Ð¤"),
            "form_code": tf.get("code", ""),
            "sections_analysis": [],
            "missing_sections": [],
            "found_sections": [],
            "partial_sections": [],
            "deviation_sections": [],
            "risks": [],
            "compliance_score": 0,
            "recommendations": [],
            "summary": ""
        }
        
        contract_sections = cls.extract_sections(contract_text)
        total_score, total_weight = 0, 0
        
        for section_name, section_data in tf.get("sections", {}).items():
            is_required = section_data.get("required", False)
            weight = 2.0 if is_required else 1.0
            total_weight += weight
            
            matched_name, comp = cls.find_best_section(section_name, contract_sections, section_data.get("template", ""), section_data.get("keywords", []))
            section_result = {"section_name": section_name, "required": is_required, "matched_in_contract": matched_name, "comparison": comp, "risks": []}
            
            if matched_name and contract_sections.get(matched_name):
                section_risks = cls.check_risks(contract_sections[matched_name], section_data.get("risk_patterns", []))
                section_result["risks"] = section_risks
                result["risks"].extend(section_risks)
            
            if comp.get("found") and comp.get("status") != "missing":
                status = comp.get("status", "deviation")
                if status == "match":
                    result["found_sections"].append(section_name)
                    total_score += weight
                elif status == "partial":
                    result["partial_sections"].append(section_name)
                    total_score += weight * 0.6
                else:
                    result["deviation_sections"].append(section_name)
                    total_score += weight * 0.3
                    result["recommendations"].append(f"âš ï¸ Ð Ð°Ð·Ð´ÐµÐ» Â«{section_name}Â» Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚ Ð¢Ð¤")
            else:
                result["missing_sections"].append(section_name)
                if is_required:
                    result["recommendations"].append(f"âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð´ÐµÐ» Â«{section_name}Â»")
            
            result["sections_analysis"].append(section_result)
        
        # Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸
        global_risks = cls.check_risks(contract_text, tf.get("global_risk_patterns", []))
        result["risks"].extend(global_risks)
        
        # Ð Ð°ÑÑ‡Ñ‘Ñ‚ ÑÐºÐ¾Ñ€Ð°
        red_count = sum(1 for r in result["risks"] if r.get("risk_level") == "red")
        yellow_count = sum(1 for r in result["risks"] if r.get("risk_level") == "yellow")
        risk_penalty = red_count * 15 + yellow_count * 5
        
        if total_weight > 0:
            base_score = (total_score / total_weight) * 100
            result["compliance_score"] = max(0, min(100, base_score - risk_penalty))
        
        if result["compliance_score"] >= 75:
            result["summary"] = "âœ… Ð’Ñ‹ÑÐ¾ÐºÐ¾Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ðµ."
        elif result["compliance_score"] >= 50:
            result["summary"] = "âš ï¸ Ð§Ð°ÑÑ‚Ð¸Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ. Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°."
        elif result["compliance_score"] >= 25:
            result["summary"] = "ðŸ”¶ Ð—Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð¢Ð¤."
        else:
            result["summary"] = "âŒ Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ñ. Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ð¾Ð»Ð½Ð°Ñ ÑÐºÑÐ¿ÐµÑ€Ñ‚Ð¸Ð·Ð° Ð®Ð”."
        
        return result

# ============================================================================
# AI ÐÐÐÐ›Ð˜Ð—ÐÐ¢ÐžÐ  (Ð¼ÑƒÐ»ÑŒÑ‚Ð¸Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€)
# ============================================================================

class AIAnalyzer:
    @classmethod
    def generate_prompt(cls, contract_text: str, comparison: Dict, org_config: Dict) -> str:
        risks_text = "\n".join([f"- {'ðŸ”´' if r.get('risk_level')=='red' else 'ðŸŸ¡'}: {r.get('issue','')}" for r in comparison.get("risks", [])[:10]]) or "ÐÐµ Ð²Ñ‹ÑÐ²Ð»ÐµÐ½Ñ‹"
        org_name = org_config.get("short_name", "ÐÐž Â«Ð¡ÐŸÐšÂ»")
        
        return f"""Ð¢Ñ‹ â€” Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¹ ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑŽÑ€Ð¸ÑÑ‚ Ð¶ÐµÐ»ÐµÐ·Ð½Ð¾Ð´Ð¾Ñ€Ð¾Ð¶Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸.
ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð´Ð»Ñ {org_name}. ÐœÑ‹ Ð²Ñ‹ÑÑ‚ÑƒÐ¿Ð°ÐµÐ¼ ÐºÐ°Ðº Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº/ÐŸÐ¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»ÑŒ.

Ð”ÐžÐ“ÐžÐ’ÐžÐ  (Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚):
{contract_text[:6000]}

Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ“Ðž ÐÐÐÐ›Ð˜Ð—Ð:
- Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ðµ: {comparison.get('compliance_score', 0):.0f}%
- ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»Ñ‹: {', '.join(comparison.get('missing_sections', [])[:5]) or 'ÐÐµÑ‚'}
- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ñ‹ÑÐ²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ€Ð¸ÑÐºÐ¾Ð²: {len(comparison.get('risks', []))}

Ð’Ð«Ð¯Ð’Ð›Ð•ÐÐÐ«Ð• Ð Ð˜Ð¡ÐšÐ˜:
{risks_text}

Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ ÑŽÑ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ:

## 1. ÐšÐ ÐÐ¢ÐšÐžÐ• Ð Ð•Ð—Ð®ÐœÐ• (2-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)

## 2. ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð Ð˜Ð¡ÐšÐ˜
Ð£ÑÐ»Ð¾Ð²Ð¸Ñ, ÑÐ¾Ð·Ð´Ð°ÑŽÑ‰Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸ Ð´Ð»Ñ {org_name}.

## 3. Ð¢Ð Ð•Ð‘Ð£Ð®Ð©Ð˜Ð• ÐšÐžÐ Ð Ð•ÐšÐ¢Ð˜Ð ÐžÐ’ÐšÐ˜
Ð£ÑÐ»Ð¾Ð²Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ.

## 4. Ð Ð•ÐšÐžÐœÐ•ÐÐ”ÐÐ¦Ð˜Ð˜
ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ð° Ñ€Ð°Ð·Ð½Ð¾Ð³Ð»Ð°ÑÐ¸Ð¹.

## 5. Ð˜Ð¢ÐžÐ“ÐžÐ’ÐžÐ• Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð•
Ð¡ÐžÐ“Ð›ÐÐ¡ÐžÐ’ÐÐ¢Ð¬ / Ð”ÐžÐ ÐÐ‘ÐžÐ¢ÐÐ¢Ð¬ / ÐžÐ¢ÐšÐ›ÐžÐÐ˜Ð¢Ð¬

ÐŸÐ¸ÑˆÐ¸ ÐºÑ€Ð°Ñ‚ÐºÐ¾, Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ."""
    
    @classmethod
    def test_api_key(cls, provider: str, api_key: str, folder_id: str = "") -> Tuple[bool, str]:
        """ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ API ÐºÐ»ÑŽÑ‡Ð°"""
        if not api_key:
            return False, "API ÐºÐ»ÑŽÑ‡ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"
        
        try:
            import requests
            
            if provider == "openai":
                response = requests.get(
                    "https://api.openai.com/v1/models",
                    headers={"Authorization": f"Bearer {api_key}"},
                    timeout=10
                )
                if response.status_code == 200:
                    return True, "âœ… OpenAI API ÐºÐ»ÑŽÑ‡ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
                return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {response.status_code}"
            
            elif provider == "anthropic":
                response = requests.post(
                    "https://api.anthropic.com/v1/messages",
                    headers={"x-api-key": api_key, "Content-Type": "application/json", "anthropic-version": "2023-06-01"},
                    json={"model": "claude-3-haiku-20240307", "max_tokens": 10, "messages": [{"role": "user", "content": "Hi"}]},
                    timeout=15
                )
                if response.status_code in [200, 400]:  # 400 = valid key but invalid request
                    return True, "âœ… Anthropic API ÐºÐ»ÑŽÑ‡ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
                return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {response.status_code}"
            
            elif provider == "gigachat":
                # GigaChat Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ OAuth Ñ‚Ð¾ÐºÐµÐ½
                return True, "âš ï¸ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° OAuth Ñ‚Ð¾ÐºÐµÐ½Ð° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
            
            elif provider == "yandexgpt":
                if not folder_id:
                    return False, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Folder ID Ð´Ð»Ñ YandexGPT"
                response = requests.post(
                    "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                    headers={"Authorization": f"Api-Key {api_key}", "Content-Type": "application/json"},
                    json={"modelUri": f"gpt://{folder_id}/yandexgpt-lite", "completionOptions": {"stream": False, "maxTokens": 10}, "messages": [{"role": "user", "text": "ÐŸÑ€Ð¸Ð²ÐµÑ‚"}]},
                    timeout=15
                )
                if response.status_code == 200:
                    return True, "âœ… YandexGPT API ÐºÐ»ÑŽÑ‡ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
                return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {response.status_code}"
            
            elif provider == "mistral":
                response = requests.get(
                    "https://api.mistral.ai/v1/models",
                    headers={"Authorization": f"Bearer {api_key}"},
                    timeout=10
                )
                if response.status_code == 200:
                    return True, "âœ… Mistral API ÐºÐ»ÑŽÑ‡ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
                return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {response.status_code}"
            
            elif provider == "perplexity":
                response = requests.post(
                    "https://api.perplexity.ai/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={"model": "llama-3.1-sonar-small-128k-online", "messages": [{"role": "user", "content": "Hi"}], "max_tokens": 10},
                    timeout=15
                )
                if response.status_code == 200:
                    return True, "âœ… Perplexity API ÐºÐ»ÑŽÑ‡ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
                return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {response.status_code}"
            
            return False, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€"
        
        except requests.exceptions.Timeout:
            return False, "âŒ Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ"
        except Exception as e:
            return False, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {str(e)}"
    
    @classmethod
    def call_provider(cls, provider: str, prompt: str, api_key: str, folder_id: str = "") -> Tuple[bool, str]:
        """Ð’Ñ‹Ð·Ð¾Ð² AI Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°"""
        try:
            import requests
            
            if provider == "openai":
                response = requests.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={
                        "model": "gpt-4o-mini",
                        "messages": [
                            {"role": "system", "content": "Ð¢Ñ‹ Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¹ ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑŽÑ€Ð¸ÑÑ‚. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ."},
                            {"role": "user", "content": prompt}
                        ],
                        "max_tokens": 4000,
                        "temperature": 0.3
                    },
                    timeout=90
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"ÐžÑˆÐ¸Ð±ÐºÐ° OpenAI: {response.status_code}"
            
            elif provider == "anthropic":
                response = requests.post(
                    "https://api.anthropic.com/v1/messages",
                    headers={"x-api-key": api_key, "Content-Type": "application/json", "anthropic-version": "2023-06-01"},
                    json={
                        "model": "claude-3-haiku-20240307",
                        "max_tokens": 4000,
                        "messages": [{"role": "user", "content": prompt}]
                    },
                    timeout=90
                )
                if response.status_code == 200:
                    return True, response.json()["content"][0]["text"]
                return False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Anthropic: {response.status_code}"
            
            elif provider == "gigachat":
                # GigaChat Ñ‡ÐµÑ€ÐµÐ· Bearer Ñ‚Ð¾ÐºÐµÐ½
                response = requests.post(
                    "https://gigachat.devices.sberbank.ru/api/v1/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={
                        "model": "GigaChat",
                        "messages": [{"role": "user", "content": prompt}],
                        "max_tokens": 4000
                    },
                    timeout=90,
                    verify=False  # Ð¡Ð±ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÐ²Ð¾Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"ÐžÑˆÐ¸Ð±ÐºÐ° GigaChat: {response.status_code}"
            
            elif provider == "yandexgpt":
                if not folder_id:
                    return False, "Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Folder ID"
                response = requests.post(
                    "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                    headers={"Authorization": f"Api-Key {api_key}", "Content-Type": "application/json"},
                    json={
                        "modelUri": f"gpt://{folder_id}/yandexgpt-lite",
                        "completionOptions": {"stream": False, "maxTokens": 4000, "temperature": 0.3},
                        "messages": [{"role": "user", "text": prompt}]
                    },
                    timeout=90
                )
                if response.status_code == 200:
                    return True, response.json()["result"]["alternatives"][0]["message"]["text"]
                return False, f"ÐžÑˆÐ¸Ð±ÐºÐ° YandexGPT: {response.status_code}"
            
            elif provider == "mistral":
                response = requests.post(
                    "https://api.mistral.ai/v1/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={
                        "model": "mistral-small-latest",
                        "messages": [{"role": "user", "content": prompt}],
                        "max_tokens": 4000
                    },
                    timeout=90
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Mistral: {response.status_code}"
            
            elif provider == "perplexity":
                response = requests.post(
                    "https://api.perplexity.ai/chat/completions",
                    headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
                    json={
                        "model": "llama-3.1-sonar-small-128k-online",
                        "messages": [{"role": "user", "content": prompt}],
                        "max_tokens": 4000
                    },
                    timeout=90
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Perplexity: {response.status_code}"
            
            return False, "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€"
        
        except Exception as e:
            return False, f"ÐžÑˆÐ¸Ð±ÐºÐ°: {str(e)}"

# ============================================================================
# Ð“Ð•ÐÐ•Ð ÐÐ¢ÐžÐ  ÐžÐ¢Ð§Ð•Ð¢ÐžÐ’
# ============================================================================

class ReportGenerator:
    @classmethod
    def generate_text_report(cls, data: Dict, user: Dict, org: Dict, ai: str = "") -> str:
        zone_names = {"green": "Ð—Ð•Ð›Ð•ÐÐÐ¯", "yellow": "Ð–Ð•Ð›Ð¢ÐÐ¯", "red": "ÐšÐ ÐÐ¡ÐÐÐ¯"}
        zone = data.get("zone", "")
        org_name = org.get("short_name", "ÐÐž Â«Ð¡ÐŸÐšÂ»")
        
        report = f"""{'='*70}
Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð• Ð®Ð Ð˜Ð”Ð˜Ð§Ð•Ð¡ÐšÐžÐ“Ðž Ð”Ð•ÐŸÐÐ Ð¢ÐÐœÐ•ÐÐ¢Ð
{org.get("full_name", org_name)}
{'='*70}
Ð”Ð°Ñ‚Ð°: {datetime.now().strftime('%d.%m.%Y %H:%M')}
ID: {data.get('analysis_id', '')}
Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ: {user.get('name', '')}, {user.get('position', '')}

{'-'*70}
1. ÐžÐ‘Ð©Ð˜Ð• Ð¡Ð’Ð•Ð”Ð•ÐÐ˜Ð¯ Ðž Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð•
{'-'*70}
ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚: {data.get('counterparty', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½')}
ÐÐ¾Ð¼ÐµÑ€ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°: {data.get('contract_number', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½')}
Ð”Ð°Ñ‚Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°: {data.get('contract_date', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°')}
Ð¢Ð¸Ð¿ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°: {data.get('contract_type', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½')}
Ð¡ÑƒÐ¼Ð¼Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°: {data.get('amount', 0):,.2f} Ñ€ÑƒÐ±.
Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ Ð®Ð”: {data.get('legal_status_label', '')}

{'-'*70}
2. Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« ÐÐÐÐ›Ð˜Ð—Ð
{'-'*70}
Ð—ÐžÐÐ Ð Ð˜Ð¡ÐšÐ: {zone_names.get(zone, 'ÐÐ• ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ')}
Ð Ð˜Ð¡Ðš-Ð¡ÐšÐžÐ : {data.get('risk_score', 0):.1f} / 10
Ð¡ÐžÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð˜Ð• Ð¢Ð˜ÐŸÐžÐ’ÐžÐ™ Ð¤ÐžÐ ÐœÐ•: {data.get('compliance_score', 0):.1f}%
Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑƒÑ‡Ð°ÑÑ‚Ð¸Ðµ Ð®Ð”: {'Ð”Ð' if data.get('requires_legal') else 'ÐÐ•Ð¢'}
Ð¡Ñ€Ð¾Ðº ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ: {data.get('deadline_days', 0)} Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹

{'-'*70}
3. Ð’Ð«Ð¯Ð’Ð›Ð•ÐÐÐ«Ð• Ð Ð˜Ð¡ÐšÐ˜
{'-'*70}
"""
        red_risks = [r for r in data.get('risks', []) if r.get('risk_level') == 'red']
        yellow_risks = [r for r in data.get('risks', []) if r.get('risk_level') == 'yellow']
        
        if red_risks:
            report += "ðŸ”´ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð Ð˜Ð¡ÐšÐ˜:\n" + "\n".join([f"  â€¢ {r.get('issue', '')}" for r in red_risks]) + "\n\n"
        else:
            report += "ðŸ”´ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð Ð˜Ð¡ÐšÐ˜: ÐÐµ Ð²Ñ‹ÑÐ²Ð»ÐµÐ½Ñ‹\n\n"
        
        if yellow_risks:
            report += "ðŸŸ¡ Ð¢Ð Ð•Ð‘Ð£Ð®Ð¢ Ð’ÐÐ˜ÐœÐÐÐ˜Ð¯:\n" + "\n".join([f"  â€¢ {r.get('issue', '')}" for r in yellow_risks]) + "\n\n"
        
        if ai:
            report += f"\n{'-'*70}\n4. Ð­ÐšÐ¡ÐŸÐ•Ð Ð¢ÐÐžÐ• Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð• (AI)\n{'-'*70}\n{ai}\n"
        
        report += f"\n{'-'*70}\n5. Ð˜Ð¢ÐžÐ“ÐžÐ’ÐžÐ• Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð•\n{'-'*70}\n{data.get('conclusion', data.get('summary', ''))}\n"
        report += f"\n{'='*70}\nLegal Traffic Light v7.0 | {org_name} | {datetime.now().strftime('%d.%m.%Y %H:%M')}\n{'='*70}"
        return report
    
    @classmethod
    def generate_docx_report(cls, data: Dict, user: Dict, org: Dict, ai: str = "") -> Tuple[bool, bytes]:
        if not DOCX_AVAILABLE:
            return False, b"python-docx not installed"
        try:
            doc = DocxDocument()
            doc.add_heading('Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð• Ð®Ð Ð˜Ð”Ð˜Ð§Ð•Ð¡ÐšÐžÐ“Ðž Ð”Ð•ÐŸÐÐ Ð¢ÐÐœÐ•ÐÐ¢Ð', 0).alignment = WD_ALIGN_PARAGRAPH.CENTER
            doc.add_paragraph(org.get("full_name", "")).alignment = WD_ALIGN_PARAGRAPH.CENTER
            doc.add_paragraph(f"Ð”Ð°Ñ‚Ð°: {datetime.now().strftime('%d.%m.%Y')} | ID: {data.get('analysis_id', '')}")
            doc.add_paragraph(f"Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ: {user.get('name', '')}, {user.get('position', '')}")
            
            doc.add_heading('1. ÐžÐ‘Ð©Ð˜Ð• Ð¡Ð’Ð•Ð”Ð•ÐÐ˜Ð¯', level=1)
            for label, key in [("ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚", "counterparty"), ("ÐÐ¾Ð¼ÐµÑ€", "contract_number"), ("Ð¡ÑƒÐ¼Ð¼Ð°", "amount")]:
                val = data.get(key, "")
                if key == "amount": val = f"{val:,.2f} Ñ€ÑƒÐ±."
                doc.add_paragraph(f"{label}: {val}")
            
            doc.add_heading('2. Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð«', level=1)
            zone_names = {"green": "ðŸŸ¢ Ð—Ð•Ð›Ð•ÐÐÐ¯", "yellow": "ðŸŸ¡ Ð–Ð•Ð›Ð¢ÐÐ¯", "red": "ðŸ”´ ÐšÐ ÐÐ¡ÐÐÐ¯"}
            doc.add_paragraph(f"Ð—ÐžÐÐ: {zone_names.get(data.get('zone', ''), 'ÐÐ• ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ')}")
            doc.add_paragraph(f"Ð Ð¸ÑÐº-ÑÐºÐ¾Ñ€: {data.get('risk_score', 0):.1f} / 10 | Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¢Ð¤: {data.get('compliance_score', 0):.1f}%")
            
            doc.add_heading('3. Ð Ð˜Ð¡ÐšÐ˜', level=1)
            for r in data.get('risks', [])[:10]:
                doc.add_paragraph(f"{'ðŸ”´' if r.get('risk_level')=='red' else 'ðŸŸ¡'} {r.get('issue', '')}", style='List Bullet')
            
            if ai:
                doc.add_heading('4. AI-ÐÐÐÐ›Ð˜Ð—', level=1)
                doc.add_paragraph(ai)
            
            doc.add_heading('5. Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð•', level=1)
            doc.add_paragraph(data.get('conclusion', data.get('summary', '')))
            doc.add_paragraph(f"\nLegal Traffic Light v7.0 | {datetime.now().strftime('%d.%m.%Y %H:%M')}")
            
            buffer = io.BytesIO()
            doc.save(buffer)
            buffer.seek(0)
            return True, buffer.getvalue()
        except Exception as e:
            return False, str(e).encode()
    
    @classmethod
    def generate_html_report(cls, data: Dict, user: Dict, org: Dict, ai: str = "") -> str:
        zone_colors = {"green": "#28a745", "yellow": "#ffc107", "red": "#dc3545"}
        zone_names = {"green": "ðŸŸ¢ Ð—Ð•Ð›Ð•ÐÐÐ¯", "yellow": "ðŸŸ¡ Ð–Ð•Ð›Ð¢ÐÐ¯", "red": "ðŸ”´ ÐšÐ ÐÐ¡ÐÐÐ¯"}
        zone = data.get('zone', '')
        zone_color = zone_colors.get(zone, '#6c757d')
        org_name = org.get("full_name", "")
        
        red_risks = [r for r in data.get('risks', []) if r.get('risk_level') == 'red']
        yellow_risks = [r for r in data.get('risks', []) if r.get('risk_level') == 'yellow']
        
        red_html = "".join(f'<div style="padding:10px;margin:5px 0;background:#fff5f5;border-left:4px solid #dc3545;"><strong>âš ï¸ {r.get("issue", "")}</strong></div>' for r in red_risks) if red_risks else '<p style="color:#28a745;">âœ… ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€Ð¸ÑÐºÐ¸ Ð½Ðµ Ð²Ñ‹ÑÐ²Ð»ÐµÐ½Ñ‹</p>'
        yellow_html = "".join(f'<div style="padding:10px;margin:5px 0;background:#fffcf0;border-left:4px solid #ffc107;">{r.get("issue", "")}</div>' for r in yellow_risks) if yellow_risks else ''
        
        return f'''<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>Ð—Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð®Ð”</title>
<style>body{{font-family:'Times New Roman',serif;font-size:12pt;line-height:1.6;max-width:210mm;margin:0 auto;padding:20px;color:#333;}}
.header{{text-align:center;border-bottom:3px solid #1e3a5f;padding-bottom:20px;margin-bottom:30px;}}
.header h1{{color:#1e3a5f;margin:0;}}
.section{{margin-bottom:30px;}}.section-title{{font-size:14pt;font-weight:bold;color:#1e3a5f;border-bottom:2px solid #dee2e6;padding-bottom:8px;margin-bottom:15px;}}
.zone-badge{{display:inline-block;padding:15px 30px;border-radius:8px;color:white;font-weight:bold;font-size:16pt;background:{zone_color};margin:20px 0;}}
.metrics{{display:flex;justify-content:space-around;flex-wrap:wrap;margin:20px 0;}}
.metric{{text-align:center;padding:15px;background:#f8f9fa;border-radius:8px;min-width:150px;margin:5px;}}
.metric-value{{font-size:24pt;font-weight:bold;color:{zone_color};}}.metric-label{{font-size:10pt;color:#666;}}
table{{width:100%;border-collapse:collapse;margin:15px 0;}}th,td{{padding:12px;text-align:left;border-bottom:1px solid #dee2e6;}}th{{background:#f8f9fa;}}
.ai-box{{background:#e8f4f8;border:1px solid #b8d4e3;border-radius:8px;padding:20px;margin:20px 0;white-space:pre-wrap;}}
.footer{{margin-top:40px;padding-top:20px;border-top:2px solid #dee2e6;text-align:center;font-size:10pt;color:#666;}}
@media print{{body{{padding:0;}}}}</style></head><body>
<div class="header"><h1>Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð• Ð®Ð Ð˜Ð”Ð˜Ð§Ð•Ð¡ÐšÐžÐ“Ðž Ð”Ð•ÐŸÐÐ Ð¢ÐÐœÐ•ÐÐ¢Ð</h1><p style="color:#666;">{org_name}</p></div>
<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:25px;"><strong>Ð”Ð°Ñ‚Ð°:</strong> {datetime.now().strftime('%d.%m.%Y %H:%M')} | <strong>ID:</strong> {data.get('analysis_id', '')} | <strong>Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {user.get('name', '')}</div>
<div class="section"><div class="section-title">1. ÐžÐ‘Ð©Ð˜Ð• Ð¡Ð’Ð•Ð”Ð•ÐÐ˜Ð¯</div><table><tr><td><strong>ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚</strong></td><td>{data.get('counterparty', '')}</td></tr><tr><td><strong>ÐÐ¾Ð¼ÐµÑ€</strong></td><td>{data.get('contract_number', '')}</td></tr><tr><td><strong>Ð¡ÑƒÐ¼Ð¼Ð°</strong></td><td>{data.get('amount', 0):,.2f} Ñ€ÑƒÐ±.</td></tr><tr><td><strong>Ð¢Ð¸Ð¿</strong></td><td>{data.get('contract_type', '')}</td></tr></table></div>
<div class="section"><div class="section-title">2. Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« ÐÐÐÐ›Ð˜Ð—Ð</div><div style="text-align:center;"><div class="zone-badge">{zone_names.get(zone, 'ÐÐ• ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ')}</div></div><div class="metrics"><div class="metric"><div class="metric-value">{data.get('risk_score', 0):.1f}</div><div class="metric-label">Ð Ð¸ÑÐº-ÑÐºÐ¾Ñ€</div></div><div class="metric"><div class="metric-value">{data.get('compliance_score', 0):.0f}%</div><div class="metric-label">Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¢Ð¤</div></div><div class="metric"><div class="metric-value">{data.get('deadline_days', 0)}</div><div class="metric-label">Ð¡Ñ€Ð¾Ðº (Ð´Ð½.)</div></div></div></div>
<div class="section"><div class="section-title">3. Ð’Ð«Ð¯Ð’Ð›Ð•ÐÐÐ«Ð• Ð Ð˜Ð¡ÐšÐ˜</div><h4>ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ:</h4>{red_html}{'<h4>ðŸŸ¡ Ð¢Ñ€ÐµÐ±ÑƒÑŽÑ‚ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ:</h4>' + yellow_html if yellow_html else ''}</div>
{'<div class="section"><div class="section-title">4. Ð­ÐšÐ¡ÐŸÐ•Ð Ð¢ÐÐžÐ• Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð• (AI)</div><div class="ai-box">' + ai + '</div></div>' if ai else ''}
<div class="section"><div class="section-title">5. Ð˜Ð¢ÐžÐ“ÐžÐ’ÐžÐ• Ð—ÐÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð•</div><p style="font-size:13pt;padding:15px;background:#f8f9fa;border-radius:8px;">{data.get('conclusion', data.get('summary', ''))}</p></div>
<div class="footer"><strong>Legal Traffic Light v7.0</strong> | {org.get("short_name", "")} Â© {datetime.now().year} | {datetime.now().strftime('%d.%m.%Y %H:%M')}</div></body></html>'''
    
    @classmethod
    def generate_json_1c(cls, data: Dict, user: Dict, org: Dict) -> str:
        return json.dumps({
            "Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚": "Ð—Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ®Ð”",
            "Ð’ÐµÑ€ÑÐ¸Ñ": "2.0",
            "Ð”Ð°Ñ‚Ð°Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ñ": datetime.now().isoformat(),
            "ÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ": org.get("short_name", ""),
            "Ð˜ÐÐ": org.get("inn", ""),
            "ÐÐ²Ñ‚Ð¾Ñ€": {"Ð¤Ð˜Ðž": user.get("name", ""), "Ð”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ": user.get("position", "")},
            "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€": {"ÐÐ¾Ð¼ÐµÑ€": data.get("contract_number", ""), "ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚": data.get("counterparty", ""), "Ð¡ÑƒÐ¼Ð¼Ð°": data.get("amount", 0), "Ð¢Ð¸Ð¿": data.get("contract_type", "")},
            "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚": {"Ð—Ð¾Ð½Ð°": data.get("zone", ""), "Ð Ð¸ÑÐºÐ¡ÐºÐ¾Ñ€": round(data.get("risk_score", 0), 2), "Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸ÐµÐ¢Ð¤": round(data.get("compliance_score", 0), 2), "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑÐ®Ð”": data.get("requires_legal", False), "Ð¡Ñ€Ð¾ÐºÐ”Ð½ÐµÐ¹": data.get("deadline_days", 0)},
            "Ð Ð¸ÑÐºÐ¸": {"ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ": [r.get("issue", "") for r in data.get("risks", []) if r.get("risk_level") == "red"], "ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ": [r.get("issue", "") for r in data.get("risks", []) if r.get("risk_level") == "yellow"]},
            "Ð—Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ": data.get("conclusion", ""),
            "ID": data.get("analysis_id", "")
        }, ensure_ascii=False, indent=2)

# ============================================================================
# Ð’ÐÐ›Ð˜Ð”ÐÐ¦Ð˜Ð¯
# ============================================================================

class Validator:
    @classmethod
    def sanitize_text(cls, text: str, max_len: int = 2_000_000) -> str:
        if not text: return ""
        dangerous = [r'<script[^>]*>.*?</script>', r'javascript:', r'on\w+\s*=']
        for p in dangerous:
            text = re.sub(p, '', text, flags=re.IGNORECASE | re.DOTALL)
        return text[:max_len]
    
    @classmethod
    def validate_amount(cls, value: str) -> Tuple[bool, float, str]:
        if not value or not value.strip(): return True, 0, "OK"
        try:
            cleaned = re.sub(r'[^\d.,]', '', value).replace(',', '.').replace(' ', '')
            if not cleaned: return True, 0, "OK"
            amount = float(cleaned)
            return (True, amount, "OK") if amount >= 0 else (False, 0, "Ð¡ÑƒÐ¼Ð¼Ð° Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹")
        except ValueError:
            return False, 0, "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÑƒÐ¼Ð¼Ñ‹"
    
    @classmethod
    def validate_analysis_input(cls, counterparty: str, contract_text: str, doc_form: DocumentForm) -> Tuple[bool, str]:
        """ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ´ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð¼"""
        errors = []
        
        if not counterparty or len(counterparty.strip()) < 3:
            errors.append("Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚Ð° (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 3 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°)")
        
        if not contract_text or len(contract_text.strip()) < 100:
            errors.append("Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¸Ð»Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 100 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)")
        
        if not doc_form:
            errors.append("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°")
        
        if errors:
            return False, "âŒ " + "\nâŒ ".join(errors)
        return True, "OK"

# ============================================================================
# ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ˜Ð• Ð—ÐžÐÐ« Ð Ð˜Ð¡ÐšÐ
# ============================================================================

@dataclass
class AnalysisInput:
    amount: float = 0
    document_form: DocumentForm = DocumentForm.TYPICAL
    document_type: str = ""
    deal_type: str = ""
    legal_status: LegalStatus = LegalStatus.NOT_SUBMITTED
    is_single_supplier: bool = False
    is_tender: bool = False
    tender_amount: float = 0
    contract_years: int = 0
    changes_essential: bool = False
    is_urgent: bool = False
    counterparty: str = ""
    contract_number: str = ""
    contract_date: str = ""

@dataclass
class ZoneResult:
    zone: RiskZone = RiskZone.GREEN
    zone_reason: str = ""
    deadline_days: int = 0
    requires_legal: bool = False
    responsible: str = "Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€"
    warnings: List[str] = field(default_factory=list)
    approval_route: List[str] = field(default_factory=list)

def determine_risk_zone(inp: AnalysisInput, thresholds: Dict = None) -> ZoneResult:
    if thresholds is None:
        thresholds = DEFAULT_THRESHOLDS
    
    result = ZoneResult()
    
    # ÐšÐ ÐÐ¡ÐÐÐ¯ Ð—ÐžÐÐ
    if inp.deal_type and inp.deal_type in RED_ZONE_ALWAYS:
        result.zone = RiskZone.RED
        result.zone_reason = f"Ð¢Ð¸Ð¿ ÑÐ´ÐµÐ»ÐºÐ¸ Â«{inp.deal_type}Â» Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ ÑƒÑ‡Ð°ÑÑ‚Ð¸Ñ Ð®Ð”"
        result.requires_legal = True
        result.responsible = "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"
        result.deadline_days = DEFAULT_DEADLINES["extended"]
        result.approval_route = ["Ð®Ð” (Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ)", "Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°", "ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ"]
        result.warnings.append("âš ï¸ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð®Ð” Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ!")
        return result
    
    if inp.document_type and inp.document_type in RED_DOCUMENTS_ALWAYS:
        result.zone = RiskZone.RED
        result.zone_reason = f"Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Â«{inp.document_type}Â» Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð½ÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑƒÑ‡Ð°ÑÑ‚Ð¸Ñ Ð®Ð”"
        result.requires_legal = True
        result.responsible = "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"
        result.deadline_days = DEFAULT_DEADLINES["urgent"]
        result.approval_route = ["Ð®Ð” ÐÐ•Ð—ÐÐœÐ•Ð”Ð›Ð˜Ð¢Ð•Ð›Ð¬ÐÐž"]
        result.warnings.append("ðŸš¨ ÐÐ•ÐœÐ•Ð”Ð›Ð•ÐÐÐžÐ• Ð¿Ñ€Ð¸Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð®Ð”!")
        return result
    
    if inp.is_tender and inp.tender_amount > thresholds.get("tender_red", 3_000_000):
        result.zone = RiskZone.RED
        result.zone_reason = f"Ð¢ÐµÐ½Ð´ÐµÑ€ {inp.tender_amount:,.0f} Ñ€ÑƒÐ±. > {thresholds.get('tender_red', 3_000_000):,.0f} Ñ€ÑƒÐ±."
        result.requires_legal = True
        result.responsible = "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"
        result.deadline_days = DEFAULT_DEADLINES["extended"]
        return result
    
    if inp.amount > thresholds.get("yellow_max", 5_000_000):
        result.zone = RiskZone.RED
        result.zone_reason = f"Ð¡ÑƒÐ¼Ð¼Ð° {inp.amount:,.0f} Ñ€ÑƒÐ±. > {thresholds.get('yellow_max', 5_000_000):,.0f} Ñ€ÑƒÐ±."
        result.requires_legal = True
        result.responsible = "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"
        result.deadline_days = DEFAULT_DEADLINES["extended"]
        return result
    
    # Ð–Ð•Ð›Ð¢ÐÐ¯ Ð—ÐžÐÐ
    yellow_reasons = []
    
    if inp.deal_type and inp.deal_type in YELLOW_ZONE_TYPES:
        yellow_reasons.append(f"Ð¢Ð¸Ð¿ ÑÐ´ÐµÐ»ÐºÐ¸: {inp.deal_type}")
    
    if inp.is_single_supplier and inp.amount > thresholds.get("single_supplier_yellow", 100_000):
        yellow_reasons.append("Ð•Ð´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº > 100Ðš")
    
    if inp.contract_years > 3:
        yellow_reasons.append(f"Ð¡Ñ€Ð¾Ðº {inp.contract_years} Ð»ÐµÑ‚ > 3 Ð»ÐµÑ‚")
    
    if inp.document_form == DocumentForm.TYPICAL:
        if inp.amount > thresholds.get("green_tf_max", 100_000):
            yellow_reasons.append(f"Ð¢Ð¤ Ñ ÑÑƒÐ¼Ð¼Ð¾Ð¹ {inp.amount:,.0f} > {thresholds.get('green_tf_max', 100_000):,.0f}")
    elif inp.document_form in [DocumentForm.COUNTERPARTY, DocumentForm.FREE, DocumentForm.SELF_DEVELOPED]:
        if inp.amount > thresholds.get("green_non_tf_max", 50_000):
            yellow_reasons.append(f"ÐÐµÑ‚Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ñ ÑÑƒÐ¼Ð¼Ð¾Ð¹ {inp.amount:,.0f} > {thresholds.get('green_non_tf_max', 50_000):,.0f}")
    elif inp.document_form == DocumentForm.MODIFIED_TF:
        if inp.changes_essential:
            yellow_reasons.append("Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹ Ð¢Ð¤")
        elif inp.amount > thresholds.get("green_non_tf_max", 50_000):
            yellow_reasons.append("Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¢Ð¤ > 50Ðš")
    
    if yellow_reasons:
        result.zone = RiskZone.YELLOW
        result.zone_reason = "; ".join(yellow_reasons)
        result.requires_legal = True
        result.responsible = "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"
        result.deadline_days = DEFAULT_DEADLINES["standard"]
        result.approval_route = ["Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€", "Ð¡Ð­Ð”", "Ð®Ð” (5 Ð´Ð½ÐµÐ¹)", "ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ"]
        result.warnings.append("âš ï¸ Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð´Ð¾ Ð²Ð¸Ð·Ñ‹ Ð®Ð”!")
        return result
    
    # Ð—Ð•Ð›Ð•ÐÐÐ¯ Ð—ÐžÐÐ
    result.zone = RiskZone.GREEN
    result.zone_reason = "Ð—ÐµÐ»ÐµÐ½Ñ‹Ð¹ ÐºÐ¾Ñ€Ð¸Ð´Ð¾Ñ€ (Ð¿. 4.1 Ð ÐµÐ³Ð»Ð°Ð¼ÐµÐ½Ñ‚Ð°)"
    result.requires_legal = False
    result.responsible = "Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€"
    result.deadline_days = 0
    result.approval_route = ["Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€", "Ð ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ", "ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ"]
    return result

def add_to_history(data: Dict):
    if "history" not in st.session_state:
        st.session_state.history = []
    data["id"] = hashlib.md5(f"{datetime.now().isoformat()}{data.get('counterparty', '')}".encode()).hexdigest()[:8]
    data["timestamp"] = datetime.now().isoformat()
    st.session_state.history.insert(0, data)
    if len(st.session_state.history) > 100:
        st.session_state.history = st.session_state.history[:100]

# ============================================================================
# Ð¡Ð¢Ð˜Ð›Ð˜ CSS (Legal Design)
# ============================================================================

def apply_styles():
    st.markdown("""<style>
:root {
    --primary: #1e3a5f;
    --secondary: #2d5a87;
    --accent: #4a90d9;
    --red: #dc3545;
    --yellow: #f0ad4e;
    --green: #28a745;
    --dark: #1a1a2e;
    --light: #f8f9fa;
}

/* Legal Design - Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ ÑÑ‚Ð¸Ð»ÑŒ */
.main-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    color: white;
    box-shadow: 0 4px 20px rgba(30,58,95,0.3);
}

.main-header h2 { margin: 0; font-size: 1.6rem; font-weight: 600; }

.traffic-light {
    display: flex;
    gap: 8px;
    margin-bottom: 1rem;
}

.traffic-light span {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    box-shadow: 0 0 10px currentColor;
}

.tl-red { background: var(--red); color: var(--red); }
.tl-yellow { background: var(--yellow); color: var(--yellow); }
.tl-green { background: var(--green); color: var(--green); }

.version-badge {
    background: rgba(255,255,255,0.2);
    padding: 4px 12px;
    border-radius: 8px;
    font-size: 0.75rem;
    margin-left: 12px;
    font-weight: 500;
}

.zone-card {
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 5px solid;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.zone-card.green {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border-left-color: var(--green);
}

.zone-card.yellow {
    background: linear-gradient(135deg, #fff8e1, #ffecb3);
    border-left-color: var(--yellow);
}

.zone-card.red {
    background: linear-gradient(135deg, #ffebee, #ffcdd2);
    border-left-color: var(--red);
}

.zone-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; color: #333; }
.zone-subtitle { font-size: 0.95rem; color: #555; }

.risk-item {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.6rem;
    border-left: 4px solid;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

.risk-item.red { border-left-color: var(--red); background: linear-gradient(90deg, #fff5f5, white); }
.risk-item.yellow { border-left-color: var(--yellow); background: linear-gradient(90deg, #fffcf0, white); }

.section-score {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.score-high { background: #d4edda; color: #155724; }
.score-medium { background: #fff3cd; color: #856404; }
.score-low { background: #f8d7da; color: #721c24; }

.metric-card {
    background: var(--light);
    border-radius: 10px;
    padding: 1.2rem;
    text-align: center;
    border: 1px solid #e9ecef;
}

.metric-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
.metric-label { font-size: 0.85rem; color: #6c757d; margin-top: 0.3rem; }

.stButton > button {
    border-radius: 8px;
    font-weight: 500;
    padding: 0.5rem 1rem;
    transition: all 0.2s;
}

.stButton > button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}

.info-box {
    background: #e3f2fd;
    border: 1px solid #90caf9;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.warning-box {
    background: #fff3e0;
    border: 1px solid #ffb74d;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.admin-panel {
    background: linear-gradient(135deg, #f5f5f5, #eeeeee);
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.admin-badge {
    background: #7b1fa2;
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.user-badge {
    background: #1976d2;
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

footer { visibility: hidden; }
</style>""", unsafe_allow_html=True)

# ============================================================================
# Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯
# ============================================================================

def init_session():
    defaults = {
        "authenticated": False,
        "user": None,
        "user_role": None,
        "demo_mode": False,
        "contract_text": "",
        "zone_result": None,
        "comparison_result": None,
        "ai_analysis": "",
        "history": [],
        "current_input": None,
        "custom_typical_forms": {},
        "org_config": DEFAULT_ORG_CONFIG.copy(),
        "thresholds": DEFAULT_THRESHOLDS.copy(),
        "deadlines": DEFAULT_DEADLINES.copy(),
        "api_keys": {p: "" for p in AI_PROVIDERS},
        "yandex_folder_id": "",
        "enabled_providers": list(AI_PROVIDERS.keys()),
        "admin_settings": {
            "allow_demo": True,
            "require_counterparty": True,
            "require_contract_text": True,
            "min_contract_length": 100,
            "show_ai_tab": True,
            "show_regulation_tab": True,
        }
    }
    
    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

# ============================================================================
# UI: ÐÐ’Ð¢ÐžÐ Ð˜Ð—ÐÐ¦Ð˜Ð¯
# ============================================================================

def render_auth_page():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    
    st.markdown(f'''<div style="text-align:center;padding:3rem 1rem;">
<div class="traffic-light" style="justify-content:center;margin-bottom:1rem;"><span class="tl-red"></span><span class="tl-yellow"></span><span class="tl-green"></span></div>
<h1 style="font-size:2.2rem;margin-bottom:0.5rem;color:#1e3a5f;">ðŸš¦ Legal Traffic Light</h1>
<p style="color:#666;font-size:1rem;margin-bottom:2rem;">Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð²<br><strong>{org.get("short_name", "ÐÐž Â«Ð¡ÐŸÐšÂ»")}</strong></p>
</div>''', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        tab1, tab2 = st.tabs(["ðŸ‘¤ Ð’Ñ…Ð¾Ð´ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹", "ðŸ” Ð’Ñ…Ð¾Ð´ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²"])
        
        with tab1:
            st.markdown("### Ð’Ñ…Ð¾Ð´ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ")
            with st.form("user_auth"):
                name = st.text_input("Ð¤Ð˜Ðž *", placeholder="Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡")
                position = st.selectbox("Ð”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ *", options=[""] + POSITIONS)
                department = st.selectbox("ÐŸÐ¾Ð´Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ *", options=[""] + DEPARTMENTS)
                
                col_a, col_b = st.columns(2)
                with col_a:
                    login_btn = st.form_submit_button("ðŸš€ Ð’Ð¾Ð¹Ñ‚Ð¸", use_container_width=True, type="primary")
                with col_b:
                    demo_btn = st.form_submit_button("ðŸ“‹ Ð”ÐµÐ¼Ð¾", use_container_width=True)
                
                if login_btn:
                    if name and len(name.strip()) >= 3 and position and department:
                        st.session_state.authenticated = True
                        st.session_state.user = {"name": name.strip(), "position": position, "department": department}
                        st.session_state.user_role = UserRole.USER
                        st.session_state.demo_mode = False
                        st.rerun()
                    else:
                        st.error("âŒ Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ")
                
                if demo_btn and st.session_state.get("admin_settings", {}).get("allow_demo", True):
                    st.session_state.authenticated = True
                    st.session_state.user = {"name": "Ð”ÐµÐ¼Ð¾-Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ", "position": "Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚", "department": "Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚"}
                    st.session_state.user_role = UserRole.USER
                    st.session_state.demo_mode = True
                    st.rerun()
        
        with tab2:
            st.markdown("### Ð’Ñ…Ð¾Ð´ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²")
            with st.form("admin_auth"):
                admin_login = st.text_input("Ð›Ð¾Ð³Ð¸Ð½", placeholder="admin")
                admin_password = st.text_input("ÐŸÐ°Ñ€Ð¾Ð»ÑŒ", type="password")
                admin_btn = st.form_submit_button("ðŸ” Ð’Ð¾Ð¹Ñ‚Ð¸ ÐºÐ°Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€", use_container_width=True, type="primary")
                
                if admin_btn:
                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
                    if admin_login in DEFAULT_USERS:
                        user_data = DEFAULT_USERS[admin_login]
                        if user_data["password_hash"] == hashlib.sha256(admin_password.encode()).hexdigest():
                            if user_data["role"] == UserRole.ADMIN:
                                st.session_state.authenticated = True
                                st.session_state.user = {
                                    "name": user_data["name"],
                                    "position": user_data["position"],
                                    "department": user_data["department"]
                                }
                                st.session_state.user_role = UserRole.ADMIN
                                st.session_state.demo_mode = False
                                st.rerun()
                            else:
                                st.error("âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð²")
                        else:
                            st.error("âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ")
                    else:
                        st.error("âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")
            
            st.caption("ðŸ’¡ ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: admin / admin123")
        
        st.markdown("---")
        st.markdown(f'<div style="text-align:center;color:#666;font-size:0.85rem;"><strong>Legal Traffic Light v7.0</strong><br>{org.get("short_name", "")}</div>', unsafe_allow_html=True)

# ============================================================================
# UI: Ð‘ÐžÐšÐžÐ’ÐÐ¯ ÐŸÐÐÐ•Ð›Ð¬
# ============================================================================

def render_sidebar():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    
    with st.sidebar:
        st.markdown("### ðŸ‘¤ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ")
        
        user = st.session_state.user
        role = st.session_state.user_role
        
        role_badge = "admin-badge" if role == UserRole.ADMIN else "user-badge"
        role_name = "ÐÐ”ÐœÐ˜ÐÐ˜Ð¡Ð¢Ð ÐÐ¢ÐžÐ " if role == UserRole.ADMIN else "ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¬"
        
        if st.session_state.demo_mode:
            st.info("ðŸŽ¯ Ð”ÐµÐ¼Ð¾-Ñ€ÐµÐ¶Ð¸Ð¼")
        
        st.markdown(f"""
        <div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-bottom:10px;">
            <strong>{user['name']}</strong><br>
            <small>{user['position']}</small><br>
            <small style="color:#666;">{user['department']}</small><br>
            <span class="{role_badge}">{role_name}</span>
        </div>
        """, unsafe_allow_html=True)
        
        if st.button("ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸", use_container_width=True):
            for key in ["authenticated", "user", "user_role", "demo_mode", "zone_result", "comparison_result", "ai_analysis", "contract_text", "current_input"]:
                if key in st.session_state:
                    del st.session_state[key]
            st.rerun()
        
        st.markdown("---")
        st.markdown(f"### ðŸ¢ {org.get('abbrev', 'Ð¡ÐŸÐš')}")
        
        thresholds = st.session_state.get("thresholds", DEFAULT_THRESHOLDS)
        
        st.markdown(f"""
        ðŸŸ¢ **Ð—Ð•Ð›Ð•ÐÐÐ¯**
        - Ð¢Ð¤ â‰¤ {thresholds.get('green_tf_max', 100000):,.0f}â‚½
        - ÐÐµÑ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ â‰¤ {thresholds.get('green_non_tf_max', 50000):,.0f}â‚½
        
        ðŸŸ¡ **Ð–Ð•Ð›Ð¢ÐÐ¯**
        - Ð´Ð¾ {thresholds.get('yellow_max', 5000000):,.0f}â‚½
        
        ðŸ”´ **ÐšÐ ÐÐ¡ÐÐÐ¯**
        - > {thresholds.get('yellow_max', 5000000):,.0f}â‚½
        """)
        
        if st.session_state.history:
            st.markdown("---")
            st.markdown("### ðŸ“œ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð°Ð½Ð°Ð»Ð¸Ð·Ñ‹")
            for item in st.session_state.history[:5]:
                zone_emoji = {"green": "ðŸŸ¢", "yellow": "ðŸŸ¡", "red": "ðŸ”´"}.get(item.get("zone", ""), "âšª")
                st.markdown(f"{zone_emoji} {item.get('counterparty', 'N/A')[:20]}")
        
        st.markdown("---")
        st.markdown("### ðŸ“š Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸")
        st.markdown(f"{'âœ…' if DOCX_AVAILABLE else 'âŒ'} python-docx")
        st.markdown(f"{'âœ…' if PDF_READER_AVAILABLE else 'âŒ'} PyPDF2")

# ============================================================================
# UI: Ð’ÐšÐ›ÐÐ”ÐšÐ ÐÐÐÐ›Ð˜Ð—Ð
# ============================================================================

def render_analysis_tab():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    admin_settings = st.session_state.get("admin_settings", {})
    
    st.markdown("### ðŸ“ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°")
    
    col1, col2 = st.columns(2)
    
    with col1:
        counterparty = st.text_input("ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚ *", placeholder="ÐžÐžÐž Â«ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸Â»", help="ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð½Ð°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚Ð°")
        contract_number = st.text_input("ÐÐ¾Ð¼ÐµÑ€ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°", placeholder="2025/Ð¢Ð­Ðž-001")
        contract_date = st.date_input("Ð”Ð°Ñ‚Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°", value=date.today())
        doc_type = st.selectbox("Ð¢Ð¸Ð¿ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°", options=CONTRACT_TYPES)
        doc_form_options = [(DOCUMENT_FORM_LABELS[df], df) for df in DocumentForm]
        doc_form = st.selectbox("Ð¤Ð¾Ñ€Ð¼Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð° *", options=doc_form_options, format_func=lambda x: x[0])[1]
    
    with col2:
        amount_str = st.text_input("Ð¡ÑƒÐ¼Ð¼Ð° (â‚½)", placeholder="1 500 000")
        valid_amount, amount, amount_msg = Validator.validate_amount(amount_str)
        if not valid_amount:
            st.error(amount_msg)
        
        legal_status = st.selectbox("Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ Ð®Ð”", options=list(LegalStatus), format_func=lambda x: LEGAL_STATUS_LABELS[x])
        
        deal_type = st.selectbox("Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑÐ´ÐµÐ»ÐºÐ¸", options=["â€” ÐÐµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð¼Ð¾ â€”"] + RED_ZONE_ALWAYS + YELLOW_ZONE_TYPES)
        if deal_type == "â€” ÐÐµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð¼Ð¾ â€”":
            deal_type = ""
        
        is_single_supplier = st.checkbox("Ð—Ð°ÐºÑƒÐ¿ÐºÐ° Ñƒ ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ°")
        is_tender = st.checkbox("Ð¢ÐµÐ½Ð´ÐµÑ€ / ÐºÐ¾Ð½ÐºÑƒÑ€Ñ")
        
        tender_amount = 0
        if is_tender:
            tender_str = st.text_input("Ð¡ÑƒÐ¼Ð¼Ð° Ñ‚ÐµÐ½Ð´ÐµÑ€Ð° (â‚½)", placeholder="5 000 000")
            if tender_str:
                _, tender_amount, _ = Validator.validate_amount(tender_str)
    
    with st.expander("ðŸ”§ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹"):
        col_a, col_b = st.columns(2)
        with col_a:
            contract_years = st.number_input("Ð¡Ñ€Ð¾Ðº Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° (Ð»ÐµÑ‚)", min_value=0, max_value=50, value=0)
            changes_essential = st.checkbox("Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹ Ð¢Ð¤")
        with col_b:
            is_urgent = st.checkbox("ðŸš¨ Ð¡Ñ€Ð¾Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ")
            if is_urgent:
                st.warning("âš ï¸ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ð¸ÑÑŒÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð¾Ð±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸!")
    
    st.markdown("---")
    
    # ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
    col_btn1, col_btn2, col_btn3 = st.columns(3)
    
    with col_btn1:
        analyze_btn = st.button("ðŸš¦ ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð·Ð¾Ð½Ñƒ Ñ€Ð¸ÑÐºÐ°", type="primary", use_container_width=True)
    with col_btn2:
        demo_btn = st.button("ðŸ“ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´ÐµÐ¼Ð¾-Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€", use_container_width=True)
    with col_btn3:
        clear_btn = st.button("ðŸ—‘ï¸ ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÑ‘", use_container_width=True)
    
    if analyze_btn:
        if valid_amount:
            inp = AnalysisInput(
                amount=amount, document_form=doc_form, document_type=doc_type, deal_type=deal_type,
                legal_status=legal_status, is_single_supplier=is_single_supplier, is_tender=is_tender,
                tender_amount=tender_amount, contract_years=contract_years, changes_essential=changes_essential,
                is_urgent=is_urgent, counterparty=counterparty, contract_number=contract_number,
                contract_date=str(contract_date)
            )
            st.session_state.zone_result = determine_risk_zone(inp, st.session_state.get("thresholds"))
            st.session_state.current_input = inp
            st.rerun()
    
    if demo_btn:
        st.session_state.contract_text = DEMO_CONTRACT
        st.rerun()
    
    if clear_btn:
        st.session_state.zone_result = None
        st.session_state.comparison_result = None
        st.session_state.ai_analysis = ""
        st.session_state.contract_text = ""
        st.session_state.current_input = None
        st.rerun()
    
    # ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð·Ð¾Ð½Ñ‹
    if st.session_state.zone_result:
        zr = st.session_state.zone_result
        zone_config = {
            RiskZone.GREEN: ("green", "ðŸŸ¢ Ð—Ð•Ð›Ð•ÐÐÐ¯ Ð—ÐžÐÐ", "Ð¡Ð°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼"),
            RiskZone.YELLOW: ("yellow", "ðŸŸ¡ Ð–Ð•Ð›Ð¢ÐÐ¯ Ð—ÐžÐÐ", "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð°"),
            RiskZone.RED: ("red", "ðŸ”´ ÐšÐ ÐÐ¡ÐÐÐ¯ Ð—ÐžÐÐ", "ÐŸÐ¾Ð»Ð½Ð¾Ðµ ÑÐ¾Ð¿Ñ€Ð¾Ð²Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð°"),
        }
        zone_class, zone_title, zone_subtitle = zone_config.get(zr.zone, ("green", "âšª ÐÐ• ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ", ""))
        
        st.markdown(f'''
        <div class="zone-card {zone_class}">
            <div class="zone-title">{zone_title}</div>
            <div class="zone-subtitle">{zone_subtitle}</div>
            <div style="margin-top:0.8rem;font-size:0.95rem;color:#555;">{zr.zone_reason}</div>
        </div>
        ''', unsafe_allow_html=True)
        
        col_m1, col_m2, col_m3, col_m4 = st.columns(4)
        with col_m1:
            st.metric("ðŸ’° Ð¡ÑƒÐ¼Ð¼Ð°", f"{amount:,.0f} â‚½".replace(",", " "))
        with col_m2:
            st.metric("â±ï¸ Ð¡Ñ€Ð¾Ðº", f"{zr.deadline_days} Ð´Ð½." if zr.deadline_days else "â€”")
        with col_m3:
            st.metric("ðŸ‘¤ ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹", zr.responsible[:15] if zr.responsible else "â€”")
        with col_m4:
            st.metric("âš–ï¸ Ð£Ñ‡Ð°ÑÑ‚Ð¸Ðµ Ð®Ð”", "Ð”Ð°" if zr.requires_legal else "ÐÐµÑ‚")
        
        if zr.approval_route:
            st.info("ðŸ“ **ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ:** " + " â†’ ".join(zr.approval_route))
        
        for warning in zr.warnings:
            st.warning(warning)
        
        st.markdown(f"**Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ:** {LEGAL_STATUS_LABELS[legal_status]}")
    
    st.markdown("---")
    
    # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°
    st.markdown("### ðŸ“„ Ð¢ÐµÐºÑÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°")
    
    uploaded_file = st.file_uploader("Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°", type=["txt", "docx", "pdf"], help="ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹: TXT, DOCX, PDF")
    
    if uploaded_file:
        with st.spinner("Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°..."):
            success, result = DocumentLoader.load_file(uploaded_file)
        
        if success:
            st.session_state.contract_text = Validator.sanitize_text(result)
            st.success(f"âœ… Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½: {len(st.session_state.contract_text):,} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²")
        else:
            st.error(result)
    
    contract_text = st.text_area(
        "Ð˜Ð»Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°:",
        value=st.session_state.contract_text,
        height=250,
        placeholder="Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð¸Ð»Ð¸ ÐµÐ³Ð¾ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»Ñ‹...",
        help="ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 100 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°"
    )
    
    if contract_text != st.session_state.contract_text:
        st.session_state.contract_text = Validator.sanitize_text(contract_text)
    
    # Ð’Ñ‹Ð±Ð¾Ñ€ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹
    all_tf = {**BUILTIN_TYPICAL_FORMS, **st.session_state.custom_typical_forms}
    tf_options = [("â€” Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿Ð¾Ð²ÑƒÑŽ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ â€”", None)]
    tf_options += [(f"{v['name']} ({v['code']})", k) for k, v in all_tf.items()]
    
    selected_tf_key = st.selectbox("Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ñ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð¾Ð¹:", options=tf_options, format_func=lambda x: x[0])[1]
    
    # ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
    col_an1, col_an2 = st.columns(2)
    
    with col_an1:
        compare_btn = st.button("ðŸ” Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ñ Ð¢Ð¤ Ð¸ Ð½Ð°Ð¹Ñ‚Ð¸ Ñ€Ð¸ÑÐºÐ¸", type="primary", use_container_width=True)
    
    with col_an2:
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ AI
        api_keys = st.session_state.get("api_keys", {})
        has_api = any(api_keys.get(p) for p in st.session_state.get("enabled_providers", []))
        
        ai_btn = st.button("ðŸ¤– AI-Ð°Ð½Ð°Ð»Ð¸Ð· Ñ€Ð¸ÑÐºÐ¾Ð²", use_container_width=True, disabled=not has_api)
        
        if not has_api:
            st.caption("ðŸ’¡ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ API-ÐºÐ»ÑŽÑ‡ Ð²Ð¾ Ð²ÐºÐ»Ð°Ð´ÐºÐµ Â«ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸Â»")
    
    # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ
    if compare_btn:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð¼
        require_counterparty = admin_settings.get("require_counterparty", True)
        require_text = admin_settings.get("require_contract_text", True)
        min_length = admin_settings.get("min_contract_length", 100)
        
        errors = []
        if require_counterparty and (not counterparty or len(counterparty.strip()) < 3):
            errors.append("Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚Ð°")
        if require_text and (not st.session_state.contract_text or len(st.session_state.contract_text.strip()) < min_length):
            errors.append(f"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¸Ð»Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ {min_length} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)")
        if not selected_tf_key:
            errors.append("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿Ð¾Ð²ÑƒÑŽ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ")
        
        if errors:
            for err in errors:
                st.error(f"âŒ {err}")
        else:
            with st.spinner("ðŸ”„ ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€..."):
                tf = all_tf.get(selected_tf_key)
                st.session_state.comparison_result = AdvancedComparator.full_comparison(st.session_state.contract_text, tf)
            st.rerun()
    
    # AI-Ð°Ð½Ð°Ð»Ð¸Ð·
    if ai_btn:
        if not st.session_state.comparison_result:
            st.warning("âš ï¸ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð¾Ð¹")
        elif len(st.session_state.contract_text) < 100:
            st.error("âŒ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 100 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)")
        else:
            with st.spinner("ðŸ¤– AI Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€..."):
                api_keys = st.session_state.get("api_keys", {})
                enabled = st.session_state.get("enabled_providers", [])
                folder_id = st.session_state.get("yandex_folder_id", "")
                org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
                
                # ÐÐ°Ð¹Ñ‚Ð¸ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€
                provider = None
                api_key = None
                for p in enabled:
                    if api_keys.get(p):
                        provider = p
                        api_key = api_keys[p]
                        break
                
                if provider and api_key:
                    prompt = AIAnalyzer.generate_prompt(st.session_state.contract_text, st.session_state.comparison_result, org)
                    success, result = AIAnalyzer.call_provider(provider, prompt, api_key, folder_id)
                    
                    if success:
                        st.session_state.ai_analysis = result
                    else:
                        st.error(f"âŒ {result}")
                else:
                    st.error("âŒ API-ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½")
            
            if st.session_state.ai_analysis:
                st.rerun()
    
    # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ
    if st.session_state.comparison_result:
        render_comparison_results(st.session_state.comparison_result)
    
    # AI-Ð°Ð½Ð°Ð»Ð¸Ð·
    if st.session_state.ai_analysis:
        st.markdown("---")
        st.markdown("### ðŸ¤– Ð­ÐºÑÐ¿ÐµÑ€Ñ‚Ð½Ð¾Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ (AI-Ð°Ð½Ð°Ð»Ð¸Ð·)")
        st.markdown(f'<div class="info-box">{st.session_state.ai_analysis}</div>', unsafe_allow_html=True)


def render_comparison_results(result: Dict):
    """ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ"""
    st.markdown("---")
    st.markdown(f"### ðŸ“‹ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ñ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð¾Ð¹")
    st.markdown(f"**{result.get('form_name', '')}** ({result.get('form_code', '')})")
    
    compliance = result.get('compliance_score', 0)
    
    col1, col2, col3, col4 = st.columns(4)
    
    color = "#28a745" if compliance >= 70 else "#f0ad4e" if compliance >= 40 else "#dc3545"
    
    with col1:
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:{color};">{compliance:.0f}%</div><div class="metric-label">Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¢Ð¤</div></div>', unsafe_allow_html=True)
    with col2:
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#28a745;">{len(result.get("found_sections", []))}</div><div class="metric-label">ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²</div></div>', unsafe_allow_html=True)
    with col3:
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#dc3545;">{len(result.get("missing_sections", []))}</div><div class="metric-label">ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚</div></div>', unsafe_allow_html=True)
    with col4:
        st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#f0ad4e;">{len(result.get("deviation_sections", []))}</div><div class="metric-label">Ð¡ Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸ÑÐ¼Ð¸</div></div>', unsafe_allow_html=True)
    
    st.markdown(f"**Ð ÐµÐ·ÑŽÐ¼Ðµ:** {result.get('summary', '')}")
    
    red_risks = [r for r in result.get('risks', []) if r.get('risk_level') == 'red']
    yellow_risks = [r for r in result.get('risks', []) if r.get('risk_level') == 'yellow']
    
    if red_risks:
        with st.expander(f"ðŸ”´ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð Ð˜Ð¡ÐšÐ˜ ({len(red_risks)})", expanded=True):
            for risk in red_risks:
                st.markdown(f'''
                <div class="risk-item red">
                    <strong>âš ï¸ {risk.get("issue", "")}</strong>
                    <div style="margin-top:8px;font-size:0.9rem;color:#666;">{risk.get("context", "")[:300]}...</div>
                </div>
                ''', unsafe_allow_html=True)
    
    if yellow_risks:
        with st.expander(f"ðŸŸ¡ Ð¢Ð Ð•Ð‘Ð£Ð®Ð¢ Ð’ÐÐ˜ÐœÐÐÐ˜Ð¯ ({len(yellow_risks)})"):
            for risk in yellow_risks:
                st.markdown(f'<div class="risk-item yellow"><strong>âš¡ {risk.get("issue", "")}</strong></div>', unsafe_allow_html=True)
    
    with st.expander("ðŸ“‘ Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¿Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð°Ð¼"):
        for section in result.get('sections_analysis', []):
            comp = section.get('comparison', {})
            status = comp.get('status', 'missing')
            score = comp.get('combined_score', 0) * 100
            
            status_config = {
                "match": ("âœ…", "#28a745", "score-high"),
                "partial": ("âš ï¸", "#f0ad4e", "score-medium"),
                "deviation": ("âŒ", "#dc3545", "score-low"),
                "missing": ("âŒ", "#dc3545", "score-low"),
            }
            icon, color, score_class = status_config.get(status, ("â“", "#6c757d", "score-medium"))
            required_badge = ' <span style="background:#e9ecef;padding:2px 8px;border-radius:4px;font-size:0.75rem;">ÐžÐ‘Ð¯Ð—ÐÐ¢.</span>' if section.get('required') else ''
            
            st.markdown(f'''
            <div style="margin-bottom:12px;padding:10px;border-left:4px solid {color};background:#f8f9fa;border-radius:0 8px 8px 0;">
                <strong>{icon} {section.get("section_name", "")}</strong>{required_badge}
                <span class="section-score {score_class}" style="float:right;">{score:.0f}%</span>
            </div>
            ''', unsafe_allow_html=True)
            
            for risk in section.get('risks', []):
                risk_icon = "ðŸ”´" if risk.get('risk_level') == 'red' else "ðŸŸ¡"
                st.markdown(f"&nbsp;&nbsp;&nbsp;&nbsp;{risk_icon} {risk.get('issue', '')}")

# ============================================================================
# UI: Ð’ÐšÐ›ÐÐ”ÐšÐ ÐžÐ¢Ð§ÐÐ¢ÐžÐ’
# ============================================================================

def render_reports_tab():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    
    st.markdown("### ðŸ“Š Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²")
    
    if not st.session_state.comparison_result and not st.session_state.zone_result:
        st.info("â„¹ï¸ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð°Ð½Ð°Ð»Ð¸Ð· Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð½Ð° Ð²ÐºÐ»Ð°Ð´ÐºÐµ Â«ÐÐ½Ð°Ð»Ð¸Ð·Â»")
        return
    
    inp = st.session_state.get('current_input') or AnalysisInput()
    
    data = {
        "analysis_id": hashlib.md5(datetime.now().isoformat().encode()).hexdigest()[:8],
        "counterparty": inp.counterparty or "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½",
        "contract_number": inp.contract_number or "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½",
        "contract_date": str(inp.contract_date) if inp.contract_date else "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°",
        "contract_type": inp.document_type or "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½",
        "document_form_label": DOCUMENT_FORM_LABELS.get(inp.document_form, "") if inp.document_form else "",
        "amount": inp.amount or 0,
        "legal_status_label": LEGAL_STATUS_LABELS.get(inp.legal_status, "") if inp.legal_status else "",
    }
    
    if st.session_state.zone_result:
        zr = st.session_state.zone_result
        data.update({
            "zone": zr.zone.value if zr.zone else "",
            "zone_reason": zr.zone_reason or "",
            "requires_legal": zr.requires_legal,
            "deadline_days": zr.deadline_days or 0,
            "approver": zr.responsible or "",
        })
    
    if st.session_state.comparison_result:
        cr = st.session_state.comparison_result
        data.update({
            "compliance_score": cr.get("compliance_score", 0),
            "tf_name": cr.get("form_name", ""),
            "tf_code": cr.get("form_code", ""),
            "risks": cr.get("risks", []),
            "sections_analysis": cr.get("sections_analysis", []),
            "missing_sections": cr.get("missing_sections", []),
            "deviation_sections": cr.get("deviation_sections", []),
            "recommendations": cr.get("recommendations", []),
            "summary": cr.get("summary", ""),
        })
    
    # Ð Ð°ÑÑ‡Ñ‘Ñ‚ Ñ€Ð¸ÑÐº-ÑÐºÐ¾Ñ€Ð°
    red_count = sum(1 for r in data.get('risks', []) if r.get('risk_level') == 'red')
    yellow_count = sum(1 for r in data.get('risks', []) if r.get('risk_level') == 'yellow')
    data["risk_score"] = min(10, red_count * 2 + yellow_count * 0.7)
    
    # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
    zone = data.get("zone", "")
    if zone == "red" or data["risk_score"] >= 6:
        data["conclusion"] = "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð Ð˜Ð¡ÐšÐ˜. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð° Ð¿Ð¾Ð»Ð½ÑƒÑŽ ÑŽÑ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÐºÑÐ¿ÐµÑ€Ñ‚Ð¸Ð·Ñƒ Ð¸ ÑƒÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð²Ñ‹ÑÐ²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ñ Ð´Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ."
    elif zone == "yellow" or data["risk_score"] >= 3:
        data["conclusion"] = "Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ñ‚ÑŒ Ñ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð¾Ð¼ Ð¸ Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ñ€Ð¸ÑÐºÐ¾Ð²Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹."
    else:
        data["conclusion"] = f"Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ñ€Ð¸ÑÐºÐ¾Ð² Ð½Ðµ Ð²Ñ‹ÑÐ²Ð»ÐµÐ½Ð¾. Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ðµ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ {data.get('compliance_score', 0):.0f}%. Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½ Ð² ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ."
    
    # ÐŸÑ€ÐµÐ´Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€
    st.markdown("#### ðŸ“‹ ÐŸÑ€ÐµÐ´Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°")
    
    zone_emoji = {"green": "ðŸŸ¢", "yellow": "ðŸŸ¡", "red": "ðŸ”´"}.get(zone, "âšª")
    
    col_preview1, col_preview2 = st.columns(2)
    
    with col_preview1:
        st.markdown(f"""
        **ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚:** {data.get('counterparty')}  
        **ÐÐ¾Ð¼ÐµÑ€ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°:** {data.get('contract_number')}  
        **Ð¡ÑƒÐ¼Ð¼Ð°:** {data.get('amount', 0):,.0f} â‚½
        """)
    
    with col_preview2:
        st.markdown(f"""
        **Ð—Ð¾Ð½Ð° Ñ€Ð¸ÑÐºÐ°:** {zone_emoji} {zone.upper() if zone else 'ÐÐ• ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ'}  
        **Ð Ð¸ÑÐº-ÑÐºÐ¾Ñ€:** {data['risk_score']:.1f} / 10  
        **Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¢Ð¤:** {data.get('compliance_score', 0):.0f}%
        """)
    
    st.markdown("---")
    
    # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²
    st.markdown("#### ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("**ðŸ“„ Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹**")
        
        html_report = ReportGenerator.generate_html_report(data, st.session_state.user, org, st.session_state.ai_analysis)
        st.download_button("ðŸ“¥ HTML (Ð´Ð»Ñ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸/PDF)", html_report.encode('utf-8'), f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html", "text/html", use_container_width=True)
        
        if DOCX_AVAILABLE:
            success, docx_data = ReportGenerator.generate_docx_report(data, st.session_state.user, org, st.session_state.ai_analysis)
            if success:
                st.download_button("ðŸ“¥ DOCX (Word)", docx_data, f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.docx", "application/vnd.openxmlformats-officedocument.wordprocessingml.document", use_container_width=True)
            else:
                st.warning("DOCX: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸")
        else:
            st.warning("DOCX: ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ python-docx")
        
        txt_report = ReportGenerator.generate_text_report(data, st.session_state.user, org, st.session_state.ai_analysis)
        st.download_button("ðŸ“¥ TXT (Ñ‚ÐµÐºÑÑ‚)", txt_report.encode('utf-8'), f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt", "text/plain", use_container_width=True)
    
    with col2:
        st.markdown("**ðŸ“Š JSON Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹**")
        
        json_1c = ReportGenerator.generate_json_1c(data, st.session_state.user, org)
        st.download_button("ðŸ“¥ JSON Ð´Ð»Ñ 1Ð¡", json_1c.encode('utf-8'), f"1c_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json", "application/json", use_container_width=True)
    
    with col3:
        st.markdown("**ðŸ’¾ Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ**")
        
        if st.button("ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ", use_container_width=True):
            add_to_history(data)
            st.success("âœ… ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ!")
        
        st.caption("ðŸ’¡ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ ÐºÐ°Ðº PDF Ñ‡ÐµÑ€ÐµÐ· Ctrl+P")
    
    with st.expander("ðŸ‘ï¸ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°"):
        st.text(txt_report)

# ============================================================================
# UI: Ð’ÐšÐ›ÐÐ”ÐšÐ Ð¢Ð˜ÐŸÐžÐ’Ð«Ð¥ Ð¤ÐžÐ Ðœ
# ============================================================================

def render_typical_forms_tab():
    st.markdown("### ðŸ“‚ Ð¢Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð²")
    
    # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ²Ð¾ÐµÐ¹ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹
    st.markdown("#### â¬†ï¸ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ²Ð¾ÑŽ Ñ‚Ð¸Ð¿Ð¾Ð²ÑƒÑŽ Ñ„Ð¾Ñ€Ð¼Ñƒ")
    
    col_upload1, col_upload2 = st.columns(2)
    
    with col_upload1:
        tf_name = st.text_input("ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹", placeholder="Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð½Ð° Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ")
    
    with col_upload2:
        uploaded_tf = st.file_uploader("Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»", type=["docx", "pdf", "txt", "json"], key="tf_uploader")
    
    if uploaded_tf and tf_name:
        if st.button("ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿Ð¾Ð²ÑƒÑŽ Ñ„Ð¾Ñ€Ð¼Ñƒ", type="primary"):
            with st.spinner("ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ„Ð°Ð¹Ð»Ð°..."):
                filename = uploaded_tf.name.lower()
                
                if filename.endswith('.json'):
                    try:
                        content = uploaded_tf.read().decode('utf-8')
                        tf_data = json.loads(content)
                        
                        if "name" in tf_data and "sections" in tf_data:
                            code = tf_data.get("code", f"USER-{len(st.session_state.custom_typical_forms)+1}")
                            st.session_state.custom_typical_forms[code] = tf_data
                            st.success(f"âœ… Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Â«{tf_data['name']}Â» Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°!")
                            st.rerun()
                        else:
                            st.error("âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ JSON. Ð¢Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ Ð¿Ð¾Ð»Ñ: name, sections")
                    except json.JSONDecodeError as e:
                        st.error(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° JSON: {e}")
                else:
                    success, text = DocumentLoader.load_file(uploaded_tf)
                    
                    if success and len(text) > 100:
                        tf_data = DocumentLoader.parse_typical_form(text, tf_name)
                        code = tf_data["code"]
                        st.session_state.custom_typical_forms[code] = tf_data
                        st.success(f"âœ… Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Â«{tf_name}Â» ÑÐ¾Ð·Ð´Ð°Ð½Ð°! ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ {len(tf_data['sections'])} Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð².")
                        st.rerun()
                    else:
                        st.error(f"âŒ {text if not success else 'Ð¤Ð°Ð¹Ð» ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹'}")
    
    st.markdown("---")
    
    # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ñ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼
    st.markdown("#### ðŸ“‹ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ñ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹")
    
    all_tf = {**BUILTIN_TYPICAL_FORMS, **st.session_state.custom_typical_forms}
    
    for key, tf in all_tf.items():
        is_custom = key in st.session_state.custom_typical_forms
        
        with st.expander(f"ðŸ“„ {tf.get('name', key)} ({tf.get('code', key)})"):
            col_info1, col_info2 = st.columns([3, 1])
            
            with col_info1:
                badge = "ðŸ”µ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ°Ñ" if is_custom else "âšª Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ð°Ñ"
                st.markdown(f"""
                **ÐšÐ¾Ð´:** {tf.get('code', '')} | **Ð’ÐµÑ€ÑÐ¸Ñ:** {tf.get('version', '1.0')}  
                {badge}
                """)
                
                if tf.get('description'):
                    st.caption(tf['description'])
            
            with col_info2:
                st.download_button("ðŸ“¥ JSON", json.dumps(tf, ensure_ascii=False, indent=2).encode('utf-8'), f"{key}.json", "application/json", key=f"download_{key}", use_container_width=True)
                
                if is_custom:
                    if st.button("ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ", key=f"delete_{key}", use_container_width=True):
                        del st.session_state.custom_typical_forms[key]
                        st.rerun()
            
            st.markdown("**Ð Ð°Ð·Ð´ÐµÐ»Ñ‹:**")
            for section_name, section_data in tf.get("sections", {}).items():
                required_icon = "âœ…" if section_data.get("required") else "âšª"
                risk_count = len(section_data.get("risk_patterns", []))
                risk_badge = f" ({risk_count} Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº)" if risk_count > 0 else ""
                st.markdown(f"{required_icon} {section_name}{risk_badge}")

# ============================================================================
# UI: Ð’ÐšÐ›ÐÐ”ÐšÐ ÐÐÐ¡Ð¢Ð ÐžÐ•Ðš (Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹)
# ============================================================================

def render_settings_tab():
    st.markdown("### âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸")
    
    # API-ÐºÐ»ÑŽÑ‡Ð¸
    st.markdown("#### ðŸ”‘ API-ÐºÐ»ÑŽÑ‡Ð¸ Ð´Ð»Ñ AI-Ð°Ð½Ð°Ð»Ð¸Ð·Ð°")
    st.info("â„¹ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ API-ÐºÐ»ÑŽÑ‡ Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ AI-Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð²")
    
    api_keys = st.session_state.get("api_keys", {})
    enabled_providers = st.session_state.get("enabled_providers", list(AI_PROVIDERS.keys()))
    
    for provider_id, provider_info in AI_PROVIDERS.items():
        if provider_id not in enabled_providers:
            continue
        
        col1, col2, col3 = st.columns([3, 1, 1])
        
        with col1:
            current_key = api_keys.get(provider_id, "")
            masked_key = f"{current_key[:8]}...{current_key[-4:]}" if len(current_key) > 12 else ("*" * len(current_key) if current_key else "")
            
            new_key = st.text_input(
                f"{provider_info['name']}",
                type="password",
                value=current_key,
                placeholder=f"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ API ÐºÐ»ÑŽÑ‡ ({provider_info.get('key_prefix', '')}...)",
                key=f"api_key_{provider_id}"
            )
            
            if new_key != current_key:
                st.session_state.api_keys[provider_id] = new_key
        
        with col2:
            if api_keys.get(provider_id):
                if st.button("ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ", key=f"test_{provider_id}"):
                    with st.spinner("ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°..."):
                        folder_id = st.session_state.get("yandex_folder_id", "") if provider_id == "yandexgpt" else ""
                        success, msg = AIAnalyzer.test_api_key(provider_id, api_keys[provider_id], folder_id)
                    if success:
                        st.success(msg)
                    else:
                        st.error(msg)
        
        with col3:
            if api_keys.get(provider_id):
                st.markdown(f"{'âœ…' if api_keys.get(provider_id) else 'âŒ'}")
    
    # Ð”Ð»Ñ YandexGPT Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð½ÑƒÐ¶ÐµÐ½ Folder ID
    if "yandexgpt" in enabled_providers:
        st.markdown("---")
        folder_id = st.text_input(
            "YandexGPT Folder ID",
            value=st.session_state.get("yandex_folder_id", ""),
            placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Folder ID Ð¸Ð· Yandex Cloud"
        )
        if folder_id != st.session_state.get("yandex_folder_id", ""):
            st.session_state.yandex_folder_id = folder_id
    
    st.markdown("---")
    
    # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ
    st.markdown("#### â„¹ï¸ Ðž ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ")
    
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    
    st.markdown(f"""
    **Legal Traffic Light v7.0 Professional**  
    Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð²  
    Â© {org.get('short_name', 'ÐÐž Â«Ð¡ÐŸÐšÂ»')} {datetime.now().year}
    
    ---
    
    **ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ AI-Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ñ‹:**
    - OpenAI GPT-4
    - Anthropic Claude
    - GigaChat (Ð¡Ð±ÐµÑ€)
    - YandexGPT
    - Mistral AI
    - Perplexity AI
    
    ---
    
    **Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:**
    ```bash
    pip install streamlit python-docx PyPDF2 requests
    ```
    
    **Ð—Ð°Ð¿ÑƒÑÐº:**
    ```bash
    streamlit run legal_traffic_light_v7.py
    ```
    """)
    
    st.markdown("#### ðŸ“š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº")
    st.markdown(f"{'âœ…' if DOCX_AVAILABLE else 'âŒ'} python-docx â€” Ð§Ñ‚ÐµÐ½Ð¸Ðµ/Ð·Ð°Ð¿Ð¸ÑÑŒ DOCX")
    st.markdown(f"{'âœ…' if PDF_READER_AVAILABLE else 'âŒ'} PyPDF2 â€” Ð§Ñ‚ÐµÐ½Ð¸Ðµ PDF")

# ============================================================================
# UI: ÐÐ”ÐœÐ˜Ð-ÐŸÐÐÐ•Ð›Ð¬ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²)
# ============================================================================

def render_admin_tab():
    """Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²"""
    
    if st.session_state.user_role != UserRole.ADMIN:
        st.error("ðŸš« Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰Ñ‘Ð½. Ð¢Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ Ð¿Ñ€Ð°Ð²Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°.")
        return
    
    st.markdown("### ðŸ”§ ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°")
    st.markdown('<div class="admin-panel">', unsafe_allow_html=True)
    
    # Ð’ÐºÐ»Ð°Ð´ÐºÐ¸ Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»Ð¸
    admin_tabs = st.tabs(["ðŸ¢ ÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ", "ðŸ“Š ÐŸÐ¾Ñ€Ð¾Ð³Ð¸", "ðŸ”‘ API-ÐºÐ»ÑŽÑ‡Ð¸", "âš™ï¸ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹", "ðŸ‘¥ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸"])
    
    # --- Ð’ÐºÐ»Ð°Ð´ÐºÐ°: ÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ ---
    with admin_tabs[0]:
        st.markdown("#### ðŸ¢ Ð ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸")
        
        org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
        
        col1, col2 = st.columns(2)
        
        with col1:
            new_full_name = st.text_input("ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð½Ð°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ", value=org.get("full_name", ""), key="admin_full_name")
            new_short_name = st.text_input("ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð½Ð°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ", value=org.get("short_name", ""), key="admin_short_name")
            new_abbrev = st.text_input("ÐÐ±Ð±Ñ€ÐµÐ²Ð¸Ð°Ñ‚ÑƒÑ€Ð°", value=org.get("abbrev", ""), key="admin_abbrev")
            new_inn = st.text_input("Ð˜ÐÐ", value=org.get("inn", ""), key="admin_inn")
            new_kpp = st.text_input("ÐšÐŸÐŸ", value=org.get("kpp", ""), key="admin_kpp")
        
        with col2:
            new_ogrn = st.text_input("ÐžÐ“Ð Ð", value=org.get("ogrn", ""), key="admin_ogrn")
            new_address = st.text_input("Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð´Ñ€ÐµÑ", value=org.get("address", ""), key="admin_address")
            new_director_name = st.text_input("Ð¤Ð˜Ðž Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ", value=org.get("director_name", ""), key="admin_director")
            new_director_position = st.text_input("Ð”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ", value=org.get("director_position", ""), key="admin_dir_pos")
            new_basis = st.text_input("ÐžÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ð¼Ð¾Ñ‡Ð¸Ð¹", value=org.get("basis", ""), key="admin_basis")
        
        if st.button("ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸", key="save_org"):
            st.session_state.org_config = {
                "full_name": new_full_name,
                "short_name": new_short_name,
                "abbrev": new_abbrev,
                "inn": new_inn,
                "kpp": new_kpp,
                "ogrn": new_ogrn,
                "address": new_address,
                "director_name": new_director_name,
                "director_position": new_director_position,
                "basis": new_basis
            }
            st.success("âœ… Ð ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹!")
    
    # --- Ð’ÐºÐ»Ð°Ð´ÐºÐ°: ÐŸÐ¾Ñ€Ð¾Ð³Ð¸ ---
    with admin_tabs[1]:
        st.markdown("#### ðŸ“Š ÐŸÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð·Ð¾Ð½ Ñ€Ð¸ÑÐºÐ°")
        
        thresholds = st.session_state.get("thresholds", DEFAULT_THRESHOLDS)
        
        st.markdown("**Ð—ÐµÐ»Ñ‘Ð½Ð°Ñ Ð·Ð¾Ð½Ð° (ÑÐ°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ):**")
        col1, col2 = st.columns(2)
        with col1:
            new_green_tf = st.number_input(
                "ÐœÐ°ÐºÑ. ÑÑƒÐ¼Ð¼Ð° Ð´Ð»Ñ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹ (â‚½)",
                value=thresholds.get("green_tf_max", 100000),
                min_value=0, max_value=10_000_000, step=10000,
                key="thresh_green_tf"
            )
        with col2:
            new_green_non_tf = st.number_input(
                "ÐœÐ°ÐºÑ. ÑÑƒÐ¼Ð¼Ð° Ð´Ð»Ñ Ð½ÐµÑ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹ (â‚½)",
                value=thresholds.get("green_non_tf_max", 50000),
                min_value=0, max_value=10_000_000, step=10000,
                key="thresh_green_non_tf"
            )
        
        st.markdown("**Ð–Ñ‘Ð»Ñ‚Ð°Ñ Ð·Ð¾Ð½Ð° (ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ Ð®Ð”):**")
        new_yellow_max = st.number_input(
            "ÐœÐ°ÐºÑ. ÑÑƒÐ¼Ð¼Ð° Ð¶Ñ‘Ð»Ñ‚Ð¾Ð¹ Ð·Ð¾Ð½Ñ‹ (â‚½)",
            value=thresholds.get("yellow_max", 5_000_000),
            min_value=0, max_value=100_000_000, step=100000,
            key="thresh_yellow"
        )
        
        st.markdown("**Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ñ€Ð¾Ð³Ð¸:**")
        col3, col4 = st.columns(2)
        with col3:
            new_tender_red = st.number_input(
                "Ð¢ÐµÐ½Ð´ÐµÑ€ â†’ ÐºÑ€Ð°ÑÐ½Ð°Ñ Ð·Ð¾Ð½Ð° Ð¾Ñ‚ (â‚½)",
                value=thresholds.get("tender_red", 3_000_000),
                min_value=0, max_value=50_000_000, step=100000,
                key="thresh_tender"
            )
        with col4:
            new_single_supplier = st.number_input(
                "Ð•Ð´. Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº â†’ Ð¶Ñ‘Ð»Ñ‚Ð°Ñ Ð·Ð¾Ð½Ð° Ð¾Ñ‚ (â‚½)",
                value=thresholds.get("single_supplier_yellow", 100_000),
                min_value=0, max_value=5_000_000, step=10000,
                key="thresh_single"
            )
        
        st.markdown("**Ð¡Ñ€Ð¾ÐºÐ¸ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ (Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹):**")
        deadlines = st.session_state.get("deadlines", DEFAULT_DEADLINES)
        col5, col6, col7 = st.columns(3)
        with col5:
            new_standard = st.number_input("Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹", value=deadlines.get("standard", 5), min_value=1, max_value=30, key="dl_std")
        with col6:
            new_extended = st.number_input("Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹", value=deadlines.get("extended", 10), min_value=1, max_value=60, key="dl_ext")
        with col7:
            new_urgent = st.number_input("Ð¡Ñ€Ð¾Ñ‡Ð½Ñ‹Ð¹", value=deadlines.get("urgent", 1), min_value=1, max_value=10, key="dl_urg")
        
        if st.button("ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ€Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ", key="save_thresholds"):
            st.session_state.thresholds = {
                "green_tf_max": new_green_tf,
                "green_non_tf_max": new_green_non_tf,
                "yellow_max": new_yellow_max,
                "tender_red": new_tender_red,
                "single_supplier_yellow": new_single_supplier
            }
            st.session_state.deadlines = {
                "standard": new_standard,
                "extended": new_extended,
                "urgent": new_urgent
            }
            st.success("âœ… ÐŸÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹!")
    
    # --- Ð’ÐºÐ»Ð°Ð´ÐºÐ°: API-ÐºÐ»ÑŽÑ‡Ð¸ ---
    with admin_tabs[2]:
        st.markdown("#### ðŸ”‘ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ API-ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸")
        
        api_keys = st.session_state.get("api_keys", {})
        enabled_providers = st.session_state.get("enabled_providers", list(AI_PROVIDERS.keys()))
        
        st.markdown("**Ð’ÐºÐ»ÑŽÑ‡Ñ‘Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ñ‹:**")
        
        new_enabled = []
        for provider_id, provider_info in AI_PROVIDERS.items():
            col1, col2, col3 = st.columns([1, 3, 1])
            
            with col1:
                is_enabled = st.checkbox(
                    provider_info['name'],
                    value=provider_id in enabled_providers,
                    key=f"enable_{provider_id}"
                )
                if is_enabled:
                    new_enabled.append(provider_id)
            
            with col2:
                new_key = st.text_input(
                    f"API ÐºÐ»ÑŽÑ‡",
                    type="password",
                    value=api_keys.get(provider_id, ""),
                    placeholder=f"{provider_info.get('key_prefix', '')}...",
                    key=f"admin_api_{provider_id}",
                    disabled=not is_enabled
                )
                if new_key != api_keys.get(provider_id, ""):
                    st.session_state.api_keys[provider_id] = new_key
            
            with col3:
                if is_enabled and api_keys.get(provider_id):
                    if st.button("ðŸ”", key=f"admin_test_{provider_id}", help="ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ»ÑŽÑ‡"):
                        with st.spinner("..."):
                            folder_id = st.session_state.get("yandex_folder_id", "") if provider_id == "yandexgpt" else ""
                            success, msg = AIAnalyzer.test_api_key(provider_id, api_keys[provider_id], folder_id)
                        if success:
                            st.success("âœ…")
                        else:
                            st.error("âŒ")
        
        st.session_state.enabled_providers = new_enabled
        
        # YandexGPT Folder ID
        st.markdown("---")
        st.markdown("**Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:**")
        new_folder_id = st.text_input(
            "YandexGPT Folder ID",
            value=st.session_state.get("yandex_folder_id", ""),
            key="admin_folder_id"
        )
        if new_folder_id != st.session_state.get("yandex_folder_id", ""):
            st.session_state.yandex_folder_id = new_folder_id
    
    # --- Ð’ÐºÐ»Ð°Ð´ÐºÐ°: ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ---
    with admin_tabs[3]:
        st.markdown("#### âš™ï¸ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹")
        
        admin_settings = st.session_state.get("admin_settings", {})
        
        st.markdown("**Ð ÐµÐ¶Ð¸Ð¼Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:**")
        new_allow_demo = st.checkbox("Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð´ÐµÐ¼Ð¾-Ñ€ÐµÐ¶Ð¸Ð¼", value=admin_settings.get("allow_demo", True), key="set_demo")
        new_show_ai = st.checkbox("ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ AI-Ð°Ð½Ð°Ð»Ð¸Ð·", value=admin_settings.get("show_ai_tab", True), key="set_ai")
        new_show_reg = st.checkbox("ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð²ÐºÐ»Ð°Ð´ÐºÑƒ Ð ÐµÐ³Ð»Ð°Ð¼ÐµÐ½Ñ‚", value=admin_settings.get("show_regulation_tab", True), key="set_reg")
        
        st.markdown("**Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…:**")
        new_req_counterparty = st.checkbox("Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚Ð°", value=admin_settings.get("require_counterparty", True), key="set_cp")
        new_req_text = st.checkbox("Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°", value=admin_settings.get("require_contract_text", True), key="set_text")
        new_min_len = st.number_input("ÐœÐ¸Ð½. Ð´Ð»Ð¸Ð½Ð° Ñ‚ÐµÐºÑÑ‚Ð° (ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)", value=admin_settings.get("min_contract_length", 100), min_value=10, max_value=1000, key="set_minlen")
        
        if st.button("ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹", key="save_settings"):
            st.session_state.admin_settings = {
                "allow_demo": new_allow_demo,
                "show_ai_tab": new_show_ai,
                "show_regulation_tab": new_show_reg,
                "require_counterparty": new_req_counterparty,
                "require_contract_text": new_req_text,
                "min_contract_length": new_min_len
            }
            st.success("âœ… ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹!")
    
    # --- Ð’ÐºÐ»Ð°Ð´ÐºÐ°: ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ ---
    with admin_tabs[4]:
        st.markdown("#### ðŸ‘¥ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸")
        
        st.info("â„¹ï¸ Ð’ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÑƒÑ‡Ñ‘Ñ‚Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸:")
        
        for login, user_data in DEFAULT_USERS.items():
            role_badge = "ðŸ”´ ÐÐ´Ð¼Ð¸Ð½" if user_data["role"] == UserRole.ADMIN else "ðŸ”µ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ"
            st.markdown(f"""
            - **{login}** â€” {role_badge}
              - Ð¤Ð˜Ðž: {user_data['name']}
              - Ð”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ: {user_data['position']}
            """)
        
        st.markdown("---")
        st.caption("ðŸ’¡ Ð”Ð»Ñ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ LDAP/AD")
    
    st.markdown('</div>', unsafe_allow_html=True)

# ============================================================================
# UI: Ð’ÐšÐ›ÐÐ”ÐšÐ Ð Ð•Ð“Ð›ÐÐœÐ•ÐÐ¢Ð
# ============================================================================

def render_regulation_tab():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    thresholds = st.session_state.get("thresholds", DEFAULT_THRESHOLDS)
    deadlines = st.session_state.get("deadlines", DEFAULT_DEADLINES)
    
    st.markdown(f'''
    <div style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:2rem;border-radius:12px;color:white;margin-bottom:2rem;">
        <h2 style="margin:0 0 0.5rem 0;">ðŸ“‹ Ð ÐµÐ³Ð»Ð°Ð¼ÐµÐ½Ñ‚ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ñ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð¾Ð¼</h2>
        <p style="margin:0;opacity:0.9;">{org.get("short_name", "")} | Ð’ÐµÑ€ÑÐ¸Ñ 3.0</p>
    </div>
    ''', unsafe_allow_html=True)
    
    st.markdown(f'''
    <div class="zone-card green">
        <div class="zone-title">ðŸŸ¢ Ð—Ð•Ð›Ð•ÐÐÐ¯ Ð—ÐžÐÐ â€” Ð¡Ð°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ</div>
        <div class="zone-subtitle">Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÑÐµÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð±ÐµÐ· ÑƒÑ‡Ð°ÑÑ‚Ð¸Ñ Ð®Ð”</div>
        <ul>
            <li>Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹: Ð´Ð¾ <strong>{thresholds.get("green_tf_max", 100000):,.0f}</strong> Ñ€ÑƒÐ±.</li>
            <li>ÐÐµÑ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹: Ð´Ð¾ <strong>{thresholds.get("green_non_tf_max", 50000):,.0f}</strong> Ñ€ÑƒÐ±.</li>
            <li>Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ</li>
        </ul>
    </div>
    
    <div class="zone-card yellow">
        <div class="zone-title">ðŸŸ¡ Ð–Ð•Ð›Ð¢ÐÐ¯ Ð—ÐžÐÐ â€” Ð¡Ð¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ Ð®Ð” ({deadlines.get("standard", 5)} Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹)</div>
        <div class="zone-subtitle">ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ ÑÐºÑÐ¿ÐµÑ€Ñ‚Ð¸Ð·Ð° Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð°</div>
        <ul>
            <li>Ð¢Ð¸Ð¿Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð°: Ð¾Ñ‚ <strong>{thresholds.get("green_tf_max", 100000):,.0f}</strong> Ð´Ð¾ <strong>{thresholds.get("yellow_max", 5000000):,.0f}</strong> Ñ€ÑƒÐ±.</li>
            <li>ÐÐµÑ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹: Ð¾Ñ‚ <strong>{thresholds.get("green_non_tf_max", 50000):,.0f}</strong> Ñ€ÑƒÐ±.</li>
            <li>Ð—Ð°ÐºÑƒÐ¿ÐºÐ° Ñƒ ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ°: Ð¾Ñ‚ <strong>{thresholds.get("single_supplier_yellow", 100000):,.0f}</strong> Ñ€ÑƒÐ±.</li>
            <li>Ð¡Ñ€Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð±Ð¾Ð»ÐµÐµ 3 Ð»ÐµÑ‚</li>
            <li>Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹ Ñ‚Ð¸Ð¿Ð¾Ð²Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹</li>
        </ul>
        <div style="background:#856404;color:white;padding:10px;border-radius:6px;margin-top:12px;font-weight:bold;">
            âš ï¸ Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð±ÐµÐ· Ð²Ð¸Ð·Ñ‹ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð°!
        </div>
    </div>
    
    <div class="zone-card red">
        <div class="zone-title">ðŸ”´ ÐšÐ ÐÐ¡ÐÐÐ¯ Ð—ÐžÐÐ â€” ÐŸÐ¾Ð»Ð½Ð¾Ðµ ÑÐ¾Ð¿Ñ€Ð¾Ð²Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð®Ð”</div>
        <div class="zone-subtitle">Ð®Ð” Ð¿Ñ€Ð¸Ð²Ð»ÐµÐºÐ°ÐµÑ‚ÑÑ Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ´ÐµÐ»ÐºÐ¸</div>
        <ul>
            <li>Ð¡ÑƒÐ¼Ð¼Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° ÑÐ²Ñ‹ÑˆÐµ <strong>{thresholds.get("yellow_max", 5000000):,.0f}</strong> Ñ€ÑƒÐ±.</li>
            <li>Ð¢ÐµÐ½Ð´ÐµÑ€Ñ‹ Ð¸ ÐºÐ¾Ð½ÐºÑƒÑ€ÑÑ‹: Ð¾Ñ‚ <strong>{thresholds.get("tender_red", 3000000):,.0f}</strong> Ñ€ÑƒÐ±.</li>
            <li>Ð¡Ð´ÐµÐ»ÐºÐ¸ Ñ Ð²Ð°Ð³Ð¾Ð½Ð°Ð¼Ð¸, Ð»Ð¾ÐºÐ¾Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ð¼Ð¸, ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°Ð¼Ð¸</li>
            <li>Ð’Ð½ÐµÑˆÐ½ÐµÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð´ÐµÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ (Ð’Ð­Ð”), Ð²Ð°Ð»ÑŽÑ‚Ð½Ñ‹Ðµ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ñ‹</li>
            <li>Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñ‹ Ð½Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð¸ Ð²Ð½ÐµÐ´Ñ€ÐµÐ½Ð¸Ðµ ÐŸÐž</li>
            <li>Ð¡Ð´ÐµÐ»ÐºÐ¸ Ñ Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚ÑŒÑŽ</li>
            <li>ÐšÑ€ÐµÐ´Ð¸Ñ‚Ð½Ñ‹Ðµ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñ‹, Ð·Ð°Ð¹Ð¼Ñ‹, Ð·Ð°Ð»Ð¾Ð³Ð¸</li>
            <li>Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñ‹ Ñ ÐžÐÐž Â«Ð Ð–Ð”Â»</li>
        </ul>
        <div style="background:#721c24;color:white;padding:10px;border-radius:6px;margin-top:12px;font-weight:bold;">
            ðŸš¨ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚ ÑƒÑ‡Ð°ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð° Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿ÐµÑ€ÐµÐ³Ð¾Ð²Ð¾Ñ€Ð¾Ð²!
        </div>
    </div>
    ''', unsafe_allow_html=True)
    
    st.markdown("---")
    
    st.markdown("### â±ï¸ Ð¡Ñ€Ð¾ÐºÐ¸ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown(f'''
        <div class="metric-card">
            <div class="metric-value" style="color:#28a745;">{deadlines.get("standard", 5)}</div>
            <div class="metric-label">Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹ â€” Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹</div>
        </div>
        ''', unsafe_allow_html=True)
    
    with col2:
        st.markdown(f'''
        <div class="metric-card">
            <div class="metric-value" style="color:#f0ad4e;">{deadlines.get("extended", 10)}</div>
            <div class="metric-label">Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹ â€” Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹</div>
        </div>
        ''', unsafe_allow_html=True)
    
    with col3:
        st.markdown(f'''
        <div class="metric-card">
            <div class="metric-value" style="color:#dc3545;">{deadlines.get("urgent", 1)}</div>
            <div class="metric-label">Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð´ÐµÐ½ÑŒ â€” Ð¡Ñ€Ð¾Ñ‡Ð½Ñ‹Ð¹</div>
        </div>
        ''', unsafe_allow_html=True)
    
    st.markdown("---")
    
    st.markdown("### ðŸ“ž ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚Ð°")
    st.markdown(f"""
    **{org.get("short_name", "")}**  
    Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð°Ñ€Ñ‚Ð°Ð¼ÐµÐ½Ñ‚  
    ðŸ“§ legal@spk-rail.ru  
    ðŸ“ž +7 (495) XXX-XX-XX
    """)

# ============================================================================
# UI: Ð’ÐšÐ›ÐÐ”ÐšÐ Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð˜
# ============================================================================

def render_history_tab():
    st.markdown("### ðŸ“œ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð²")
    
    if not st.session_state.history:
        st.info("â„¹ï¸ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð² Ð¿ÑƒÑÑ‚Ð°. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð°Ð½Ð°Ð»Ð¸Ð· Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚.")
        return
    
    # Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
    total = len(st.session_state.history)
    green_count = sum(1 for h in st.session_state.history if h.get('zone') == 'green')
    yellow_count = sum(1 for h in st.session_state.history if h.get('zone') == 'yellow')
    red_count = sum(1 for h in st.session_state.history if h.get('zone') == 'red')
    
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("ðŸ“Š Ð’ÑÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð²", total)
    col2.metric("ðŸŸ¢ Ð—ÐµÐ»Ñ‘Ð½Ñ‹Ñ…", green_count)
    col3.metric("ðŸŸ¡ Ð–Ñ‘Ð»Ñ‚Ñ‹Ñ…", yellow_count)
    col4.metric("ðŸ”´ ÐšÑ€Ð°ÑÐ½Ñ‹Ñ…", red_count)
    
    st.markdown("---")
    
    # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð°Ð½Ð°Ð»Ð¸Ð·Ð¾Ð²
    for item in st.session_state.history:
        zone_emoji = {"green": "ðŸŸ¢", "yellow": "ðŸŸ¡", "red": "ðŸ”´"}.get(item.get("zone", ""), "âšª")
        timestamp = item.get('timestamp', '')[:10]
        
        with st.expander(f"{zone_emoji} {item.get('counterparty', 'N/A')} | {timestamp}"):
            col_h1, col_h2 = st.columns(2)
            
            with col_h1:
                st.markdown(f"""
                **ID:** {item.get('id', '')}  
                **ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚:** {item.get('counterparty', '')}  
                **ÐÐ¾Ð¼ÐµÑ€:** {item.get('contract_number', '')}  
                **Ð¡ÑƒÐ¼Ð¼Ð°:** {item.get('amount', 0):,.0f} â‚½
                """)
            
            with col_h2:
                st.markdown(f"""
                **Ð Ð¸ÑÐº-ÑÐºÐ¾Ñ€:** {item.get('risk_score', 0):.1f} / 10  
                **Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¢Ð¤:** {item.get('compliance_score', 0):.0f}%  
                **Ð£Ñ‡Ð°ÑÑ‚Ð¸Ðµ Ð®Ð”:** {'Ð”Ð°' if item.get('requires_legal') else 'ÐÐµÑ‚'}
                """)
            
            st.download_button(
                "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ JSON",
                json.dumps(item, ensure_ascii=False, indent=2).encode('utf-8'),
                f"analysis_{item.get('id', '')}.json",
                "application/json",
                key=f"history_download_{item.get('id', '')}"
            )
    
    st.markdown("---")
    
    if st.button("ðŸ—‘ï¸ ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ", type="secondary"):
        st.session_state.history = []
        st.rerun()

# ============================================================================
# Ð“Ð›ÐÐ’ÐÐÐ¯ Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯
# ============================================================================

def render_main():
    org = st.session_state.get("org_config", DEFAULT_ORG_CONFIG)
    role = st.session_state.user_role
    admin_settings = st.session_state.get("admin_settings", {})
    
    st.markdown(f'''
    <div class="main-header">
        <div class="traffic-light">
            <span class="tl-red"></span>
            <span class="tl-yellow"></span>
            <span class="tl-green"></span>
        </div>
        <h2>ðŸš¦ Legal Traffic Light <span class="version-badge">v7.0</span></h2>
        <p style="margin:0.5rem 0 0 0;opacity:0.85;">Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð² | {org.get("short_name", "")}</p>
    </div>
    ''', unsafe_allow_html=True)
    
    render_sidebar()
    
    # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÐºÐ»Ð°Ð´Ð¾Ðº Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ€Ð¾Ð»Ð¸
    tab_names = ["ðŸ“ ÐÐ½Ð°Ð»Ð¸Ð·", "ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚Ñ‹", "ðŸ“‚ Ð¢Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹"]
    
    if admin_settings.get("show_regulation_tab", True):
        tab_names.append("ðŸ“‹ Ð ÐµÐ³Ð»Ð°Ð¼ÐµÐ½Ñ‚")
    
    tab_names.append("ðŸ“œ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ")
    tab_names.append("âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸")
    
    if role == UserRole.ADMIN:
        tab_names.append("ðŸ”§ ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ")
    
    tabs = st.tabs(tab_names)
    
    tab_idx = 0
    
    with tabs[tab_idx]:
        render_analysis_tab()
    tab_idx += 1
    
    with tabs[tab_idx]:
        render_reports_tab()
    tab_idx += 1
    
    with tabs[tab_idx]:
        render_typical_forms_tab()
    tab_idx += 1
    
    if admin_settings.get("show_regulation_tab", True):
        with tabs[tab_idx]:
            render_regulation_tab()
        tab_idx += 1
    
    with tabs[tab_idx]:
        render_history_tab()
    tab_idx += 1
    
    with tabs[tab_idx]:
        render_settings_tab()
    tab_idx += 1
    
    if role == UserRole.ADMIN:
        with tabs[tab_idx]:
            render_admin_tab()


def main():
    apply_styles()
    init_session()
    
    if not st.session_state.authenticated:
        render_auth_page()
    else:
        render_main()


if __name__ == "__main__":
    main()
