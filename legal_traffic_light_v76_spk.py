"""
ะะตะณะปะฐะผะตะฝั ะกะฒะตัะพัะพั v7.6
ะะ ยซะกะะยป โ ะกัะฐัะฐั ะฟะตัะตะฒะพะทะพัะฝะฐั ะบะพะผะฟะฐะฝะธั

ะะพะฒะพะต ะฒ v7.6:
- ะะฒัะพะธะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั ะธะท ะดะพะณะพะฒะพัะฐ (ะดะฐัะฐ, ะบะพะฝััะฐะณะตะฝั, ััะผะผะฐ, ะฟัะตะดะผะตั)
- ะฃะปัััะตะฝะฝัะน RAG ั ัะบะฐะทะฐะฝะธะตะผ ะฝะตัะพะพัะฒะตัััะฒัััะธั ะฟัะฝะบัะพะฒ
- AI ะพะฟัะตะดะตะปัะตั ัะธะฟ ะดะพะบัะผะตะฝัะฐ ะธ ะฐะฝะฐะปะธะทะธััะตั ะฟะพ ะฟัะฝะบัะฐะผ
- ะัะฟัะฐะฒะปะตะฝะพ ะพัะพะฑัะฐะถะตะฝะธะต ัะตะทัะปััะฐัะพะฒ (ะฑะตะท ะบะพะดะฐ)
"""

import streamlit as st
import re, json, hashlib, io, time
from datetime import datetime, date
from typing import Dict, List, Tuple, Optional
from dataclasses import dataclass

# ============================================================================
# ะะะะะะะขะะะ
# ============================================================================

DOCX_AVAILABLE = False
PDF_AVAILABLE = False
REQUESTS_AVAILABLE = False

try:
    from docx import Document as DocxDocument
    DOCX_AVAILABLE = True
except ImportError:
    pass

try:
    from PyPDF2 import PdfReader
    PDF_AVAILABLE = True
except ImportError:
    pass

try:
    import requests
    REQUESTS_AVAILABLE = True
except ImportError:
    pass

# ============================================================================
# ะะะกะขะะะะะ ะกะขะะะะะฆะซ
# ============================================================================

st.set_page_config(
    page_title="ะะตะณะปะฐะผะตะฝั ะกะฒะตัะพัะพั v7.6 | ะกะะ",
    page_icon="๐ฆ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ============================================================================
# ะะะะกะขะะะขะซ
# ============================================================================

DEFAULT_ORG_CONFIG = {
    "full_name": 'ะะบัะธะพะฝะตัะฝะพะต ะพะฑัะตััะฒะพ ยซะกัะฐัะฐั ะฟะตัะตะฒะพะทะพัะฝะฐั ะบะพะผะฟะฐะฝะธัยป',
    "short_name": 'ะะ ยซะกะะยป',
    "inn": "7701234567",
    "kpp": "770101001",
    "director_name": "ะกะธะดะพัะพะฒ ะกะตัะณะตะน ะกะตัะณะตะตะฒะธั",
    "director_position": "ะะตะฝะตัะฐะปัะฝัะน ะดะธัะตะบัะพั",
}

DEFAULT_THRESHOLDS = {
    "ะทะตะปัะฝะฐั_ัั_ะผะฐะบั": 100_000,
    "ะทะตะปัะฝะฐั_ะฝะตัั_ะผะฐะบั": 50_000,
    "ะถัะปัะฐั_ะผะฐะบั": 5_000_000,
    "ัะตะฝะดะตั_ะบัะฐัะฝะฐั": 3_000_000,
    "ะตะดะธะฝััะฒ_ะฟะพััะฐะฒัะธะบ": 100_000
}

DEFAULT_DEADLINES = {"ััะฐะฝะดะฐััะฝัะน": 5, "ัะฐััะธัะตะฝะฝัะน": 10, "ััะพัะฝัะน": 1}

ะะะะฌ_ะะะะะ = "ะฐะดะผะธะฝะธัััะฐัะพั"
ะะะะฌ_ะฎะะะ = "ะฟะพะปัะทะพะฒะฐัะตะปั"

# ============================================================================
# ะะะะฌะะะะะขะะะ
# ============================================================================

ะะะะฌะะะะะขะะะ = {
    "admin": {
        "ะฟะฐัะพะปั_ัะตั": hashlib.sha256("admin123".encode()).hexdigest(),
        "ัะพะปั": ะะะะฌ_ะะะะะ,
        "ะธะผั": "ะะดะผะธะฝะธัััะฐัะพั ัะธััะตะผั",
        "ะดะพะปะถะฝะพััั": "ะกะธััะตะผะฝัะน ะฐะดะผะธะฝะธัััะฐัะพั",
        "ะฟะพะดัะฐะทะดะตะปะตะฝะธะต": "ะะข-ะดะตะฟะฐััะฐะผะตะฝั"
    },
    "legal": {
        "ะฟะฐัะพะปั_ัะตั": hashlib.sha256("legal123".encode()).hexdigest(),
        "ัะพะปั": ะะะะฌ_ะะะะะ,
        "ะธะผั": "ะัะบะพะฒะพะดะธัะตะปั ะฎะ",
        "ะดะพะปะถะฝะพััั": "ะัะบะพะฒะพะดะธัะตะปั ะดะตะฟะฐััะฐะผะตะฝัะฐ",
        "ะฟะพะดัะฐะทะดะตะปะตะฝะธะต": "ะฎัะธะดะธัะตัะบะธะน ะดะตะฟะฐััะฐะผะตะฝั"
    }
}

# ============================================================================
# AI ะะะะะะะะะะซ
# ============================================================================

AI_ะะะะะะะะะะซ = {
    "openai": {
        "ะฝะฐะทะฒะฐะฝะธะต": "OpenAI GPT-4",
        "ะผะพะดะตะปั": "gpt-4o-mini",
        "url_api": "https://api.openai.com/v1/chat/completions",
        "url_keys": "https://platform.openai.com/api-keys",
        "ะพะฟะธัะฐะฝะธะต": "ะะพะปััะธัะต ะบะปัั ะฝะฐ platform.openai.com โ API Keys",
        "ัะตะฝะฐ": "~$0.15 ะทะฐ 1M ัะพะบะตะฝะพะฒ"
    },
    "anthropic": {
        "ะฝะฐะทะฒะฐะฝะธะต": "Anthropic Claude",
        "ะผะพะดะตะปั": "claude-3-haiku-20240307",
        "url_api": "https://api.anthropic.com/v1/messages",
        "url_keys": "https://console.anthropic.com/settings/keys",
        "ะพะฟะธัะฐะฝะธะต": "ะะพะปััะธัะต ะบะปัั ะฝะฐ console.anthropic.com โ API Keys",
        "ัะตะฝะฐ": "~$0.25 ะทะฐ 1M ัะพะบะตะฝะพะฒ"
    },
    "gigachat": {
        "ะฝะฐะทะฒะฐะฝะธะต": "GigaChat (ะกะฑะตั)",
        "ะผะพะดะตะปั": "GigaChat",
        "url_api": "https://gigachat.devices.sberbank.ru/api/v1/chat/completions",
        "url_keys": "https://developers.sber.ru/portal/products/gigachat-api",
        "ะพะฟะธัะฐะฝะธะต": "ะะตะณะธัััะฐัะธั ะฝะฐ developers.sber.ru โ GigaChat API",
        "ัะตะฝะฐ": "ะะตัะฟะปะฐัะฝะพ ะดะพ 1000 ะทะฐะฟัะพัะพะฒ/ะผะตั"
    },
    "yandexgpt": {
        "ะฝะฐะทะฒะฐะฝะธะต": "YandexGPT",
        "ะผะพะดะตะปั": "yandexgpt-lite",
        "url_api": "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
        "url_keys": "https://console.cloud.yandex.ru/",
        "ะพะฟะธัะฐะฝะธะต": "ะะพะฝัะพะปั ะฏะฝะดะตะบั.ะะฑะปะฐะบะฐ โ ะกะตัะฒะธัะฝัะต ะฐะบะบะฐัะฝัั โ API-ะบะปัั",
        "ัะตะฝะฐ": "~1.2โฝ ะทะฐ 1000 ัะพะบะตะฝะพะฒ"
    },
}

# ============================================================================
# ะกะะะะะะงะะะะ
# ============================================================================

ะะะะะะะะะะะะะฏ = [
    "ะฎัะธะดะธัะตัะบะธะน ะดะตะฟะฐััะฐะผะตะฝั", "ะะตะฟะฐััะฐะผะตะฝั ะพัะณะฐะฝะธะทะฐัะธะธ ะฟะตัะตะฒะพะทะพะบ",
    "ะะตะฟะฐััะฐะผะตะฝั ะบะพะผะผะตััะตัะบะพะน ัะฐะฑะพัั", "ะะตะฟะฐััะฐะผะตะฝั ะฟะพะดะฒะธะถะฝะพะณะพ ัะพััะฐะฒะฐ",
    "ะคะธะฝะฐะฝัะพะฒัะน ะดะตะฟะฐััะฐะผะตะฝั", "ะะตะฟะฐััะฐะผะตะฝั ะทะฐะบัะฟะพะบ", "ะกะปัะถะฑะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ",
    "ะะข-ะดะตะฟะฐััะฐะผะตะฝั", "ะัะดะตะป ะบะฐะดัะพะฒ", "ะััะณะฐะปัะตัะธั",
]

ะะะะะะะกะขะ = [
    "ะกะฟะตัะธะฐะปะธัั", "ะะตะดััะธะน ัะฟะตัะธะฐะปะธัั", "ะะปะฐะฒะฝัะน ัะฟะตัะธะฐะปะธัั",
    "ะะฐัะฐะปัะฝะธะบ ะพัะดะตะปะฐ", "ะะฐะผะตััะธัะตะปั ะฝะฐัะฐะปัะฝะธะบะฐ ัะฟัะฐะฒะปะตะฝะธั",
    "ะะฐัะฐะปัะฝะธะบ ัะฟัะฐะฒะปะตะฝะธั", "ะัะบะพะฒะพะดะธัะตะปั ะดะตะฟะฐััะฐะผะตะฝัะฐ",
]

ะะะะกะะะฏ_ะะะะ_ะะกะะะะ = [
    "ะัะตะฝะดะฐ ะฒะฐะณะพะฝะพะฒ", "ะะธะทะธะฝะณ ะฒะฐะณะพะฝะพะฒ", "ะะพะบัะฟะบะฐ/ะฟัะพะดะฐะถะฐ ะฒะฐะณะพะฝะพะฒ",
    "ะัะตะฝะดะฐ ะปะพะบะพะผะพัะธะฒะพะฒ", "ะะพะณะพะฒะพั ั ะะะ ยซะะะยป", "ะะญะ/ะะฐะปััะฝัะต ัะฐััััั",
    "ะัะตะดะธัะฝัะน ะดะพะณะพะฒะพั", "ะะพะณะพะฒะพั ะทะฐะนะผะฐ", "ะะพะณะพะฒะพั ะทะฐะปะพะณะฐ",
    "ะัะตะฝะดะฐ/ะะพะบัะฟะบะฐ ะฝะตะดะฒะธะถะธะผะพััะธ", "ะะฐะทัะฐะฑะพัะบะฐ ะะ",
]

ะะะะขะะฏ_ะะะะ_ะขะะะซ = [
    "ะะพะณะพะฒะพั ะขะญะ", "ะะฐะผะพัะฝัะน ะดะพะณะพะฒะพั", "ะะตัะตะฒะพะทะบะฐ ะพะฟะฐัะฝะพะณะพ ะณััะทะฐ",
    "ะะฐะบัะฟะบะฐ ั ะตะดะธะฝััะฒะตะฝะฝะพะณะพ ะฟะพััะฐะฒัะธะบะฐ",
]

ะคะะะะซ_ะะะะฃะะะะขะ = ["ะขะธะฟะพะฒะฐั ัะพัะผะฐ (ะขะค)", "ะคะพัะผะฐ ะบะพะฝััะฐะณะตะฝัะฐ", "ะกะฒะพะฑะพะดะฝะฐั ัะพัะผะฐ", "ะขะค ั ะธะทะผะตะฝะตะฝะธัะผะธ"]

# ============================================================================
# ะขะะะะะซะ ะคะะะะซ ะก ะญะขะะะะะะซะะ ะะฃะะะขะะะ
# ============================================================================

ะขะะะะะซะ_ะคะะะะซ = {
    "ััะปัะณะธ_ััะพ": {
        "ะฝะฐะทะฒะฐะฝะธะต": "ะะพะณะพะฒะพั ะพะบะฐะทะฐะฝะธั ััะปัะณ (ะขะญะ)",
        "ะบะพะด": "ะขะค-ะกะะ-ะฃะกะ-001",
        "ะฒะตััะธั": "2025.1",
        "ะฝะฐัะฐ_ัะพะปั": "ะะฐะบะฐะทัะธะบ",
        "ะพะฟะธัะฐะฝะธะต": "ะขะธะฟะพะฒะฐั ัะพัะผะฐ ะดะปั ะดะพะณะพะฒะพัะพะฒ ััะฐะฝัะฟะพััะฝะพ-ัะบัะฟะตะดะธัะธะพะฝะฝะพะณะพ ะพะฑัะปัะถะธะฒะฐะฝะธั",
        "ะผะฐัะบะตัั": ["ะธัะฟะพะปะฝะธัะตะปั", "ะทะฐะบะฐะทัะธะบ", "ััะปัะณะธ", "ะฒะฐะณะพะฝ", "ะฟะตัะตะฒะพะทะบะฐ", "ััะพ", "ะตะปั", "ัะถะด"],
        
        # ะญัะฐะปะพะฝะฝัะต ะฟัะฝะบัั ะขะค - ััะพ ะะะะะะ ะฑััั
        "ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั": {
            "ะฟัะตะดะพะฟะปะฐัะฐ": {
                "ััะฐะปะพะฝ": "ะัะตะดะพะฟะปะฐัะฐ ะฒ ัะฐะทะผะตัะต ะฝะต ะฑะพะปะตะต 30% ะพั ััะผะผั ะดะพะณะพะฒะพัะฐ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะฟัะตะดะพะฟะปะฐั\w*.*?(?:[4-9]\d|100)\s*%",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ััะพะบ_ะพะฟะปะฐัั": {
                "ััะฐะปะพะฝ": "ะะฟะปะฐัะฐ ะฒ ัะตัะตะฝะธะต 5 (ะฟััะธ) ัะฐะฑะพัะธั ะดะฝะตะน ั ะดะฐัั ะฟะพะปััะตะฝะธั ััััะฐ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะพะฟะปะฐัะฐ.*?(?:1|2|3)\s*(?:ัะฐะฑะพั|ะบะฐะปะตะฝะดะฐัะฝ|ะฑะฐะฝะบะพะฒัะบ)",
                "ะบัะธัะธัะฝะพััั": "ะถัะปััะน"
            },
            "ะฝะตัััะพะนะบะฐ_ะทะฐะบะฐะทัะธะบะฐ": {
                "ััะฐะปะพะฝ": "ะะตัััะพะนะบะฐ 0,1% ะทะฐ ะบะฐะถะดัะน ะดะตะฝั ะฟัะพััะพัะบะธ, ะฝะพ ะฝะต ะฑะพะปะตะต 10% ะพั ััะผะผั ะดะพะณะพะฒะพัะฐ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะฝะตัััะพะนะบ\w*.*?(?:ะทะฐะบะฐะทัะธะบ|ะฟะพะบัะฟะฐัะตะป)\w*.*?(?:0[,.]?[3-9]|[1-9])\s*%",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ะฝะตัััะพะนะบะฐ_ะพะณัะฐะฝะธัะตะฝะธะต": {
                "ััะฐะปะพะฝ": "ะะฑัะฐั ััะผะผะฐ ะฝะตัััะพะนะบะธ ะฝะต ะผะพะถะตั ะฟัะตะฒััะฐัั 10% ะพั ััะผะผั ะดะพะณะพะฒะพัะฐ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะฑะตะท\s*(?:ะพะณัะฐะฝะธัะตะฝ|ะปะธะผะธั|ะฟัะตะดะตะป)",
                "ะบัะธัะธัะฝะพััั": "ะถัะปััะน"
            },
            "ัััะฐั_ะฟัะพััะพะน": {
                "ััะฐะปะพะฝ": "ะจััะฐั ะทะฐ ัะฒะตััะฝะพัะผะฐัะธะฒะฝัะน ะฟัะพััะพะน: ะฝะต ะฑะพะปะตะต 2500 ััะฑ. ะทะฐ ะฒะฐะณะพะฝะพ-ัััะบะธ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"(?:ัััะฐั|ะฝะตัััะพะนะบะฐ).*?ะฟัะพััะพะน.*?(?:[3-9]\d{3}|[1-9]\d{4,})",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ัััะฐั_ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝะพััั": {
                "ััะฐะปะพะฝ": "ะจััะฐั ะทะฐ ะฝะฐัััะตะฝะธะต ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝะพััะธ: ะฝะต ะฑะพะปะตะต 3 000 000 ััะฑะปะตะน",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ัััะฐั.*?ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝะพัั.*?(?:[5-9]|[1-9]\d)\s*(?:000\s*000|ะผะปะฝ)",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ัะฐัะฟัะตะดะตะปะตะฝะธะต_ัะธัะบะพะฒ": {
                "ััะฐะปะพะฝ": "ะะฐะถะดะฐั ััะพัะพะฝะฐ ะฝะตััั ัะธัะบะธ ะฒ ะฟัะตะดะตะปะฐั ัะฒะพะธั ะพะฑัะทะฐัะตะปัััะฒ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะทะฐะบะฐะทัะธะบ.*?(?:ะฝะตััั|ะพัะฒะตัะฐะตั|ะฟัะธะฝะธะผะฐะตั).*?(?:ะฒัะต|ะปัะฑัะต|ะฟะพะปะฝ).*?ัะธัะบ",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ะธะทะผะตะฝะตะฝะธะต_ัะตะฝั": {
                "ััะฐะปะพะฝ": "ะะทะผะตะฝะตะฝะธะต ัะตะฝั/ัะฐัะธัะพะฒ ัะพะปัะบะพ ะฟะพ ะฟะธััะผะตะฝะฝะพะผั ัะพะณะปะฐัะตะฝะธั ััะพัะพะฝ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะพะดะฝะพััะพัะพะฝะฝ\w+.*?(?:ะธะทะผะตะฝะตะฝ|ะฟะพะฒัั|ัะฒะตะปะธั)\w*.*?(?:ัะตะฝ|ัะฐัะธั|ััะพะธะผะพัั)",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ะฟัะธัะผะบะฐ_ััะปัะณ": {
                "ััะฐะปะพะฝ": "ะฃัะปัะณะธ ััะธัะฐัััั ะฟัะธะฝัััะผะธ ะฟะพัะปะต ะฟะพะดะฟะธัะฐะฝะธั ะฐะบัะฐ ะพะฑะตะธะผะธ ััะพัะพะฝะฐะผะธ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะผะพะปัะฐะฝะธ\w+.*?(?:ัะพะณะปะฐัะธ|ะฐะบัะตะฟั|ะฟัะธะฝัั)",
                "ะบัะธัะธัะฝะพััั": "ะถัะปััะน"
            },
            "ะพัะฒะตัััะฒะตะฝะฝะพััั_ะธัะฟะพะปะฝะธัะตะปั": {
                "ััะฐะปะพะฝ": "ะัะฟะพะปะฝะธัะตะปั ะฝะตััั ะพัะฒะตัััะฒะตะฝะฝะพััั ะทะฐ ะฝะตะฝะฐะดะปะตะถะฐัะตะต ะธัะฟะพะปะฝะตะฝะธะต ะพะฑัะทะฐัะตะปัััะฒ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะธัะฟะพะปะฝะธัะตะป\w+.*?ะฝะต\s+(?:ะฝะตััั|ะพัะฒะตัะฐะตั).*?(?:ะพัะฒะตัััะฒะตะฝะฝะพัั|ัะฑััะบ)",
                "ะบัะธัะธัะฝะพััั": "ะถัะปััะน"
            },
            "ะฟะพะดััะดะฝะพััั": {
                "ััะฐะปะพะฝ": "ะัะต ัะฟะพัั ัะฐััะผะฐััะธะฒะฐัััั ะฒ ะัะฑะธััะฐะถะฝะพะผ ััะดะต ะณะพัะพะดะฐ ะะพัะบะฒั",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"(?:ะธะฝะพัััะฐะฝะฝ|ะทะฐััะฑะตะถะฝ)\w*.*?(?:ััะด|ะฐัะฑะธััะฐะถ)",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ััะพะบ_ัะฐััะพัะถะตะฝะธั": {
                "ััะฐะปะพะฝ": "ะะฐััะพัะถะตะฝะธะต ะดะพะณะพะฒะพัะฐ ะฟะพ ะธะฝะธัะธะฐัะธะฒะต ััะพัะพะฝั: ัะฒะตะดะพะผะปะตะฝะธะต ะทะฐ 30 ะดะฝะตะน",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ัะฐััะพัะถ\w*.*?(?:5|7|10)\s*(?:ะดะฝ|ะบะฐะปะตะฝะด)",
                "ะบัะธัะธัะฝะพััั": "ะถัะปััะน"
            },
        },
        
        # ะะฑัะทะฐัะตะปัะฝัะต ัะฐะทะดะตะปั
        "ะพะฑัะทะฐัะตะปัะฝัะต_ัะฐะทะดะตะปั": [
            "ะะะะะะะข ะะะะะะะะ",
            "ะะะะะ ะ ะะะฏะะะะะะกะขะ ะกะขะะะะ", 
            "ะกะขะะะะะกะขะฌ ะ ะะะะฏะะะ ะะะกะงะะขะะ",
            "ะะขะะะขะกะขะะะะะะกะขะฌ ะกะขะะะะ",
            "ะกะะะ ะะะะกะขะะะฏ",
            "ะะะะฏะะะ ะะะะะะจะะะะฏ ะกะะะะะ",
            "ะะะะะะะะขะซ ะกะขะะะะ"
        ]
    },
    
    "ะฟะพััะฐะฒะบะฐ": {
        "ะฝะฐะทะฒะฐะฝะธะต": "ะะพะณะพะฒะพั ะฟะพััะฐะฒะบะธ",
        "ะบะพะด": "ะขะค-ะกะะ-ะะะก-001",
        "ะฒะตััะธั": "2025.1",
        "ะฝะฐัะฐ_ัะพะปั": "ะะพะบัะฟะฐัะตะปั",
        "ะพะฟะธัะฐะฝะธะต": "ะขะธะฟะพะฒะฐั ัะพัะผะฐ ะดะปั ะดะพะณะพะฒะพัะพะฒ ะฟะพััะฐะฒะบะธ",
        "ะผะฐัะบะตัั": ["ะฟะพััะฐะฒัะธะบ", "ะฟะพะบัะฟะฐัะตะปั", "ัะพะฒะฐั", "ะฟะพััะฐะฒะบะฐ", "ัะพัะณ-12"],
        "ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั": {
            "ะฟัะตะดะพะฟะปะฐัะฐ": {
                "ััะฐะปะพะฝ": "ะัะตะดะพะฟะปะฐัะฐ ะฝะต ะฑะพะปะตะต 30%",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะฟัะตะดะพะฟะปะฐั\w*.*?(?:[4-9]\d|100)\s*%",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
            "ะณะฐัะฐะฝัะธั": {
                "ััะฐะปะพะฝ": "ะะฐัะฐะฝัะธะนะฝัะน ััะพะบ ะฝะต ะผะตะฝะตะต 12 ะผะตัััะตะฒ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"(?:ะณะฐัะฐะฝัะธั|ะณะฐัะฐะฝัะธะนะฝัะน).*?(?:[1-6])\s*ะผะตััั",
                "ะบัะธัะธัะฝะพััั": "ะถัะปััะน"
            },
            "ะฟัะธัะผะบะฐ": {
                "ััะฐะปะพะฝ": "ะัะธัะผะบะฐ ะฟะพ ะธะฝััััะบัะธัะผ ะ-6, ะ-7",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ะฑะตะท\s*(?:ะพัะผะพััะฐ|ะฟัะพะฒะตัะบะธ|ะฟัะธัะผะบะธ)",
                "ะบัะธัะธัะฝะพััั": "ะถัะปััะน"
            },
        },
        "ะพะฑัะทะฐัะตะปัะฝัะต_ัะฐะทะดะตะปั": [
            "ะะะะะะะข ะะะะะะะะ",
            "ะะะงะะกะขะะ ะขะะะะะ",
            "ะฆะะะ ะ ะะะะฏะะะ ะะะกะงะะขะะ",
            "ะกะะะะ ะะะกะขะะะะ",
            "ะะะะะะะ ะขะะะะะ",
            "ะะะะะะขะะฏ",
            "ะะขะะะขะกะขะะะะะะกะขะฌ"
        ]
    },
    
    "ััะฐะฝะตะฝะธะต": {
        "ะฝะฐะทะฒะฐะฝะธะต": "ะะพะณะพะฒะพั ััะฐะฝะตะฝะธั",
        "ะบะพะด": "ะขะค-ะกะะ-ะฅะะ-001",
        "ะฒะตััะธั": "2025.1",
        "ะฝะฐัะฐ_ัะพะปั": "ะะพะบะปะฐะถะตะดะฐัะตะปั",
        "ะพะฟะธัะฐะฝะธะต": "ะขะธะฟะพะฒะฐั ัะพัะผะฐ ะดะปั ะดะพะณะพะฒะพัะพะฒ ััะฐะฝะตะฝะธั",
        "ะผะฐัะบะตัั": ["ััะฐะฝะธัะตะปั", "ะฟะพะบะปะฐะถะตะดะฐัะตะปั", "ััะฐะฝะตะฝะธะต", "ะธะผััะตััะฒะพ", "ัะบะปะฐะด"],
        "ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั": {
            "ะพัะฒะตัััะฒะตะฝะฝะพััั_ััะฐะฝะธัะตะปั": {
                "ััะฐะปะพะฝ": "ะฅัะฐะฝะธัะตะปั ะฝะตััั ะฟะพะปะฝัั ะพัะฒะตัััะฒะตะฝะฝะพััั ะทะฐ ัะพััะฐะฝะฝะพััั ะธะผััะตััะฒะฐ",
                "ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั": r"ััะฐะฝะธัะตะป\w+.*?ะฝะต\s+(?:ะฝะตััั|ะพัะฒะตัะฐะตั)",
                "ะบัะธัะธัะฝะพััั": "ะบัะฐัะฝัะน"
            },
        },
        "ะพะฑัะทะฐัะตะปัะฝัะต_ัะฐะทะดะตะปั": [
            "ะะะะะะะข ะะะะะะะะ",
            "ะะะฏะะะะะะกะขะ ะกะขะะะะ",
            "ะะะะะะะะะะะะะะ",
            "ะะขะะะขะกะขะะะะะะกะขะฌ"
        ]
    },
}

# ============================================================================
# ะะะะ ะะะะะะะ
# ============================================================================

ะะะะ_ะะะะะะะ = """ะะะะะะะ ะะะะะะะะฏ ะฃะกะะฃะ โ 2025/ะขะญะ-001

ะณ. ะะพัะบะฒะฐ                                                     ยซ15ยป ัะฝะฒะฐัั 2025 ะณ.

ะะะ ยซะขัะฐะฝัะะพะณะธััะธะบยป (ะะะ 7707999888), ะธะผะตะฝัะตะผะพะต ะฒ ะดะฐะปัะฝะตะนัะตะผ ยซะัะฟะพะปะฝะธัะตะปัยป, ะฒ ะปะธัะต ะะตะฝะตัะฐะปัะฝะพะณะพ ะดะธัะตะบัะพัะฐ ะะพะทะปะพะฒะฐ ะะพะฝััะฐะฝัะธะฝะฐ ะะพะฝััะฐะฝัะธะฝะพะฒะธัะฐ, ะดะตะนััะฒัััะตะณะพ ะฝะฐ ะพัะฝะพะฒะฐะฝะธะธ ะฃััะฐะฒะฐ, ั ะพะดะฝะพะน ััะพัะพะฝั, ะธ
ะะ ยซะกะะยป (ะะะ 7701234567), ะธะผะตะฝัะตะผะพะต ะฒ ะดะฐะปัะฝะตะนัะตะผ ยซะะฐะบะฐะทัะธะบยป, ะฒ ะปะธัะต ะะตะฝะตัะฐะปัะฝะพะณะพ ะดะธัะตะบัะพัะฐ ะกะธะดะพัะพะฒะฐ ะกะตัะณะตั ะกะตัะณะตะตะฒะธัะฐ, ะดะตะนััะฒัััะตะณะพ ะฝะฐ ะพัะฝะพะฒะฐะฝะธะธ ะฃััะฐะฒะฐ, ั ะดััะณะพะน ััะพัะพะฝั,
ะทะฐะบะปััะธะปะธ ะฝะฐััะพััะธะน ะะพะณะพะฒะพั ะพ ะฝะธะถะตัะปะตะดัััะตะผ:

1. ะะะะะะะข ะะะะะะะะ
1.1. ะัะฟะพะปะฝะธัะตะปั ะพะฑัะทัะตััั ะพะบะฐะทะฐัั ััะปัะณะธ ะฟะพ ะฟัะตะดะพััะฐะฒะปะตะฝะธั ะถะตะปะตะทะฝะพะดะพัะพะถะฝัั ะฒะฐะณะพะฝะพะฒ ะดะปั ะฟะตัะตะฒะพะทะบะธ ะณััะทะพะฒ ะะฐะบะฐะทัะธะบะฐ, ะฐ ะะฐะบะฐะทัะธะบ ะพะฑัะทัะตััั ะฟัะธะฝััั ะธ ะพะฟะปะฐัะธัั ะพะบะฐะทะฐะฝะฝัะต ััะปัะณะธ.
1.2. ะะฑััะผ, ััะพะบะธ ะธ ะผะฐัััััั ะฟะตัะตะฒะพะทะพะบ ัะพะณะปะฐัะพะฒัะฒะฐัััั ะฒ ะะฐัะฒะบะฐั.

2. ะะะะะ ะ ะะะฏะะะะะะกะขะ ะกะขะะะะ
2.1. ะัะฟะพะปะฝะธัะตะปั ะพะฑัะทะฐะฝ ะฟัะตะดะพััะฐะฒะธัั ะฒะฐะณะพะฝั ัะพะณะปะฐัะฝะพ ะะฐัะฒะบะต ะะฐะบะฐะทัะธะบะฐ.
2.2. ะะฐะบะฐะทัะธะบ ะพะฑะตัะฟะตัะธะฒะฐะตั ะฟะพะณััะทะบั/ะฒัะณััะทะบั ะฒ ะฝะพัะผะฐัะธะฒะฝัะต ััะพะบะธ.
2.3. ะะฐะบะฐะทัะธะบ ะฝะตััั ะฒัะต ัะธัะบะธ, ัะฒัะทะฐะฝะฝัะต ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ะฒะฐะณะพะฝะพะฒ ั ะผะพะผะตะฝัะฐ ะธั ะฟัะธัะผะบะธ.

3. ะกะขะะะะะกะขะฌ ะฃะกะะฃะ ะ ะะะะฏะะะ ะะะกะงะะขะะ
3.1. ะกัะพะธะผะพััั ััะปัะณ ะฟะพ ะฝะฐััะพััะตะผั ะะพะณะพะฒะพัั ัะพััะฐะฒะปัะตั 8 500 000 (ะะพัะตะผั ะผะธะปะปะธะพะฝะพะฒ ะฟััััะพั ััััั) ััะฑะปะตะน, ะฒ ัะพะผ ัะธัะปะต ะะะก 20%.
3.2. ะัะตะดะพะฟะปะฐัะฐ ะฒ ัะฐะทะผะตัะต 50% ะพั ััะผะผั ะดะพะณะพะฒะพัะฐ ะฒ ัะตัะตะฝะธะต 5 ะฑะฐะฝะบะพะฒัะบะธั ะดะฝะตะน ะฟะพัะปะต ะฟะพะดะฟะธัะฐะฝะธั.
3.3. ะะบะพะฝัะฐัะตะปัะฝัะน ัะฐัััั โ ะพะฟะปะฐัะฐ ะฒ ัะตัะตะฝะธะต 3 ะบะฐะปะตะฝะดะฐัะฝัั ะดะฝะตะน ะฟะพัะปะต ะฟะพะปััะตะฝะธั ััััะฐ.
3.4. ะัะฟะพะปะฝะธัะตะปั ะฒะฟัะฐะฒะต ะฒ ะพะดะฝะพััะพัะพะฝะฝะตะผ ะฟะพััะดะบะต ะธะทะผะตะฝััั ัะฐัะธัั ั ัะฒะตะดะพะผะปะตะฝะธะตะผ ะทะฐ 10 ะดะฝะตะน.

4. ะะะะะะะ ะฃะกะะฃะ
4.1. ะะพ ัะฐะบัั ะพะบะฐะทะฐะฝะธั ััะปัะณ ะัะฟะพะปะฝะธัะตะปั ะฝะฐะฟัะฐะฒะปัะตั ะะบั ะพะบะฐะทะฐะฝะฝัั ััะปัะณ.
4.2. ะะฐะบะฐะทัะธะบ ะฟะพะดะฟะธััะฒะฐะตั ะะบั ะฒ ัะตัะตะฝะธะต 2 ัะฐะฑะพัะธั ะดะฝะตะน.
4.3. ะะพะปัะฐะฝะธะต ะะฐะบะฐะทัะธะบะฐ ะฑะพะปะตะต 3 ะดะฝะตะน ััะธัะฐะตััั ัะพะณะปะฐัะธะตะผ ั ะะบัะพะผ ะธ ะฑะตะทััะปะพะฒะฝัะผ ะฟัะธะฝััะธะตะผ ััะปัะณ.

5. ะะขะะะขะกะขะะะะะะกะขะฌ ะกะขะะะะ
5.1. ะะฐ ัะฒะตััะฝะพัะผะฐัะธะฒะฝัะน ะฟัะพััะพะน ะฒะฐะณะพะฝะพะฒ ะะฐะบะฐะทัะธะบ ัะฟะปะฐัะธะฒะฐะตั ัััะฐั 5 000 (ะััั ััััั) ััะฑะปะตะน ะทะฐ ะบะฐะถะดัะต ะฒะฐะณะพะฝะพ-ัััะบะธ ะฟัะพััะพั.
5.2. ะะฐ ะฝะฐัััะตะฝะธะต ััะพะบะพะฒ ะพะฟะปะฐัั ะะฐะบะฐะทัะธะบ ัะฟะปะฐัะธะฒะฐะตั ะฝะตัััะพะนะบั ะฒ ัะฐะทะผะตัะต 0,5% ะพั ะฝะตะพะฟะปะฐัะตะฝะฝะพะน ััะผะผั ะทะฐ ะบะฐะถะดัะน ะดะตะฝั ะฟัะพััะพัะบะธ ะฑะตะท ะพะณัะฐะฝะธัะตะฝะธั ะพะฑัะตะน ััะผะผั ะฝะตัััะพะนะบะธ.
5.3. ะะฐะบะฐะทัะธะบ ะฝะตััั ะฟะพะปะฝัั ะผะฐัะตัะธะฐะปัะฝัั ะพัะฒะตัััะฒะตะฝะฝะพััั ะทะฐ ะฟะพะฒัะตะถะดะตะฝะธะต ะฒะฐะณะพะฝะพะฒ.
5.4. ะัะฟะพะปะฝะธัะตะปั ะฝะต ะฝะตััั ะพัะฒะตัััะฒะตะฝะฝะพััะธ ะทะฐ ะบะพัะฒะตะฝะฝัะต ัะฑััะบะธ ะะฐะบะฐะทัะธะบะฐ.

6. ะะะะคะะะะะฆะะะะฌะะะกะขะฌ
6.1. ะกัะพัะพะฝั ะพะฑัะทััััั ัะพััะฐะฝััั ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝะพััั ััะปะพะฒะธะน ะะพะณะพะฒะพัะฐ.
6.2. ะกัะพะบ ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝะพััะธ: ะฑะตัััะพัะฝะพ.
6.3. ะจััะฐั ะทะฐ ะฝะฐัััะตะฝะธะต ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝะพััะธ: 15 000 000 (ะััะฝะฐะดัะฐัั ะผะธะปะปะธะพะฝะพะฒ) ััะฑะปะตะน.

7. ะคะะะก-ะะะะะ
7.1. ะกัะพัะพะฝั ะพัะฒะพะฑะพะถะดะฐัััั ะพั ะพัะฒะตัััะฒะตะฝะฝะพััะธ ะฟัะธ ะฝะฐัััะฟะปะตะฝะธะธ ะพะฑััะพััะตะปัััะฒ ะฝะตะฟัะตะพะดะพะปะธะผะพะน ัะธะปั.

8. ะกะะะ ะะะะกะขะะะฏ ะ ะะะกะขะะะะะะะ
8.1. ะะพะณะพะฒะพั ะฒัััะฟะฐะตั ะฒ ัะธะปั ั ะผะพะผะตะฝัะฐ ะฟะพะดะฟะธัะฐะฝะธั ะธ ะดะตะนััะฒัะตั ะดะพ 31.12.2025.
8.2. ะัะฟะพะปะฝะธัะตะปั ะฒะฟัะฐะฒะต ัะฐััะพัะณะฝััั ะดะพะณะพะฒะพั ะฒ ะพะดะฝะพััะพัะพะฝะฝะตะผ ะฟะพััะดะบะต ั ัะฒะตะดะพะผะปะตะฝะธะตะผ ะทะฐ 5 ะดะฝะตะน.

9. ะะะะฏะะะ ะะะะะะจะะะะฏ ะกะะะะะ
9.1. ะัะต ัะฟะพัั ัะตัะฐัััั ะฟัััะผ ะฟะตัะตะณะพะฒะพัะพะฒ.
9.2. ะัะธ ะฝะตะดะพััะธะถะตะฝะธะธ ัะพะณะปะฐัะธั ัะฟะพัั ัะฐััะผะฐััะธะฒะฐัััั ะฒ ะัะฑะธััะฐะถะฝะพะผ ััะดะต ะณะพัะพะดะฐ ะะพัะบะฒั.

10. ะะะะะะะะขะซ ะ ะะะะะะกะ ะกะขะะะะ

ะะะะะะงะะ:                                    ะะกะะะะะะขะะะฌ:
ะะ ยซะกะะยป                                     ะะะ ยซะขัะฐะฝัะะพะณะธััะธะบยป
ะะะ 7701234567, ะะะ 770101001                ะะะ 7707999888, ะะะ 770701001
ะะดัะตั: ะณ. ะะพัะบะฒะฐ, ัะป. ะัะธะผะตัะฝะฐั, ะด. 1        ะะดัะตั: ะณ. ะะพัะบะฒะฐ, ัะป. ะะพะณะธััะธะบะธ, ะด. 5

_______________/ะกะธะดะพัะพะฒ ะก.ะก./                _______________/ะะพะทะปะพะฒ ะ.ะ./
"""

# ============================================================================
# ะญะะกะขะะะะขะะ ะะะะะซะฅ ะะ ะะะะะะะะ
# ============================================================================

class ะญะบัััะฐะบัะพัะะฐะฝะฝัั:
    """ะะฒัะพะผะฐัะธัะตัะบะพะต ะธะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั ะธะท ัะตะบััะฐ ะดะพะณะพะฒะพัะฐ"""
    
    # ะะฐััะตัะฝั ะดะปั ะธะทะฒะปะตัะตะฝะธั
    ะะะขะขะะะะซ = {
        "ะดะฐัะฐ": [
            r'ยซ?(\d{1,2})ยป?\s*([ะฐ-ัั]+)\s*(\d{4})\s*ะณ?\.?',  # ยซ15ยป ัะฝะฒะฐัั 2025 ะณ.
            r'(\d{1,2})\.(\d{1,2})\.(\d{4})',  # 15.01.2025
            r'(\d{1,2})/(\d{1,2})/(\d{4})',  # 15/01/2025
        ],
        "ะฝะพะผะตั": [
            r'(?:ะดะพะณะพะฒะพั|ะบะพะฝััะฐะบั|ัะพะณะปะฐัะตะฝะธะต)[^โ]*โ\s*([^\s,\n]{1,30})',
            r'โ\s*([A-Za-zะ-ะฏะฐ-ั0-9\-/]+)',
        ],
        "ััะผะผะฐ": [
            r'(?:ััะพะธะผะพััั|ััะผะผะฐ|ัะตะฝะฐ)[^โฝ\d]*?(\d[\d\s]*[\d])\s*(?:\([^)]+\))?\s*ััะฑ',
            r'(\d[\d\s]*[\d])\s*(?:\([^)]+\))?\s*ััะฑ',
            r'(\d{1,3}(?:\s?\d{3})+)\s*โฝ',
        ],
        "ะบะพะฝััะฐะณะตะฝั": [
            r'(?:ะะะ|ะะะ|ะะะ|ะะะ|ะะ|ะะ)\s*[ยซ"]([^ยป"]+)[ยป"]',
        ],
        "ะธะฝะฝ_ะบะพะฝััะฐะณะตะฝัะฐ": [
            r'(?:ะะะ|ะะะ|ะะะ|ะะะ)[^ะ]*ะะะ\s*(\d{10,12})',
        ],
    }
    
    ะะะกะฏะฆะซ = {
        'ัะฝะฒะฐัั': 1, 'ัะตะฒัะฐะปั': 2, 'ะผะฐััะฐ': 3, 'ะฐะฟัะตะปั': 4,
        'ะผะฐั': 5, 'ะธัะฝั': 6, 'ะธัะปั': 7, 'ะฐะฒะณัััะฐ': 8,
        'ัะตะฝััะฑัั': 9, 'ะพะบััะฑัั': 10, 'ะฝะพัะฑัั': 11, 'ะดะตะบะฐะฑัั': 12
    }
    
    @classmethod
    def ะธะทะฒะปะตัั_ะดะฐัั(cls, ัะตะบัั: str) -> Optional[date]:
        """ะะทะฒะปะตัะตะฝะธะต ะดะฐัั ะธะท ัะตะบััะฐ"""
        ัะตะบัั_lower = ัะตะบัั.lower()
        
        # ะะฐััะตัะฝ ั ะฝะฐะทะฒะฐะฝะธะตะผ ะผะตัััะฐ
        match = re.search(r'ยซ?(\d{1,2})ยป?\s*([ะฐ-ัั]+)\s*(\d{4})', ัะตะบัั_lower)
        if match:
            ะดะตะฝั = int(match.group(1))
            ะผะตััั_ะธะผั = match.group(2)
            ะณะพะด = int(match.group(3))
            ะผะตััั = cls.ะะะกะฏะฆะซ.get(ะผะตััั_ะธะผั)
            if ะผะตััั and 1 <= ะดะตะฝั <= 31:
                try:
                    return date(ะณะพะด, ะผะตััั, ะดะตะฝั)
                except:
                    pass
        
        # ะะฐััะตัะฝ ั ัะพัะบะฐะผะธ
        match = re.search(r'(\d{1,2})\.(\d{1,2})\.(\d{4})', ัะตะบัั)
        if match:
            try:
                return date(int(match.group(3)), int(match.group(2)), int(match.group(1)))
            except:
                pass
        
        return None
    
    @classmethod
    def ะธะทะฒะปะตัั_ะฝะพะผะตั(cls, ัะตะบัั: str) -> Optional[str]:
        """ะะทะฒะปะตัะตะฝะธะต ะฝะพะผะตัะฐ ะดะพะณะพะฒะพัะฐ"""
        # ะัะตะผ ะฒ ะฟะตัะฒัั 500 ัะธะผะฒะพะปะฐั
        ะฝะฐัะฐะปะพ = ัะตะบัั[:500].upper()
        
        match = re.search(r'(?:ะะะะะะะ|ะะะะขะะะะข)[^โ]*โ\s*([^\s,\n]{1,30})', ะฝะฐัะฐะปะพ, re.IGNORECASE)
        if match:
            return match.group(1).strip()
        
        match = re.search(r'โ\s*([A-Za-zะ-ะฏะฐ-ั0-9\-/]+)', ัะตะบัั[:500])
        if match:
            ะฝะพะผะตั = match.group(1).strip()
            if len(ะฝะพะผะตั) >= 3:
                return ะฝะพะผะตั
        
        return None
    
    @classmethod
    def ะธะทะฒะปะตัั_ััะผะผั(cls, ัะตะบัั: str) -> Optional[float]:
        """ะะทะฒะปะตัะตะฝะธะต ััะผะผั ะดะพะณะพะฒะพัะฐ"""
        ัะตะบัั_lower = ัะตะบัั.lower()
        
        # ะัะตะผ "ััะพะธะผะพััั" ะธะปะธ "ััะผะผะฐ" + ัะธัะปะพ + ััะฑะป
        match = re.search(r'(?:ััะพะธะผะพััั|ััะผะผะฐ|ัะตะฝะฐ)[^โฝ\d]*?(\d[\d\s]*\d)\s*(?:\([^)]+\))?\s*ััะฑ', ัะตะบัั_lower)
        if match:
            ััะผะผะฐ_str = re.sub(r'\s+', '', match.group(1))
            try:
                return float(ััะผะผะฐ_str)
            except:
                pass
        
        # ะัะตะผ ะฑะพะปััะธะต ััะผะผั (ะผะธะปะปะธะพะฝั)
        match = re.search(r'(\d{1,3}(?:\s?\d{3})+)\s*(?:\([^)]+\))?\s*ััะฑ', ัะตะบัั_lower)
        if match:
            ััะผะผะฐ_str = re.sub(r'\s+', '', match.group(1))
            try:
                ััะผะผะฐ = float(ััะผะผะฐ_str)
                if ััะผะผะฐ >= 10000:  # ะะธะฝะธะผัะผ 10 ััั
                    return ััะผะผะฐ
            except:
                pass
        
        return None
    
    @classmethod
    def ะธะทะฒะปะตัั_ะบะพะฝััะฐะณะตะฝัะฐ(cls, ัะตะบัั: str, ะฝะฐั_ะธะฝะฝ: str = "7701234567") -> Optional[str]:
        """ะะทะฒะปะตัะตะฝะธะต ะฝะฐะทะฒะฐะฝะธั ะบะพะฝััะฐะณะตะฝัะฐ (ะฝะต ะฝะฐัะฐ ะบะพะผะฟะฐะฝะธั)"""
        # ะะฐัะพะดะธะผ ะฒัะต ัั.ะปะธัะฐ
        ััะปะธัะฐ = re.findall(r'((?:ะะะ|ะะะ|ะะะ|ะะะ|ะะ|ะะ)\s*[ยซ"]([^ยป"]+)[ยป"])', ัะตะบัั)
        
        for ะฟะพะปะฝะพะต, ะฝะฐะทะฒะฐะฝะธะต in ััะปะธัะฐ:
            # ะัะพะฒะตััะตะผ ััะพ ััะพ ะฝะต ะผั (ะฟะพ ะะะ ะธะปะธ ะฝะฐะทะฒะฐะฝะธั)
            ะบะพะฝัะตะบัั_ะธะฝะฝ = re.search(rf'{re.escape(ะฟะพะปะฝะพะต)}[^ะ]{{0,50}}ะะะ\s*(\d{{10,12}})', ัะตะบัั)
            if ะบะพะฝัะตะบัั_ะธะฝะฝ:
                if ะบะพะฝัะตะบัั_ะธะฝะฝ.group(1) != ะฝะฐั_ะธะฝะฝ:
                    return ะฟะพะปะฝะพะต
            elif 'ะกะะ' not in ะฝะฐะทะฒะฐะฝะธะต.upper() and 'ะกะขะะะะฏ ะะะะะะะะะงะะะฏ' not in ะฝะฐะทะฒะฐะฝะธะต.upper():
                return ะฟะพะปะฝะพะต
        
        return None
    
    @classmethod
    def ะพะฟัะตะดะตะปะธัั_ัะธะฟ_ะดะพะบัะผะตะฝัะฐ(cls, ัะตะบัั: str) -> dict:
        """ะะฟัะตะดะตะปะตะฝะธะต ัะธะฟะฐ ะดะพะบัะผะตะฝัะฐ"""
        ัะตะบัั_upper = ัะตะบัั[:2000].upper()
        ัะตะบัั_lower = ัะตะบัั.lower()
        
        ัะตะทัะปััะฐั = {
            "ัะธะฟ": "ะฝะตะธะทะฒะตััะฝะพ",
            "ัะฒะตัะตะฝะฝะพััั": 0,
            "ะพะฟะธัะฐะฝะธะต": "",
            "ััะพ_ะดะพะณะพะฒะพั": False
        }
        
        # ะัะพะฒะตัะบะฐ ะฝะฐ ะดะพะณะพะฒะพั
        ะดะพะณะพะฒะพั_ะผะฐัะบะตัั = ["ะดะพะณะพะฒะพั", "ะบะพะฝััะฐะบั", "ัะพะณะปะฐัะตะฝะธะต"]
        for ะผ in ะดะพะณะพะฒะพั_ะผะฐัะบะตัั:
            if ะผ in ัะตะบัั_lower[:500]:
                ัะตะทัะปััะฐั["ััะพ_ะดะพะณะพะฒะพั"] = True
                break
        
        if not ัะตะทัะปััะฐั["ััะพ_ะดะพะณะพะฒะพั"]:
            # ะัะพะฒะตััะตะผ ะดััะณะธะต ัะธะฟั ะดะพะบัะผะตะฝัะพะฒ
            if "ัััั" in ัะตะบัั_lower or "ััะตั" in ัะตะบัั_lower:
                ัะตะทัะปััะฐั["ัะธะฟ"] = "ัััั"
                ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะญัะพ ัััั ะฝะฐ ะพะฟะปะฐัั, ะฐ ะฝะต ะดะพะณะพะฒะพั"
            elif "ะฐะบั" in ัะตะบัั_lower[:200]:
                ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฐะบั"
                ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะญัะพ ะฐะบั (ะฒัะฟะพะปะฝะตะฝะฝัั ัะฐะฑะพั/ะพะบะฐะทะฐะฝะฝัั ััะปัะณ), ะฐ ะฝะต ะดะพะณะพะฒะพั"
            elif "ะฝะฐะบะปะฐะดะฝะฐั" in ัะตะบัั_lower:
                ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฝะฐะบะปะฐะดะฝะฐั"
                ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะญัะพ ัะพะฒะฐัะฝะฐั ะฝะฐะบะปะฐะดะฝะฐั, ะฐ ะฝะต ะดะพะณะพะฒะพั"
            elif "ะฟัะธะบะฐะท" in ัะตะบัั_lower[:200]:
                ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฟัะธะบะฐะท"
                ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะญัะพ ะฟัะธะบะฐะท, ะฐ ะฝะต ะดะพะณะพะฒะพั"
            elif "ะฟัะพัะพะบะพะป" in ัะตะบัั_lower[:200]:
                ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฟัะพัะพะบะพะป"
                ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะญัะพ ะฟัะพัะพะบะพะป, ะฐ ะฝะต ะดะพะณะพะฒะพั"
            elif "ะฟะธััะผะพ" in ัะตะบัั_lower[:200] or "ัะฒะฐะถะฐะตะผ" in ัะตะบัั_lower[:300]:
                ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฟะธััะผะพ"
                ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะญัะพ ะฟะธััะผะพ/ะบะพััะตัะฟะพะฝะดะตะฝัะธั, ะฐ ะฝะต ะดะพะณะพะฒะพั"
            else:
                ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฝะตะธะทะฒะตััะฝะพ"
                ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะต ัะดะฐะปะพัั ะพะฟัะตะดะตะปะธัั ัะธะฟ ะดะพะบัะผะตะฝัะฐ. ะะพะทะผะพะถะฝะพ, ััะพ ะฝะต ะดะพะณะพะฒะพั."
            return ัะตะทัะปััะฐั
        
        # ะะฟัะตะดะตะปัะตะผ ะฒะธะด ะดะพะณะพะฒะพัะฐ
        ัะตะทัะปััะฐั["ััะพ_ะดะพะณะพะฒะพั"] = True
        
        if "ััะปัะณ" in ัะตะบัั_lower and ("ััะพ" in ัะตะบัั_lower or "ะฒะฐะณะพะฝ" in ัะตะบัั_lower or "ะฟะตัะตะฒะพะทะบ" in ัะตะบัั_lower):
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ััะปัะณะธ_ััะพ"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ะพะบะฐะทะฐะฝะธั ััะปัะณ (ััะฐะฝัะฟะพััะฝะพ-ัะบัะฟะตะดะธัะธะพะฝะฝะพะต ะพะฑัะปัะถะธะฒะฐะฝะธะต)"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.9
        elif "ะฟะพััะฐะฒะบ" in ัะตะบัั_lower and ("ัะพะฒะฐั" in ัะตะบัั_lower or "ะฟัะพะดัะบั" in ัะตะบัั_lower):
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฟะพััะฐะฒะบะฐ"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ะฟะพััะฐะฒะบะธ ัะพะฒะฐัะพะฒ"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.85
        elif "ััะฐะฝะตะฝะธ" in ัะตะบัั_lower:
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ััะฐะฝะตะฝะธะต"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ััะฐะฝะตะฝะธั"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.85
        elif "ะฐัะตะฝะด" in ัะตะบัั_lower and "ะฒะฐะณะพะฝ" in ัะตะบัั_lower:
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฐัะตะฝะดะฐ_ะฒะฐะณะพะฝะพะฒ"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ะฐัะตะฝะดั ะฒะฐะณะพะฝะพะฒ (ะะะะกะะะฏ ะะะะ)"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.9
        elif "ะฟะพะดััะด" in ัะตะบัั_lower:
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฟะพะดััะด"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ะฟะพะดััะดะฐ"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.8
        elif "ะฐัะตะฝะด" in ัะตะบัั_lower:
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ะฐัะตะฝะดะฐ"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ะฐัะตะฝะดั"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.8
        elif "ะทะฐะนะผ" in ัะตะบัั_lower or "ะทะฐัะผ" in ัะตะบัั_lower:
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ะทะฐะนะผ"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ะทะฐะนะผะฐ (ะะะะกะะะฏ ะะะะ)"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.85
        elif "ััะปัะณ" in ัะตะบัั_lower:
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ััะปัะณะธ"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั ะพะบะฐะทะฐะฝะธั ััะปัะณ"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.7
        else:
            ัะตะทัะปััะฐั["ัะธะฟ"] = "ะธะฝะพะน"
            ัะตะทัะปััะฐั["ะพะฟะธัะฐะฝะธะต"] = "ะะพะณะพะฒะพั (ัะธะฟ ะฝะต ะพะฟัะตะดะตะปัะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ)"
            ัะตะทัะปััะฐั["ัะฒะตัะตะฝะฝะพััั"] = 0.5
        
        return ัะตะทัะปััะฐั
    
    @classmethod
    def ะธะทะฒะปะตัั_ะฟัะตะดะผะตั(cls, ัะตะบัั: str) -> Optional[str]:
        """ะะทะฒะปะตัะตะฝะธะต ะฟัะตะดะผะตัะฐ ะดะพะณะพะฒะพัะฐ"""
        # ะัะตะผ ัะฐะทะดะตะป "ะะะะะะะข ะะะะะะะะ"
        match = re.search(r'(?:1\.?\s*)?ะะะะะะะข\s+ะะะะะะะะ\s*\n?(.*?)(?:\n\s*2\.|\n\s*ะะะะะ|\n\s*ะะะฏะะะะ)', 
                         ัะตะบัั, re.IGNORECASE | re.DOTALL)
        if match:
            ะฟัะตะดะผะตั = match.group(1).strip()
            # ะะตััะผ ะฟะตัะฒัะต 2-3 ะฟัะตะดะปะพะถะตะฝะธั
            ะฟัะตะดะปะพะถะตะฝะธั = re.split(r'(?<=[.!?])\s+', ะฟัะตะดะผะตั)
            if ะฟัะตะดะปะพะถะตะฝะธั:
                return ' '.join(ะฟัะตะดะปะพะถะตะฝะธั[:2])[:500]
        
        # ะัะตะผ ะฟัะฝะบั 1.1
        match = re.search(r'1\.1\.?\s+(.+?)(?:\n|1\.2)', ัะตะบัั, re.DOTALL)
        if match:
            return match.group(1).strip()[:500]
        
        return None
    
    @classmethod
    def ะฟะพะปะฝะพะต_ะธะทะฒะปะตัะตะฝะธะต(cls, ัะตะบัั: str) -> dict:
        """ะะพะปะฝะพะต ะธะทะฒะปะตัะตะฝะธะต ะฒัะตั ะดะฐะฝะฝัั ะธะท ะดะพะณะพะฒะพัะฐ"""
        ะพัะณ = st.session_state.get("ะพัะณ", DEFAULT_ORG_CONFIG)
        
        ัะธะฟ_ะดะพะบ = cls.ะพะฟัะตะดะตะปะธัั_ัะธะฟ_ะดะพะบัะผะตะฝัะฐ(ัะตะบัั)
        
        return {
            "ัะธะฟ_ะดะพะบัะผะตะฝัะฐ": ัะธะฟ_ะดะพะบ,
            "ะดะฐัะฐ": cls.ะธะทะฒะปะตัั_ะดะฐัั(ัะตะบัั),
            "ะฝะพะผะตั": cls.ะธะทะฒะปะตัั_ะฝะพะผะตั(ัะตะบัั),
            "ััะผะผะฐ": cls.ะธะทะฒะปะตัั_ััะผะผั(ัะตะบัั),
            "ะบะพะฝััะฐะณะตะฝั": cls.ะธะทะฒะปะตัั_ะบะพะฝััะฐะณะตะฝัะฐ(ัะตะบัั, ะพัะณ.get("inn", "")),
            "ะฟัะตะดะผะตั": cls.ะธะทะฒะปะตัั_ะฟัะตะดะผะตั(ัะตะบัั),
        }

# ============================================================================
# RAG ะะะะะะะะขะะ - ะกะะะงะะะะ ะก ะขะะะะะซะะ ะคะะะะะะ
# ============================================================================

class RAGะะฝะฐะปะธะทะฐัะพั:
    """ะะฝะฐะปะธะทะฐัะพั ะดะปั ััะฐะฒะฝะตะฝะธั ะดะพะณะพะฒะพัะพะฒ ั ัะธะฟะพะฒัะผะธ ัะพัะผะฐะผะธ"""
    
    @classmethod
    def ะฝะฐะนัะธ_ะฟัะฝะบั_ะฒ_ัะตะบััะต(cls, ัะตะบัั: str, ะฟะฐััะตัะฝ: str) -> Optional[dict]:
        """ะะพะธัะบ ะฟัะฝะบัะฐ ะดะพะณะพะฒะพัะฐ ะฟะพ ะฟะฐััะตัะฝั ะฝะฐัััะตะฝะธั"""
        try:
            match = re.search(ะฟะฐััะตัะฝ, ัะตะบัั.lower(), re.IGNORECASE | re.DOTALL)
            if match:
                start = match.start()
                end = match.end()
                
                # ะัะตะผ ะฝะพะผะตั ะฟัะฝะบัะฐ ะฟะตัะตะด ะฝะฐะนะดะตะฝะฝัะผ ัะตะบััะพะผ
                ัะตะบัั_ะดะพ = ัะตะบัั[max(0, start-100):start]
                ะฟัะฝะบั_match = re.search(r'(\d+\.\d+\.?\d*)', ัะตะบัั_ะดะพ)
                ะฝะพะผะตั_ะฟัะฝะบัะฐ = ะฟัะฝะบั_match.group(1) if ะฟัะฝะบั_match else None
                
                # ะะทะฒะปะตะบะฐะตะผ ะบะพะฝัะตะบัั
                ะบะพะฝัะตะบัั_start = max(0, start - 50)
                ะบะพะฝัะตะบัั_end = min(len(ัะตะบัั), end + 100)
                ะบะพะฝัะตะบัั = ัะตะบัั[ะบะพะฝัะตะบัั_start:ะบะพะฝัะตะบัั_end].replace('\n', ' ').strip()
                
                return {
                    "ะฝะฐะนะดะตะฝะพ": True,
                    "ะฟัะฝะบั": ะฝะพะผะตั_ะฟัะฝะบัะฐ,
                    "ะบะพะฝัะตะบัั": f"...{ะบะพะฝัะตะบัั}...",
                    "ะฟะพะทะธัะธั": start
                }
        except:
            pass
        return {"ะฝะฐะนะดะตะฝะพ": False}
    
    @classmethod
    def ะฟัะพะฒะตัะธัั_ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั(cls, ัะตะบัั: str, ัั: dict) -> List[dict]:
        """ะัะพะฒะตัะบะฐ ะดะพะณะพะฒะพัะฐ ะฝะฐ ัะพะพัะฒะตัััะฒะธะต ััะฐะปะพะฝะฝัะผ ะฟัะฝะบัะฐะผ ะขะค"""
        ะฝะฐัััะตะฝะธั = []
        ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั = ัั.get("ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั", {})
        
        for ะฝะฐะทะฒะฐะฝะธะต, ะดะฐะฝะฝัะต in ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั.items():
            ะฟะฐััะตัะฝ = ะดะฐะฝะฝัะต.get("ะฟะฐััะตัะฝ_ะฝะฐัััะตะฝะธั", "")
            if not ะฟะฐััะตัะฝ:
                continue
            
            ัะตะทัะปััะฐั = cls.ะฝะฐะนัะธ_ะฟัะฝะบั_ะฒ_ัะตะบััะต(ัะตะบัั, ะฟะฐััะตัะฝ)
            
            if ัะตะทัะปััะฐั.get("ะฝะฐะนะดะตะฝะพ"):
                ะฝะฐัััะตะฝะธั.append({
                    "ะฝะฐะทะฒะฐะฝะธะต": ะฝะฐะทะฒะฐะฝะธะต,
                    "ะฟัะพะฑะปะตะผะฐ": ะดะฐะฝะฝัะต.get("ััะฐะปะพะฝ", "").replace("ะญัะฐะปะพะฝ: ", ""),
                    "ััะฐะปะพะฝ": ะดะฐะฝะฝัะต.get("ััะฐะปะพะฝ", ""),
                    "ะบัะธัะธัะฝะพััั": ะดะฐะฝะฝัะต.get("ะบัะธัะธัะฝะพััั", "ะถัะปััะน"),
                    "ะฟัะฝะบั_ะดะพะณะพะฒะพัะฐ": ัะตะทัะปััะฐั.get("ะฟัะฝะบั"),
                    "ะบะพะฝัะตะบัั": ัะตะทัะปััะฐั.get("ะบะพะฝัะตะบัั", ""),
                    "ัะตะบะพะผะตะฝะดะฐัะธั": f"ะะทะผะตะฝะธัั ะฝะฐ: {ะดะฐะฝะฝัะต.get('ััะฐะปะพะฝ', '')}"
                })
        
        return ะฝะฐัััะตะฝะธั
    
    @classmethod
    def ะฟัะพะฒะตัะธัั_ัะฐะทะดะตะปั(cls, ัะตะบัั: str, ะพะฑัะทะฐัะตะปัะฝัะต: List[str]) -> dict:
        """ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ะพะฑัะทะฐัะตะปัะฝัั ัะฐะทะดะตะปะพะฒ"""
        ัะตะบัั_upper = ัะตะบัั.upper()
        
        ะฝะฐะนะดะตะฝะฝัะต = []
        ะพััััััะฒัััะธะต = []
        
        for ัะฐะทะดะตะป in ะพะฑัะทะฐัะตะปัะฝัะต:
            # ะฃะฟัะพัะฐะตะผ ะฟะพะธัะบ - ะธัะตะผ ะบะปััะตะฒัะต ัะปะพะฒะฐ
            ะบะปััะตะฒัะต = ัะฐะทะดะตะป.upper().split()
            ะฝะฐะนะดะตะฝ = any(ะบ in ัะตะบัั_upper for ะบ in ะบะปััะตะฒัะต if len(ะบ) > 3)
            
            if ะฝะฐะนะดะตะฝ:
                ะฝะฐะนะดะตะฝะฝัะต.append(ัะฐะทะดะตะป)
            else:
                ะพััััััะฒัััะธะต.append(ัะฐะทะดะตะป)
        
        return {
            "ะฝะฐะนะดะตะฝะฝัะต": ะฝะฐะนะดะตะฝะฝัะต,
            "ะพััััััะฒัััะธะต": ะพััััััะฒัััะธะต,
            "ะฟัะพัะตะฝั": len(ะฝะฐะนะดะตะฝะฝัะต) / len(ะพะฑัะทะฐัะตะปัะฝัะต) * 100 if ะพะฑัะทะฐัะตะปัะฝัะต else 100
        }
    
    @classmethod
    def ะฟะพะปะฝัะน_ะฐะฝะฐะปะธะท(cls, ัะตะบัั: str, ะบะพะด_ัั: str) -> dict:
        """ะะพะปะฝัะน RAG-ะฐะฝะฐะปะธะท ะดะพะณะพะฒะพัะฐ"""
        ะฒัะต_ัั = {**ะขะะะะะซะ_ะคะะะะซ, **st.session_state.get("ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต_ัั", {})}
        
        ัะตะทัะปััะฐั = {
            "ััะฟะตั": False,
            "ะฝะฐะทะฒะฐะฝะธะต_ัั": "",
            "ะบะพะด_ัั": "",
            "ะฝะฐัะฐ_ัะพะปั": "",
            "ะฝะฐัััะตะฝะธั": [],
            "ัะฐะทะดะตะปั": {},
            "ะบัะฐัะฝัั": 0,
            "ะถัะปััั": 0,
            "ัะพะพัะฒะตัััะฒะธะต": 0,
            "ะฒะตัะดะธะบั": "",
            "ัะตะทัะผะต": ""
        }
        
        if ะบะพะด_ัั not in ะฒัะต_ัั:
            ัะตะทัะปััะฐั["ัะตะทัะผะต"] = "ะขะธะฟะพะฒะฐั ัะพัะผะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ"
            return ัะตะทัะปััะฐั
        
        ัั = ะฒัะต_ัั[ะบะพะด_ัั]
        ัะตะทัะปััะฐั["ะฝะฐะทะฒะฐะฝะธะต_ัั"] = ัั.get("ะฝะฐะทะฒะฐะฝะธะต", "")
        ัะตะทัะปััะฐั["ะบะพะด_ัั"] = ัั.get("ะบะพะด", "")
        ัะตะทัะปััะฐั["ะฝะฐัะฐ_ัะพะปั"] = ัั.get("ะฝะฐัะฐ_ัะพะปั", "")
        ัะตะทัะปััะฐั["ััะฟะตั"] = True
        
        # 1. ะัะพะฒะตััะตะผ ััะฐะปะพะฝะฝัะต ะฟัะฝะบัั
        ะฝะฐัััะตะฝะธั = cls.ะฟัะพะฒะตัะธัั_ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั(ัะตะบัั, ัั)
        ัะตะทัะปััะฐั["ะฝะฐัััะตะฝะธั"] = ะฝะฐัััะตะฝะธั
        ัะตะทัะปััะฐั["ะบัะฐัะฝัั"] = sum(1 for ะฝ in ะฝะฐัััะตะฝะธั if ะฝ["ะบัะธัะธัะฝะพััั"] == "ะบัะฐัะฝัะน")
        ัะตะทัะปััะฐั["ะถัะปััั"] = sum(1 for ะฝ in ะฝะฐัััะตะฝะธั if ะฝ["ะบัะธัะธัะฝะพััั"] == "ะถัะปััะน")
        
        # 2. ะัะพะฒะตััะตะผ ัะฐะทะดะตะปั
        ะพะฑัะทะฐัะตะปัะฝัะต = ัั.get("ะพะฑัะทะฐัะตะปัะฝัะต_ัะฐะทะดะตะปั", [])
        ัะตะทัะปััะฐั["ัะฐะทะดะตะปั"] = cls.ะฟัะพะฒะตัะธัั_ัะฐะทะดะตะปั(ัะตะบัั, ะพะฑัะทะฐัะตะปัะฝัะต)
        
        # 3. ะะฐัััั ัะพะพัะฒะตัััะฒะธั
        ะฑะฐะทะพะฒัะน = ัะตะทัะปััะฐั["ัะฐะทะดะตะปั"].get("ะฟัะพัะตะฝั", 50)
        ัััะฐั = ัะตะทัะปััะฐั["ะบัะฐัะฝัั"] * 15 + ัะตะทัะปััะฐั["ะถัะปััั"] * 5
        ัะตะทัะปััะฐั["ัะพะพัะฒะตัััะฒะธะต"] = max(0, min(100, ะฑะฐะทะพะฒัะน - ัััะฐั))
        
        # 4. ะะตัะดะธะบั
        if ัะตะทัะปััะฐั["ะบัะฐัะฝัั"] == 0 and ัะตะทัะปััะฐั["ัะพะพัะฒะตัััะฒะธะต"] >= 80:
            ัะตะทัะปััะฐั["ะฒะตัะดะธะบั"] = "ะกะะะขะะะขะกะขะะฃะะข"
            ัะตะทัะปััะฐั["ัะตะทัะผะต"] = f"โ ะะพะณะพะฒะพั ะกะะะขะะะขะกะขะะฃะะข ัะธะฟะพะฒะพะน ัะพัะผะต ({ัะตะทัะปััะฐั['ัะพะพัะฒะตัััะฒะธะต']:.0f}%)"
        elif ัะตะทัะปััะฐั["ะบัะฐัะฝัั"] <= 1 and ัะตะทัะปััะฐั["ัะพะพัะฒะตัััะฒะธะต"] >= 50:
            ัะตะทัะปััะฐั["ะฒะตัะดะธะบั"] = "ะงะะกะขะะงะะ"
            ัะตะทัะปััะฐั["ัะตะทัะผะต"] = f"โ๏ธ ะงะะกะขะะงะะะ ัะพะพัะฒะตัััะฒะธะต ({ัะตะทัะปััะฐั['ัะพะพัะฒะตัััะฒะธะต']:.0f}%). ะขัะตะฑััััั ะบะพััะตะบัะธัะพะฒะบะธ."
        else:
            ัะตะทัะปััะฐั["ะฒะตัะดะธะบั"] = "ะะ_ะกะะะขะะะขะกะขะะฃะะข"
            ัะตะทัะปััะฐั["ัะตะทัะผะต"] = f"โ ะะ ะกะะะขะะะขะกะขะะฃะะข ัะธะฟะพะฒะพะน ัะพัะผะต ({ัะตะทัะปััะฐั['ัะพะพัะฒะตัััะฒะธะต']:.0f}%). ะขัะตะฑัะตััั ัะบัะฟะตััะธะทะฐ ะฎะ."
        
        return ัะตะทัะปััะฐั

# ============================================================================
# AI ะะะะะะข - ะฃะะฃะงะจะะะะซะ ะะะะะะ
# ============================================================================

class AIะะปะธะตะฝั:
    """ะะปะธะตะฝั ะดะปั AI-ะฐะฝะฐะปะธะทะฐ ะดะพะณะพะฒะพัะพะฒ"""
    
    @classmethod
    def ะฟัะพะฒะตัะธัั_ัะพะตะดะธะฝะตะฝะธะต(cls, ะฟัะพะฒะฐะนะดะตั: str, ะบะปัั: str, folder_id: str = "") -> Tuple[bool, str, float]:
        """ะัะพะฒะตัะบะฐ ัะพะตะดะธะฝะตะฝะธั ั API"""
        if not REQUESTS_AVAILABLE:
            return False, "โ requests ะฝะต ัััะฐะฝะพะฒะปะตะฝ", 0
        if not ะบะปัั:
            return False, "โ ะะปัั ะฝะต ัะบะฐะทะฐะฝ", 0
        
        start = time.time()
        
        try:
            if ะฟัะพะฒะฐะนะดะตั == "openai":
                response = requests.get(
                    "https://api.openai.com/v1/models",
                    headers={"Authorization": f"Bearer {ะบะปัั}"},
                    timeout=10
                )
                elapsed = (time.time() - start) * 1000
                if response.status_code == 200:
                    return True, f"โ OK ({elapsed:.0f}ะผั)", elapsed
                return False, f"โ ะัะธะฑะบะฐ {response.status_code}", elapsed
            
            elif ะฟัะพะฒะฐะนะดะตั == "anthropic":
                response = requests.post(
                    "https://api.anthropic.com/v1/messages",
                    headers={
                        "x-api-key": ะบะปัั,
                        "Content-Type": "application/json",
                        "anthropic-version": "2023-06-01"
                    },
                    json={"model": "claude-3-haiku-20240307", "max_tokens": 10, "messages": [{"role": "user", "content": "ะขะตัั"}]},
                    timeout=15
                )
                elapsed = (time.time() - start) * 1000
                if response.status_code == 200:
                    return True, f"โ OK ({elapsed:.0f}ะผั)", elapsed
                return False, f"โ ะัะธะฑะบะฐ {response.status_code}", elapsed
            
            elif ะฟัะพะฒะฐะนะดะตั == "yandexgpt":
                if not folder_id:
                    return False, "โ ะัะถะตะฝ Folder ID", 0
                return True, "โ๏ธ ะัะพะฒะตัััะต ะฟัะธ ะทะฐะฟัะพัะต", 0
            
            elif ะฟัะพะฒะฐะนะดะตั == "gigachat":
                return True, "โ๏ธ ะขัะตะฑัะตััั OAuth", 0
            
            return False, "โ ะะตะธะทะฒะตััะฝัะน ะฟัะพะฒะฐะนะดะตั", 0
            
        except Exception as e:
            return False, f"โ {str(e)[:30]}", 0
    
    @classmethod
    def ัะพะทะดะฐัั_ะฟัะพะผะฟั(cls, ัะตะบัั: str, ะธะทะฒะปะตััะฝะฝัะต: dict, rag_ัะตะทัะปััะฐั: dict, ะพัะณ: dict) -> str:
        """ะกะพะทะดะฐะฝะธะต ะฟัะพะผะฟัะฐ ะดะปั AI"""
        
        ัะธะฟ_ะดะพะบ = ะธะทะฒะปะตััะฝะฝัะต.get("ัะธะฟ_ะดะพะบัะผะตะฝัะฐ", {})
        
        # ะคะพัะผะธััะตะผ ะธะฝัะพัะผะฐัะธั ะพ ะฝะฐัััะตะฝะธัั
        ะฝะฐัััะตะฝะธั_ัะตะบัั = ""
        for i, ะฝ in enumerate(rag_ัะตะทัะปััะฐั.get("ะฝะฐัััะตะฝะธั", [])[:10], 1):
            emoji = "๐ด" if ะฝ["ะบัะธัะธัะฝะพััั"] == "ะบัะฐัะฝัะน" else "๐ก"
            ะฝะฐัััะตะฝะธั_ัะตะบัั += f"\n{i}. {emoji} [{ะฝ.get('ะฟัะฝะบั_ะดะพะณะพะฒะพัะฐ', '?')}] {ะฝ['ะฟัะพะฑะปะตะผะฐ']}"
            ะฝะฐัััะตะฝะธั_ัะตะบัั += f"\n   ะะฐะนะดะตะฝะพ: {ะฝ.get('ะบะพะฝัะตะบัั', '')[:150]}"
        
        ะฟัะพะผะฟั = f"""ะขั โ ะพะฟััะฝัะน ะบะพัะฟะพัะฐัะธะฒะฝัะน ััะธัั ะบะพะผะฟะฐะฝะธะธ {ะพัะณ.get('short_name', 'ะะ ยซะกะะยป')} (ะถะตะปะตะทะฝะพะดะพัะพะถะฝัะน ะพะฟะตัะฐัะพั).

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะะคะะะะะฆะะฏ ะ ะะะะฃะะะะขะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะขะธะฟ ะดะพะบัะผะตะฝัะฐ: {ัะธะฟ_ะดะพะบ.get('ะพะฟะธัะฐะฝะธะต', 'ะะพะณะพะฒะพั')}
ะญัะพ ะดะพะณะพะฒะพั: {'ะะ' if ัะธะฟ_ะดะพะบ.get('ััะพ_ะดะพะณะพะฒะพั') else 'ะะะข โ ะฟัะพะฐะฝะฐะปะธะทะธััะน ััะพ ััะพ ะทะฐ ะดะพะบัะผะตะฝั'}
ะะฐัะฐ ัะพะปั: {rag_ัะตะทัะปััะฐั.get('ะฝะฐัะฐ_ัะพะปั', 'ะะฐะบะฐะทัะธะบ')}
ะะพะฝััะฐะณะตะฝั: {ะธะทะฒะปะตััะฝะฝัะต.get('ะบะพะฝััะฐะณะตะฝั', 'ะะต ะพะฟัะตะดะตะปัะฝ')}
ะกัะผะผะฐ: {ะธะทะฒะปะตััะฝะฝัะต.get('ััะผะผะฐ', 0):,.0f} ััะฑ.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะขะะะกะข ะะะะฃะะะะขะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
{ัะตะบัั[:6000]}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ๏ธ ะะะขะะะะขะะงะะกะะ ะะซะฏะะะะะะซะ ะะะกะะะขะะะขะกะขะะะฏ ะขะค
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
{ะฝะฐัััะตะฝะธั_ัะตะบัั if ะฝะฐัััะตะฝะธั_ัะตะบัั else "ะะฒัะพะผะฐัะธัะตัะบะธะน ะฐะฝะฐะปะธะท ะฝะต ะฒััะฒะธะป ัะฒะฝัั ะพัะบะปะพะฝะตะฝะธะน ะพั ะขะค."}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะะะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

{"ะญัะพ ะะ ะดะพะณะพะฒะพั. ะัะฐัะบะพ ะพะฟะธัะธ (2-3 ะฟัะตะดะปะพะถะตะฝะธั) ััะพ ััะพ ะทะฐ ะดะพะบัะผะตะฝั ะธ ะผะพะถะฝะพ ะปะธ ะตะณะพ ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ะบะฐะบ ะดะพะณะพะฒะพั." if not ัะธะฟ_ะดะพะบ.get('ััะพ_ะดะพะณะพะฒะพั') else '''
ะัะพะฒะตะดะธ ะะะขะะะฌะะซะ ััะธะดะธัะตัะบะธะน ะฐะฝะฐะปะธะท. ะัะฒะตั ััััะบัััะธััะน ัะฐะบ:

## 1. ะงะขะ ะญะขะ ะะ ะะะะฃะะะะข
ะัะฐัะบะพ (1-2 ะฟัะตะดะปะพะถะตะฝะธั): ะบะฐะบะพะน ััะพ ะดะพะณะพะฒะพั, ะผะตะถะดั ะบะตะผ, ะฝะฐ ะบะฐะบัั ััะผะผั, ะฟัะตะดะผะตั.

## 2. ะะะะขะะงะะกะะะ ะะฃะะะขะซ (ััะตะฑััั ะพะฑัะทะฐัะตะปัะฝะพะณะพ ะธะทะผะตะฝะตะฝะธั)
ะะปั ะะะะะะะ ะบัะธัะธัะตัะบะพะณะพ ะฟัะฝะบัะฐ ัะบะฐะถะธ:
- **ะัะฝะบั X.X** โ [ะบัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ะฟัะพะฑะปะตะผั]
- ะขะตะบัั ะฒ ะดะพะณะพะฒะพัะต: "ัะธัะฐัะฐ ะธะท ะดะพะณะพะฒะพัะฐ"
- โ ะะพัะตะผั ะฟะปะพัะพ: [ะพะฑัััะฝะตะฝะธะต ัะธัะบะฐ ะดะปั ะฝะฐั]
- โ ะะฐะบ ะธัะฟัะฐะฒะธัั: "ะฟัะตะดะปะพะถะธ ะบะพะฝะบัะตัะฝัั ัะพัะผัะปะธัะพะฒะบั ะดะปั ะทะฐะผะตะฝั"

## 3. ะะะะะงะะะะฏ (ัะตะบะพะผะตะฝะดัะตััั ะธะทะผะตะฝะธัั)
ะะฝะฐะปะพะณะธัะฝะพ ั ัะบะฐะทะฐะฝะธะตะผ ะฟัะฝะบัะพะฒ ะธ ัะตะบะพะผะตะฝะดัะตะผัั ัะพัะผัะปะธัะพะฒะพะบ.

## 4. ะะขะกะฃะขะกะขะะฃะฎะฉะะ ะฃะกะะะะะฏ
ะะฐะบะธะต ะฒะฐะถะฝัะต ะฟัะฝะบัั ะพััััััะฒััั ะฒ ะดะพะณะพะฒะพัะต (ะพะณัะฐะฝะธัะตะฝะธะต ะฝะตัััะพะนะบะธ, ะณะฐัะฐะฝัะธะธ ะธ ั.ะด.)

## 5. ะะขะะะะะะฏ ะะะะะะะะะะฆะะฏ
ะัะฑะตัะธ ะะะะ:
- โ ะกะะะะะกะะะะขะฌ โ ะผะพะถะฝะพ ะฟะพะดะฟะธััะฒะฐัั
- โ๏ธ ะกะะะะะกะะะะขะฌ ะก ะะะะะงะะะะฏะะ โ ะฟะพัะปะต ะฒะฝะตัะตะฝะธั ัะบะฐะทะฐะฝะฝัั ะฟัะฐะฒะพะบ
- ๐ ะะะะะะะขะะขะฌ โ ััะตะฑััััั ัััะตััะฒะตะฝะฝัะต ะธะทะผะตะฝะตะฝะธั
- โ ะะขะะะะะะขะฌ โ ะฝะตะฟัะธะตะผะปะตะผัะต ััะปะพะฒะธั

ะะะะะ: ะฃะบะฐะทัะฒะฐะน ะะะะะะะขะะซะ ะฝะพะผะตัะฐ ะฟัะฝะบัะพะฒ (1.1, 3.2 ะธ ั.ะด.) ะธ ะฟัะตะดะปะฐะณะฐะน ะะะขะะะซะ ัะพัะผัะปะธัะพะฒะบะธ ะดะปั ะทะฐะผะตะฝั.
'''}
"""
        return ะฟัะพะผะฟั
    
    @classmethod
    def ะฒัะทะฒะฐัั_api(cls, ะฟัะพะฒะฐะนะดะตั: str, ะฟัะพะผะฟั: str, ะบะปัั: str, folder_id: str = "") -> Tuple[bool, str]:
        """ะัะทะพะฒ AI API"""
        if not REQUESTS_AVAILABLE:
            return False, "requests ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
        
        try:
            if ะฟัะพะฒะฐะนะดะตั == "openai":
                response = requests.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={"Authorization": f"Bearer {ะบะปัั}", "Content-Type": "application/json"},
                    json={
                        "model": "gpt-4o-mini",
                        "messages": [
                            {"role": "system", "content": "ะขั ะพะฟััะฝัะน ะบะพัะฟะพัะฐัะธะฒะฝัะน ััะธัั. ะะฝะฐะปะธะทะธััะน ะดะพะณะพะฒะพัั ะดะตัะฐะปัะฝะพ, ัะบะฐะทัะฒะฐะน ะบะพะฝะบัะตัะฝัะต ะฟัะฝะบัั ะธ ัะพัะผัะปะธัะพะฒะบะธ. ะัะฒะตัะฐะน ะฝะฐ ััััะบะพะผ."},
                            {"role": "user", "content": ะฟัะพะผะฟั}
                        ],
                        "max_tokens": 4000,
                        "temperature": 0.3
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"ะัะธะฑะบะฐ: {response.status_code}"
            
            elif ะฟัะพะฒะฐะนะดะตั == "anthropic":
                response = requests.post(
                    "https://api.anthropic.com/v1/messages",
                    headers={
                        "x-api-key": ะบะปัั,
                        "Content-Type": "application/json",
                        "anthropic-version": "2023-06-01"
                    },
                    json={
                        "model": "claude-3-haiku-20240307",
                        "max_tokens": 4000,
                        "messages": [{"role": "user", "content": ะฟัะพะผะฟั}]
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["content"][0]["text"]
                return False, f"ะัะธะฑะบะฐ: {response.status_code}"
            
            elif ะฟัะพะฒะฐะนะดะตั == "yandexgpt":
                if not folder_id:
                    return False, "ะขัะตะฑัะตััั Folder ID"
                response = requests.post(
                    "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                    headers={"Authorization": f"Api-Key {ะบะปัั}", "Content-Type": "application/json"},
                    json={
                        "modelUri": f"gpt://{folder_id}/yandexgpt-lite",
                        "completionOptions": {"stream": False, "maxTokens": 4000, "temperature": 0.3},
                        "messages": [{"role": "user", "text": ะฟัะพะผะฟั}]
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["result"]["alternatives"][0]["message"]["text"]
                return False, f"ะัะธะฑะบะฐ: {response.status_code}"
            
            return False, "ะะตะธะทะฒะตััะฝัะน ะฟัะพะฒะฐะนะดะตั"
            
        except requests.exceptions.Timeout:
            return False, "ะขะฐะนะผะฐัั (120 ัะตะบ). ะะพะฟัะพะฑัะนัะต ะฟะพะทะถะต."
        except Exception as e:
            return False, f"ะัะธะฑะบะฐ: {str(e)}"
    
    @classmethod
    def ะฐะฝะฐะปะธะทะธัะพะฒะฐัั(cls, ัะตะบัั: str, ะธะทะฒะปะตััะฝะฝัะต: dict, rag_ัะตะทัะปััะฐั: dict) -> Tuple[bool, str]:
        """ะะพะปะฝัะน AI-ะฐะฝะฐะปะธะท"""
        api_ะบะปััะธ = st.session_state.get("api_ะบะปััะธ", {})
        ะพัะณ = st.session_state.get("ะพัะณ", DEFAULT_ORG_CONFIG)
        
        # ะัะตะผ ะฟะตัะฒัะน ะดะพัััะฟะฝัะน ะฟัะพะฒะฐะนะดะตั
        ะฟัะพะฒะฐะนะดะตั = None
        ะบะปัั = ""
        for pid in ["openai", "anthropic", "yandexgpt", "gigachat"]:
            if api_ะบะปััะธ.get(pid):
                ะฟัะพะฒะฐะนะดะตั = pid
                ะบะปัั = api_ะบะปััะธ[pid]
                break
        
        if not ะฟัะพะฒะฐะนะดะตั:
            return False, "ะะต ะฝะฐัััะพะตะฝ ะฝะธ ะพะดะธะฝ AI-ะฟัะพะฒะฐะนะดะตั. ะะพะฑะฐะฒััะต API-ะบะปัั ะฒ โ๏ธ ะะฐัััะพะนะบะฐั."
        
        ะฟัะพะผะฟั = cls.ัะพะทะดะฐัั_ะฟัะพะผะฟั(ัะตะบัั, ะธะทะฒะปะตััะฝะฝัะต, rag_ัะตะทัะปััะฐั, ะพัะณ)
        folder_id = st.session_state.get("yandex_folder", "") if ะฟัะพะฒะฐะนะดะตั == "yandexgpt" else ""
        
        return cls.ะฒัะทะฒะฐัั_api(ะฟัะพะฒะฐะนะดะตั, ะฟัะพะผะฟั, ะบะปัั, folder_id)

# ============================================================================
# ะะกะะะะะะะขะะะฌะะซะ ะคะฃะะะฆะะ
# ============================================================================

def ะทะฐะณััะทะธัั_ัะฐะนะป(uploaded_file) -> Tuple[bool, str]:
    """ะะฐะณััะทะบะฐ ัะฐะนะปะฐ"""
    if not uploaded_file:
        return False, ""
    try:
        content = uploaded_file.read()
        name = uploaded_file.name.lower()
        
        if name.endswith('.txt'):
            for enc in ['utf-8', 'cp1251', 'cp866', 'koi8-r']:
                try:
                    return True, content.decode(enc)
                except:
                    pass
            return True, content.decode('utf-8', errors='replace')
        
        elif name.endswith('.docx') and DOCX_AVAILABLE:
            doc = DocxDocument(io.BytesIO(content))
            text = '\n'.join([p.text for p in doc.paragraphs if p.text.strip()])
            return (True, text) if text else (False, "ะะพะบัะผะตะฝั ะฟัััะพะน")
        
        elif name.endswith('.pdf') and PDF_AVAILABLE:
            reader = PdfReader(io.BytesIO(content))
            text = '\n'.join([p.extract_text() or '' for p in reader.pages])
            return (True, text) if text.strip() else (False, "ะะต ัะดะฐะปะพัั ะธะทะฒะปะตัั ัะตะบัั")
        
        return False, "ะคะพัะผะฐั ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตััั (.docx, .pdf, .txt)"
    except Exception as e:
        return False, f"ะัะธะฑะบะฐ: {str(e)}"


def ะพะฟัะตะดะตะปะธัั_ะทะพะฝั(ััะผะผะฐ: float, ัะพัะผะฐ: str, ัะธะฟ_ัะดะตะปะบะธ: str) -> dict:
    """ะะฟัะตะดะตะปะตะฝะธะต ะทะพะฝั ัะธัะบะฐ"""
    ะฟะพัะพะณะธ = st.session_state.get("ะฟะพัะพะณะธ", DEFAULT_THRESHOLDS)
    
    # ะะะะกะะะฏ
    if ัะธะฟ_ัะดะตะปะบะธ and ัะธะฟ_ัะดะตะปะบะธ in ะะะะกะะะฏ_ะะะะ_ะะกะะะะ:
        return {"ะทะพะฝะฐ": "ะบัะฐัะฝะฐั", "ะฟัะธัะธะฝะฐ": f"ะขะธะฟ: {ัะธะฟ_ัะดะตะปะบะธ}", "ััะตะฑัะตััั_ัะด": True, "ััะพะบ": 10}
    
    if ััะผะผะฐ > ะฟะพัะพะณะธ.get("ะถัะปัะฐั_ะผะฐะบั", 5_000_000):
        return {"ะทะพะฝะฐ": "ะบัะฐัะฝะฐั", "ะฟัะธัะธะฝะฐ": f"ะกัะผะผะฐ > {ะฟะพัะพะณะธ['ะถัะปัะฐั_ะผะฐะบั']:,}โฝ", "ััะตะฑัะตััั_ัะด": True, "ััะพะบ": 10}
    
    # ะะะะขะะฏ
    if ัะธะฟ_ัะดะตะปะบะธ and ัะธะฟ_ัะดะตะปะบะธ in ะะะะขะะฏ_ะะะะ_ะขะะะซ:
        return {"ะทะพะฝะฐ": "ะถัะปัะฐั", "ะฟัะธัะธะฝะฐ": f"ะขะธะฟ: {ัะธะฟ_ัะดะตะปะบะธ}", "ััะตะฑัะตััั_ัะด": True, "ััะพะบ": 5}
    
    if ัะพัะผะฐ == "ะขะธะฟะพะฒะฐั ัะพัะผะฐ (ะขะค)":
        if ััะผะผะฐ > ะฟะพัะพะณะธ.get("ะทะตะปัะฝะฐั_ัั_ะผะฐะบั", 100_000):
            return {"ะทะพะฝะฐ": "ะถัะปัะฐั", "ะฟัะธัะธะฝะฐ": f"ะขะค > {ะฟะพัะพะณะธ['ะทะตะปัะฝะฐั_ัั_ะผะฐะบั']:,}โฝ", "ััะตะฑัะตััั_ัะด": True, "ััะพะบ": 5}
    else:
        if ััะผะผะฐ > ะฟะพัะพะณะธ.get("ะทะตะปัะฝะฐั_ะฝะตัั_ะผะฐะบั", 50_000):
            return {"ะทะพะฝะฐ": "ะถัะปัะฐั", "ะฟัะธัะธะฝะฐ": f"ะะตัะธะฟะพะฒะฐั > {ะฟะพัะพะณะธ['ะทะตะปัะฝะฐั_ะฝะตัั_ะผะฐะบั']:,}โฝ", "ััะตะฑัะตััั_ัะด": True, "ััะพะบ": 5}
    
    return {"ะทะพะฝะฐ": "ะทะตะปัะฝะฐั", "ะฟัะธัะธะฝะฐ": "ะะตะปัะฝัะน ะบะพัะธะดะพั", "ััะตะฑัะตััั_ัะด": False, "ััะพะบ": 0}


def ะดะพะฑะฐะฒะธัั_ะฒ_ะธััะพัะธั(ะดะฐะฝะฝัะต: dict):
    """ะกะพััะฐะฝะตะฝะธะต ะฒ ะธััะพัะธั"""
    if "ะธััะพัะธั" not in st.session_state:
        st.session_state.ะธััะพัะธั = []
    
    ะทะฐะฟะธัั = {
        "ะดะฐัะฐ": datetime.now().strftime('%d.%m.%Y %H:%M'),
        "ะบะพะฝััะฐะณะตะฝั": ะดะฐะฝะฝัะต.get("ะบะพะฝััะฐะณะตะฝั", ""),
        "ะฝะพะผะตั": ะดะฐะฝะฝัะต.get("ะฝะพะผะตั", ""),
        "ััะผะผะฐ": ะดะฐะฝะฝัะต.get("ััะผะผะฐ", 0),
        "ะทะพะฝะฐ": ะดะฐะฝะฝัะต.get("ะทะพะฝะฐ", ""),
        "ัะพะพัะฒะตัััะฒะธะต": ะดะฐะฝะฝัะต.get("ัะพะพัะฒะตัััะฒะธะต", 0),
        "ะบัะฐัะฝัั": ะดะฐะฝะฝัะต.get("ะบัะฐัะฝัั", 0),
        "ะถัะปััั": ะดะฐะฝะฝัะต.get("ะถัะปััั", 0),
    }
    st.session_state.ะธััะพัะธั.insert(0, ะทะฐะฟะธัั)
    if len(st.session_state.ะธััะพัะธั) > 50:
        st.session_state.ะธััะพัะธั = st.session_state.ะธััะพัะธั[:50]


def ััะพ_ะฐะดะผะธะฝ() -> bool:
    return st.session_state.get("ัะพะปั", "") == ะะะะฌ_ะะะะะ


# ============================================================================
# ะกะขะะะ
# ============================================================================

def ะฟัะธะผะตะฝะธัั_ััะธะปะธ():
    st.markdown("""<style>
.main-header { background:linear-gradient(135deg,#1e3a5f,#2d5a87); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem; color:white; }
.traffic-light { display:flex; gap:8px; margin-bottom:0.5rem; }
.traffic-light span { width:14px; height:14px; border-radius:50%; box-shadow:0 0 6px currentColor; }
.tl-red { background:#dc3545; color:#dc3545; }
.tl-yellow { background:#f0ad4e; color:#f0ad4e; }
.tl-green { background:#28a745; color:#28a745; }
.zone-card { border-radius:10px; padding:1.2rem; margin:1rem 0; border-left:5px solid; }
.zone-card.ะทะตะปัะฝะฐั { background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border-left-color:#28a745; }
.zone-card.ะถัะปัะฐั { background:linear-gradient(135deg,#fff8e1,#ffecb3); border-left-color:#f0ad4e; }
.zone-card.ะบัะฐัะฝะฐั { background:linear-gradient(135deg,#ffebee,#ffcdd2); border-left-color:#dc3545; }
.admin-badge { background:#7b1fa2; color:white; padding:3px 10px; border-radius:12px; font-size:0.75rem; }
.user-badge { background:#1976d2; color:white; padding:3px 10px; border-radius:12px; font-size:0.75rem; }
.risk-card { border-radius:8px; padding:12px; margin:10px 0; border-left:4px solid; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.risk-card.red { border-left-color:#dc3545; }
.risk-card.yellow { border-left-color:#f0ad4e; }
.metric-box { background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; border:1px solid #e9ecef; }
.metric-value { font-size:1.8rem; font-weight:700; color:#1e3a5f; }
.metric-label { font-size:0.85rem; color:#6c757d; }
.ai-result { background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; padding:20px; margin-top:15px; }
.extract-box { background:#e3f2fd; border-radius:8px; padding:12px; margin:8px 0; }
.doc-type-box { padding:15px; border-radius:8px; margin:10px 0; }
.doc-type-box.ะดะพะณะพะฒะพั { background:#e8f5e9; border:1px solid #4caf50; }
.doc-type-box.ะฝะต_ะดะพะณะพะฒะพั { background:#fff3e0; border:1px solid #ff9800; }
</style>""", unsafe_allow_html=True)


# ============================================================================
# ะะะะฆะะะะะะะฆะะฏ
# ============================================================================

def ะธะฝะธัะธะฐะปะธะทะฐัะธั():
    defaults = {
        "ะฐะฒัะพัะธะทะพะฒะฐะฝ": False,
        "ะฟะพะปัะทะพะฒะฐัะตะปั": None,
        "ัะพะปั": ะะะะฌ_ะฎะะะ,
        "ะดะตะผะพ": False,
        "ัะตะบัั_ะดะพะณะพะฒะพัะฐ": "",
        "ัะฐะนะป_ะทะฐะณััะถะตะฝ": False,
        "ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต": None,
        "ัะตะทัะปััะฐั_ะทะพะฝั": None,
        "ัะตะทัะปััะฐั_rag": None,
        "ัะตะทัะปััะฐั_ai": "",
        "ะธััะพัะธั": [],
        "ะพัะณ": DEFAULT_ORG_CONFIG.copy(),
        "ะฟะพัะพะณะธ": DEFAULT_THRESHOLDS.copy(),
        "ััะพะบะธ": DEFAULT_DEADLINES.copy(),
        "api_ะบะปััะธ": {p: "" for p in AI_ะะะะะะะะะะซ},
        "yandex_folder": "",
        "ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต_ัั": {},
        "ััะฐััั_api": {},
    }
    for k, v in defaults.items():
        if k not in st.session_state:
            st.session_state[k] = v

# ============================================================================
# ะกะขะะะะะฆะ ะะฅะะะ
# ============================================================================

def ัััะฐะฝะธัะฐ_ะฒัะพะดะฐ():
    st.markdown('''<div style="text-align:center;padding:2rem;">
<div class="traffic-light" style="justify-content:center;margin-bottom:1rem;">
    <span class="tl-red"></span><span class="tl-yellow"></span><span class="tl-green"></span>
</div>
<h1 style="color:#1e3a5f;">๐ฆ ะะตะณะปะฐะผะตะฝั ะกะฒะตัะพัะพั</h1>
<p>ะกะธััะตะผะฐ ะฐะฝะฐะปะธะทะฐ ะดะพะณะพะฒะพัะพะฒ v7.6<br><strong>ะะ ยซะกะะยป</strong></p>
</div>''', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        tab1, tab2 = st.tabs(["๐ค ะะพะปัะทะพะฒะฐัะตะปั", "๐ ะะดะผะธะฝะธัััะฐัะพั"])
        
        with tab1:
            with st.form("user_form"):
                ะธะผั = st.text_input("ะคะะ *", placeholder="ะะฒะฐะฝะพะฒ ะะฒะฐะฝ ะะฒะฐะฝะพะฒะธั")
                ะดะพะปะถะฝะพััั = st.selectbox("ะะพะปะถะฝะพััั *", ["โ ะัะฑะตัะธัะต โ"] + ะะะะะะะกะขะ)
                ะฟะพะดัะฐะทะดะตะปะตะฝะธะต = st.selectbox("ะะพะดัะฐะทะดะตะปะตะฝะธะต *", ["โ ะัะฑะตัะธัะต โ"] + ะะะะะะะะะะะะะฏ)
                
                c1, c2 = st.columns(2)
                with c1:
                    btn_user = st.form_submit_button("๐ ะะพะนัะธ", use_container_width=True)
                with c2:
                    btn_demo = st.form_submit_button("๐ ะะตะผะพ", use_container_width=True)
                
                if btn_user:
                    if ะธะผั and len(ะธะผั) >= 3 and ะดะพะปะถะฝะพััั != "โ ะัะฑะตัะธัะต โ" and ะฟะพะดัะฐะทะดะตะปะตะฝะธะต != "โ ะัะฑะตัะธัะต โ":
                        st.session_state.ะฐะฒัะพัะธะทะพะฒะฐะฝ = True
                        st.session_state.ะฟะพะปัะทะพะฒะฐัะตะปั = {"ะธะผั": ะธะผั, "ะดะพะปะถะฝะพััั": ะดะพะปะถะฝะพััั, "ะฟะพะดัะฐะทะดะตะปะตะฝะธะต": ะฟะพะดัะฐะทะดะตะปะตะฝะธะต}
                        st.session_state.ัะพะปั = ะะะะฌ_ะฎะะะ
                        st.rerun()
                    else:
                        st.error("โ ะะฐะฟะพะปะฝะธัะต ะฒัะต ะฟะพะปั")
                
                if btn_demo:
                    st.session_state.ะฐะฒัะพัะธะทะพะฒะฐะฝ = True
                    st.session_state.ะฟะพะปัะทะพะฒะฐัะตะปั = {"ะธะผั": "ะะตะผะพ-ะฟะพะปัะทะพะฒะฐัะตะปั", "ะดะพะปะถะฝะพััั": "ะกะฟะตัะธะฐะปะธัั", "ะฟะพะดัะฐะทะดะตะปะตะฝะธะต": "ะฎะ"}
                    st.session_state.ัะพะปั = ะะะะฌ_ะฎะะะ
                    st.session_state.ะดะตะผะพ = True
                    st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ = ะะะะ_ะะะะะะะ
                    st.rerun()
        
        with tab2:
            with st.form("admin_form"):
                ะปะพะณะธะฝ = st.text_input("ะะพะณะธะฝ", placeholder="admin")
                ะฟะฐัะพะปั = st.text_input("ะะฐัะพะปั", type="password")
                
                c1, c2 = st.columns(2)
                with c1:
                    btn_admin = st.form_submit_button("๐ ะะพะนัะธ", use_container_width=True)
                with c2:
                    btn_demo_admin = st.form_submit_button("๐ ะะตะผะพ-ะฐะดะผะธะฝ", use_container_width=True)
                
                if btn_admin:
                    if ะปะพะณะธะฝ in ะะะะฌะะะะะขะะะ:
                        user = ะะะะฌะะะะะขะะะ[ะปะพะณะธะฝ]
                        if user["ะฟะฐัะพะปั_ัะตั"] == hashlib.sha256(ะฟะฐัะพะปั.encode()).hexdigest():
                            st.session_state.ะฐะฒัะพัะธะทะพะฒะฐะฝ = True
                            st.session_state.ะฟะพะปัะทะพะฒะฐัะตะปั = {"ะธะผั": user["ะธะผั"], "ะดะพะปะถะฝะพััั": user["ะดะพะปะถะฝะพััั"], "ะฟะพะดัะฐะทะดะตะปะตะฝะธะต": user["ะฟะพะดัะฐะทะดะตะปะตะฝะธะต"]}
                            st.session_state.ัะพะปั = ะะะะฌ_ะะะะะ
                            st.rerun()
                        else:
                            st.error("โ ะะตะฒะตัะฝัะน ะฟะฐัะพะปั")
                    else:
                        st.error("โ ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฝะฐะนะดะตะฝ")
                
                if btn_demo_admin:
                    st.session_state.ะฐะฒัะพัะธะทะพะฒะฐะฝ = True
                    st.session_state.ะฟะพะปัะทะพะฒะฐัะตะปั = {"ะธะผั": "ะะตะผะพ-ะฐะดะผะธะฝะธัััะฐัะพั", "ะดะพะปะถะฝะพััั": "ะกะธั.ะฐะดะผะธะฝ", "ะฟะพะดัะฐะทะดะตะปะตะฝะธะต": "ะะข"}
                    st.session_state.ัะพะปั = ะะะะฌ_ะะะะะ
                    st.session_state.ะดะตะผะพ = True
                    st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ = ะะะะ_ะะะะะะะ
                    st.rerun()
            
            st.caption("๐ก admin/admin123 ะธะปะธ legal/legal123")


# ============================================================================
# ะะะะะะะฏ ะะะะะะฌ
# ============================================================================

def ะฑะพะบะพะฒะฐั_ะฟะฐะฝะตะปั():
    with st.sidebar:
        user = st.session_state.ะฟะพะปัะทะพะฒะฐัะตะปั
        is_admin = ััะพ_ะฐะดะผะธะฝ()
        
        badge = "admin-badge" if is_admin else "user-badge"
        badge_text = "ะะะะะะะกะขะะะขะะ" if is_admin else "ะะะะฌะะะะะขะะะฌ"
        
        st.markdown(f'''
        <div style="background:#f8f9fa;padding:12px;border-radius:10px;margin-bottom:15px;">
            <strong>{user["ะธะผั"]}</strong><br>
            <small>{user["ะดะพะปะถะฝะพััั"]}</small><br>
            <span class="{badge}">{badge_text}</span>
        </div>
        ''', unsafe_allow_html=True)
        
        if st.button("๐ช ะัะนัะธ", use_container_width=True):
            for k in list(st.session_state.keys()):
                del st.session_state[k]
            st.rerun()
        
        st.markdown("---")
        
        ะพัะณ = st.session_state.get("ะพัะณ", DEFAULT_ORG_CONFIG)
        st.markdown(f"**{ะพัะณ.get('short_name', '')}**")
        st.caption(f"ะะะ: {ะพัะณ.get('inn', '')}")
        
        st.markdown("---")
        ะฟะพัะพะณะธ = st.session_state.get("ะฟะพัะพะณะธ", DEFAULT_THRESHOLDS)
        st.markdown(f"""
**ะะพัะพะณะธ:**
- ๐ข ะขะค โค {ะฟะพัะพะณะธ['ะทะตะปัะฝะฐั_ัั_ะผะฐะบั']:,}โฝ
- ๐ข ะะฝัะต โค {ะฟะพัะพะณะธ['ะทะตะปัะฝะฐั_ะฝะตัั_ะผะฐะบั']:,}โฝ
- ๐ก ะดะพ {ะฟะพัะพะณะธ['ะถัะปัะฐั_ะผะฐะบั']:,}โฝ
- ๐ด > {ะฟะพัะพะณะธ['ะถัะปัะฐั_ะผะฐะบั']:,}โฝ
        """)
        
        # ะกัะฐััั AI
        api_ะบะปััะธ = st.session_state.get("api_ะบะปััะธ", {})
        ะฐะบัะธะฒะฝัะต = [p for p, k in api_ะบะปััะธ.items() if k]
        
        st.markdown("---")
        if ะฐะบัะธะฒะฝัะต:
            st.success(f"๐ค AI: {len(ะฐะบัะธะฒะฝัะต)} ะฟัะพะฒะฐะนะดะตั(ะฐ)")
        else:
            st.warning("๐ค AI ะฝะต ะฝะฐัััะพะตะฝ")
        
        if is_admin:
            st.info("๐ ะะตะถะธะผ ะฐะดะผะธะฝะฐ")

# ============================================================================
# ะะะะะะะ ะะะะะะะ
# ============================================================================

def ะฒะบะปะฐะดะบะฐ_ะฐะฝะฐะปะธะทะฐ():
    st.markdown("### ๐ ะะฐะณััะทะบะฐ ะดะพะบัะผะตะฝัะฐ")
    
    # ะะฐะณััะทะบะฐ ัะฐะนะปะฐ
    ัะฐะนะป = st.file_uploader("ะะฐะณััะทะธัะต ะดะพะณะพะฒะพั (DOCX, PDF, TXT)", type=["txt", "docx", "pdf"])
    
    if ัะฐะนะป:
        ok, ัะตะบัั = ะทะฐะณััะทะธัั_ัะฐะนะป(ัะฐะนะป)
        if ok:
            st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ = ัะตะบัั[:300000]
            st.session_state.ัะฐะนะป_ะทะฐะณััะถะตะฝ = True
            st.success(f"โ ะะฐะณััะถะตะฝะพ: {len(st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ):,} ัะธะผะฒะพะปะพะฒ")
            
            # ะะฒัะพะผะฐัะธัะตัะบะพะต ะธะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั
            with st.spinner("๐ ะะฝะฐะปะธะท ะดะพะบัะผะตะฝัะฐ..."):
                ะธะทะฒะปะตััะฝะฝัะต = ะญะบัััะฐะบัะพัะะฐะฝะฝัั.ะฟะพะปะฝะพะต_ะธะทะฒะปะตัะตะฝะธะต(st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ)
                st.session_state.ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต = ะธะทะฒะปะตััะฝะฝัะต
            st.rerun()
        else:
            st.error(f"โ {ัะตะบัั}")
    
    # ะะฝะพะฟะบะธ ัะฟัะฐะฒะปะตะฝะธั
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("๐ ะะฐะณััะทะธัั ะดะตะผะพ", use_container_width=True):
            st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ = ะะะะ_ะะะะะะะ
            st.session_state.ัะฐะนะป_ะทะฐะณััะถะตะฝ = False
            ะธะทะฒะปะตััะฝะฝัะต = ะญะบัััะฐะบัะพัะะฐะฝะฝัั.ะฟะพะปะฝะพะต_ะธะทะฒะปะตัะตะฝะธะต(ะะะะ_ะะะะะะะ)
            st.session_state.ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต = ะธะทะฒะปะตััะฝะฝัะต
            st.rerun()
    
    with col2:
        if st.button("๐ ะััะฐะฒะธัั ัะตะบัั", use_container_width=True):
            st.session_state.ะฟะพะบะฐะทะฐัั_ัะตะบััะพะฒะพะต_ะฟะพะปะต = True
    
    with col3:
        if st.button("๐๏ธ ะัะธััะธัั ะฒัั", use_container_width=True):
            for key in ["ัะตะบัั_ะดะพะณะพะฒะพัะฐ", "ัะฐะนะป_ะทะฐะณััะถะตะฝ", "ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต", "ัะตะทัะปััะฐั_ะทะพะฝั", "ัะตะทัะปััะฐั_rag", "ัะตะทัะปััะฐั_ai"]:
                if key in st.session_state:
                    st.session_state[key] = None if key != "ัะตะบัั_ะดะพะณะพะฒะพัะฐ" else ""
            st.session_state.ัะฐะนะป_ะทะฐะณััะถะตะฝ = False
            st.rerun()
    
    # ะขะตะบััะพะฒะพะต ะฟะพะปะต (ะตัะปะธ ะฒัะฑัะฐะฝะพ)
    if st.session_state.get("ะฟะพะบะฐะทะฐัั_ัะตะบััะพะฒะพะต_ะฟะพะปะต"):
        ัะตะบัั = st.text_area("ะััะฐะฒััะต ัะตะบัั ะดะพะณะพะฒะพัะฐ:", height=200)
        if st.button("โ ะัะธะผะตะฝะธัั ัะตะบัั"):
            if len(ัะตะบัั) > 100:
                st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ = ัะตะบัั
                st.session_state.ัะฐะนะป_ะทะฐะณััะถะตะฝ = False
                ะธะทะฒะปะตััะฝะฝัะต = ะญะบัััะฐะบัะพัะะฐะฝะฝัั.ะฟะพะปะฝะพะต_ะธะทะฒะปะตัะตะฝะธะต(ัะตะบัั)
                st.session_state.ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต = ะธะทะฒะปะตััะฝะฝัะต
                st.session_state.ะฟะพะบะฐะทะฐัั_ัะตะบััะพะฒะพะต_ะฟะพะปะต = False
                st.rerun()
            else:
                st.error("ะะธะฝะธะผัะผ 100 ัะธะผะฒะพะปะพะฒ")
    
    # ========== ะะะะะะงะะะะซะ ะะะะะซะ ==========
    if st.session_state.get("ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต"):
        ะธะทะฒะป = st.session_state.ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต
        ัะธะฟ_ะดะพะบ = ะธะทะฒะป.get("ัะธะฟ_ะดะพะบัะผะตะฝัะฐ", {})
        
        st.markdown("---")
        
        # ะขะธะฟ ะดะพะบัะผะตะฝัะฐ
        if ัะธะฟ_ะดะพะบ.get("ััะพ_ะดะพะณะพะฒะพั"):
            st.markdown(f'''<div class="doc-type-box ะดะพะณะพะฒะพั">
                <strong>๐ {ัะธะฟ_ะดะพะบ.get("ะพะฟะธัะฐะฝะธะต", "ะะพะณะพะฒะพั")}</strong>
            </div>''', unsafe_allow_html=True)
        else:
            st.markdown(f'''<div class="doc-type-box ะฝะต_ะดะพะณะพะฒะพั">
                <strong>โ๏ธ {ัะธะฟ_ะดะพะบ.get("ะพะฟะธัะฐะฝะธะต", "ะญัะพ ะฝะต ะดะพะณะพะฒะพั")}</strong><br>
                <small>ะะพะบัะผะตะฝั ะพะฟัะตะดะตะปัะฝ ะบะฐะบ: {ัะธะฟ_ะดะพะบ.get("ัะธะฟ", "ะฝะตะธะทะฒะตััะฝะพ")}</small>
            </div>''', unsafe_allow_html=True)
        
        st.markdown("### ๐ ะะทะฒะปะตััะฝะฝัะต ะดะฐะฝะฝัะต")
        st.info("๐ก ะะฐะฝะฝัะต ะธะทะฒะปะตัะตะฝั ะฐะฒัะพะผะฐัะธัะตัะบะธ. ะัะพะฒะตัััะต ะธ ัะบะพััะตะบัะธััะนัะต ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ.")
        
        c1, c2 = st.columns(2)
        
        with c1:
            # ะะพะฝััะฐะณะตะฝั
            ะบะพะฝัั_ะฐะฒัะพ = ะธะทะฒะป.get("ะบะพะฝััะฐะณะตะฝั", "")
            ะบะพะฝััะฐะณะตะฝั = st.text_input("ะะพะฝััะฐะณะตะฝั", value=ะบะพะฝัั_ะฐะฒัะพ or "", placeholder="ะะะ ยซะะฐะทะฒะฐะฝะธะตยป")
            if ะบะพะฝัั_ะฐะฒัะพ:
                st.caption(f"๐ ะะทะฒะปะตัะตะฝะพ: {ะบะพะฝัั_ะฐะฒัะพ}")
            
            # ะะพะผะตั
            ะฝะพะผะตั_ะฐะฒัะพ = ะธะทะฒะป.get("ะฝะพะผะตั", "")
            ะฝะพะผะตั = st.text_input("ะะพะผะตั ะดะพะณะพะฒะพัะฐ", value=ะฝะพะผะตั_ะฐะฒัะพ or "", placeholder="2025/001")
            if ะฝะพะผะตั_ะฐะฒัะพ:
                st.caption(f"๐ ะะทะฒะปะตัะตะฝะพ: {ะฝะพะผะตั_ะฐะฒัะพ}")
            
            # ะะฐัะฐ
            ะดะฐัะฐ_ะฐะฒัะพ = ะธะทะฒะป.get("ะดะฐัะฐ")
            ะดะฐัะฐ = st.date_input("ะะฐัะฐ ะดะพะณะพะฒะพัะฐ", value=ะดะฐัะฐ_ะฐะฒัะพ or date.today())
            if ะดะฐัะฐ_ะฐะฒัะพ:
                st.caption(f"๐ ะะทะฒะปะตัะตะฝะพ: {ะดะฐัะฐ_ะฐะฒัะพ.strftime('%d.%m.%Y')}")
        
        with c2:
            # ะกัะผะผะฐ
            ััะผะผะฐ_ะฐะฒัะพ = ะธะทะฒะป.get("ััะผะผะฐ")
            ััะผะผะฐ_str = st.text_input("ะกัะผะผะฐ (โฝ)", value=f"{ััะผะผะฐ_ะฐะฒัะพ:,.0f}".replace(",", " ") if ััะผะผะฐ_ะฐะฒัะพ else "", placeholder="1 500 000")
            if ััะผะผะฐ_ะฐะฒัะพ:
                st.caption(f"๐ ะะทะฒะปะตัะตะฝะพ: {ััะผะผะฐ_ะฐะฒัะพ:,.0f}โฝ")
            
            ััะผะผะฐ = 0
            if ััะผะผะฐ_str:
                try:
                    ััะผะผะฐ = float(re.sub(r'[^\d.]', '', ััะผะผะฐ_str.replace(' ', '')))
                except:
                    pass
            
            # ะคะพัะผะฐ
            ัะพัะผะฐ = st.selectbox("ะคะพัะผะฐ ะดะพะบัะผะตะฝัะฐ", ะคะะะะซ_ะะะะฃะะะะขะ)
            
            # ะขะธะฟ ัะดะตะปะบะธ
            ัะธะฟ_ัะดะตะปะบะธ = st.selectbox("ะกะฟะตัะธะฐะปัะฝัะน ัะธะฟ", ["โ ะะฑััะฝัะน โ"] + ะะะะกะะะฏ_ะะะะ_ะะกะะะะ + ะะะะขะะฏ_ะะะะ_ะขะะะซ)
            if ัะธะฟ_ัะดะตะปะบะธ == "โ ะะฑััะฝัะน โ":
                ัะธะฟ_ัะดะตะปะบะธ = ""
        
        # ะัะตะดะผะตั ะดะพะณะพะฒะพัะฐ
        ะฟัะตะดะผะตั_ะฐะฒัะพ = ะธะทะฒะป.get("ะฟัะตะดะผะตั", "")
        if ะฟัะตะดะผะตั_ะฐะฒัะพ:
            with st.expander("๐ ะะทะฒะปะตััะฝะฝัะน ะฟัะตะดะผะตั ะดะพะณะพะฒะพัะฐ"):
                st.write(ะฟัะตะดะผะตั_ะฐะฒัะพ)
        
        # ะกะพััะฐะฝัะตะผ ะฒ session_state
        st.session_state.ัะตะบััะธะต_ะดะฐะฝะฝัะต = {
            "ะบะพะฝััะฐะณะตะฝั": ะบะพะฝััะฐะณะตะฝั,
            "ะฝะพะผะตั": ะฝะพะผะตั,
            "ััะผะผะฐ": ััะผะผะฐ,
            "ะดะฐัะฐ": ะดะฐัะฐ
        }
        
        st.markdown("---")
        
        # ========== ะะะะะะ ะะะะะะะ ==========
        st.markdown("### ๐ ะะฝะฐะปะธะท")
        
        col_a, col_b, col_c = st.columns(3)
        
        with col_a:
            if st.button("๐ฆ ะะฟัะตะดะตะปะธัั ะทะพะฝั", type="primary", use_container_width=True):
                ัะตะทัะปััะฐั = ะพะฟัะตะดะตะปะธัั_ะทะพะฝั(ััะผะผะฐ, ัะพัะผะฐ, ัะธะฟ_ัะดะตะปะบะธ)
                st.session_state.ัะตะทัะปััะฐั_ะทะพะฝั = ัะตะทัะปััะฐั
                st.rerun()
        
        with col_b:
            # ะัะฑะพั ะขะค ะดะปั RAG
            ะฒัะต_ัั = {**ะขะะะะะซะ_ะคะะะะซ, **st.session_state.get("ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต_ัั", {})}
            ะพะฟัะธะธ_ัั = ["โ ะะฒัะพ โ"] + [f"{v['ะฝะฐะทะฒะฐะฝะธะต']}" for k, v in ะฒัะต_ัั.items()]
            ะฒัะฑะพั_ัั = st.selectbox("ะขะธะฟะพะฒะฐั ัะพัะผะฐ", ะพะฟัะธะธ_ัั, label_visibility="collapsed")
            
            ะบะพะด_ัั = None
            if ะฒัะฑะพั_ัั != "โ ะะฒัะพ โ":
                for k, v in ะฒัะต_ัั.items():
                    if v['ะฝะฐะทะฒะฐะฝะธะต'] == ะฒัะฑะพั_ัั:
                        ะบะพะด_ัั = k
                        break
            else:
                # ะะฒัะพะพะฟัะตะดะตะปะตะฝะธะต
                ัะธะฟ = ัะธะฟ_ะดะพะบ.get("ัะธะฟ", "")
                if ัะธะฟ in ะฒัะต_ัั:
                    ะบะพะด_ัั = ัะธะฟ
        
        with col_c:
            if st.button("๐ RAG-ัะปะธัะตะฝะธะต ั ะขะค", type="primary", use_container_width=True):
                if not ะบะพะด_ัั:
                    st.error("ะัะฑะตัะธัะต ัะธะฟะพะฒัั ัะพัะผั")
                elif len(st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ) < 100:
                    st.error("ะะฐะณััะทะธัะต ะดะพะณะพะฒะพั")
                else:
                    with st.spinner("๐ RAG-ะฐะฝะฐะปะธะท..."):
                        ัะตะทัะปััะฐั = RAGะะฝะฐะปะธะทะฐัะพั.ะฟะพะปะฝัะน_ะฐะฝะฐะปะธะท(st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ, ะบะพะด_ัั)
                        st.session_state.ัะตะทัะปััะฐั_rag = ัะตะทัะปััะฐั
                    st.rerun()
        
        # AI ะฐะฝะฐะปะธะท
        api_ะบะปััะธ = st.session_state.get("api_ะบะปััะธ", {})
        ะตััั_ะบะปัั = any(api_ะบะปััะธ.get(p) for p in AI_ะะะะะะะะะะซ)
        
        if ะตััั_ะบะปัั:
            if st.button("๐ค AI-ัะบัะฟะตััะธะทะฐ ะดะพะณะพะฒะพัะฐ", type="primary", use_container_width=True):
                if len(st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ) < 100:
                    st.error("ะะฐะณััะทะธัะต ะดะพะณะพะฒะพั")
                else:
                    rag = st.session_state.get("ัะตะทัะปััะฐั_rag") or {"ะฝะฐัััะตะฝะธั": [], "ะฝะฐัะฐ_ัะพะปั": "ะะฐะบะฐะทัะธะบ"}
                    ะธะทะฒะป = st.session_state.get("ะธะทะฒะปะตััะฝะฝัะต_ะดะฐะฝะฝัะต") or {}
                    
                    ะฐะบัะธะฒะฝัะน = next((p for p in AI_ะะะะะะะะะะซ if api_ะบะปััะธ.get(p)), None)
                    with st.spinner(f"๐ค AI-ะฐะฝะฐะปะธะท ({AI_ะะะะะะะะะะซ[ะฐะบัะธะฒะฝัะน]['ะฝะฐะทะฒะฐะฝะธะต']})... 30-60 ัะตะบ..."):
                        ok, ัะตะทัะปััะฐั = AIะะปะธะตะฝั.ะฐะฝะฐะปะธะทะธัะพะฒะฐัั(st.session_state.ัะตะบัั_ะดะพะณะพะฒะพัะฐ, ะธะทะฒะป, rag)
                        if ok:
                            st.session_state.ัะตะทัะปััะฐั_ai = ัะตะทัะปััะฐั
                        else:
                            st.error(f"โ {ัะตะทัะปััะฐั}")
                    st.rerun()
        else:
            st.warning("โ๏ธ ะะปั AI-ะฐะฝะฐะปะธะทะฐ ะดะพะฑะฐะฒััะต API-ะบะปัั ะฒ โ๏ธ ะะฐัััะพะนะบะฐั")
        
        # ========== ะะะะฃะะฌะขะะขะซ ==========
        
        # ะะพะฝะฐ
        if st.session_state.get("ัะตะทัะปััะฐั_ะทะพะฝั"):
            ัะตะท = st.session_state.ัะตะทัะปััะฐั_ะทะพะฝั
            ะทะพะฝะฐ = ัะตะท["ะทะพะฝะฐ"]
            emoji = {"ะทะตะปัะฝะฐั": "๐ข", "ะถัะปัะฐั": "๐ก", "ะบัะฐัะฝะฐั": "๐ด"}.get(ะทะพะฝะฐ, "โช")
            ะฝะฐะทะฒะฐะฝะธะต = {"ะทะตะปัะฝะฐั": "ะะะะะะะฏ ะะะะ", "ะถัะปัะฐั": "ะะะะขะะฏ ะะะะ", "ะบัะฐัะฝะฐั": "ะะะะกะะะฏ ะะะะ"}.get(ะทะพะฝะฐ, "")
            
            st.markdown(f'''<div class="zone-card {ะทะพะฝะฐ}">
                <h3 style="margin:0;">{emoji} {ะฝะฐะทะฒะฐะฝะธะต}</h3>
                <p style="margin:8px 0;">{ัะตะท["ะฟัะธัะธะฝะฐ"]}</p>
                <p style="margin:0;"><strong>ะขัะตะฑัะตััั ะฎะ:</strong> {"ะะฐ" if ัะตะท["ััะตะฑัะตััั_ัะด"] else "ะะตั"} | <strong>ะกัะพะบ:</strong> {ัะตะท["ััะพะบ"]} ะดะฝ.</p>
            </div>''', unsafe_allow_html=True)
        
        # RAG ัะตะทัะปััะฐัั
        if st.session_state.get("ัะตะทัะปััะฐั_rag"):
            ะฟะพะบะฐะทะฐัั_ัะตะทัะปััะฐัั_rag()
        
        # AI ัะตะทัะปััะฐัั
        if st.session_state.get("ัะตะทัะปััะฐั_ai"):
            st.markdown("---")
            st.markdown("### ๐ค ะญะบัะฟะตััะฝะพะต ะทะฐะบะปััะตะฝะธะต AI")
            st.markdown(f'<div class="ai-result">{st.session_state.ัะตะทัะปััะฐั_ai}</div>', unsafe_allow_html=True)


def ะฟะพะบะฐะทะฐัั_ัะตะทัะปััะฐัั_rag():
    """ะัะพะฑัะฐะถะตะฝะธะต ัะตะทัะปััะฐัะพะฒ RAG ะฑะตะท ะบะพะดะฐ"""
    ัะตะท = st.session_state.ัะตะทัะปััะฐั_rag
    
    st.markdown("---")
    st.markdown(f"### ๐ ะะตะทัะปััะฐัั RAG-ัะปะธัะตะฝะธั: {ัะตะท.get('ะฝะฐะทะฒะฐะฝะธะต_ัั', '')}")
    
    # ะะตััะธะบะธ
    c1, c2, c3, c4 = st.columns(4)
    
    ัะพะพัะฒ = ัะตะท.get("ัะพะพัะฒะตัััะฒะธะต", 0)
    ัะฒะตั = "#28a745" if ัะพะพัะฒ >= 70 else ("#f0ad4e" if ัะพะพัะฒ >= 50 else "#dc3545")
    
    with c1:
        st.markdown(f'''<div class="metric-box">
            <div class="metric-value" style="color:{ัะฒะตั};">{ัะพะพัะฒ:.0f}%</div>
            <div class="metric-label">ะกะพะพัะฒะตัััะฒะธะต ะขะค</div>
        </div>''', unsafe_allow_html=True)
    
    with c2:
        st.markdown(f'''<div class="metric-box">
            <div class="metric-value" style="color:#dc3545;">{ัะตะท.get("ะบัะฐัะฝัั", 0)}</div>
            <div class="metric-label">๐ด ะัะธัะธัะตัะบะธั</div>
        </div>''', unsafe_allow_html=True)
    
    with c3:
        st.markdown(f'''<div class="metric-box">
            <div class="metric-value" style="color:#f0ad4e;">{ัะตะท.get("ะถัะปััั", 0)}</div>
            <div class="metric-label">๐ก ะะฐะผะตัะฐะฝะธะน</div>
        </div>''', unsafe_allow_html=True)
    
    with c4:
        ัะฐะทะด = ัะตะท.get("ัะฐะทะดะตะปั", {})
        ะฝะฐะนะด = len(ัะฐะทะด.get("ะฝะฐะนะดะตะฝะฝัะต", []))
        ะฒัะตะณะพ = ะฝะฐะนะด + len(ัะฐะทะด.get("ะพััััััะฒัััะธะต", []))
        st.markdown(f'''<div class="metric-box">
            <div class="metric-value" style="color:#28a745;">{ะฝะฐะนะด}/{ะฒัะตะณะพ}</div>
            <div class="metric-label">โ ะะฐะทะดะตะปะพะฒ</div>
        </div>''', unsafe_allow_html=True)
    
    # ะะตัะดะธะบั
    st.markdown(f"**{ัะตะท.get('ัะตะทัะผะต', '')}**")
    
    # ะะฐัััะตะฝะธั
    ะฝะฐัััะตะฝะธั = ัะตะท.get("ะฝะฐัััะตะฝะธั", [])
    ะบัะฐัะฝัะต = [ะฝ for ะฝ in ะฝะฐัััะตะฝะธั if ะฝ["ะบัะธัะธัะฝะพััั"] == "ะบัะฐัะฝัะน"]
    ะถัะปััะต = [ะฝ for ะฝ in ะฝะฐัััะตะฝะธั if ะฝ["ะบัะธัะธัะฝะพััั"] == "ะถัะปััะน"]
    
    if ะบัะฐัะฝัะต:
        st.markdown("#### ๐ด ะัะธัะธัะตัะบะธะต ะฝะตัะพะพัะฒะตัััะฒะธั ะขะค")
        for ะฝ in ะบัะฐัะฝัะต:
            ะฟัะฝะบั = f"**ะัะฝะบั {ะฝ['ะฟัะฝะบั_ะดะพะณะพะฒะพัะฐ']}**" if ะฝ.get('ะฟัะฝะบั_ะดะพะณะพะฒะพัะฐ') else ""
            st.markdown(f'''<div class="risk-card red">
                {ะฟัะฝะบั}<br>
                <strong>โ ะัะพะฑะปะตะผะฐ:</strong> ะะฐะนะดะตะฝะพ ััะปะพะฒะธะต, ะฟัะพัะธะฒะพัะตัะฐัะตะต ะขะค<br>
                <em>"{ะฝ.get('ะบะพะฝัะตะบัั', '')[:200]}"</em><br><br>
                <strong>โ ะญัะฐะปะพะฝ ะขะค:</strong> {ะฝ.get('ััะฐะปะพะฝ', '')}<br>
                <strong>โก๏ธ ะะตะบะพะผะตะฝะดะฐัะธั:</strong> {ะฝ.get('ัะตะบะพะผะตะฝะดะฐัะธั', '')}
            </div>''', unsafe_allow_html=True)
    
    if ะถัะปััะต:
        with st.expander(f"๐ก ะะฐะผะตัะฐะฝะธั ({len(ะถัะปััะต)})"):
            for ะฝ in ะถัะปััะต:
                ะฟัะฝะบั = f"**ะัะฝะบั {ะฝ['ะฟัะฝะบั_ะดะพะณะพะฒะพัะฐ']}** โ " if ะฝ.get('ะฟัะฝะบั_ะดะพะณะพะฒะพัะฐ') else ""
                st.markdown(f'''<div class="risk-card yellow">
                    {ะฟัะฝะบั}<strong>โก {ะฝ.get('ััะฐะปะพะฝ', '')}</strong><br>
                    <small>ะะฐะนะดะตะฝะพ: {ะฝ.get('ะบะพะฝัะตะบัั', '')[:150]}</small><br>
                    <strong>โก๏ธ</strong> {ะฝ.get('ัะตะบะพะผะตะฝะดะฐัะธั', '')}
                </div>''', unsafe_allow_html=True)
    
    # ะััััััะฒัััะธะต ัะฐะทะดะตะปั
    ัะฐะทะดะตะปั = ัะตะท.get("ัะฐะทะดะตะปั", {})
    ะพััััััะฒ = ัะฐะทะดะตะปั.get("ะพััััััะฒัััะธะต", [])
    if ะพััััััะฒ:
        with st.expander(f"๐ ะััััััะฒัััะธะต ัะฐะทะดะตะปั ({len(ะพััััััะฒ)})"):
            for ั in ะพััััััะฒ:
                st.markdown(f"- โ๏ธ **{ั}**")

# ============================================================================
# ะะะะะะะ ะะขะงะะขะะ
# ============================================================================

def ะฒะบะปะฐะดะบะฐ_ะพััััะพะฒ():
    st.markdown("### ๐ ะััััั")
    
    if not st.session_state.get("ัะตะทัะปััะฐั_ะทะพะฝั") and not st.session_state.get("ัะตะทัะปััะฐั_rag"):
        st.info("โน๏ธ ะกะฝะฐัะฐะปะฐ ะฒัะฟะพะปะฝะธัะต ะฐะฝะฐะปะธะท ะดะพะณะพะฒะพัะฐ")
        return
    
    ะดะฐะฝะฝัะต = st.session_state.get("ัะตะบััะธะต_ะดะฐะฝะฝัะต", {})
    ะทะพะฝะฐ = st.session_state.get("ัะตะทัะปััะฐั_ะทะพะฝั", {})
    rag = st.session_state.get("ัะตะทัะปััะฐั_rag", {})
    
    c1, c2 = st.columns(2)
    with c1:
        st.markdown(f"""
**ะะพะฝััะฐะณะตะฝั:** {ะดะฐะฝะฝัะต.get('ะบะพะฝััะฐะณะตะฝั', 'ะ/ะ')}  
**ะะพะผะตั:** {ะดะฐะฝะฝัะต.get('ะฝะพะผะตั', 'ะ/ะ')}  
**ะกัะผะผะฐ:** {ะดะฐะฝะฝัะต.get('ััะผะผะฐ', 0):,.0f} โฝ
        """)
    with c2:
        emoji = {"ะทะตะปัะฝะฐั": "๐ข", "ะถัะปัะฐั": "๐ก", "ะบัะฐัะฝะฐั": "๐ด"}.get(ะทะพะฝะฐ.get('ะทะพะฝะฐ', ''), "โช")
        st.markdown(f"""
**ะะพะฝะฐ:** {emoji} {ะทะพะฝะฐ.get('ะทะพะฝะฐ', 'ะ/ะ').upper()}  
**ะกะพะพัะฒะตัััะฒะธะต ะขะค:** {rag.get('ัะพะพัะฒะตัััะฒะธะต', 0):.0f}%  
**ะะฐัััะตะฝะธะน:** ๐ด {rag.get('ะบัะฐัะฝัั', 0)} / ๐ก {rag.get('ะถัะปััั', 0)}
        """)
    
    if st.button("๐พ ะกะพััะฐะฝะธัั ะฒ ะธััะพัะธั", use_container_width=True):
        ะดะพะฑะฐะฒะธัั_ะฒ_ะธััะพัะธั({
            "ะบะพะฝััะฐะณะตะฝั": ะดะฐะฝะฝัะต.get('ะบะพะฝััะฐะณะตะฝั', ''),
            "ะฝะพะผะตั": ะดะฐะฝะฝัะต.get('ะฝะพะผะตั', ''),
            "ััะผะผะฐ": ะดะฐะฝะฝัะต.get('ััะผะผะฐ', 0),
            "ะทะพะฝะฐ": ะทะพะฝะฐ.get('ะทะพะฝะฐ', ''),
            "ัะพะพัะฒะตัััะฒะธะต": rag.get('ัะพะพัะฒะตัััะฒะธะต', 0),
            "ะบัะฐัะฝัั": rag.get('ะบัะฐัะฝัั', 0),
            "ะถัะปััั": rag.get('ะถัะปััั', 0),
        })
        st.success("โ ะกะพััะฐะฝะตะฝะพ!")


# ============================================================================
# ะะะะะะะ ะะกะขะะะะ
# ============================================================================

def ะฒะบะปะฐะดะบะฐ_ะธััะพัะธะธ():
    st.markdown("### ๐ ะััะพัะธั")
    
    ะธััะพัะธั = st.session_state.get("ะธััะพัะธั", [])
    
    if not ะธััะพัะธั:
        st.info("ะััะพัะธั ะฟัััะฐ")
        return
    
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("๐ ะัะตะณะพ", len(ะธััะพัะธั))
    c2.metric("๐ข", sum(1 for h in ะธััะพัะธั if h.get('ะทะพะฝะฐ') == 'ะทะตะปัะฝะฐั'))
    c3.metric("๐ก", sum(1 for h in ะธััะพัะธั if h.get('ะทะพะฝะฐ') == 'ะถัะปัะฐั'))
    c4.metric("๐ด", sum(1 for h in ะธััะพัะธั if h.get('ะทะพะฝะฐ') == 'ะบัะฐัะฝะฐั'))
    
    st.markdown("---")
    
    for ะท in ะธััะพัะธั:
        emoji = {"ะทะตะปัะฝะฐั": "๐ข", "ะถัะปัะฐั": "๐ก", "ะบัะฐัะฝะฐั": "๐ด"}.get(ะท.get("ะทะพะฝะฐ", ""), "โช")
        with st.expander(f"{emoji} {ะท.get('ะบะพะฝััะฐะณะตะฝั', 'ะ/ะ')} | {ะท.get('ะดะฐัะฐ', '')}"):
            st.markdown(f"""
**ะะพะผะตั:** {ะท.get('ะฝะพะผะตั', 'ะ/ะ')}  
**ะกัะผะผะฐ:** {ะท.get('ััะผะผะฐ', 0):,.0f} โฝ  
**ะกะพะพัะฒะตัััะฒะธะต ะขะค:** {ะท.get('ัะพะพัะฒะตัััะฒะธะต', 0):.0f}%  
**ะะฐัััะตะฝะธะน:** ๐ด {ะท.get('ะบัะฐัะฝัั', 0)} / ๐ก {ะท.get('ะถัะปััั', 0)}
            """)
    
    if st.button("๐๏ธ ะัะธััะธัั"):
        st.session_state.ะธััะพัะธั = []
        st.rerun()


# ============================================================================
# ะะะะะะะ ะะะกะขะะะะ
# ============================================================================

def ะฒะบะปะฐะดะบะฐ_ะฝะฐัััะพะตะบ():
    st.markdown("### โ๏ธ ะะฐัััะพะนะบะธ")
    st.success("๐ ะะตะถะธะผ ะฐะดะผะธะฝะธัััะฐัะพัะฐ")
    
    tabs = st.tabs(["๐ข ะัะณะฐะฝะธะทะฐัะธั", "๐ ะะพัะพะณะธ", "๐ API-ะบะปััะธ", "๐ ะขะธะฟะพะฒัะต ัะพัะผั"])
    
    # ะัะณะฐะฝะธะทะฐัะธั
    with tabs[0]:
        st.markdown("#### ๐ข ะะตะบะฒะธะทะธัั")
        ะพัะณ = st.session_state.get("ะพัะณ", DEFAULT_ORG_CONFIG)
        
        c1, c2 = st.columns(2)
        with c1:
            new_full = st.text_input("ะะพะปะฝะพะต ะฝะฐะธะผะตะฝะพะฒะฐะฝะธะต", value=ะพัะณ.get("full_name", ""))
            new_short = st.text_input("ะัะฐัะบะพะต", value=ะพัะณ.get("short_name", ""))
            new_inn = st.text_input("ะะะ", value=ะพัะณ.get("inn", ""))
        with c2:
            new_kpp = st.text_input("ะะะ", value=ะพัะณ.get("kpp", ""))
            new_dir = st.text_input("ะะธัะตะบัะพั", value=ะพัะณ.get("director_name", ""))
            new_pos = st.text_input("ะะพะปะถะฝะพััั", value=ะพัะณ.get("director_position", ""))
        
        if st.button("๐พ ะกะพััะฐะฝะธัั", key="save_org"):
            st.session_state.ะพัะณ = {"full_name": new_full, "short_name": new_short, "inn": new_inn, "kpp": new_kpp, "director_name": new_dir, "director_position": new_pos}
            st.success("โ ะกะพััะฐะฝะตะฝะพ!")
    
    # ะะพัะพะณะธ
    with tabs[1]:
        st.markdown("#### ๐ ะะพัะพะณะธ")
        ะฟะพัะพะณะธ = st.session_state.get("ะฟะพัะพะณะธ", DEFAULT_THRESHOLDS)
        
        c1, c2 = st.columns(2)
        with c1:
            new_tf = st.number_input("๐ข ะขะค ะผะฐะบั (โฝ)", value=ะฟะพัะพะณะธ.get("ะทะตะปัะฝะฐั_ัั_ะผะฐะบั", 100000), step=10000)
            new_ntf = st.number_input("๐ข ะะตัะธะฟะพะฒะฐั ะผะฐะบั (โฝ)", value=ะฟะพัะพะณะธ.get("ะทะตะปัะฝะฐั_ะฝะตัั_ะผะฐะบั", 50000), step=10000)
        with c2:
            new_yellow = st.number_input("๐กโ๐ด ะะพัะพะณ (โฝ)", value=ะฟะพัะพะณะธ.get("ะถัะปัะฐั_ะผะฐะบั", 5000000), step=100000)
        
        if st.button("๐พ ะกะพััะฐะฝะธัั", key="save_thresh"):
            st.session_state.ะฟะพัะพะณะธ = {"ะทะตะปัะฝะฐั_ัั_ะผะฐะบั": new_tf, "ะทะตะปัะฝะฐั_ะฝะตัั_ะผะฐะบั": new_ntf, "ะถัะปัะฐั_ะผะฐะบั": new_yellow, "ัะตะฝะดะตั_ะบัะฐัะฝะฐั": ะฟะพัะพะณะธ.get("ัะตะฝะดะตั_ะบัะฐัะฝะฐั", 3000000), "ะตะดะธะฝััะฒ_ะฟะพััะฐะฒัะธะบ": ะฟะพัะพะณะธ.get("ะตะดะธะฝััะฒ_ะฟะพััะฐะฒัะธะบ", 100000)}
            st.success("โ ะกะพััะฐะฝะตะฝะพ!")
    
    # API
    with tabs[2]:
        st.markdown("#### ๐ API-ะบะปััะธ")
        st.info("ะะพะฑะฐะฒััะต ะบะปัั ะดะปั AI-ะฐะฝะฐะปะธะทะฐ")
        
        api = st.session_state.get("api_ะบะปััะธ", {})
        
        for pid, info in AI_ะะะะะะะะะะซ.items():
            st.markdown(f"**{info['ะฝะฐะทะฒะฐะฝะธะต']}**")
            st.caption(f"๐ [{info['url_keys']}]({info['url_keys']}) โ {info['ัะตะฝะฐ']}")
            
            c1, c2 = st.columns([4, 1])
            with c1:
                ะฝะพะฒัะน = st.text_input(f"ะะปัั {pid}", type="password", value=api.get(pid, ""), key=f"api_{pid}", label_visibility="collapsed")
                if ะฝะพะฒัะน != api.get(pid, ""):
                    st.session_state.api_ะบะปััะธ[pid] = ะฝะพะฒัะน
            with c2:
                if api.get(pid):
                    if st.button("๐", key=f"test_{pid}"):
                        ok, msg, _ = AIะะปะธะตะฝั.ะฟัะพะฒะตัะธัั_ัะพะตะดะธะฝะตะฝะธะต(pid, api[pid], st.session_state.get("yandex_folder", ""))
                        if ok:
                            st.success(msg)
                        else:
                            st.error(msg)
            st.markdown("---")
        
        st.text_input("YandexGPT Folder ID", value=st.session_state.get("yandex_folder", ""), key="yf_input", on_change=lambda: setattr(st.session_state, "yandex_folder", st.session_state.yf_input))
    
    # ะขะธะฟะพะฒัะต ัะพัะผั
    with tabs[3]:
        st.markdown("#### ๐ ะขะธะฟะพะฒัะต ัะพัะผั")
        
        st.markdown("**ะกะธััะตะผะฝัะต:**")
        for ะบะพะด, ัั in ะขะะะะะซะ_ะคะะะะซ.items():
            with st.expander(f"โช {ัั['ะฝะฐะทะฒะฐะฝะธะต']}"):
                st.markdown(f"ะะพะด: {ัั['ะบะพะด']} | ะะพะปั: {ัั['ะฝะฐัะฐ_ัะพะปั']}")
                st.markdown(f"ะญัะฐะปะพะฝะฝัั ะฟัะฝะบัะพะฒ: {len(ัั.get('ััะฐะปะพะฝะฝัะต_ะฟัะฝะบัั', {}))}")
        
        st.markdown("---")
        st.markdown("**ะะพะปัะทะพะฒะฐัะตะปััะบะธะต:**")
        user_tf = st.session_state.get("ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต_ัั", {})
        if user_tf:
            for ะบะพะด, ัั in list(user_tf.items()):
                c1, c2 = st.columns([4, 1])
                with c1:
                    st.markdown(f"๐ต {ัั.get('ะฝะฐะทะฒะฐะฝะธะต', ะบะพะด)}")
                with c2:
                    if st.button("๐๏ธ", key=f"del_{ะบะพะด}"):
                        del st.session_state.ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต_ัั[ะบะพะด]
                        st.rerun()
        else:
            st.info("ะะตั ะฟะพะปัะทะพะฒะฐัะตะปััะบะธั ัะพัะผ")


# ============================================================================
# ะะะะะะะฏ
# ============================================================================

def ะณะปะฐะฒะฝะฐั():
    ะพัะณ = st.session_state.get("ะพัะณ", DEFAULT_ORG_CONFIG)
    is_admin = ััะพ_ะฐะดะผะธะฝ()
    
    st.markdown(f'''
    <div class="main-header">
        <div class="traffic-light"><span class="tl-red"></span><span class="tl-yellow"></span><span class="tl-green"></span></div>
        <h2 style="margin:0;">๐ฆ ะะตะณะปะฐะผะตะฝั ะกะฒะตัะพัะพั <small style="opacity:0.7;">v7.6</small></h2>
        <div style="opacity:0.9;">{ะพัะณ.get("short_name", "ะะ ยซะกะะยป")}</div>
    </div>
    ''', unsafe_allow_html=True)
    
    ะฑะพะบะพะฒะฐั_ะฟะฐะฝะตะปั()
    
    if is_admin:
        tabs = st.tabs(["๐ ะะฝะฐะปะธะท", "๐ ะััััั", "๐ ะััะพัะธั", "โ๏ธ ะะฐัััะพะนะบะธ"])
        with tabs[0]:
            ะฒะบะปะฐะดะบะฐ_ะฐะฝะฐะปะธะทะฐ()
        with tabs[1]:
            ะฒะบะปะฐะดะบะฐ_ะพััััะพะฒ()
        with tabs[2]:
            ะฒะบะปะฐะดะบะฐ_ะธััะพัะธะธ()
        with tabs[3]:
            ะฒะบะปะฐะดะบะฐ_ะฝะฐัััะพะตะบ()
    else:
        tabs = st.tabs(["๐ ะะฝะฐะปะธะท", "๐ ะััััั", "๐ ะััะพัะธั"])
        with tabs[0]:
            ะฒะบะปะฐะดะบะฐ_ะฐะฝะฐะปะธะทะฐ()
        with tabs[1]:
            ะฒะบะปะฐะดะบะฐ_ะพััััะพะฒ()
        with tabs[2]:
            ะฒะบะปะฐะดะบะฐ_ะธััะพัะธะธ()


def main():
    ะฟัะธะผะตะฝะธัั_ััะธะปะธ()
    ะธะฝะธัะธะฐะปะธะทะฐัะธั()
    
    if not st.session_state.ะฐะฒัะพัะธะทะพะฒะฐะฝ:
        ัััะฐะฝะธัะฐ_ะฒัะพะดะฐ()
    else:
        ะณะปะฐะฒะฝะฐั()


if __name__ == "__main__":
    main()
