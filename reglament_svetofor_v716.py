"""
–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.16
–ê–û ¬´–°–ü–ö¬ª ‚Äî AI-–∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ + –û–±–ª–∞—á–Ω—ã–π OCR

–ù–û–í–û–ï –í v7.16:
1. AI-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ª—é–±—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–Ω–µ —Ç–æ–ª—å–∫–æ –¥–æ–≥–æ–≤–æ—Ä—ã)
2. AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø—Ä–∞–≤–∫—É –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ
3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Ñ–∞–π–ª
4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
5. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (50+)
6. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω —á–µ—Ä–µ–∑ AI
7. –ü–æ–ª–Ω–∞—è AI-—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –∏ —Å–ª–∏—á–µ–Ω–∏–µ
"""

import os
os.environ["STREAMLIT_SERVER_FILE_WATCHER_TYPE"] = "none"

import streamlit as st
import re, json, hashlib, io, time, base64
from datetime import datetime, date
from typing import Dict, List, Tuple, Optional, Any
from dataclasses import dataclass, asdict
from pathlib import Path

# ============================================================================
# –ë–ò–ë–õ–ò–û–¢–ï–ö–ò
# ============================================================================

DOCX_AVAILABLE = False
PDF_AVAILABLE = False
REQUESTS_AVAILABLE = False
PIL_AVAILABLE = False

try:
    from docx import Document as DocxDocument
    DOCX_AVAILABLE = True
except ImportError:
    pass

try:
    from PyPDF2 import PdfReader
    PDF_AVAILABLE = True
except ImportError:
    pass

try:
    import requests
    REQUESTS_AVAILABLE = True
except ImportError:
    pass

try:
    from PIL import Image
    PIL_AVAILABLE = True
except ImportError:
    pass

IMAGE_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.tiff', '.tif', '.bmp', '.gif', '.webp']

try:
    st.set_page_config(page_title="–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.16 | –°–ü–ö", page_icon="üö¶", layout="wide")
except:
    pass

# ============================================================================
# –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================================

CONFIG_FILE = "svetofor_config.json"
HISTORY_FILE = "svetofor_history.json"

DEFAULT_ORG = {
    "full_name": "–ê–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ ¬´–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ü–ö¬ª",
    "short_name": "–ê–û ¬´–°–ü–ö¬ª",
    "inn": "7712345678"
}

DEFAULT_THRESHOLDS = {
    "–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å": 100_000,
    "–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å": 50_000,
    "–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å": 5_000_000
}

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
AI_–ü–†–û–í–ê–ô–î–ï–†–´ = {
    "openai": {
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "OpenAI GPT-4",
        "url": "https://platform.openai.com/api-keys",
        "model": "gpt-4o-mini"
    },
    "anthropic": {
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "Anthropic Claude",
        "url": "https://console.anthropic.com/settings/keys",
        "model": "claude-3-haiku-20240307"
    },
    "yandexgpt": {
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "YandexGPT",
        "url": "https://console.cloud.yandex.ru/",
        "model": "yandexgpt-lite"
    },
    "perplexity": {
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "Perplexity AI",
        "url": "https://www.perplexity.ai/settings/api",
        "model": "llama-3.1-sonar-small-128k-online"
    },
}

# ============================================================================
# –†–ê–°–®–ò–†–ï–ù–ù–´–ï –¢–ò–ü–´ –î–û–ö–£–ú–ï–ù–¢–û–í (50+)
# ============================================================================

–¢–ò–ü–´_–î–û–ö–£–ú–ï–ù–¢–û–í = {
    # === –î–û–ì–û–í–û–†–´ ===
    "–¥–æ–≥–æ–≤–æ—Ä—ã": {
        "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏": ["–ø–æ—Å—Ç–∞–≤–∫", "–ø–æ—Å—Ç–∞–≤—â–∏–∫", "–ø–æ–∫—É–ø–∞—Ç–µ–ª—å", "—Ç–æ–≤–∞—Ä", "–ø–∞—Ä—Ç–∏—è"],
        "–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏": ["–∫—É–ø–ª", "–ø—Ä–æ–¥–∞–∂", "–ø—Ä–æ–¥–∞–≤–µ—Ü", "–ø–æ–∫—É–ø–∞—Ç–µ–ª—å"],
        "–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã": ["–∞—Ä–µ–Ω–¥", "–∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å", "–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä", "–∞—Ä–µ–Ω–¥–Ω–∞—è –ø–ª–∞—Ç–∞"],
        "–î–æ–≥–æ–≤–æ—Ä –ª–∏–∑–∏–Ω–≥–∞": ["–ª–∏–∑–∏–Ω–≥", "–ª–∏–∑–∏–Ω–≥–æ–¥–∞—Ç–µ–ª—å", "–ª–∏–∑–∏–Ω–≥–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å"],
        "–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞": ["–ø–æ–¥—Ä—è–¥", "–ø–æ–¥—Ä—è–¥—á–∏–∫", "–∑–∞–∫–∞–∑—á–∏–∫", "—Ä–∞–±–æ—Ç—ã"],
        "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥": ["—É—Å–ª—É–≥", "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–∑–∞–∫–∞–∑—á–∏–∫"],
        "–î–æ–≥–æ–≤–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–∫–∏": ["–ø–µ—Ä–µ–≤–æ–∑", "–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫", "–≥—Ä—É–∑", "–≥—Ä—É–∑–æ–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å"],
        "–î–æ–≥–æ–≤–æ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏": ["—ç–∫—Å–ø–µ–¥–∏—Ü", "—ç–∫—Å–ø–µ–¥–∏—Ç–æ—Ä", "–∫–ª–∏–µ–Ω—Ç"],
        "–î–æ–≥–æ–≤–æ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è": ["—Ö—Ä–∞–Ω–µ–Ω", "—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å", "–ø–æ–∫–ª–∞–∂–µ–¥–∞—Ç–µ–ª—å"],
        "–î–æ–≥–æ–≤–æ—Ä –∫–æ–º–∏—Å—Å–∏–∏": ["–∫–æ–º–∏—Å—Å–∏", "–∫–æ–º–∏—Å—Å–∏–æ–Ω–µ—Ä", "–∫–æ–º–∏—Ç–µ–Ω—Ç"],
        "–î–æ–≥–æ–≤–æ—Ä –∞–≥–µ–Ω—Ç—Å–∫–∏–π": ["–∞–≥–µ–Ω—Ç", "–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª", "–∞–≥–µ–Ω—Ç—Å–∫–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ"],
        "–î–æ–≥–æ–≤–æ—Ä –∑–∞–π–º–∞": ["–∑–∞–π–º", "–∑–∞—ë–º—â–∏–∫", "–∑–∞–π–º–æ–¥–∞–≤–µ—Ü", "–ø—Ä–æ—Ü–µ–Ω—Ç"],
        "–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä": ["–∫—Ä–µ–¥–∏—Ç", "–∫—Ä–µ–¥–∏—Ç–æ—Ä", "–∑–∞—ë–º—â–∏–∫", "–±–∞–Ω–∫"],
        "–î–æ–≥–æ–≤–æ—Ä –∑–∞–ª–æ–≥–∞": ["–∑–∞–ª–æ–≥", "–∑–∞–ª–æ–≥–æ–¥–∞—Ç–µ–ª—å", "–∑–∞–ª–æ–≥–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å"],
        "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Ä—É—á–∏—Ç–µ–ª—å—Å—Ç–≤–∞": ["–ø–æ—Ä—É—á–∏—Ç–µ–ª—å—Å—Ç–≤", "–ø–æ—Ä—É—á–∏—Ç–µ–ª—å", "–¥–æ–ª–∂–Ω–∏–∫"],
        "–î–æ–≥–æ–≤–æ—Ä —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è": ["—Å—Ç—Ä–∞—Ö–æ–≤", "—Å—Ç—Ä–∞—Ö–æ–≤—â–∏–∫", "—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç–µ–ª—å", "–ø—Ä–µ–º–∏—è"],
        "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä": ["–ª–∏—Ü–µ–Ω–∑–∏", "–ª–∏—Ü–µ–Ω–∑–∏–∞—Ä", "–ª–∏—Ü–µ–Ω–∑–∏–∞—Ç", "—Ä–æ—è–ª—Ç–∏"],
        "–î–æ–≥–æ–≤–æ—Ä —Ñ—Ä–∞–Ω—á–∞–π–∑–∏–Ω–≥–∞": ["—Ñ—Ä–∞–Ω—á–∞–π–∑", "—Ñ—Ä–∞–Ω—á–∞–π–∑–µ—Ä", "—Ñ—Ä–∞–Ω—á–∞–π–∑–∏"],
        "–î–æ–≥–æ–≤–æ—Ä —Ü–µ—Å—Å–∏–∏": ["—Ü–µ—Å—Å–∏", "—Ü–µ–¥–µ–Ω—Ç", "—Ü–µ—Å—Å–∏–æ–Ω–∞—Ä–∏–π", "—É—Å—Ç—É–ø–∫–∞"],
        "–î–æ–≥–æ–≤–æ—Ä —Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞": ["—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥", "—Ñ–∞–∫—Ç–æ—Ä", "–∫–ª–∏–µ–Ω—Ç"],
        "–î–æ–≥–æ–≤–æ—Ä –æ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏": ["—Å–æ–≤–º–µ—Å—Ç–Ω", "—É—á–∞—Å—Ç–Ω–∏–∫–∏", "–≤–∫–ª–∞–¥—ã"],
        "–£—á—Ä–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä": ["—É—á—Ä–µ–¥–∏—Ç–µ–ª", "—É—á—Ä–µ–¥–∏—Ç–µ–ª–∏", "—É—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª"],
        "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä": ["—Ç—Ä—É–¥–æ–≤", "—Ä–∞–±–æ—Ç–Ω–∏–∫", "—Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å", "–∑–∞—Ä–ø–ª–∞—Ç–∞"],
        "–î–æ–≥–æ–≤–æ—Ä –ì–ü–•": ["–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤", "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–∑–∞–∫–∞–∑—á–∏–∫"],
        "–î–æ–≥–æ–≤–æ—Ä NDA": ["–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω", "nda", "–Ω–µ—Ä–∞–∑–≥–ª–∞—à–µ–Ω", "—Å–µ–∫—Ä–µ—Ç"],
        "–†–∞–º–æ—á–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä": ["—Ä–∞–º–æ—á–Ω", "–æ–±—â–∏–µ —É—Å–ª–æ–≤–∏—è", "–∑–∞—è–≤–∫–∏"],
    },
    
    # === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–û–ì–õ–ê–®–ï–ù–ò–Ø ===
    "–¥–æ–ø—Å–æ–≥–ª–∞—à–µ–Ω–∏—è": {
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ": ["–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–¥–æ–ø—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ –¥–æ–≥–æ–≤–æ—Ä—É"],
        "–ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π": ["–ø—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π", "—Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è"],
        "–ü—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è": ["–ø—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è", "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã"],
    },
    
    # === –ü–ï–†–í–ò–ß–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´ ===
    "–ø–µ—Ä–≤–∏—á–∫–∞": {
        "–°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É": ["—Å—á—ë—Ç", "—Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É", "–∫ –æ–ø–ª–∞—Ç–µ", "–∏—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ"],
        "–°—á—ë—Ç-—Ñ–∞–∫—Ç—É—Ä–∞": ["—Å—á—ë—Ç-—Ñ–∞–∫—Ç—É—Ä–∞", "—Å—á–µ—Ç-—Ñ–∞–∫—Ç—É—Ä–∞", "–Ω–¥—Å", "–Ω–∞–ª–æ–≥"],
        "–£–ü–î": ["—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã–π", "—É–ø–¥", "—Å—Ç–∞—Ç—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞"],
        "–¢–æ–≤–∞—Ä–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è (–¢–û–†–ì-12)": ["—Ç–æ—Ä–≥-12", "—Ç–æ–≤–∞—Ä–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è", "–≥—Ä—É–∑–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å"],
        "–¢–¢–ù": ["—Ç–æ–≤–∞—Ä–Ω–æ-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è", "—Ç—Ç–Ω", "–≤–æ–¥–∏—Ç–µ–ª—å", "–∞–≤—Ç–æ–º–æ–±–∏–ª—å"],
        "–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç": ["–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö", "–∞–∫—Ç —Å–¥–∞—á–∏-–ø—Ä–∏—ë–º–∫–∏", "—Ä–∞–±–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"],
        "–ê–∫—Ç –æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥": ["–∞–∫—Ç –æ–∫–∞–∑–∞–Ω–Ω—ã—Ö", "—É—Å–ª—É–≥–∏ –æ–∫–∞–∑–∞–Ω—ã"],
        "–ê–∫—Ç —Å–≤–µ—Ä–∫–∏": ["–∞–∫—Ç —Å–≤–µ—Ä–∫–∏", "–≤–∑–∞–∏–º–æ—Ä–∞—Å—á—ë—Ç", "—Å–∞–ª—å–¥–æ"],
    },
    
    # === –ö–û–†–ü–û–†–ê–¢–ò–í–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´ ===
    "–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ": {
        "–£—Å—Ç–∞–≤": ["—É—Å—Ç–∞–≤", "–æ–±—â–µ—Å—Ç–≤–æ", "—É—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª", "–æ—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"],
        "–ü—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–±—Ä–∞–Ω–∏—è": ["–ø—Ä–æ—Ç–æ–∫–æ–ª", "—Å–æ–±—Ä–∞–Ω–∏–µ", "–ø–æ–≤–µ—Å—Ç–∫–∞ –¥–Ω—è", "–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ"],
        "–†–µ—à–µ–Ω–∏–µ —É—á—Ä–µ–¥–∏—Ç–µ–ª—è": ["—Ä–µ—à–µ–Ω–∏–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ", "—É—á—Ä–µ–¥–∏—Ç–µ–ª—å —Ä–µ—à–∏–ª"],
        "–ü—Ä–∏–∫–∞–∑": ["–ø—Ä–∏–∫–∞–∑", "–ø—Ä–∏–∫–∞–∑—ã–≤–∞—é", "–¥–∏—Ä–µ–∫—Ç–æ—Ä"],
        "–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": ["–¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–¥–æ–≤–µ—Ä—è—é", "–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å", "–ø–æ–ª–Ω–æ–º–æ—á–∏—è"],
        "–ü–æ–ª–æ–∂–µ–Ω–∏–µ": ["–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ", "–Ω–∞—Å—Ç–æ—è—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ", "—Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä—É–µ—Ç"],
        "–†–µ–≥–ª–∞–º–µ–Ω—Ç": ["—Ä–µ–≥–ª–∞–º–µ–Ω—Ç", "–ø–æ—Ä—è–¥–æ–∫", "–ø—Ä–æ—Ü–µ–¥—É—Ä–∞"],
        "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è": ["–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", "–¥–æ–ª–∂–Ω–æ—Å—Ç–Ω–∞—è", "–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏"],
    },
    
    # === –ü–†–ï–¢–ï–ù–ó–ò–û–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´ ===
    "–ø—Ä–µ—Ç–µ–Ω–∑–∏–æ–Ω–Ω—ã–µ": {
        "–ü—Ä–µ—Ç–µ–Ω–∑–∏—è": ["–ø—Ä–µ—Ç–µ–Ω–∑–∏—è", "—Ç—Ä–µ–±—É–µ–º", "–Ω–∞—Ä—É—à–µ–Ω–∏–µ", "—Å—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è"],
        "–û—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é": ["–Ω–∞ –≤–∞—à—É –ø—Ä–µ—Ç–µ–Ω–∑–∏—é", "—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–≤ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é"],
        "–ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ": ["–∏—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ", "–∏—Å—Ç–µ—Ü", "–æ—Ç–≤–µ—Ç—á–∏–∫", "—Å—É–¥"],
        "–û—Ç–∑—ã–≤ –Ω–∞ –∏—Å–∫": ["–æ—Ç–∑—ã–≤ –Ω–∞ –∏—Å–∫–æ–≤–æ–µ", "–≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è"],
        "–ú–∏—Ä–æ–≤–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ": ["–º–∏—Ä–æ–≤–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "—Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å"],
    },
    
    # === –ü–ò–°–¨–ú–ê –ò –ó–ê–Ø–í–õ–ï–ù–ò–Ø ===
    "–ø–∏—Å—å–º–∞": {
        "–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–µ –ø–∏—Å—å–º–æ": ["–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–µ –ø–∏—Å—å–º–æ", "–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º", "–æ–±—è–∑—É–µ–º—Å—è"],
        "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ": ["–∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º", "—Å–æ–æ–±—â–∞–µ–º", "—É–≤–µ–¥–æ–º–ª—è–µ–º"],
        "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ": ["–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", "–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º", "—Ü–µ–Ω—ã"],
        "–ó–∞—è–≤–ª–µ–Ω–∏–µ": ["–∑–∞—è–≤–ª–µ–Ω–∏–µ", "–ø—Ä–æ—à—É", "–∑–∞—è–≤–∏—Ç–µ–ª—å"],
        "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ": ["—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ", "—É–≤–µ–¥–æ–º–ª—è–µ–º", "–Ω–∞—Å—Ç–æ—è—â–∏–º"],
        "–ó–∞–ø—Ä–æ—Å": ["–∑–∞–ø—Ä–æ—Å", "–ø—Ä–æ—Å–∏–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å", "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"],
    },
    
    # === –§–ò–ù–ê–ù–°–û–í–´–ï –î–û–ö–£–ú–ï–ù–¢–´ ===
    "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ": {
        "–ü–ª–∞—Ç—ë–∂–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ": ["–ø–ª–∞—Ç—ë–∂–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ", "–ø–ª–∞—Ç–µ–ª—å—â–∏–∫", "–ø–æ–ª—É—á–∞—Ç–µ–ª—å", "–±–∞–Ω–∫"],
        "–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –≤—ã–ø–∏—Å–∫–∞": ["–≤—ã–ø–∏—Å–∫–∞", "–±–∞–Ω–∫", "–æ—Å—Ç–∞—Ç–æ–∫", "–æ–±–æ—Ä–æ—Ç—ã"],
        "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞": ["–±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞", "—Å–ø—Ä–∞–≤–∫–∞-—Ä–∞—Å—á—ë—Ç"],
        "–ê–≤–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç": ["–∞–≤–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç", "–ø–æ–¥–æ—Ç—á—ë—Ç–Ω–æ–µ –ª–∏—Ü–æ"],
    },
    
    # === –ö–ê–î–†–û–í–´–ï –î–û–ö–£–ú–ï–ù–¢–´ ===
    "–∫–∞–¥—Ä–æ–≤—ã–µ": {
        "–ó–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–ø—É—Å–∫": ["–æ—Ç–ø—É—Å–∫", "–ø—Ä–æ—à—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å", "–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π"],
        "–ó–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ —É–≤–æ–ª—å–Ω–µ–Ω–∏–µ": ["—É–≤–æ–ª—å–Ω–µ–Ω–∏–µ", "–ø—Ä–æ—à—É —É–≤–æ–ª–∏—Ç—å", "—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∂–µ–ª–∞–Ω–∏–µ"],
        "–¢–∞–±–µ–ª—å —É—á—ë—Ç–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏": ["—Ç–∞–±–µ–ª—å", "—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è", "—è–≤–∫–∏"],
        "–®—Ç–∞—Ç–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ": ["—à—Ç–∞—Ç–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", "–¥–æ–ª–∂–Ω–æ—Å—Ç–∏", "–æ–∫–ª–∞–¥"],
    },
    
    # === –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–û–ö–£–ú–ï–ù–¢–´ ===
    "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ": {
        "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ": ["—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ", "—Ç–∑", "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è", "—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª"],
        "–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è": ["—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è", "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏", "–ø–∞—Ä–∞–º–µ—Ç—Ä—ã"],
        "–ê–∫—Ç –æ—Å–º–æ—Ç—Ä–∞": ["–∞–∫—Ç –æ—Å–º–æ—Ç—Ä–∞", "–æ—Å–º–æ—Ç—Ä", "—Å–æ—Å—Ç–æ—è–Ω–∏–µ"],
        "–î–µ—Ñ–µ–∫—Ç–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å": ["–¥–µ—Ñ–µ–∫—Ç–Ω–∞—è", "–¥–µ—Ñ–µ–∫—Ç—ã", "–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏"],
        "–ü–∞—Å–ø–æ—Ä—Ç –∏–∑–¥–µ–ª–∏—è": ["–ø–∞—Å–ø–æ—Ä—Ç", "–∏–∑–¥–µ–ª–∏–µ", "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"],
    },
}

# –í—Å–µ —Ç–∏–ø—ã –≤ –ø–ª–æ—Å–∫–æ–º —Å–ø–∏—Å–∫–µ
–í–°–ï_–¢–ò–ü–´_–î–û–ö–£–ú–ï–ù–¢–û–í = {}
for –∫–∞—Ç–µ–≥–æ—Ä–∏—è, —Ç–∏–ø—ã in –¢–ò–ü–´_–î–û–ö–£–ú–ï–ù–¢–û–í.items():
    –í–°–ï_–¢–ò–ü–´_–î–û–ö–£–ú–ï–ù–¢–û–í.update(—Ç–∏–ø—ã)

# –¢–∏–ø—ã —Ç—Ä–µ–±—É—é—â–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
–¢–†–ï–ë–£–Æ–¢_–≠–ö–°–ü–ï–†–¢–ò–ó–´ = [
    "–¥–æ–≥–æ–≤–æ—Ä—ã", "–¥–æ–ø—Å–æ–≥–ª–∞—à–µ–Ω–∏—è", "–ø—Ä–µ—Ç–µ–Ω–∑–∏–æ–Ω–Ω—ã–µ", "–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ"
]

# ============================================================================
# –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –ù–ê–°–¢–†–û–ï–ö
# ============================================================================

def get_config_path():
    """–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."""
    return Path.home() / ".svetofor" / CONFIG_FILE

def get_history_path():
    """–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏—Å—Ç–æ—Ä–∏–∏."""
    return Path.home() / ".svetofor" / HISTORY_FILE

def save_config(config: dict):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª."""
    try:
        config_path = get_config_path()
        config_path.parent.mkdir(parents=True, exist_ok=True)
        with open(config_path, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2, default=str)
        return True
    except Exception as e:
        st.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {e}")
        return False

def load_config() -> dict:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞."""
    try:
        config_path = get_config_path()
        if config_path.exists():
            with open(config_path, 'r', encoding='utf-8') as f:
                return json.load(f)
    except Exception:
        pass
    return {}

def save_history(history: list):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–æ–≤."""
    try:
        history_path = get_history_path()
        history_path.parent.mkdir(parents=True, exist_ok=True)
        # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞–ø–∏—Å–µ–π
        with open(history_path, 'w', encoding='utf-8') as f:
            json.dump(history[-100:], f, ensure_ascii=False, indent=2, default=str)
        return True
    except Exception:
        return False

def load_history() -> list:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–æ–≤."""
    try:
        history_path = get_history_path()
        if history_path.exists():
            with open(history_path, 'r', encoding='utf-8') as f:
                return json.load(f)
    except Exception:
        pass
    return []

def init_session_state():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è session_state —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫."""
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    saved_config = load_config()
    
    defaults = {
        "–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω": False,
        "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å": None,
        "—Ä–æ–ª—å": None,
        "–æ—Ä–≥": saved_config.get("–æ—Ä–≥", DEFAULT_ORG),
        "–ø–æ—Ä–æ–≥–∏": saved_config.get("–ø–æ—Ä–æ–≥–∏", DEFAULT_THRESHOLDS),
        "api_–∫–ª—é—á–∏": saved_config.get("api_–∫–ª—é—á–∏", {}),
        "ocr_api": saved_config.get("ocr_api", {}),
        "–∏—Å—Ç–æ—Ä–∏—è": load_history(),
        "—Ç–µ–∫—É—â–∏–π_–∞–Ω–∞–ª–∏–∑": None,
        "uploaded_file_id": None,  # –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    }
    
    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

def save_current_settings():
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫."""
    config = {
        "–æ—Ä–≥": st.session_state.get("–æ—Ä–≥", DEFAULT_ORG),
        "–ø–æ—Ä–æ–≥–∏": st.session_state.get("–ø–æ—Ä–æ–≥–∏", DEFAULT_THRESHOLDS),
        "api_–∫–ª—é—á–∏": st.session_state.get("api_–∫–ª—é—á–∏", {}),
        "ocr_api": st.session_state.get("ocr_api", {}),
    }
    save_config(config)

def add_to_history(–∞–Ω–∞–ª–∏–∑: dict):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é."""
    –∏—Å—Ç–æ—Ä–∏—è = st.session_state.get("–∏—Å—Ç–æ—Ä–∏—è", [])
    –∑–∞–ø–∏—Å—å = {
        "timestamp": datetime.now().isoformat(),
        "filename": –∞–Ω–∞–ª–∏–∑.get("filename", ""),
        "—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞": –∞–Ω–∞–ª–∏–∑.get("—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞", ""),
        "–∑–æ–Ω–∞": –∞–Ω–∞–ª–∏–∑.get("–∑–æ–Ω–∞", ""),
        "–∫—Ä–∞—Ç–∫–æ–µ_–æ–ø–∏—Å–∞–Ω–∏–µ": –∞–Ω–∞–ª–∏–∑.get("–∫—Ä–∞—Ç–∫–æ–µ_–æ–ø–∏—Å–∞–Ω–∏–µ", "")[:200],
    }
    –∏—Å—Ç–æ—Ä–∏—è.append(–∑–∞–ø–∏—Å—å)
    st.session_state.–∏—Å—Ç–æ—Ä–∏—è = –∏—Å—Ç–æ—Ä–∏—è
    save_history(–∏—Å—Ç–æ—Ä–∏—è)

# ============================================================================
# –û–ë–õ–ê–ß–ù–´–ô OCR
# ============================================================================

class CloudOCR:
    """–û–±–ª–∞—á–Ω—ã–π OCR —á–µ—Ä–µ–∑ API."""
    
    @staticmethod
    def yandex_vision_ocr(image_bytes: bytes, api_key: str, folder_id: str) -> Tuple[bool, str]:
        if not REQUESTS_AVAILABLE:
            return False, "requests –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        if not api_key or not folder_id:
            return False, "–ù–µ —É–∫–∞–∑–∞–Ω API –∫–ª—é—á –∏–ª–∏ Folder ID Yandex"
        
        try:
            image_base64 = base64.b64encode(image_bytes).decode('utf-8')
            
            url = "https://ocr.api.cloud.yandex.net/ocr/v1/recognizeText"
            headers = {
                "Authorization": f"Api-Key {api_key}",
                "Content-Type": "application/json",
                "x-folder-id": folder_id
            }
            body = {
                "mimeType": "image",
                "languageCodes": ["ru", "en"],
                "model": "page",
                "content": image_base64
            }
            
            response = requests.post(url, headers=headers, json=body, timeout=30)
            
            if response.status_code == 200:
                result = response.json()
                if "result" in result and "textAnnotation" in result["result"]:
                    text_annotation = result["result"]["textAnnotation"]
                    if "fullText" in text_annotation:
                        return True, text_annotation["fullText"]
                return False, "–¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω"
            else:
                return False, f"–û—à–∏–±–∫–∞ Yandex Vision: {response.status_code}"
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞: {str(e)}"
    
    @staticmethod
    def google_vision_ocr(image_bytes: bytes, api_key: str) -> Tuple[bool, str]:
        if not REQUESTS_AVAILABLE or not api_key:
            return False, "API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω"
        
        try:
            image_base64 = base64.b64encode(image_bytes).decode('utf-8')
            url = f"https://vision.googleapis.com/v1/images:annotate?key={api_key}"
            body = {
                "requests": [{
                    "image": {"content": image_base64},
                    "features": [{"type": "TEXT_DETECTION"}]
                }]
            }
            
            response = requests.post(url, json=body, timeout=30)
            
            if response.status_code == 200:
                result = response.json()
                if "responses" in result and result["responses"]:
                    annotations = result["responses"][0].get("textAnnotations", [])
                    if annotations:
                        return True, annotations[0].get("description", "")
                return False, "–¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω"
            return False, f"–û—à–∏–±–∫–∞: {response.status_code}"
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞: {str(e)}"


class OCRProcessor:
    """–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä OCR."""
    
    @classmethod
    def is_available(cls):
        ocr_api = st.session_state.get("ocr_api", {})
        if ocr_api.get("yandex_vision") and ocr_api.get("yandex_folder"):
            return True, "Yandex Vision ‚úì"
        if ocr_api.get("google_vision"):
            return True, "Google Vision ‚úì"
        return False, "OCR –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    
    @classmethod
    def get_provider(cls):
        ocr_api = st.session_state.get("ocr_api", {})
        if ocr_api.get("yandex_vision") and ocr_api.get("yandex_folder"):
            return "yandex", ocr_api
        if ocr_api.get("google_vision"):
            return "google", ocr_api
        return "", {}
    
    @classmethod
    def ocr_image(cls, image_bytes: bytes) -> Tuple[bool, str]:
        provider, api = cls.get_provider()
        if provider == "yandex":
            return CloudOCR.yandex_vision_ocr(
                image_bytes, api.get("yandex_vision"), api.get("yandex_folder")
            )
        elif provider == "google":
            return CloudOCR.google_vision_ocr(image_bytes, api.get("google_vision"))
        return False, "OCR –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    
    @classmethod
    def get_status(cls):
        available, message = cls.is_available()
        ocr_api = st.session_state.get("ocr_api", {})
        return {
            "available": available,
            "message": message,
            "yandex": bool(ocr_api.get("yandex_vision") and ocr_api.get("yandex_folder")),
            "google": bool(ocr_api.get("google_vision")),
        }

# ============================================================================
# AI –ö–õ–ò–ï–ù–¢ (–£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô)
# ============================================================================

class AIClient:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π AI –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤."""
    
    @classmethod
    def get_provider(cls) -> Tuple[str, str, str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–ø—Ä–æ–≤–∞–π–¥–µ—Ä, –∫–ª—é—á, folder_id)."""
        api = st.session_state.get("api_–∫–ª—é—á–∏", {})
        preferred = api.get("preferred_ai", "")
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–≥–æ
        if preferred and api.get(preferred):
            return preferred, api[preferred], api.get("yandex_folder", "")
        
        # –ê–≤—Ç–æ–≤—ã–±–æ—Ä
        for pid in ["openai", "anthropic", "perplexity", "yandexgpt"]:
            if api.get(pid):
                return pid, api[pid], api.get("yandex_folder", "")
        
        return "", "", ""
    
    @classmethod
    def is_available(cls) -> Tuple[bool, str]:
        provider, key, _ = cls.get_provider()
        if provider and key:
            return True, AI_–ü–†–û–í–ê–ô–î–ï–†–´[provider]["–Ω–∞–∑–≤–∞–Ω–∏–µ"]
        return False, "AI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    
    @classmethod
    def call(cls, prompt: str, max_tokens: int = 4000) -> Tuple[bool, str]:
        """–í—ã–∑–æ–≤ AI API."""
        provider, key, folder_id = cls.get_provider()
        
        if not provider:
            return False, "AI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí AI API"
        
        try:
            if provider == "openai":
                response = requests.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={"Authorization": f"Bearer {key}", "Content-Type": "application/json"},
                    json={
                        "model": "gpt-4o-mini",
                        "messages": [{"role": "user", "content": prompt}],
                        "max_tokens": max_tokens,
                        "temperature": 0.3
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"OpenAI –æ—à–∏–±–∫–∞: {response.status_code}"
            
            elif provider == "anthropic":
                response = requests.post(
                    "https://api.anthropic.com/v1/messages",
                    headers={
                        "x-api-key": key,
                        "Content-Type": "application/json",
                        "anthropic-version": "2023-06-01"
                    },
                    json={
                        "model": "claude-3-haiku-20240307",
                        "max_tokens": max_tokens,
                        "messages": [{"role": "user", "content": prompt}]
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["content"][0]["text"]
                return False, f"Anthropic –æ—à–∏–±–∫–∞: {response.status_code}"
            
            elif provider == "perplexity":
                response = requests.post(
                    "https://api.perplexity.ai/chat/completions",
                    headers={"Authorization": f"Bearer {key}", "Content-Type": "application/json"},
                    json={
                        "model": "llama-3.1-sonar-small-128k-online",
                        "messages": [{"role": "user", "content": prompt}],
                        "max_tokens": max_tokens
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    return True, response.json()["choices"][0]["message"]["content"]
                return False, f"Perplexity –æ—à–∏–±–∫–∞: {response.status_code}"
            
            elif provider == "yandexgpt":
                if not folder_id:
                    return False, "–ù–µ —É–∫–∞–∑–∞–Ω Folder ID –¥–ª—è YandexGPT"
                
                response = requests.post(
                    "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                    headers={
                        "Authorization": f"Api-Key {key}",
                        "Content-Type": "application/json",
                        "x-folder-id": folder_id
                    },
                    json={
                        "modelUri": f"gpt://{folder_id}/yandexgpt-lite",
                        "completionOptions": {"stream": False, "temperature": 0.3, "maxTokens": max_tokens},
                        "messages": [{"role": "user", "text": prompt}]
                    },
                    timeout=120
                )
                if response.status_code == 200:
                    result = response.json()
                    if "result" in result and "alternatives" in result["result"]:
                        return True, result["result"]["alternatives"][0]["message"]["text"]
                return False, f"YandexGPT –æ—à–∏–±–∫–∞: {response.status_code}"
            
            return False, f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: {provider}"
        
        except requests.Timeout:
            return False, "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (120 —Å–µ–∫)"
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞: {str(e)}"

# ============================================================================
# AI –ê–ù–ê–õ–ò–ó –î–û–ö–£–ú–ï–ù–¢–û–í
# ============================================================================

def ai_–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è_–¥–æ–∫—É–º–µ–Ω—Ç–∞(—Ç–µ–∫—Å—Ç: str) -> dict:
    """AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Å–æ–∑–¥–∞—ë—Ç —Å–ø—Ä–∞–≤–∫—É."""
    
    –æ—Ä–≥ = st.session_state.get("–æ—Ä–≥", DEFAULT_ORG)
    
    prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç—É –∫–æ–º–ø–∞–Ω–∏–∏ {–æ—Ä–≥.get('short_name', '–ê–û –°–ü–ö')}.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:

1. **–¢–ò–ü –î–û–ö–£–ú–ï–ù–¢–ê** ‚Äî –≤—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π:
   - –î–æ–≥–æ–≤–æ—Ä (—É–∫–∞–∂–∏ –≤–∏–¥: –ø–æ—Å—Ç–∞–≤–∫–∏, –∞—Ä–µ–Ω–¥—ã, —É—Å–ª—É–≥, –ø–æ–¥—Ä—è–¥–∞, –∏ —Ç.–¥.)
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
   - –°—á—ë—Ç / –°—á—ë—Ç-—Ñ–∞–∫—Ç—É—Ä–∞ / –£–ü–î
   - –ê–∫—Ç (–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç, —Å–≤–µ—Ä–∫–∏, –æ—Å–º–æ—Ç—Ä–∞)
   - –ù–∞–∫–ª–∞–¥–Ω–∞—è (–¢–û–†–ì-12, –¢–¢–ù)
   - –ü—Ä–µ—Ç–µ–Ω–∑–∏—è / –ò—Å–∫
   - –î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
   - –ü—Ä–∏–∫–∞–∑
   - –ü–∏—Å—å–º–æ (–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ)
   - –ó–∞—è–≤–ª–µ–Ω–∏–µ
   - –ü—Ä–æ—Ç–æ–∫–æ–ª
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ / –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –î—Ä—É–≥–æ–µ (—É–∫–∞–∂–∏)

2. **–°–¢–û–†–û–ù–´ –î–û–ö–£–ú–ï–ù–¢–ê** ‚Äî –∫—Ç–æ —É—á–∞—Å—Ç–≤—É–µ—Ç:
   - –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã —É–∫–∞–∂–∏: —Ä–æ–ª—å, –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ò–ù–ù (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –û–ø—Ä–µ–¥–µ–ª–∏ –∫—Ç–æ –Ω–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è ({–æ—Ä–≥.get('short_name')}), –∞ –∫—Ç–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç

3. **–ö–õ–Æ–ß–ï–í–´–ï –£–°–õ–û–í–ò–Ø**:
   - –ü—Ä–µ–¥–º–µ—Ç (–æ —á—ë–º –¥–æ–∫—É–º–µ–Ω—Ç)
   - –°—É–º–º–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –°—Ä–æ–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –í–∞–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è

4. **–ö–†–ê–¢–ö–ê–Ø –°–ü–†–ê–í–ö–ê** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî —Å—É—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º

5. **–¢–†–ï–ë–£–ï–¢–°–Ø –õ–ò –Æ–†–ò–î–ò–ß–ï–°–ö–ê–Ø –≠–ö–°–ü–ï–†–¢–ò–ó–ê** ‚Äî –¥–∞/–Ω–µ—Ç –∏ –ø–æ—á–µ–º—É

–û—Ç–≤–µ—Ç –¥–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
```json
{{
  "—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞": "...",
  "–∫–∞—Ç–µ–≥–æ—Ä–∏—è": "–¥–æ–≥–æ–≤–æ—Ä/–ø–µ—Ä–≤–∏—á–∫–∞/–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π/–ø—Ä–µ—Ç–µ–Ω–∑–∏—è/–ø–∏—Å—å–º–æ/–¥—Ä—É–≥–æ–µ",
  "—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": 95,
  "—Å—Ç–æ—Ä–æ–Ω—ã": [
    {{"—Ä–æ–ª—å": "–ü–æ—Å—Ç–∞–≤—â–∏–∫", "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": "–û–û–û –†–æ–º–∞—à–∫–∞", "–∏–Ω–Ω": "1234567890", "—ç—Ç–æ_–º—ã": false}},
    {{"—Ä–æ–ª—å": "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å", "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": "–ê–û –°–ü–ö", "–∏–Ω–Ω": "7712345678", "—ç—Ç–æ_–º—ã": true}}
  ],
  "–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç": "–û–û–û –†–æ–º–∞—à–∫–∞",
  "–ø—Ä–µ–¥–º–µ—Ç": "...",
  "—Å—É–º–º–∞": 100000,
  "–≤–∞–ª—é—Ç–∞": "RUB",
  "—Å—Ä–æ–∫": "–¥–æ 31.12.2024",
  "–∫–ª—é—á–µ–≤—ã–µ_—É—Å–ª–æ–≤–∏—è": ["...", "..."],
  "–∫—Ä–∞—Ç–∫–∞—è_—Å–ø—Ä–∞–≤–∫–∞": "...",
  "—Ç—Ä–µ–±—É–µ—Ç_—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã": true,
  "–ø—Ä–∏—á–∏–Ω–∞_—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã": "..."
}}
```

–¢–ï–ö–°–¢ –î–û–ö–£–ú–ï–ù–¢–ê:
{—Ç–µ–∫—Å—Ç[:8000]}
"""
    
    success, response = AIClient.call(prompt)
    
    if not success:
        return {"error": response, "—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞": "–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω"}
    
    # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
    try:
        # –ò—â–µ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ
        json_match = re.search(r'```json\s*(.*?)\s*```', response, re.DOTALL)
        if json_match:
            return json.loads(json_match.group(1))
        
        # –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤–µ—Å—å –æ—Ç–≤–µ—Ç
        json_match = re.search(r'\{.*\}', response, re.DOTALL)
        if json_match:
            return json.loads(json_match.group())
        
        return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç AI", "raw": response[:500]}
    except json.JSONDecodeError as e:
        return {"error": f"JSON –æ—à–∏–±–∫–∞: {e}", "raw": response[:500]}


def ai_–ø–æ–ª–Ω—ã–π_–∞–Ω–∞–ª–∏–∑(—Ç–µ–∫—Å—Ç: str, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: dict) -> dict:
    """–ü–æ–ª–Ω—ã–π AI –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–æ–π."""
    
    –æ—Ä–≥ = st.session_state.get("–æ—Ä–≥", DEFAULT_ORG)
    —Ç–∏–ø = –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è.get("—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞", "–î–æ–∫—É–º–µ–Ω—Ç")
    –∫–∞—Ç–µ–≥–æ—Ä–∏—è = –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è.get("–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–¥—Ä—É–≥–æ–µ")
    
    # –†–∞–∑–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    if –∫–∞—Ç–µ–≥–æ—Ä–∏—è in ["–¥–æ–≥–æ–≤–æ—Ä", "–¥–æ–≥–æ–≤–æ—Ä—ã"]:
        prompt = _get_contract_analysis_prompt(—Ç–µ–∫—Å—Ç, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –æ—Ä–≥)
    elif –∫–∞—Ç–µ–≥–æ—Ä–∏—è == "–ø—Ä–µ—Ç–µ–Ω–∑–∏—è":
        prompt = _get_claim_analysis_prompt(—Ç–µ–∫—Å—Ç, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –æ—Ä–≥)
    else:
        prompt = _get_general_analysis_prompt(—Ç–µ–∫—Å—Ç, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –æ—Ä–≥)
    
    success, response = AIClient.call(prompt, max_tokens=4000)
    
    if not success:
        return {"error": response}
    
    return {"–∞–Ω–∞–ª–∏–∑": response, "–ø—Ä–æ–≤–∞–π–¥–µ—Ä": AIClient.get_provider()[0]}


def _get_contract_analysis_prompt(—Ç–µ–∫—Å—Ç: str, –∏–¥–µ–Ω—Ç: dict, –æ—Ä–≥: dict) -> str:
    """–ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤."""
    return f"""–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π —é—Ä–∏—Å—Ç {–æ—Ä–≥.get('short_name', '–ê–û –°–ü–ö')} —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã—Ö —Å–ø–æ—Ä–∞—Ö.

–ó–ê–î–ê–ß–ê: –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—É—é –ø—Ä–∞–≤–æ–≤—É—é —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É –¥–æ–≥–æ–≤–æ—Ä–∞

–î–û–ö–£–ú–ï–ù–¢: {–∏–¥–µ–Ω—Ç.get('—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞', '–î–æ–≥–æ–≤–æ—Ä')}
–ö–û–ù–¢–†–ê–ì–ï–ù–¢: {–∏–¥–µ–Ω—Ç.get('–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω')}
–°–£–ú–ú–ê: {–∏–¥–µ–Ω—Ç.get('—Å—É–º–º–∞', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}

–¢–ï–ö–°–¢ –î–û–ì–û–í–û–†–ê:
{—Ç–µ–∫—Å—Ç[:10000]}

–ü–†–û–í–ï–î–ò –ê–ù–ê–õ–ò–ó –ü–û –ü–£–ù–ö–¢–ê–ú:

## 1. –°–£–©–ï–°–¢–í–ï–ù–ù–´–ï –£–°–õ–û–í–ò–Ø
- –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ –ì–ö –†–§
- –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –¥–æ–≥–æ–≤–æ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–∑–Ω–∞–Ω –Ω–µ–∑–∞–∫–ª—é—á—ë–Ω–Ω—ã–º

## 2. –†–ò–°–ö–ò –î–õ–Ø –ù–ê–®–ï–ô –ö–û–ú–ü–ê–ù–ò–ò
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∏—Å–∫–∞ —É–∫–∞–∂–∏:
- üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π / üü° –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π / üü¢ –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π
- –ü—É–Ω–∫—Ç –¥–æ–≥–æ–≤–æ—Ä–∞
- –í —á—ë–º —Ä–∏—Å–∫
- –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å (–ø—Ä–µ–¥–ª–æ–∂–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É)

## 3. –ù–ï–í–´–ì–û–î–ù–´–ï –£–°–õ–û–í–ò–Ø
- –£—Å–ª–æ–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞–≤—è—Ç –Ω–∞—Å –≤ —Ö—É–¥—à–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
- –ù–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω
- –ó–∞–≤—ã—à–µ–Ω–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã/–ø–µ–Ω–∏

## 4. –û–¢–°–£–¢–°–¢–í–£–Æ–©–ò–ï –ü–£–ù–ö–¢–´
- –ß—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è –∑–∞—â–∏—Ç—ã –Ω–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤

## 5. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø
- –°–û–ì–õ–ê–°–û–í–ê–¢–¨ ‚Äî –±–µ–∑ –∑–∞–º–µ—á–∞–Ω–∏–π
- –° –ó–ê–ú–ï–ß–ê–ù–ò–Ø–ú–ò ‚Äî –ø–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤  
- –î–û–†–ê–ë–û–¢–ê–¢–¨ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞
- –û–¢–ö–õ–û–ù–ò–¢–¨ ‚Äî –¥–æ–≥–æ–≤–æ—Ä –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º

## 6. –ò–¢–û–ì–û–í–ê–Ø –°–ü–†–ê–í–ö–ê
–ö—Ä–∞—Ç–∫–æ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è): –æ —á—ë–º –¥–æ–≥–æ–≤–æ—Ä, –∫–ª—é—á–µ–≤—ã–µ —Ä–∏—Å–∫–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è.
"""


def _get_claim_analysis_prompt(—Ç–µ–∫—Å—Ç: str, –∏–¥–µ–Ω—Ç: dict, –æ—Ä–≥: dict) -> str:
    """–ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π."""
    return f"""–¢—ã ‚Äî —é—Ä–∏—Å—Ç –ø–æ –ø—Ä–µ—Ç–µ–Ω–∑–∏–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ {–æ—Ä–≥.get('short_name', '–ê–û –°–ü–ö')}.

–î–û–ö–£–ú–ï–ù–¢: {–∏–¥–µ–Ω—Ç.get('—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞', '–ü—Ä–µ—Ç–µ–Ω–∑–∏—è')}

–¢–ï–ö–°–¢:
{—Ç–µ–∫—Å—Ç[:10000]}

–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô:

## 1. –°–£–¢–¨ –ü–†–ï–¢–ï–ù–ó–ò–ò
- –û—Ç –∫–æ–≥–æ –∏ –∫–æ–º—É
- –ß—Ç–æ —Ç—Ä–µ–±—É—é—Ç
- –û—Å–Ω–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

## 2. –û–ë–û–°–ù–û–í–ê–ù–ù–û–°–¢–¨
- –ó–∞–∫–æ–Ω–Ω—ã –ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –ï—Å—Ç—å –ª–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –ü—Ä–æ–ø—É—â–µ–Ω—ã –ª–∏ —Å—Ä–æ–∫–∏ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏

## 3. –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –î–ï–ô–°–¢–í–ò–Ø
- –ü—Ä–∏–∑–Ω–∞—Ç—å / –ß–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∏–∑–Ω–∞—Ç—å / –û—Ç–∫–ª–æ–Ω–∏—Ç—å
- –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞
- –°—Ä–æ–∫–∏ –æ—Ç–≤–µ—Ç–∞

## 4. –†–ò–°–ö–ò
- –ß—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç—å
- –°—É–¥–µ–±–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã

## 5. –ü–†–û–ï–ö–¢ –û–¢–í–ï–¢–ê
–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é.
"""


def _get_general_analysis_prompt(—Ç–µ–∫—Å—Ç: str, –∏–¥–µ–Ω—Ç: dict, –æ—Ä–≥: dict) -> str:
    """–ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—á–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."""
    return f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç—É {–æ—Ä–≥.get('short_name', '–ê–û –°–ü–ö')}.

–î–û–ö–£–ú–ï–ù–¢: {–∏–¥–µ–Ω—Ç.get('—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞', '–î–æ–∫—É–º–µ–Ω—Ç')}

–¢–ï–ö–°–¢:
{—Ç–µ–∫—Å—Ç[:10000]}

–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô:

## 1. –°–û–î–ï–†–ñ–ê–ù–ò–ï
- –û —á—ë–º –¥–æ–∫—É–º–µ–Ω—Ç
- –ö–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–∞—Ç—ã, —Å—É–º–º—ã, —Å—Ç–æ—Ä–æ–Ω—ã)

## 2. –ü–†–û–í–ï–†–ö–ê –ö–û–†–†–ï–ö–¢–ù–û–°–¢–ò
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
- –ù–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É

## 3. –î–ï–ô–°–¢–í–ò–Ø
- –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º
- –ö–æ–º—É –Ω–∞–ø—Ä–∞–≤–∏—Ç—å
- –°—Ä–æ–∫–∏

## 4. –ó–ê–ú–ï–ß–ê–ù–ò–Ø
- –û—à–∏–±–∫–∏ –∏ –Ω–µ–¥–æ—á—ë—Ç—ã
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

## 5. –ö–†–ê–¢–ö–ê–Ø –°–ü–†–ê–í–ö–ê
–°—É—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö.
"""


def ai_—Å–ª–∏—á–µ–Ω–∏–µ_–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤(—Ç–µ–∫—Å—Ç1: str, —Ç–µ–∫—Å—Ç2: str, –Ω–∞–∑–≤–∞–Ω–∏–µ1: str, –Ω–∞–∑–≤–∞–Ω–∏–µ2: str) -> dict:
    """AI —Å–ª–∏—á–µ–Ω–∏–µ –¥–≤—É—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."""
    
    prompt = f"""–¢—ã ‚Äî —é—Ä–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Å–ª–∏—á–µ–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–ó–ê–î–ê–ß–ê: –°—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –Ω–∞–π—Ç–∏ –≤—Å–µ —Ä–∞–∑–ª–∏—á–∏—è.

–î–û–ö–£–ú–ï–ù–¢ 1 ({–Ω–∞–∑–≤–∞–Ω–∏–µ1}):
{—Ç–µ–∫—Å—Ç1[:5000]}

–î–û–ö–£–ú–ï–ù–¢ 2 ({–Ω–∞–∑–≤–∞–Ω–∏–µ2}):
{—Ç–µ–∫—Å—Ç2[:5000]}

–°–†–ê–í–ù–ò –ò –£–ö–ê–ñ–ò:

## 1. –û–ë–©–ï–ï
- –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∏–ª–∏ —Ä–∞–∑–Ω—ã–π)
- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å—Ç–æ—Ä–æ–Ω—ã, —Å—É–º–º—ã, –¥–∞—Ç—ã)

## 2. –†–ê–ó–õ–ò–ß–ò–Ø
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–ª–∏—á–∏—è:
| ‚Ññ | –ü—É–Ω–∫—Ç/–†–∞–∑–¥–µ–ª | –î–æ–∫—É–º–µ–Ω—Ç 1 | –î–æ–∫—É–º–µ–Ω—Ç 2 | –í–∞–∂–Ω–æ—Å—Ç—å |
|---|--------------|------------|------------|----------|
| 1 | ... | ... | ... | üî¥/üü°/üü¢ |

## 3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ê–ó–õ–ò–ß–ò–Ø
–†–∞–∑–ª–∏—á–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è—é—Ç —Å—É—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ä–∏—Å–∫–∏

## 4. –í–´–í–û–î
- –î–æ–∫—É–º–µ–Ω—Ç—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã / –ò–º–µ—é—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è / –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–ï—Å–ª–∏ –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî —Ç–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞, –∞ –¥—Ä—É–≥–æ–π ‚Äî –ø—Ä–æ–µ–∫—Ç, —É–∫–∞–∂–∏ –≤—Å–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º—ã.
"""
    
    success, response = AIClient.call(prompt, max_tokens=4000)
    
    if not success:
        return {"error": response}
    
    return {"—Å–ª–∏—á–µ–Ω–∏–µ": response}

# ============================================================================
# –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–û–í
# ============================================================================

def extract_text_from_file(uploaded_file) -> Tuple[bool, str, dict]:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞."""
    if not uploaded_file:
        return False, "", {}
    
    filename = uploaded_file.name
    ext = Path(filename).suffix.lower()
    file_bytes = uploaded_file.read()
    uploaded_file.seek(0)  # –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏
    
    metadata = {
        "filename": filename,
        "size": len(file_bytes),
        "extension": ext
    }
    
    # TXT
    if ext == '.txt':
        for encoding in ['utf-8', 'cp1251', 'cp866', 'latin-1']:
            try:
                text = file_bytes.decode(encoding)
                metadata["encoding"] = encoding
                return True, text, metadata
            except:
                continue
        return False, "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É", metadata
    
    # DOCX
    if ext == '.docx' and DOCX_AVAILABLE:
        try:
            doc = DocxDocument(io.BytesIO(file_bytes))
            text = "\n".join([p.text for p in doc.paragraphs if p.text.strip()])
            # –¢–∞–∫–∂–µ –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
            for table in doc.tables:
                for row in table.rows:
                    row_text = " | ".join([cell.text.strip() for cell in row.cells])
                    if row_text.strip():
                        text += "\n" + row_text
            return True, text, metadata
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è DOCX: {e}", metadata
    
    # PDF
    if ext == '.pdf' and PDF_AVAILABLE:
        try:
            reader = PdfReader(io.BytesIO(file_bytes))
            text_parts = []
            for i, page in enumerate(reader.pages):
                page_text = page.extract_text() or ""
                if page_text.strip():
                    text_parts.append(f"--- –°—Ç—Ä–∞–Ω–∏—Ü–∞ {i+1} ---\n{page_text}")
            
            if text_parts:
                text = "\n\n".join(text_parts)
                # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –º–∞–ª–æ, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ —Å–∫–∞–Ω
                if len(text.strip()) < 100:
                    return False, "PDF –ø–æ—Ö–æ–∂ –Ω–∞ —Å–∫–∞–Ω. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è OCR.", metadata
                return True, text, metadata
            else:
                return False, "PDF –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ —Å–∫–∞–Ω.", metadata
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PDF: {e}", metadata
    
    # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (OCR)
    if ext in IMAGE_EXTENSIONS:
        ocr_available, _ = OCRProcessor.is_available()
        if not ocr_available:
            return False, "–î–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ OCR –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö", metadata
        
        success, text = OCRProcessor.ocr_image(file_bytes)
        if success:
            metadata["ocr"] = True
            return True, text, metadata
        else:
            return False, text, metadata
    
    return False, f"–§–æ—Ä–º–∞—Ç {ext} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", metadata

# ============================================================================
# –ò–ù–¢–ï–†–§–ï–ô–°
# ============================================================================

# CSS —Å—Ç–∏–ª–∏
def apply_styles():
    st.markdown("""
    <style>
    .main-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding: 10px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 10px;
        color: white;
    }
    .traffic-light {
        display: flex;
        gap: 5px;
    }
    .tl-red, .tl-yellow, .tl-green {
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }
    .tl-red { background: #e74c3c; }
    .tl-yellow { background: #f39c12; }
    .tl-green { background: #27ae60; }
    
    .doc-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #3498db;
    }
    .doc-card.green { border-left-color: #27ae60; }
    .doc-card.yellow { border-left-color: #f39c12; }
    .doc-card.red { border-left-color: #e74c3c; }
    
    .risk-item {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
    }
    .risk-critical { background: #fdecea; border-left: 3px solid #e74c3c; }
    .risk-warning { background: #fef9e7; border-left: 3px solid #f39c12; }
    .risk-info { background: #eafaf1; border-left: 3px solid #27ae60; }
    
    .metric-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #2c3e50;
    }
    .metric-label {
        color: #7f8c8d;
        font-size: 0.9em;
    }
    
    .history-item {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 5px;
        cursor: pointer;
    }
    .history-item:hover {
        background: #e9ecef;
    }
    
    .stButton > button {
        width: 100%;
    }
    </style>
    """, unsafe_allow_html=True)


def render_header():
    """–®–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    st.markdown("""
    <div class="main-header">
        <div class="traffic-light">
            <span class="tl-red"></span>
            <span class="tl-yellow"></span>
            <span class="tl-green"></span>
        </div>
        <div>
            <h2 style="margin:0;">–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä</h2>
            <small style="opacity:0.7;">v7.16 ‚Ä¢ AI-–∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</small>
        </div>
    </div>
    """, unsafe_allow_html=True)


def render_sidebar():
    """–ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å."""
    with st.sidebar:
        st.markdown("### üë§ " + st.session_state.get("–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–ì–æ—Å—Ç—å"))
        
        # –°—Ç–∞—Ç—É—Å AI
        ai_ok, ai_name = AIClient.is_available()
        if ai_ok:
            st.success(f"ü§ñ {ai_name}")
        else:
            st.warning("ü§ñ AI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        # –°—Ç–∞—Ç—É—Å OCR
        ocr_status = OCRProcessor.get_status()
        if ocr_status["available"]:
            st.success(f"üîç OCR: {ocr_status['message']}")
        else:
            st.info("üîç OCR –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        st.markdown("---")
        
        # –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑", use_container_width=True):
            clear_analysis()
            st.rerun()
        
        if st.button("üìä –ò—Å—Ç–æ—Ä–∏—è", use_container_width=True):
            st.session_state.show_history = True
        
        st.markdown("---")
        
        if st.button("üö™ –í—ã–π—Ç–∏", use_container_width=True):
            for key in list(st.session_state.keys()):
                if key not in ["–æ—Ä–≥", "–ø–æ—Ä–æ–≥–∏", "api_–∫–ª—é—á–∏", "ocr_api", "–∏—Å—Ç–æ—Ä–∏—è"]:
                    del st.session_state[key]
            st.rerun()


def clear_analysis():
    """–û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."""
    keys_to_clear = [
        "—Ç–µ–∫—É—â–∏–π_–∞–Ω–∞–ª–∏–∑", "uploaded_file_id", "doc_text", 
        "–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è", "ai_–∞–Ω–∞–ª–∏–∑", "—Å–ª–∏—á–µ–Ω–∏–µ"
    ]
    for key in keys_to_clear:
        if key in st.session_state:
            del st.session_state[key]


def render_upload_section():
    """–°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞."""
    st.markdown("### üìÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞")
    
    col1, col2 = st.columns([3, 1])
    
    with col1:
        uploaded_file = st.file_uploader(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª",
            type=['txt', 'docx', 'pdf', 'png', 'jpg', 'jpeg', 'tiff', 'bmp'],
            key="file_uploader",
            help="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: TXT, DOCX, PDF, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
        )
    
    with col2:
        st.markdown("<br>", unsafe_allow_html=True)
        if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å", use_container_width=True):
            clear_analysis()
            st.rerun()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ñ–∞–π–ª
    if uploaded_file:
        file_id = f"{uploaded_file.name}_{uploaded_file.size}"
        
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–æ–≤—ã–π ‚Äî –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∞–Ω–∞–ª–∏–∑
        if st.session_state.get("uploaded_file_id") != file_id:
            clear_analysis()
            st.session_state.uploaded_file_id = file_id
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
        if "doc_text" not in st.session_state:
            with st.spinner("–ß–∏—Ç–∞—é –¥–æ–∫—É–º–µ–Ω—Ç..."):
                success, text, metadata = extract_text_from_file(uploaded_file)
                
                if success:
                    st.session_state.doc_text = text
                    st.session_state.doc_metadata = metadata
                    st.success(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {uploaded_file.name} ({len(text):,} —Å–∏–º–≤–æ–ª–æ–≤)")
                else:
                    st.error(f"‚ùå {text}")
                    return None
        
        return st.session_state.get("doc_text")
    
    return None


def render_analysis_section(text: str):
    """–°–µ–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞."""
    
    # –ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
    col1, col2, col3 = st.columns(3)
    
    with col1:
        analyze_btn = st.button("üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å", type="primary", use_container_width=True)
    
    with col2:
        full_analysis_btn = st.button("ü§ñ –ü–æ–ª–Ω—ã–π AI-–∞–Ω–∞–ª–∏–∑", use_container_width=True)
    
    with col3:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–ª–∏—á–µ–Ω–∏—è
        compare_file = st.file_uploader(
            "üìä –°–ª–∏—á–∏—Ç—å —Å...",
            type=['txt', 'docx', 'pdf'],
            key="compare_file",
            label_visibility="collapsed"
        )
    
    # –ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
    if analyze_btn:
        with st.spinner("AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞..."):
            –∏–¥–µ–Ω—Ç = ai_–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è_–¥–æ–∫—É–º–µ–Ω—Ç–∞(text)
            st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è = –∏–¥–µ–Ω—Ç
    
    # –ü–æ–ª–Ω—ã–π AI –∞–Ω–∞–ª–∏–∑
    if full_analysis_btn:
        if "–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è" not in st.session_state:
            with st.spinner("AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞..."):
                –∏–¥–µ–Ω—Ç = ai_–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è_–¥–æ–∫—É–º–µ–Ω—Ç–∞(text)
                st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è = –∏–¥–µ–Ω—Ç
        
        with st.spinner("AI –ø—Ä–æ–≤–æ–¥–∏—Ç –ø–æ–ª–Ω—É—é —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É..."):
            –∞–Ω–∞–ª–∏–∑ = ai_–ø–æ–ª–Ω—ã–π_–∞–Ω–∞–ª–∏–∑(text, st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
            st.session_state.ai_–∞–Ω–∞–ª–∏–∑ = –∞–Ω–∞–ª–∏–∑
    
    # –°–ª–∏—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if compare_file:
        with st.spinner("–ß–∏—Ç–∞—é –≤—Ç–æ—Ä–æ–π –¥–æ–∫—É–º–µ–Ω—Ç..."):
            success2, text2, _ = extract_text_from_file(compare_file)
            
            if success2:
                with st.spinner("AI —Å–ª–∏—á–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã..."):
                    —Å–ª–∏—á–µ–Ω–∏–µ = ai_—Å–ª–∏—á–µ–Ω–∏–µ_–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤(
                        text, text2,
                        st.session_state.get("doc_metadata", {}).get("filename", "–î–æ–∫—É–º–µ–Ω—Ç 1"),
                        compare_file.name
                    )
                    st.session_state.—Å–ª–∏—á–µ–Ω–∏–µ = —Å–ª–∏—á–µ–Ω–∏–µ
            else:
                st.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –¥–ª—è —Å–ª–∏—á–µ–Ω–∏—è: {text2}")
    
    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    render_results()


def render_results():
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞."""
    
    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    if "–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è" in st.session_state:
        –∏–¥–µ–Ω—Ç = st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        
        if "error" in –∏–¥–µ–Ω—Ç:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: {–∏–¥–µ–Ω—Ç['error']}")
        else:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏
            —Ç—Ä–µ–±—É–µ—Ç = –∏–¥–µ–Ω—Ç.get("—Ç—Ä–µ–±—É–µ—Ç_—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã", False)
            card_class = "yellow" if —Ç—Ä–µ–±—É–µ—Ç else "green"
            
            st.markdown(f"""
            <div class="doc-card {card_class}">
                <h3>üìã {–∏–¥–µ–Ω—Ç.get('—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞', '–î–æ–∫—É–º–µ–Ω—Ç')}</h3>
                <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {–∏–¥–µ–Ω—Ç.get('–∫–∞—Ç–µ–≥–æ—Ä–∏—è', '‚Äî')}</p>
                <p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> {–∏–¥–µ–Ω—Ç.get('—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å', 0)}%</p>
            </div>
            """, unsafe_allow_html=True)
            
            # –°—Ç–æ—Ä–æ–Ω—ã
            —Å—Ç–æ—Ä–æ–Ω—ã = –∏–¥–µ–Ω—Ç.get("—Å—Ç–æ—Ä–æ–Ω—ã", [])
            if —Å—Ç–æ—Ä–æ–Ω—ã:
                st.markdown("#### üë• –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞")
                cols = st.columns(len(—Å—Ç–æ—Ä–æ–Ω—ã))
                for i, —Å—Ç–æ—Ä–æ–Ω–∞ in enumerate(—Å—Ç–æ—Ä–æ–Ω—ã):
                    with cols[i]:
                        emoji = "üè¢" if —Å—Ç–æ—Ä–æ–Ω–∞.get("—ç—Ç–æ_–º—ã") else "ü§ù"
                        st.markdown(f"""
                        **{emoji} {—Å—Ç–æ—Ä–æ–Ω–∞.get('—Ä–æ–ª—å', '–°—Ç–æ—Ä–æ–Ω–∞')}**  
                        {—Å—Ç–æ—Ä–æ–Ω–∞.get('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '‚Äî')}  
                        –ò–ù–ù: {—Å—Ç–æ—Ä–æ–Ω–∞.get('–∏–Ω–Ω', '‚Äî')}
                        """)
            
            # –ö–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("üí∞ –°—É–º–º–∞", f"{–∏–¥–µ–Ω—Ç.get('—Å—É–º–º–∞', 0):,.0f} ‚ÇΩ" if –∏–¥–µ–Ω—Ç.get('—Å—É–º–º–∞') else "‚Äî")
            with col2:
                st.metric("üìÖ –°—Ä–æ–∫", –∏–¥–µ–Ω—Ç.get('—Å—Ä–æ–∫', '‚Äî'))
            with col3:
                st.metric("‚öñÔ∏è –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞", "–¢—Ä–µ–±—É–µ—Ç—Å—è" if —Ç—Ä–µ–±—É–µ—Ç else "–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
            
            # –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
            if –∏–¥–µ–Ω—Ç.get("–∫—Ä–∞—Ç–∫–∞—è_—Å–ø—Ä–∞–≤–∫–∞"):
                st.info(f"üìù **–°–ø—Ä–∞–≤–∫–∞:** {–∏–¥–µ–Ω—Ç['–∫—Ä–∞—Ç–∫–∞—è_—Å–ø—Ä–∞–≤–∫–∞']}")
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            if "–¥–æ–±–∞–≤–ª–µ–Ω–æ_–≤_–∏—Å—Ç–æ—Ä–∏—é" not in st.session_state:
                add_to_history({
                    "filename": st.session_state.get("doc_metadata", {}).get("filename", ""),
                    "—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞": –∏–¥–µ–Ω—Ç.get("—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞", ""),
                    "–∑–æ–Ω–∞": "yellow" if —Ç—Ä–µ–±—É–µ—Ç else "green",
                    "–∫—Ä–∞—Ç–∫–æ–µ_–æ–ø–∏—Å–∞–Ω–∏–µ": –∏–¥–µ–Ω—Ç.get("–∫—Ä–∞—Ç–∫–∞—è_—Å–ø—Ä–∞–≤–∫–∞", "")
                })
                st.session_state.–¥–æ–±–∞–≤–ª–µ–Ω–æ_–≤_–∏—Å—Ç–æ—Ä–∏—é = True
    
    # –ü–æ–ª–Ω—ã–π AI –∞–Ω–∞–ª–∏–∑
    if "ai_–∞–Ω–∞–ª–∏–∑" in st.session_state:
        –∞–Ω–∞–ª–∏–∑ = st.session_state.ai_–∞–Ω–∞–ª–∏–∑
        
        st.markdown("---")
        st.markdown("### ü§ñ AI-—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞")
        
        if "error" in –∞–Ω–∞–ª–∏–∑:
            st.error(f"‚ùå {–∞–Ω–∞–ª–∏–∑['error']}")
        else:
            st.markdown(–∞–Ω–∞–ª–∏–∑.get("–∞–Ω–∞–ª–∏–∑", ""))
            st.caption(f"–ü—Ä–æ–≤–∞–π–¥–µ—Ä: {AI_–ü–†–û–í–ê–ô–î–ï–†–´.get(–∞–Ω–∞–ª–∏–∑.get('–ø—Ä–æ–≤–∞–π–¥–µ—Ä', ''), {}).get('–Ω–∞–∑–≤–∞–Ω–∏–µ', 'AI')}")
    
    # –°–ª–∏—á–µ–Ω–∏–µ
    if "—Å–ª–∏—á–µ–Ω–∏–µ" in st.session_state:
        —Å–ª–∏—á–µ–Ω–∏–µ = st.session_state.—Å–ª–∏—á–µ–Ω–∏–µ
        
        st.markdown("---")
        st.markdown("### üìä –°–ª–∏—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
        
        if "error" in —Å–ª–∏—á–µ–Ω–∏–µ:
            st.error(f"‚ùå {—Å–ª–∏—á–µ–Ω–∏–µ['error']}")
        else:
            st.markdown(—Å–ª–∏—á–µ–Ω–∏–µ.get("—Å–ª–∏—á–µ–Ω–∏–µ", ""))


def render_history():
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–æ–≤."""
    st.markdown("### üìú –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤")
    
    –∏—Å—Ç–æ—Ä–∏—è = st.session_state.get("–∏—Å—Ç–æ—Ä–∏—è", [])
    
    if not –∏—Å—Ç–æ—Ä–∏—è:
        st.info("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞")
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π
    for –∑–∞–ø–∏—Å—å in reversed(–∏—Å—Ç–æ—Ä–∏—è[-20:]):
        –∑–æ–Ω–∞ = –∑–∞–ø–∏—Å—å.get("–∑–æ–Ω–∞", "")
        emoji = {"green": "üü¢", "yellow": "üü°", "red": "üî¥"}.get(–∑–æ–Ω–∞, "‚ö™")
        
        with st.expander(f"{emoji} {–∑–∞–ø–∏—Å—å.get('filename', '‚Äî')} ‚Ä¢ {–∑–∞–ø–∏—Å—å.get('—Ç–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞', '‚Äî')}"):
            st.write(f"**–î–∞—Ç–∞:** {–∑–∞–ø–∏—Å—å.get('timestamp', '‚Äî')[:19]}")
            st.write(f"**–û–ø–∏—Å–∞–Ω–∏–µ:** {–∑–∞–ø–∏—Å—å.get('–∫—Ä–∞—Ç–∫–æ–µ_–æ–ø–∏—Å–∞–Ω–∏–µ', '‚Äî')}")
    
    if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"):
        st.session_state.–∏—Å—Ç–æ—Ä–∏—è = []
        save_history([])
        st.rerun()


def render_settings():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫."""
    st.markdown("### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    
    tabs = st.tabs(["üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "üìä –ü–æ—Ä–æ–≥–∏", "ü§ñ AI API", "üîç OCR"])
    
    # === –û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø ===
    with tabs[0]:
        –æ—Ä–≥ = st.session_state.get("–æ—Ä–≥", DEFAULT_ORG)
        
        new_full = st.text_input("–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", value=–æ—Ä–≥.get("full_name", ""))
        new_short = st.text_input("–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", value=–æ—Ä–≥.get("short_name", ""))
        new_inn = st.text_input("–ò–ù–ù", value=–æ—Ä–≥.get("inn", ""))
        
        if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", key="save_org"):
            st.session_state.–æ—Ä–≥ = {"full_name": new_full, "short_name": new_short, "inn": new_inn}
            save_current_settings()
            st.success("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
    
    # === –ü–û–†–û–ì–ò ===
    with tabs[1]:
        –ø–æ—Ä–æ–≥–∏ = st.session_state.get("–ø–æ—Ä–æ–≥–∏", DEFAULT_THRESHOLDS)
        
        new_tf = st.number_input("üü¢ –ó–µ–ª—ë–Ω–∞—è –¢–§ –º–∞–∫—Å (‚ÇΩ)", value=–ø–æ—Ä–æ–≥–∏.get("–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å", 100000), step=10000)
        new_ntf = st.number_input("üü¢ –ó–µ–ª—ë–Ω–∞—è –Ω–µ—Ç–∏–ø–æ–≤–∞—è –º–∞–∫—Å (‚ÇΩ)", value=–ø–æ—Ä–æ–≥–∏.get("–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å", 50000), step=10000)
        new_yellow = st.number_input("üü°‚Üíüî¥ –ñ—ë–ª—Ç–∞—è –º–∞–∫—Å (‚ÇΩ)", value=–ø–æ—Ä–æ–≥–∏.get("–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å", 5000000), step=100000)
        
        if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", key="save_thresh"):
            st.session_state.–ø–æ—Ä–æ–≥–∏ = {"–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å": new_tf, "–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å": new_ntf, "–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å": new_yellow}
            save_current_settings()
            st.success("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
    
    # === AI API ===
    with tabs[2]:
        st.markdown("#### API-–∫–ª—é—á–∏ –¥–ª—è AI-—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã")
        
        api = st.session_state.get("api_–∫–ª—é—á–∏", {})
        
        # Yandex Folder ID (–æ–±—â–∏–π)
        st.markdown("**üîë Yandex Cloud Folder ID** (–¥–ª—è YandexGPT –∏ Yandex Vision)")
        yandex_folder = st.text_input(
            "Folder ID",
            value=api.get("yandex_folder", ""),
            key="yandex_folder_global",
            placeholder="b1g..."
        )
        if yandex_folder != api.get("yandex_folder", ""):
            if "api_–∫–ª—é—á–∏" not in st.session_state:
                st.session_state.api_–∫–ª—é—á–∏ = {}
            st.session_state.api_–∫–ª—é—á–∏["yandex_folder"] = yandex_folder
            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å OCR
            if "ocr_api" not in st.session_state:
                st.session_state.ocr_api = {}
            st.session_state.ocr_api["yandex_folder"] = yandex_folder
            save_current_settings()
        
        st.markdown("---")
        
        # API –∫–ª—é—á–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
        for pid, info in AI_–ü–†–û–í–ê–ô–î–ï–†–´.items():
            col1, col2 = st.columns([4, 1])
            with col1:
                –Ω–æ–≤—ã–π = st.text_input(
                    f"**{info['–Ω–∞–∑–≤–∞–Ω–∏–µ']}**",
                    type="password",
                    value=api.get(pid, ""),
                    key=f"api_{pid}",
                    placeholder=info['url']
                )
            with col2:
                st.markdown("<br>", unsafe_allow_html=True)
                if api.get(pid):
                    st.success("‚úì")
                else:
                    st.warning("‚Äî")
            
            if –Ω–æ–≤—ã–π != api.get(pid, ""):
                if "api_–∫–ª—é—á–∏" not in st.session_state:
                    st.session_state.api_–∫–ª—é—á–∏ = {}
                st.session_state.api_–∫–ª—é—á–∏[pid] = –Ω–æ–≤—ã–π
                save_current_settings()
                st.success(f"‚úÖ {info['–Ω–∞–∑–≤–∞–Ω–∏–µ']} —Å–æ—Ö—Ä–∞–Ω—ë–Ω")
        
        # –í—ã–±–æ—Ä –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        –∞–∫—Ç–∏–≤–Ω—ã–µ = [pid for pid in AI_–ü–†–û–í–ê–ô–î–ï–†–´ if api.get(pid)]
        if len(–∞–∫—Ç–∏–≤–Ω—ã–µ) > 1:
            st.markdown("---")
            st.markdown("**–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä:**")
            –≤—ã–±—Ä–∞–Ω–Ω—ã–π = st.selectbox(
                "–ü—Ä–æ–≤–∞–π–¥–µ—Ä",
                ["–ê–≤—Ç–æ–≤—ã–±–æ—Ä"] + –∞–∫—Ç–∏–≤–Ω—ã–µ,
                format_func=lambda x: AI_–ü–†–û–í–ê–ô–î–ï–†–´.get(x, {}).get("–Ω–∞–∑–≤–∞–Ω–∏–µ", x),
                key="preferred_ai_select",
                label_visibility="collapsed"
            )
            if –≤—ã–±—Ä–∞–Ω–Ω—ã–π != "–ê–≤—Ç–æ–≤—ã–±–æ—Ä" and api.get("preferred_ai") != –≤—ã–±—Ä–∞–Ω–Ω—ã–π:
                st.session_state.api_–∫–ª—é—á–∏["preferred_ai"] = –≤—ã–±—Ä–∞–Ω–Ω—ã–π
                save_current_settings()
    
    # === OCR ===
    with tabs[3]:
        st.markdown("#### –û–±–ª–∞—á–Ω—ã–π OCR –¥–ª—è —Å–∫–∞–Ω–æ–≤ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
        
        ocr_status = OCRProcessor.get_status()
        
        if ocr_status["available"]:
            st.success(f"‚úÖ OCR —Ä–∞–±–æ—Ç–∞–µ—Ç: {ocr_status['message']}")
        else:
            st.warning("‚ö†Ô∏è OCR –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        ocr_api = st.session_state.get("ocr_api", {})
        
        st.markdown("---")
        st.markdown("**‚òÅÔ∏è Yandex Vision OCR**")
        
        yandex_ocr_key = st.text_input(
            "API Key Yandex Vision",
            type="password",
            value=ocr_api.get("yandex_vision", ""),
            key="ocr_yandex_key",
            placeholder="AQV..."
        )
        
        # Folder ID –±–µ—Ä—ë–º –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
        api_keys = st.session_state.get("api_–∫–ª—é—á–∏", {})
        ocr_folder = ocr_api.get("yandex_folder", "") or api_keys.get("yandex_folder", "")
        
        if yandex_ocr_key != ocr_api.get("yandex_vision", ""):
            if "ocr_api" not in st.session_state:
                st.session_state.ocr_api = {}
            st.session_state.ocr_api["yandex_vision"] = yandex_ocr_key
            st.session_state.ocr_api["yandex_folder"] = ocr_folder
            save_current_settings()
            if yandex_ocr_key and ocr_folder:
                st.success("‚úÖ Yandex Vision –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        st.markdown("---")
        st.markdown("**‚òÅÔ∏è Google Cloud Vision OCR**")
        
        google_ocr_key = st.text_input(
            "API Key Google Vision",
            type="password",
            value=ocr_api.get("google_vision", ""),
            key="ocr_google_key",
            placeholder="AIza..."
        )
        
        if google_ocr_key != ocr_api.get("google_vision", ""):
            if "ocr_api" not in st.session_state:
                st.session_state.ocr_api = {}
            st.session_state.ocr_api["google_vision"] = google_ocr_key
            save_current_settings()
            if google_ocr_key:
                st.success("‚úÖ Google Vision –Ω–∞—Å—Ç—Ä–æ–µ–Ω")


def render_login():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞."""
    st.markdown("""
    <div style="text-align:center;padding:50px;">
        <div class="traffic-light" style="justify-content:center;display:flex;gap:10px;margin-bottom:20px;">
            <span class="tl-red"></span>
            <span class="tl-yellow"></span>
            <span class="tl-green"></span>
        </div>
        <h1>–†–ï–ì–õ–ê–ú–ï–ù–¢ –°–í–ï–¢–û–§–û–†</h1>
        <p style="color:#c41e3a;font-weight:600;">–ê–û ¬´–°–ü–ö¬ª</p>
        <p style="color:#666;">–°–∏—Å—Ç–µ–º–∞ AI-–∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ v7.16</p>
    </div>
    """, unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        with st.form("login_form"):
            login = st.text_input("–õ–æ–≥–∏–Ω", placeholder="admin")
            password = st.text_input("–ü–∞—Ä–æ–ª—å", type="password", placeholder="admin123")
            
            if st.form_submit_button("–í–æ–π—Ç–∏", use_container_width=True):
                # –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                users = {
                    "admin": ("admin123", "admin"),
                    "user": ("user123", "user"),
                    "—é—Ä–∏—Å—Ç": ("lawyer123", "lawyer"),
                }
                
                if login in users and password == users[login][0]:
                    st.session_state.–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω = True
                    st.session_state.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = login
                    st.session_state.—Ä–æ–ª—å = users[login][1]
                    st.rerun()
                else:
                    st.error("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
        
        st.caption("–î–µ–º–æ: admin/admin123 –∏–ª–∏ user/user123")


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    init_session_state()
    apply_styles()
    
    if not st.session_state.get("–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"):
        render_login()
        return
    
    render_header()
    render_sidebar()
    
    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
    if st.session_state.get("show_history"):
        render_history()
        if st.button("‚Üê –ù–∞–∑–∞–¥"):
            st.session_state.show_history = False
            st.rerun()
        return
    
    # –í–∫–ª–∞–¥–∫–∏
    if st.session_state.get("—Ä–æ–ª—å") == "admin":
        tabs = st.tabs(["üìÑ –ê–Ω–∞–ª–∏–∑", "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "üìú –ò—Å—Ç–æ—Ä–∏—è"])
        
        with tabs[0]:
            text = render_upload_section()
            if text:
                render_analysis_section(text)
        
        with tabs[1]:
            render_settings()
        
        with tabs[2]:
            render_history()
    else:
        text = render_upload_section()
        if text:
            render_analysis_section(text)


if __name__ == "__main__":
    main()
