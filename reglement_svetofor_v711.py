"""
–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä v7.11
–ê–û ¬´–°–ü–ö¬ª ‚Äî –°—Ç—Ä–æ–≥–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è + RAG + OCR + –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω

–ò–°–ü–†–ê–í–õ–ï–ù–û:
1. –°—Ç—Ä–æ–≥–∞—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (–ø–æ –ì–ö –†–§, –ì–û–°–¢)
2. RAG —Ç–µ–ø–µ—Ä—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ö–†–ê–°–ù–´–ô, –Ω—É–∂–Ω–æ –¥–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –Ω–µ-–¥–æ–≥–æ–≤–æ—Ä–æ–≤
"""

import streamlit as st

# –û—Ç–∫–ª—é—á–∞–µ–º file watcher –¥–ª—è Streamlit Cloud (–ø—Ä–æ–±–ª–µ–º–∞ inotify)
import os
os.environ["STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION"] = "false"
os.environ["STREAMLIT_LOGGER_LEVEL"] = "warning"
import re, json, hashlib, io, time
from datetime import datetime, date
from typing import Dict, List, Tuple, Optional
from dataclasses import dataclass

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏
DOCX_AVAILABLE = False
PDF_AVAILABLE = False
REQUESTS_AVAILABLE = False
OCR_AVAILABLE = False
PDF2IMAGE_AVAILABLE = False
PIL_AVAILABLE = False

try:
    from docx import Document as DocxDocument
    DOCX_AVAILABLE = True
except:
    pass

try:
    from PyPDF2 import PdfReader
    PDF_AVAILABLE = True
except:
    pass

try:
    import requests
    REQUESTS_AVAILABLE = True
except:
    pass

try:
    from PIL import Image
    PIL_AVAILABLE = True
except:
    pass

try:
    import pytesseract
    OCR_AVAILABLE = True
except:
    pass

try:
    from pdf2image import convert_from_bytes
    PDF2IMAGE_AVAILABLE = True
except:
    pass

# –§–æ—Ä–º–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è OCR
IMAGE_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.tiff', '.tif', '.bmp', '.gif', '.webp']

st.set_page_config(page_title="–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä | –°–ü–ö", page_icon="üö¶", layout="wide")

# ============================================================================
# OCR –ú–û–î–£–õ–¨ (pytesseract)
# ============================================================================

class OCRProcessor:
    """OCR –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (pytesseract + pdf2image)."""
    
    TESSERACT_CONFIG = r'--oem 3 --psm 3'
    LANGUAGES = 'rus+eng'
    
    @classmethod
    def is_available(cls):
        if not OCR_AVAILABLE:
            return False, "pytesseract –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        if not PIL_AVAILABLE:
            return False, "Pillow –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        try:
            version = pytesseract.get_tesseract_version()
            return True, f"Tesseract v{version}"
        except Exception as e:
            return False, f"Tesseract –Ω–µ –Ω–∞–π–¥–µ–Ω: {e}"
    
    @classmethod
    def ocr_image(cls, image):
        if not OCR_AVAILABLE or not PIL_AVAILABLE:
            return ""
        try:
            if image.mode != 'RGB':
                image = image.convert('RGB')
            return pytesseract.image_to_string(image, lang=cls.LANGUAGES, config=cls.TESSERACT_CONFIG).strip()
        except Exception as e:
            return f"[OCR –æ—à–∏–±–∫–∞: {e}]"
    
    @classmethod
    def ocr_image_bytes(cls, image_bytes, filename=""):
        if not PIL_AVAILABLE:
            return False, "Pillow –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        try:
            image = Image.open(io.BytesIO(image_bytes))
            text = cls.ocr_image(image)
            return (True, text) if text else (False, "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å")
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞: {e}"
    
    @classmethod
    def ocr_pdf(cls, pdf_bytes):
        if not PDF2IMAGE_AVAILABLE:
            return False, "pdf2image –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        if not OCR_AVAILABLE:
            return False, "pytesseract –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        try:
            images = convert_from_bytes(pdf_bytes, dpi=200)
            all_text = []
            for i, image in enumerate(images):
                page_text = cls.ocr_image(image)
                if page_text:
                    all_text.append(f"--- –°—Ç—Ä–∞–Ω–∏—Ü–∞ {i+1} ---\n{page_text}")
            return (True, "\n\n".join(all_text)) if all_text else (False, "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å")
        except Exception as e:
            return False, f"–û—à–∏–±–∫–∞ OCR PDF: {e}"
    
    @classmethod
    def get_ocr_status(cls):
        available, message = cls.is_available()
        return {"available": available, "message": message, "pytesseract": OCR_AVAILABLE, "pillow": PIL_AVAILABLE, "pdf2image": PDF2IMAGE_AVAILABLE}

# ============================================================================
# –ö–û–ù–°–¢–ê–ù–¢–´
# ============================================================================

–†–û–õ–¨_–ê–î–ú–ò–ù = "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
–†–û–õ–¨_–Æ–ó–ï–† = "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

DEFAULT_ORG = {"full_name": '–ê–û ¬´–°–ü–ö¬ª', "short_name": '–ê–û ¬´–°–ü–ö¬ª', "inn": "7701234567"}
DEFAULT_THRESHOLDS = {"–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å": 100_000, "–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å": 50_000, "–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å": 5_000_000}

–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò = {
    "admin": {"—Ö–µ—à": hashlib.sha256("admin123".encode()).hexdigest(), "—Ä–æ–ª—å": –†–û–õ–¨_–ê–î–ú–ò–ù, "–∏–º—è": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"},
    "legal": {"—Ö–µ—à": hashlib.sha256("legal123".encode()).hexdigest(), "—Ä–æ–ª—å": –†–û–õ–¨_–ê–î–ú–ò–ù, "–∏–º—è": "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –Æ–î"},
}

AI_–ü–†–û–í–ê–ô–î–ï–†–´ = {
    "openai": {"–Ω–∞–∑–≤–∞–Ω–∏–µ": "OpenAI GPT-4", "url": "https://platform.openai.com/api-keys"},
    "anthropic": {"–Ω–∞–∑–≤–∞–Ω–∏–µ": "Anthropic Claude", "url": "https://console.anthropic.com/settings/keys"},
    "yandexgpt": {"–Ω–∞–∑–≤–∞–Ω–∏–µ": "YandexGPT", "url": "https://console.cloud.yandex.ru/"},
}

–ü–û–î–†–ê–ó–î–ï–õ–ï–ù–ò–Ø = ["–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –ø–µ—Ä–µ–≤–æ–∑–æ–∫", "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"]
–î–û–õ–ñ–ù–û–°–¢–ò = ["–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–í–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–ù–∞—á–∞–ª—å–Ω–∏–∫ –æ—Ç–¥–µ–ª–∞", "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞"]
–ö–†–ê–°–ù–ê–Ø_–ó–û–ù–ê = ["–ê—Ä–µ–Ω–¥–∞ –≤–∞–≥–æ–Ω–æ–≤", "–õ–∏–∑–∏–Ω–≥ –≤–∞–≥–æ–Ω–æ–≤", "–ü–æ–∫—É–ø–∫–∞ –≤–∞–≥–æ–Ω–æ–≤", "–î–æ–≥–æ–≤–æ—Ä —Å –†–ñ–î", "–ö—Ä–µ–¥–∏—Ç", "–ó–∞–π–º"]
–ñ–Å–õ–¢–ê–Ø_–ó–û–ù–ê = ["–î–æ–≥–æ–≤–æ—Ä –¢–≠–û", "–†–∞–º–æ—á–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä", "–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫"]
–§–û–†–ú–´_–î–û–ö–£–ú–ï–ù–¢–ê = ["–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ (–¢–§)", "–§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞", "–°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞"]

# ============================================================================
# –°–¢–†–û–ì–ê–Ø –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –î–û–ì–û–í–û–†–û–í (–ø–æ –ì–ö –†–§, –ì–û–°–¢ –† 7.0.97-2016)
# ============================================================================

class –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–î–æ–≥–æ–≤–æ—Ä–∞:
    """
    –°—Ç—Ä–æ–≥–∞—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤.
    –ü–æ –ì–ö –†–§ —Å—Ç. 420, 432: –¥–æ–≥–æ–≤–æ—Ä = —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –¥–≤—É—Ö+ –ª–∏—Ü –æ –ø—Ä–∞–≤–∞—Ö/–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—è—Ö.
    –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã: —Å—Ç–æ—Ä–æ–Ω—ã, –ø—Ä–µ–¥–º–µ—Ç, —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è, –ø–æ–¥–ø–∏—Å–∏.
    """
    
    # ===== –ü–ê–¢–¢–ï–†–ù–´ –ó–ê–ì–û–õ–û–í–ö–û–í –î–û–ì–û–í–û–†–û–í =====
    –ó–ê–ì–û–õ–û–í–ö–ò_–î–û–ì–û–í–û–†–û–í = [
        r'^(?:–î–û–ì–û–í–û–†|–î–æ–≥–æ–≤–æ—Ä)\s+(?:‚Ññ|N|–Ω–æ–º–µ—Ä)?\s*[\w\-/]*',
        r'^(?:–î–û–ì–û–í–û–†|–î–æ–≥–æ–≤–æ—Ä)\s+(?:–æ–∫–∞–∑–∞–Ω–∏—è\s+—É—Å–ª—É–≥|–ø–æ—Å—Ç–∞–≤–∫–∏|–ø–æ–¥—Ä—è–¥–∞|–∞—Ä–µ–Ω–¥—ã|–∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏|–∑–∞–π–º–∞|—Ö—Ä–∞–Ω–µ–Ω–∏—è)',
        r'^(?:–ö–û–ù–¢–†–ê–ö–¢|–ö–æ–Ω—Ç—Ä–∞–∫—Ç)\s',
        r'^(?:–°–û–ì–õ–ê–®–ï–ù–ò–ï|–°–æ–≥–ª–∞—à–µ–Ω–∏–µ)\s+(?:‚Ññ|–æ\s)',
        r'^(?:–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ï\s+–°–û–ì–õ–ê–®–ï–ù–ò–ï|–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ\s+—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ)',
    ]
    
    # ===== –ü–ê–¢–¢–ï–†–ù–´ –°–¢–û–†–û–ù –î–û–ì–û–í–û–†–ê (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ –ì–ö –†–§) =====
    –ü–ê–¢–¢–ï–†–ù–´_–°–¢–û–†–û–ù = [
        r'(?:–∏–º–µ–Ω—É–µ–º\w*|–¥–∞–ª–µ–µ)\s*[¬´"]?\s*(?:–ó–∞–∫–∞–∑—á–∏–∫|–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å|–ü–æ–∫—É–ø–∞—Ç–µ–ª—å|–ü—Ä–æ–¥–∞–≤–µ—Ü|–ü–æ—Å—Ç–∞–≤—â–∏–∫|–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä|–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å|–ü–æ–¥—Ä—è–¥—á–∏–∫|–ó–∞—ë–º—â–∏–∫|–ó–∞–π–º–æ–¥–∞–≤–µ—Ü)',
        r'(?:–°—Ç–æ—Ä–æ–Ω–∞\s*[12]|–ü–µ—Ä–≤–∞—è\s+—Å—Ç–æ—Ä–æ–Ω–∞|–í—Ç–æ—Ä–∞—è\s+—Å—Ç–æ—Ä–æ–Ω–∞)',
        r'–≤\s+–ª–∏—Ü–µ\s+[\w\s]+,?\s*–¥–µ–π—Å—Ç–≤—É—é—â\w+\s+–Ω–∞\s+–æ—Å–Ω–æ–≤–∞–Ω–∏–∏',
        r'(?:–û–û–û|–û–ê–û|–ó–ê–û|–ü–ê–û|–ê–û|–ò–ü)\s*[¬´"][^¬ª"]+[¬ª"].*?(?:–∏–º–µ–Ω—É–µ–º|–¥–∞–ª–µ–µ)',
    ]
    
    # ===== –ü–ê–¢–¢–ï–†–ù–´ –†–ï–ö–í–ò–ó–ò–¢–û–í (–û–ì–†–ù, –ò–ù–ù, –ö–ü–ü, –±–∞–Ω–∫) =====
    –ü–ê–¢–¢–ï–†–ù–´_–†–ï–ö–í–ò–ó–ò–¢–û–í = [
        r'–ò–ù–ù\s*:?\s*\d{10,12}',
        r'–û–ì–†–ù\s*:?\s*\d{13,15}',
        r'–ö–ü–ü\s*:?\s*\d{9}',
        r'[–†—Ä–ü]/[–°—Å](?:—á—ë—Ç|—á–µ—Ç)?\s*:?\s*\d{20}',
        r'–ë–ò–ö\s*:?\s*\d{9}',
        r'(?:–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π|–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π)\s+–∞–¥—Ä–µ—Å',
        r'(?:–†–ï–ö–í–ò–ó–ò–¢–´|–†–µ–∫–≤–∏–∑–∏—Ç—ã)\s+(?:–°–¢–û–†–û–ù|—Å—Ç–æ—Ä–æ–Ω|–ò\s+–ü–û–î–ü–ò–°–ò)',
    ]
    
    # ===== –ü–ê–¢–¢–ï–†–ù–´ –°–¢–†–£–ö–¢–£–†–´ –î–û–ì–û–í–û–†–ê =====
    –ü–ê–¢–¢–ï–†–ù–´_–†–ê–ó–î–ï–õ–û–í = [
        r'(?:^|\n)\s*\d+\.\s*(?:–ü–†–ï–î–ú–ï–¢|–ü—Ä–µ–¥–º–µ—Ç)\s+(?:–î–û–ì–û–í–û–†–ê|–¥–æ–≥–æ–≤–æ—Ä–∞|–°–û–ì–õ–ê–®–ï–ù–ò–Ø)',
        r'(?:^|\n)\s*\d+\.\s*(?:–ü–†–ê–í–ê|–ü—Ä–∞–≤–∞)\s+(?:–ò|–∏)\s+(?:–û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò|–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏)',
        r'(?:^|\n)\s*\d+\.\s*(?:–¶–ï–ù–ê|–¶–µ–Ω–∞|–°–¢–û–ò–ú–û–°–¢–¨|–°—Ç–æ–∏–º–æ—Å—Ç—å)',
        r'(?:^|\n)\s*\d+\.\s*(?:–ü–û–†–Ø–î–û–ö|–ü–æ—Ä—è–¥–æ–∫)\s+(?:–†–ê–°–ß–Å–¢–û–í|—Ä–∞—Å—á—ë—Ç–æ–≤|–û–ü–õ–ê–¢–´|–æ–ø–ª–∞—Ç—ã)',
        r'(?:^|\n)\s*\d+\.\s*(?:–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨|–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å)',
        r'(?:^|\n)\s*\d+\.\s*(?:–°–†–û–ö|–°—Ä–æ–∫)\s+(?:–î–ï–ô–°–¢–í–ò–Ø|–¥–µ–π—Å—Ç–≤–∏—è|–î–û–ì–û–í–û–†–ê)',
        r'(?:^|\n)\s*\d+\.\s*(?:–§–û–†–°-–ú–ê–ñ–û–†|–§–æ—Ä—Å-–º–∞–∂–æ—Ä|–ù–ï–ü–†–ï–û–î–û–õ–ò–ú)',
        r'(?:^|\n)\s*\d+\.\s*(?:–ü–û–†–Ø–î–û–ö|–ü–æ—Ä—è–¥–æ–∫)\s+(?:–†–ê–ó–†–ï–®–ï–ù–ò–Ø|—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)\s+(?:–°–ü–û–†–û–í|—Å–ø–æ—Ä–æ–≤)',
        r'(?:^|\n)\s*\d+\.\s*(?:–ó–ê–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–´–ï|–ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ|–ü–†–û–ß–ò–ï|–ü—Ä–æ—á–∏–µ)',
    ]
    
    # ===== –î–û–ì–û–í–û–†–ù–´–ï –§–û–†–ú–£–õ–ò–†–û–í–ö–ò (–ø–æ –ì–ö –†–§) =====
    –§–û–†–ú–£–õ–ò–†–û–í–ö–ò_–î–û–ì–û–í–û–†–ê = [
        r'–æ–±—è–∑—É–µ—Ç—Å—è\s+(?:–ø–µ—Ä–µ–¥–∞—Ç—å|–æ–∫–∞–∑–∞—Ç—å|–≤—ã–ø–æ–ª–Ω–∏—Ç—å|–ø–æ—Å—Ç–∞–≤–∏—Ç—å|–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å)',
        r'–ø—Ä–∏–Ω–∏–º–∞–µ—Ç\s+–Ω–∞\s+—Å–µ–±—è\s+–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤',
        r'–∏–º–µ–µ—Ç\s+–ø—Ä–∞–≤–æ\s+(?:—Ç—Ä–µ–±–æ–≤–∞—Ç—å|–ø–æ–ª—É—á–∏—Ç—å|–æ—Ç–∫–∞–∑–∞—Ç—å—Å—è)',
        r'–Ω–µ—Å—ë—Ç\s+–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å\s+(?:–∑–∞|–≤\s+—Å–ª—É—á–∞–µ)',
        r'–≤\s+—Å–ª—É—á–∞–µ\s+(?:–Ω–∞—Ä—É—à–µ–Ω–∏—è|–Ω–µ–∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è|–ø—Ä–æ—Å—Ä–æ—á–∫–∏)',
        r'–Ω–µ—É—Å—Ç–æ–π–∫\w+\s+–≤\s+—Ä–∞–∑–º–µ—Ä–µ',
        r'—à—Ç—Ä–∞—Ñ\w*\s+(?:–≤\s+—Ä–∞–∑–º–µ—Ä–µ|—Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç)',
        r'(?:–Ω–∞—Å—Ç–æ—è—â–∏–π|–¥–∞–Ω–Ω—ã–π)\s+(?:–¥–æ–≥–æ–≤–æ—Ä|–∫–æ–Ω—Ç—Ä–∞–∫—Ç)\s+(?:–≤—Å—Ç—É–ø–∞–µ—Ç|–¥–µ–π—Å—Ç–≤—É–µ—Ç|–∑–∞–∫–ª—é—á—ë–Ω)',
        r'–∑–∞–∫–ª—é—á–∏–ª–∏\s+(?:–Ω–∞—Å—Ç–æ—è—â–∏–π\s+)?(?:–¥–æ–≥–æ–≤–æ—Ä|—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ|–∫–æ–Ω—Ç—Ä–∞–∫—Ç)',
        r'–¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å\s+–æ\s+(?:–Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º|—Å–ª–µ–¥—É—é—â–µ–º)',
    ]
    
    # ===== –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø ‚Äî –≠–¢–û –ù–ï –î–û–ì–û–í–û–†–´ =====
    –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø_–ó–ê–ì–û–õ–û–í–ö–ò = [
        r'^(?:–†–ï–ì–õ–ê–ú–ï–ù–¢|–†–µ–≥–ª–∞–º–µ–Ω—Ç|–ü–û–õ–û–ñ–ï–ù–ò–ï|–ü–æ–ª–æ–∂–µ–Ω–∏–µ|–ò–ù–°–¢–†–£–ö–¶–ò–Ø|–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)',
        r'^(?:–ü–†–ò–ö–ê–ó|–ü—Ä–∏–∫–∞–∑|–†–ê–°–ü–û–†–Ø–ñ–ï–ù–ò–ï|–†–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–µ)\s*(?:‚Ññ|N)',
        r'^(?:–ü–†–û–¢–û–ö–û–õ|–ü—Ä–æ—Ç–æ–∫–æ–ª)\s',
        r'^(?:–ê–ö–¢|–ê–∫—Ç)\s+(?:–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö|–ø—Ä–∏—ë–º–∞|—Å–≤–µ—Ä–∫–∏|–æ—Å–º–æ—Ç—Ä–∞)',
        r'^(?:–°–ß–Å–¢|–°—á—ë—Ç|–°–ß–ï–¢|–°—á–µ—Ç)\s*(?:‚Ññ|N|-|–Ω–∞\s+–æ–ø–ª–∞—Ç—É)',
        r'^(?:–ù–ê–ö–õ–ê–î–ù–ê–Ø|–ù–∞–∫–ª–∞–¥–Ω–∞—è|–¢–û–í–ê–†–ù–ê–Ø\s+–ù–ê–ö–õ–ê–î–ù–ê–Ø)',
        r'^(?:–°–õ–£–ñ–ï–ë–ù–ê–Ø\s+–ó–ê–ü–ò–°–ö–ê|–°–ª—É–∂–µ–±–Ω–∞—è\s+–∑–∞–ø–∏—Å–∫–∞|–î–û–ö–õ–ê–î–ù–ê–Ø)',
        r'^(?:–ü–û–õ–ò–¢–ò–ö–ê|–ü–æ–ª–∏—Ç–∏–∫–∞|–ü–†–û–¶–ï–î–£–†–ê|–ü—Ä–æ—Ü–µ–¥—É—Ä–∞)',
        r'^(?:–û–¢–ß–Å–¢|–û—Ç—á—ë—Ç|–û–¢–ß–ï–¢|–û—Ç—á–µ—Ç|–ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø)',
        r'^(?:–ó–ê–Ø–í–ö–ê|–ó–∞—è–≤–∫–∞|–ó–ê–Ø–í–õ–ï–ù–ò–ï|–ó–∞—è–≤–ª–µ–Ω–∏–µ)\s',
        r'^(?:–î–û–í–ï–†–ï–ù–ù–û–°–¢–¨|–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)\s*(?:‚Ññ|N)',
        r'^(?:–£–°–¢–ê–í|–£—Å—Ç–∞–≤|–£–ß–†–ï–î–ò–¢–ï–õ–¨–ù–´–ô)',
        r'^(?:–°–ü–†–ê–í–ö–ê|–°–ø—Ä–∞–≤–∫–∞)\s',
    ]
    
    –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø_–°–û–î–ï–†–ñ–ê–ù–ò–ï = [
        r'(?:–£–¢–í–ï–†–ñ–î–ê–Æ|–£—Ç–≤–µ—Ä–∂–¥–∞—é)\s*(?:–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π|–î–∏—Ä–µ–∫—Ç–æ—Ä)',
        r'(?:–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\s+–∫\s+–ø—Ä–∏–∫–∞–∑—É|–ü–†–ò–õ–û–ñ–ï–ù–ò–ï\s+–ö\s+–ü–†–ò–ö–ê–ó–£)',
        r'(?:–ü—Ä–æ—Ç–æ–∫–æ–ª\s+(?:–∑–∞—Å–µ–¥–∞–Ω–∏—è|—Å–æ–≤–µ—â–∞–Ω–∏—è|—Å–æ–±—Ä–∞–Ω–∏—è))',
        r'(?:–ù–∞—Å—Ç–æ—è—â\w+\s+(?:—Ä–µ–≥–ª–∞–º–µ–Ω—Ç|–ø–æ–ª–æ–∂–µ–Ω–∏–µ|–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)\s+(?:–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç|—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç|—Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç))',
        r'(?:–∞–∫—Ç\s+(?:–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö\s+—Ä–∞–±–æ—Ç|–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö\s+—É—Å–ª—É–≥|–ø—Ä–∏—ë–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏))',
        r'(?:–∫\s+–æ–ø–ª–∞—Ç–µ|–∏—Ç–æ–≥–æ\s+–∫\s+–æ–ø–ª–∞—Ç–µ|–≤—Å–µ–≥–æ\s+–∫\s+–æ–ø–ª–∞—Ç–µ)',
    ]
    
    @classmethod
    def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–∑–∞–≥–æ–ª–æ–≤–æ–∫(cls, —Ç–µ–∫—Å—Ç: str) -> Tuple[bool, int]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ–≤–∞ –î–û–ì–û–í–û–†/–ö–û–ù–¢–†–ê–ö–¢"""
        –ø–µ—Ä–≤—ã–µ_—Å—Ç—Ä–æ–∫–∏ = —Ç–µ–∫—Å—Ç[:500]
        score = 0
        
        for pattern in cls.–ó–ê–ì–û–õ–û–í–ö–ò_–î–û–ì–û–í–û–†–û–í:
            if re.search(pattern, –ø–µ—Ä–≤—ã–µ_—Å—Ç—Ä–æ–∫–∏, re.MULTILINE | re.IGNORECASE):
                score += 25
                break
        
        return score > 0, score
    
    @classmethod
    def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Å—Ç–æ—Ä–æ–Ω—ã(cls, —Ç–µ–∫—Å—Ç: str) -> Tuple[bool, int, List[str]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å—Ç–æ—Ä–æ–Ω –¥–æ–≥–æ–≤–æ—Ä–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ –ì–ö –†–§)"""
        –Ω–∞–π–¥–µ–Ω–Ω—ã–µ = []
        score = 0
        
        for pattern in cls.–ü–ê–¢–¢–ï–†–ù–´_–°–¢–û–†–û–ù:
            matches = re.findall(pattern, —Ç–µ–∫—Å—Ç, re.IGNORECASE)
            if matches:
                score += 15
                –Ω–∞–π–¥–µ–Ω–Ω—ã–µ.extend(matches[:2])
        
        # –ú–∏–Ω–∏–º—É–º 2 —Å—Ç–æ—Ä–æ–Ω—ã
        return len(–Ω–∞–π–¥–µ–Ω–Ω—ã–µ) >= 2, score, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ[:4]
    
    @classmethod
    def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ä–µ–∫–≤–∏–∑–∏—Ç—ã(cls, —Ç–µ–∫—Å—Ç: str) -> Tuple[bool, int, List[str]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ (–ò–ù–ù, –û–ì–†–ù, –±–∞–Ω–∫)"""
        –Ω–∞–π–¥–µ–Ω–Ω—ã–µ = []
        score = 0
        
        for pattern in cls.–ü–ê–¢–¢–ï–†–ù–´_–†–ï–ö–í–ò–ó–ò–¢–û–í:
            matches = re.findall(pattern, —Ç–µ–∫—Å—Ç, re.IGNORECASE)
            if matches:
                score += 10
                –Ω–∞–π–¥–µ–Ω–Ω—ã–µ.append(pattern.split(r'\s')[0].replace('\\', '').replace('(?:', ''))
        
        return score >= 20, score, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ
    
    @classmethod
    def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Å—Ç—Ä—É–∫—Ç—É—Ä—É(cls, —Ç–µ–∫—Å—Ç: str) -> Tuple[bool, int, List[str]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—Ä–∞–∑–¥–µ–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞)"""
        –Ω–∞–π–¥–µ–Ω–Ω—ã–µ = []
        score = 0
        
        for pattern in cls.–ü–ê–¢–¢–ï–†–ù–´_–†–ê–ó–î–ï–õ–û–í:
            if re.search(pattern, —Ç–µ–∫—Å—Ç, re.IGNORECASE | re.MULTILINE):
                score += 8
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
                match = re.search(pattern, —Ç–µ–∫—Å—Ç, re.IGNORECASE | re.MULTILINE)
                if match:
                    –Ω–∞–π–¥–µ–Ω–Ω—ã–µ.append(match.group(0).strip()[:50])
        
        return score >= 24, score, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ  # –ú–∏–Ω–∏–º—É–º 3 —Ä–∞–∑–¥–µ–ª–∞
    
    @classmethod
    def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏(cls, —Ç–µ–∫—Å—Ç: str) -> Tuple[bool, int]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫"""
        score = 0
        
        for pattern in cls.–§–û–†–ú–£–õ–ò–†–û–í–ö–ò_–î–û–ì–û–í–û–†–ê:
            if re.search(pattern, —Ç–µ–∫—Å—Ç, re.IGNORECASE):
                score += 7
        
        return score >= 21, score  # –ú–∏–Ω–∏–º—É–º 3 —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
    
    @classmethod
    def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–∏—Å–∫–ª—é—á–µ–Ω–∏—è(cls, —Ç–µ–∫—Å—Ç: str) -> Tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç—Ç–æ –ù–ï –¥–æ–≥–æ–≤–æ—Ä (—Ä–µ–≥–ª–∞–º–µ–Ω—Ç, –∞–∫—Ç, —Å—á—ë—Ç –∏ —Ç.–¥.)"""
        –ø–µ—Ä–≤—ã–µ_—Å—Ç—Ä–æ–∫–∏ = —Ç–µ–∫—Å—Ç[:1000]
        
        for pattern in cls.–ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø_–ó–ê–ì–û–õ–û–í–ö–ò:
            match = re.search(pattern, –ø–µ—Ä–≤—ã–µ_—Å—Ç—Ä–æ–∫–∏, re.MULTILINE | re.IGNORECASE)
            if match:
                —Ç–∏–ø = match.group(0).strip().upper()
                return True, —Ç–∏–ø
        
        for pattern in cls.–ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø_–°–û–î–ï–†–ñ–ê–ù–ò–ï:
            if re.search(pattern, —Ç–µ–∫—Å—Ç[:3000], re.IGNORECASE):
                return True, "–ù–ï –î–û–ì–û–í–û–†"
        
        return False, ""
    
    @classmethod
    def –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å_—Ç–∏–ø_–¥–æ–≥–æ–≤–æ—Ä–∞(cls, —Ç–µ–∫—Å—Ç: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–æ–≥–æ–≤–æ—Ä–∞"""
        —Ç–µ–∫—Å—Ç_l = —Ç–µ–∫—Å—Ç.lower()
        
        —Ç–∏–ø—ã = [
            (r'(?:–æ–∫–∞–∑–∞–Ω–∏\w+\s+—É—Å–ª—É–≥|—É—Å–ª—É–≥–∏|—Ç—ç–æ|—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω)', "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥"),
            (r'(?:–ø–æ—Å—Ç–∞–≤–∫\w+|–ø–æ—Å—Ç–∞–≤—â–∏–∫.*–ø–æ–∫—É–ø–∞—Ç–µ–ª—å)', "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏"),
            (r'(?:–ø–æ–¥—Ä—è–¥\w+|–ø–æ–¥—Ä—è–¥—á–∏–∫.*–∑–∞–∫–∞–∑—á–∏–∫)', "–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞"),
            (r'(?:–∞—Ä–µ–Ω–¥\w+|–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä|–∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å)', "–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã"),
            (r'(?:–∫—É–ø–ª\w+-–ø—Ä–æ–¥–∞–∂\w+|–ø—Ä–æ–¥–∞–≤–µ—Ü.*–ø–æ–∫—É–ø–∞—Ç–µ–ª—å)', "–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏"),
            (r'(?:–∑–∞–π–º\w+|–∑–∞—ë–º—â–∏–∫|–∑–∞–π–º–æ–¥–∞–≤–µ—Ü)', "–î–æ–≥–æ–≤–æ—Ä –∑–∞–π–º–∞"),
            (r'(?:—Ö—Ä–∞–Ω–µ–Ω–∏\w+|—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å|–ø–æ–∫–ª–∞–∂–µ–¥–∞—Ç–µ–ª—å)', "–î–æ–≥–æ–≤–æ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è"),
            (r'(?:–∞–≥–µ–Ω—Ç—Å–∫\w+|–∞–≥–µ–Ω—Ç.*–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª)', "–ê–≥–µ–Ω—Ç—Å–∫–∏–π –¥–æ–≥–æ–≤–æ—Ä"),
            (r'(?:–ª–∏—Ü–µ–Ω–∑–∏\w+|–ª–∏—Ü–µ–Ω–∑–∏–∞—Ä|–ª–∏—Ü–µ–Ω–∑–∏–∞—Ç)', "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä"),
        ]
        
        for pattern, –Ω–∞–∑–≤–∞–Ω–∏–µ in —Ç–∏–ø—ã:
            if re.search(pattern, —Ç–µ–∫—Å—Ç_l):
                return –Ω–∞–∑–≤–∞–Ω–∏–µ
        
        return "–î–æ–≥–æ–≤–æ—Ä (—Ç–∏–ø –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω)"
    
    @classmethod
    def –ø–æ–ª–Ω–∞—è_–ø—Ä–æ–≤–µ—Ä–∫–∞(cls, —Ç–µ–∫—Å—Ç: str) -> dict:
        """
        –ü–û–õ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–º.
        
        –ö—Ä–∏—Ç–µ—Ä–∏–∏ (–ø–æ –ì–ö –†–§ —Å—Ç. 432):
        1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–î–æ–≥–æ–≤–æ—Ä" / "–ö–æ–Ω—Ç—Ä–∞–∫—Ç" / "–°–æ–≥–ª–∞—à–µ–Ω–∏–µ"
        2. –ù–∞–ª–∏—á–∏–µ –º–∏–Ω–∏–º—É–º 2 —Å—Ç–æ—Ä–æ–Ω
        3. –†–µ–∫–≤–∏–∑–∏—Ç—ã (–ò–ù–ù, –û–ì–†–ù)
        4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Ä–∞–∑–¥–µ–ª—ã)
        5. –î–æ–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
        6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
        
        –î–ª—è –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–º –Ω—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 60 –±–∞–ª–ª–æ–≤ –∏–∑ 100.
        """
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç = {
            "—ç—Ç–æ_–¥–æ–≥–æ–≤–æ—Ä": False,
            "—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": 0,
            "—Ç–∏–ø": "",
            "–ø—Ä–∏—á–∏–Ω–∞": "",
            "–¥–µ—Ç–∞–ª–∏": {},
            "–º–æ–∂–Ω–æ_–ø—Ä–æ–≤–µ—Ä—è—Ç—å": False,
        }
        
        # 0. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        —ç—Ç–æ_–∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —Ç–∏–ø_–∏—Å–∫–ª—é—á–µ–Ω–∏—è = cls.–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–∏—Å–∫–ª—é—á–µ–Ω–∏—è(—Ç–µ–∫—Å—Ç)
        if —ç—Ç–æ_–∏—Å–∫–ª—é—á–µ–Ω–∏–µ:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—ç—Ç–æ_–¥–æ–≥–æ–≤–æ—Ä"] = False
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ç–∏–ø"] = —Ç–∏–ø_–∏—Å–∫–ª—é—á–µ–Ω–∏—è
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–ø—Ä–∏—á–∏–Ω–∞"] = f"–î–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ {—Ç–∏–ø_–∏—Å–∫–ª—é—á–µ–Ω–∏—è}, –∞ –Ω–µ –¥–æ–≥–æ–≤–æ—Ä"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–º–æ–∂–Ω–æ_–ø—Ä–æ–≤–µ—Ä—è—Ç—å"] = False
            return —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        
        total_score = 0
        –¥–µ—Ç–∞–ª–∏ = {}
        
        # 1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–º–∞–∫—Å 25)
        ok, score = cls.–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–∑–∞–≥–æ–ª–æ–≤–æ–∫(—Ç–µ–∫—Å—Ç)
        total_score += score
        –¥–µ—Ç–∞–ª–∏["–∑–∞–≥–æ–ª–æ–≤–æ–∫"] = {"ok": ok, "score": score, "–º–∞–∫—Å": 25}
        
        # 2. –°—Ç–æ—Ä–æ–Ω—ã (–º–∞–∫—Å 30)
        ok, score, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ = cls.–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Å—Ç–æ—Ä–æ–Ω—ã(—Ç–µ–∫—Å—Ç)
        total_score += min(score, 30)
        –¥–µ—Ç–∞–ª–∏["—Å—Ç–æ—Ä–æ–Ω—ã"] = {"ok": ok, "score": min(score, 30), "–º–∞–∫—Å": 30, "–Ω–∞–π–¥–µ–Ω–æ": –Ω–∞–π–¥–µ–Ω–Ω—ã–µ}
        
        # 3. –†–µ–∫–≤–∏–∑–∏—Ç—ã (–º–∞–∫—Å 20)
        ok, score, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ = cls.–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ä–µ–∫–≤–∏–∑–∏—Ç—ã(—Ç–µ–∫—Å—Ç)
        total_score += min(score, 20)
        –¥–µ—Ç–∞–ª–∏["—Ä–µ–∫–≤–∏–∑–∏—Ç—ã"] = {"ok": ok, "score": min(score, 20), "–º–∞–∫—Å": 20, "–Ω–∞–π–¥–µ–Ω–æ": –Ω–∞–π–¥–µ–Ω–Ω—ã–µ}
        
        # 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (–º–∞–∫—Å 25)
        ok, score, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ = cls.–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Å—Ç—Ä—É–∫—Ç—É—Ä—É(—Ç–µ–∫—Å—Ç)
        total_score += min(score, 25)
        –¥–µ—Ç–∞–ª–∏["—Å—Ç—Ä—É–∫—Ç—É—Ä–∞"] = {"ok": ok, "score": min(score, 25), "–º–∞–∫—Å": 25, "–Ω–∞–π–¥–µ–Ω–æ": –Ω–∞–π–¥–µ–Ω–Ω—ã–µ}
        
        # 5. –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ (–º–∞–∫—Å 21)
        ok, score = cls.–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏(—Ç–µ–∫—Å—Ç)
        total_score += min(score, 21)
        –¥–µ—Ç–∞–ª–∏["—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏"] = {"ok": ok, "score": min(score, 21), "–º–∞–∫—Å": 21}
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–æ 100
        max_possible = 121
        —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å = min(100, int(total_score / max_possible * 100))
        
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å"] = —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–¥–µ—Ç–∞–ª–∏"] = –¥–µ—Ç–∞–ª–∏
        
        # –ü–æ—Ä–æ–≥: 50% = –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–≥–æ–≤–æ—Ä, 65% = —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –¥–æ–≥–æ–≤–æ—Ä
        if —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å >= 50:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—ç—Ç–æ_–¥–æ–≥–æ–≤–æ—Ä"] = True
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ç–∏–ø"] = cls.–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å_—Ç–∏–ø_–¥–æ–≥–æ–≤–æ—Ä–∞(—Ç–µ–∫—Å—Ç)
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–º–æ–∂–Ω–æ_–ø—Ä–æ–≤–µ—Ä—è—Ç—å"] = True
            
            if —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å >= 75:
                —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–ø—Ä–∏—á–∏–Ω–∞"] = "–î–æ–∫—É–º–µ–Ω—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä"
            elif —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å >= 60:
                —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–ø—Ä–∏—á–∏–Ω–∞"] = "–î–æ–∫—É–º–µ–Ω—Ç –ø–æ—Ö–æ–∂ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä"
            else:
                —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–ø—Ä–∏—á–∏–Ω–∞"] = "–í–æ–∑–º–æ–∂–Ω–æ –¥–æ–≥–æ–≤–æ—Ä, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é"
        else:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—ç—Ç–æ_–¥–æ–≥–æ–≤–æ—Ä"] = False
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ç–∏–ø"] = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–ø—Ä–∏—á–∏–Ω–∞"] = f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∞ (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å {—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å}%)"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–º–æ–∂–Ω–æ_–ø—Ä–æ–≤–µ—Ä—è—Ç—å"] = False
        
        return —Ä–µ–∑—É–ª—å—Ç–∞—Ç

# ============================================================================
# –¢–ò–ü–û–í–´–ï –§–û–†–ú–´ –° –ñ–Å–°–¢–ö–ò–ú–ò –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú–ò
# ============================================================================

–¢–ò–ü–û–í–´–ï_–§–û–†–ú–´ = {
    "—É—Å–ª—É–≥–∏_—Ç—ç–æ": {
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–î–æ–≥–æ–≤–æ—Ä –¢–≠–û",
        "–∫–æ–¥": "–¢–§-–°–ü–ö-001",
        "—Ä–æ–ª—å": "–ó–∞–∫–∞–∑—á–∏–∫",
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø (üî¥ –Ω–∞—Ä—É—à–µ–Ω–∏–µ = –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê)
        "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ": {
            "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞_–ø—Ä–µ–≤—ã—à–µ–Ω–∞": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –±–æ–ª–µ–µ 30%",
                "—ç—Ç–∞–ª–æ–Ω": "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–µ –±–æ–ª–µ–µ 30% –æ—Ç —Å—É–º–º—ã –¥–æ–≥–æ–≤–æ—Ä–∞",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–ø—Ä–µ–¥–æ–ø–ª–∞—Ç\w*.*?(?:[4-9]\d|100)\s*%",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ó–∞–≤—ã—à–µ–Ω–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∏—Å–∫–∏"
            },
            "–Ω–µ—É—Å—Ç–æ–π–∫–∞_—á—Ä–µ–∑–º–µ—Ä–Ω–∞—è": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ù–µ—É—Å—Ç–æ–π–∫–∞ –±–æ–ª–µ–µ 0.1% –≤ –¥–µ–Ω—å",
                "—ç—Ç–∞–ª–æ–Ω": "–ù–µ—É—Å—Ç–æ–π–∫–∞ –Ω–µ –±–æ–ª–µ–µ 0.1% –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–Ω–µ—É—Å—Ç–æ–π–∫\w*.*?(?:0[,.]?[2-9]|[1-9])\s*%\s*(?:–∑–∞\s+)?(?:–∫–∞–∂–¥—ã–π\s+)?–¥–µ–Ω—å",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ß—Ä–µ–∑–º–µ—Ä–Ω–∞—è –Ω–µ—É—Å—Ç–æ–π–∫–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –ø—Ä–∞–∫—Ç–∏–∫–µ"
            },
            "—à—Ç—Ä–∞—Ñ_–ø—Ä–æ—Å—Ç–æ–π_–ø—Ä–µ–≤—ã—à–µ–Ω": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ç–æ–π –±–æ–ª–µ–µ 2500 —Ä—É–±/—Å—É—Ç–∫–∏",
                "—ç—Ç–∞–ª–æ–Ω": "–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ç–æ–π –≤–∞–≥–æ–Ω–æ–≤ –Ω–µ –±–æ–ª–µ–µ 2500 —Ä—É–±. –∑–∞ –≤–∞–≥–æ–Ω–æ-—Å—É—Ç–∫–∏",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"(?:—à—Ç—Ä–∞—Ñ|–ø—Ä–æ—Å—Ç–æ–π).*?(?:[3-9]\d{3}|[1-9]\d{4,})\s*(?:—Ä—É–±|‚ÇΩ)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ó–∞–≤—ã—à–µ–Ω–Ω—ã–π —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ç–æ–π"
            },
            "—à—Ç—Ä–∞—Ñ_–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–®—Ç—Ä–∞—Ñ –∑–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ 3 –º–ª–Ω",
                "—ç—Ç–∞–ª–æ–Ω": "–®—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –±–æ–ª–µ–µ 3 000 000 —Ä—É–±.",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"(?:—à—Ç—Ä–∞—Ñ|–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç).*?(?:[5-9]|[1-9]\d)\s*(?:000\s*000|–º–ª–Ω)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ù–µ–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å"
            },
            "–≤—Å–µ_—Ä–∏—Å–∫–∏_–Ω–∞_–∑–∞–∫–∞–∑—á–∏–∫–µ": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–í—Å–µ —Ä–∏—Å–∫–∏ –≤–æ–∑–ª–æ–∂–µ–Ω—ã –Ω–∞ –ó–∞–∫–∞–∑—á–∏–∫–∞",
                "—ç—Ç–∞–ª–æ–Ω": "–†–∏—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–µ–∂–¥—É —Å—Ç–æ—Ä–æ–Ω–∞–º–∏",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–∑–∞–∫–∞–∑—á–∏–∫.*?(?:–Ω–µ—Å—ë—Ç|–ø—Ä–∏–Ω–∏–º–∞–µ—Ç|–±–µ—Ä—ë—Ç).*?(?:–≤—Å–µ|–ª—é–±—ã–µ|–ø–æ–ª–Ω\w*)\s*—Ä–∏—Å–∫",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –≤–æ–∑–ª–æ–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤"
            },
            "–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ_–∏–∑–º–µ–Ω–µ–Ω–∏–µ_—Ü–µ–Ω—ã": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã/—Ç–∞—Ä–∏—Ñ–æ–≤",
                "—ç—Ç–∞–ª–æ–Ω": "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—é —Å—Ç–æ—Ä–æ–Ω",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"(?:–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å|–ø–æ—Å—Ç–∞–≤—â–∏–∫).*?(?:–≤–ø—Ä–∞–≤–µ|–º–æ–∂–µ—Ç).*?–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω\w*.*?(?:–∏–∑–º–µ–Ω—è|–ø–æ–≤—ã—à|—É–≤–µ–ª–∏—á)\w*.*?(?:—Ü–µ–Ω|—Ç–∞—Ä–∏—Ñ|—Å—Ç–æ–∏–º–æ—Å—Ç)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —É—Å–ª–æ–≤–∏–µ –ø–æ –ì–ö –†–§"
            },
            "–±–µ–∑_–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è_–Ω–µ—É—Å—Ç–æ–π–∫–∏": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ù–µ—É—Å—Ç–æ–π–∫–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å—É–º–º—ã",
                "—ç—Ç–∞–ª–æ–Ω": "–û–±—â–∞—è —Å—É–º–º–∞ –Ω–µ—É—Å—Ç–æ–π–∫–∏ –Ω–µ –±–æ–ª–µ–µ 10% –æ—Ç —Å—É–º–º—ã –¥–æ–≥–æ–≤–æ—Ä–∞",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"(?:–Ω–µ—É—Å—Ç–æ–π–∫|—à—Ç—Ä–∞—Ñ).*?–±–µ–∑\s*(?:–æ–≥—Ä–∞–Ω–∏—á–µ–Ω|–ª–∏–º–∏—Ç|–ø—Ä–µ–¥–µ–ª)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å"
            },
        },
        
        # –°–£–©–ï–°–¢–í–ï–ù–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø (üü° –Ω–∞—Ä—É—à–µ–Ω–∏–µ = –ñ–Å–õ–¢–ê–Ø –ó–û–ù–ê)
        "—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ": {
            "—Å—Ä–æ–∫_–æ–ø–ª–∞—Ç—ã_–∫–æ—Ä–æ—Ç–∫–∏–π": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã –º–µ–Ω–µ–µ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π",
                "—ç—Ç–∞–ª–æ–Ω": "–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã –Ω–µ –º–µ–Ω–µ–µ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–æ–ø–ª–∞—Ç\w*.*?(?:–≤\s+—Ç–µ—á–µ–Ω–∏–µ\s+)?(?:1|2|3|4)\s*(?:—Ä–∞–±–æ—á|–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω|–±–∞–Ω–∫–æ–≤—Å–∫)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã"
            },
            "–º–æ–ª—á–∞–Ω–∏–µ_—Å–æ–≥–ª–∞—Å–∏–µ": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ú–æ–ª—á–∞–Ω–∏–µ = —Å–æ–≥–ª–∞—Å–∏–µ —Å –∞–∫—Ç–æ–º",
                "—ç—Ç–∞–ª–æ–Ω": "–£—Å–ª—É–≥–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—ã–º–∏ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∞–∫—Ç–∞",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–º–æ–ª—á–∞–Ω–∏\w*.*?(?:–æ–∑–Ω–∞—á–∞–µ—Ç|—Å—á–∏—Ç–∞–µ—Ç—Å—è|—Ä–∞–≤–Ω–æ—Å–∏–ª—å–Ω\w*|–ø—Ä–∏—Ä–∞–≤–Ω\w*).*?(?:—Å–æ–≥–ª–∞—Å–∏|–∞–∫—Ü–µ–ø—Ç|–ø—Ä–∏–Ω—è—Ç)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–†–∏—Å–∫–æ–≤–∞–Ω–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ –æ –ø—Ä–∏—ë–º–∫–µ"
            },
            "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å_–Ω–µ_–æ—Ç–≤–µ—á–∞–µ—Ç": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏",
                "—ç—Ç–∞–ª–æ–Ω": "–í–∑–∞–∏–º–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª\w*.*?–Ω–µ\s+(?:–Ω–µ—Å—ë—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç|–≤–æ–∑–º–µ—â–∞–µ—Ç).*?(?:–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç|—É–±—ã—Ç–∫)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞"
            },
            "–∫–æ—Ä–æ—Ç–∫–∏–π_—Å—Ä–æ–∫_—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–°—Ä–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –º–µ–Ω–µ–µ 30 –¥–Ω–µ–π",
                "—ç—Ç–∞–ª–æ–Ω": "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –∑–∞ 30 –¥–Ω–µ–π",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"(?:—Ä–∞—Å—Ç–æ—Ä–∂|–ø—Ä–µ–∫—Ä–∞—â)\w*.*?(?:–∑–∞\s+)?(?:5|7|10|14)\s*(?:–¥–Ω|–∫–∞–ª–µ–Ω–¥)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Å—Ä–æ–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏"
            },
            "–∞–≤—Ç–æ–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è_–±–µ–∑_—Å–æ–≥–ª–∞—Å–∏—è": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ê–≤—Ç–æ–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è –±–µ–∑ —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è",
                "—ç—Ç–∞–ª–æ–Ω": "–ü—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º—É —Å–æ–≥–ª–∞—à–µ–Ω–∏—é",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"(?:–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫|–ø—Ä–æ–ª–æ–Ω–≥)\w*.*?(?:–µ—Å–ª–∏\s+)?(?:–Ω–∏\s+–æ–¥–Ω–∞|—Å—Ç–æ—Ä–æ–Ω\w*)\s*(?:–Ω–µ\s+)?(?:–∑–∞—è–≤–∏—Ç|—É–≤–µ–¥–æ–º–∏—Ç|–Ω–∞–ø—Ä–∞–≤–∏—Ç)",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–†–∏—Å–∫–æ–≤–∞–Ω–Ω–∞—è –∞–≤—Ç–æ–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è"
            },
        },
        
        # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –†–ê–ó–î–ï–õ–´
        "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ_—Ä–∞–∑–¥–µ–ª—ã": [
            "–ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê",
            "–ü–†–ê–í–ê –ò –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò",
            "–°–¢–û–ò–ú–û–°–¢–¨",
            "–ü–û–†–Ø–î–û–ö –†–ê–°–ß–Å–¢–û–í",
            "–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨",
            "–°–†–û–ö –î–ï–ô–°–¢–í–ò–Ø",
            "–†–ï–ö–í–ò–ó–ò–¢–´ –°–¢–û–†–û–ù",
        ]
    },
    
    "–ø–æ—Å—Ç–∞–≤–∫–∞": {
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏",
        "–∫–æ–¥": "–¢–§-–°–ü–ö-002",
        "—Ä–æ–ª—å": "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å",
        "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ": {
            "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞_–ø—Ä–µ–≤—ã—à–µ–Ω–∞": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –±–æ–ª–µ–µ 30%",
                "—ç—Ç–∞–ª–æ–Ω": "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–µ –±–æ–ª–µ–µ 30%",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–ø—Ä–µ–¥–æ–ø–ª–∞—Ç\w*.*?(?:[4-9]\d|100)\s*%",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∏—Å–∫–∏"
            },
        },
        "—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ": {
            "–≥–∞—Ä–∞–Ω—Ç–∏—è_–∫–æ—Ä–æ—Ç–∫–∞—è": {
                "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ì–∞—Ä–∞–Ω—Ç–∏—è –º–µ–Ω–µ–µ 12 –º–µ—Å—è—Ü–µ–≤",
                "—ç—Ç–∞–ª–æ–Ω": "–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫ –Ω–µ –º–µ–Ω–µ–µ 12 –º–µ—Å—è—Ü–µ–≤",
                "–ø–∞—Ç—Ç–µ—Ä–Ω": r"–≥–∞—Ä–∞–Ω—Ç–∏—è.*?(?:[1-9]|1[01])\s*–º–µ—Å—è—Ü",
                "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": "–ö–æ—Ä–æ—Ç–∫–∏–π –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫"
            },
        },
        "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ_—Ä–∞–∑–¥–µ–ª—ã": ["–ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê", "–ö–ê–ß–ï–°–¢–í–û", "–¶–ï–ù–ê", "–ü–û–°–¢–ê–í–ö–ê", "–ü–†–ò–Å–ú–ö–ê", "–ì–ê–†–ê–ù–¢–ò–Ø", "–†–ï–ö–í–ò–ó–ò–¢–´"]
    },
}

–î–ï–ú–û_–î–û–ì–û–í–û–† = """–î–û–ì–û–í–û–† –û–ö–ê–ó–ê–ù–ò–Ø –£–°–õ–£–ì ‚Ññ 2025/–¢–≠–û-001

–≥. –ú–æ—Å–∫–≤–∞                                           ¬´15¬ª —è–Ω–≤–∞—Ä—è 2025 –≥.

–û–û–û ¬´–¢—Ä–∞–Ω—Å–õ–æ–≥–∏—Å—Ç–∏–∫¬ª (–ò–ù–ù 7707999888, –û–ì–†–ù 1027700123456), –∏–º–µ–Ω—É–µ–º–æ–µ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å¬ª, –≤ –ª–∏—Ü–µ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ö–æ–∑–ª–æ–≤–∞ –ö.–ö., –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –£—Å—Ç–∞–≤–∞, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏
–ê–û ¬´–°–ü–ö¬ª (–ò–ù–ù 7701234567, –û–ì–†–ù 1037700654321), –∏–º–µ–Ω—É–µ–º–æ–µ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ó–∞–∫–∞–∑—á–∏–∫¬ª, –≤ –ª–∏—Ü–µ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –°–∏–¥–æ—Ä–æ–≤–∞ –°.–°., –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –£—Å—Ç–∞–≤–∞, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã,
–∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –î–æ–≥–æ–≤–æ—Ä –æ –Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º:

1. –ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê
1.1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –æ–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥–∏ –ø–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é –∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã—Ö –≤–∞–≥–æ–Ω–æ–≤ –¥–ª—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –≥—Ä—É–∑–æ–≤ –ó–∞–∫–∞–∑—á–∏–∫–∞, –∞ –ó–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –æ–∫–∞–∑–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏.

2. –ü–†–ê–í–ê –ò –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò –°–¢–û–†–û–ù
2.1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞–≥–æ–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞—è–≤–∫–∞–º–∏ –ó–∞–∫–∞–∑—á–∏–∫–∞.
2.2. –ó–∞–∫–∞–∑—á–∏–∫ –Ω–µ—Å—ë—Ç –≤—Å–µ —Ä–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–∞–≥–æ–Ω–æ–≤.

3. –°–¢–û–ò–ú–û–°–¢–¨ –ò –ü–û–†–Ø–î–û–ö –†–ê–°–ß–Å–¢–û–í
3.1. –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥: 8 500 000 (–í–æ—Å–µ–º—å –º–∏–ª–ª–∏–æ–Ω–æ–≤ –ø—è—Ç—å—Å–æ—Ç —Ç—ã—Å—è—á) —Ä—É–±–ª–µ–π.
3.2. –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 50% –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –¥–Ω–µ–π.
3.3. –û–ø–ª–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—á—ë—Ç–∞.
3.4. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ –∏–∑–º–µ–Ω—è—Ç—å —Ç–∞—Ä–∏—Ñ—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∑–∞ 10 –¥–Ω–µ–π.

4. –ü–†–ò–Å–ú–ö–ê –£–°–õ–£–ì
4.1. –ú–æ–ª—á–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞ –±–æ–ª–µ–µ 3 –¥–Ω–µ–π —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–∏–µ–º —Å –∞–∫—Ç–æ–º.

5. –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨ –°–¢–û–†–û–ù
5.1. –®—Ç—Ä–∞—Ñ –∑–∞ —Å–≤–µ—Ä—Ö–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π: 5000 —Ä—É–±–ª–µ–π –∑–∞ –≤–∞–≥–æ–Ω–æ-—Å—É—Ç–∫–∏.
5.2. –ù–µ—É—Å—Ç–æ–π–∫–∞ 0,5% –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã.
5.3. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ —É–±—ã—Ç–∫–∏.

6. –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û–°–¢–¨
6.1. –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: 15 000 000 —Ä—É–±–ª–µ–π.

7. –°–†–û–ö –î–ï–ô–°–¢–í–ò–Ø
7.1. –î–æ–≥–æ–≤–æ—Ä –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ 31.12.2025.
7.2. –†–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∑–∞ 5 –¥–Ω–µ–π.

8. –†–ï–ö–í–ò–ó–ò–¢–´ –ò –ü–û–î–ü–ò–°–ò –°–¢–û–†–û–ù

–ó–ê–ö–ê–ó–ß–ò–ö:                                    –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨:
–ê–û ¬´–°–ü–ö¬ª                                     –û–û–û ¬´–¢—Ä–∞–Ω—Å–õ–æ–≥–∏—Å—Ç–∏–∫¬ª
–ò–ù–ù 7701234567, –ö–ü–ü 770101001                –ò–ù–ù 7707999888, –ö–ü–ü 770701001
—Ä/—Å 40702810100000001234                     —Ä/—Å 40702810100000005678
–≤ –ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫, –ë–ò–ö 044525225                –≤ –ü–ê–û –í–¢–ë, –ë–ò–ö 044525187

_______________/–°–∏–¥–æ—Ä–æ–≤ –°.–°./                _______________/–ö–æ–∑–ª–æ–≤ –ö.–ö./
"""

# ============================================================================
# –°–¢–†–û–ì–ò–ô RAG –ê–ù–ê–õ–ò–ó–ê–¢–û–†
# ============================================================================

class –°—Ç—Ä–æ–≥–∏–πRAG:
    """
    –°–¢–†–û–ì–ò–ô RAG-–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä.
    
    –ü–†–ò–ù–¶–ò–ü: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–≥–æ–≤–æ—Ä –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç.
    –ù—É–∂–Ω–æ –î–û–ö–ê–ó–ê–¢–¨ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–∞–∂–¥–æ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é.
    
    –õ–æ–≥–∏–∫–∞:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è - –ª—é–±–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ = üî¥ –ö–†–ê–°–ù–ê–Ø
    2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è - –Ω–∞—Ä—É—à–µ–Ω–∏—è = üü° –ñ–Å–õ–¢–ê–Ø  
    3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
    4. –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –í–°–Å –û–ö = üü¢ –ó–ï–õ–Å–ù–ê–Ø
    """
    
    @classmethod
    def –Ω–∞–π—Ç–∏_–Ω–∞—Ä—É—à–µ–Ω–∏–µ(cls, —Ç–µ–∫—Å—Ç: str, –ø–∞—Ç—Ç–µ—Ä–Ω: str) -> Optional[dict]:
        """–ü–æ–∏—Å–∫ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        try:
            match = re.search(–ø–∞—Ç—Ç–µ—Ä–Ω, —Ç–µ–∫—Å—Ç, re.IGNORECASE | re.DOTALL)
            if match:
                start = max(0, match.start() - 80)
                end = min(len(—Ç–µ–∫—Å—Ç), match.end() + 80)
                –∫–æ–Ω—Ç–µ–∫—Å—Ç = —Ç–µ–∫—Å—Ç[start:end].replace('\n', ' ').strip()
                
                # –ò—â–µ–º –Ω–æ–º–µ—Ä –ø—É–Ω–∫—Ç–∞
                —Ç–µ–∫—Å—Ç_–¥–æ = —Ç–µ–∫—Å—Ç[max(0, match.start()-150):match.start()]
                –ø—É–Ω–∫—Ç_match = re.search(r'(\d+\.\d+)', —Ç–µ–∫—Å—Ç_–¥–æ)
                –Ω–æ–º–µ—Ä = –ø—É–Ω–∫—Ç_match.group(1) if –ø—É–Ω–∫—Ç_match else None
                
                return {
                    "–Ω–∞–π–¥–µ–Ω–æ": True,
                    "–ø—É–Ω–∫—Ç": –Ω–æ–º–µ—Ä,
                    "–∫–æ–Ω—Ç–µ–∫—Å—Ç": f"...{–∫–æ–Ω—Ç–µ–∫—Å—Ç}...",
                    "–ø–æ–∑–∏—Ü–∏—è": match.start()
                }
        except:
            pass
        return None
    
    @classmethod
    def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ä–∞–∑–¥–µ–ª—ã(cls, —Ç–µ–∫—Å—Ç: str, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ: List[str]) -> dict:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤"""
        —Ç–µ–∫—Å—Ç_upper = —Ç–µ–∫—Å—Ç.upper()
        –Ω–∞–π–¥–µ–Ω–Ω—ã–µ = []
        –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ = []
        
        for —Ä–∞–∑–¥–µ–ª in –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:
            # –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Ä–∞–∑–¥–µ–ª–∞
            –∫–ª—é—á–µ–≤—ã–µ = [–∫ for –∫ in —Ä–∞–∑–¥–µ–ª.upper().split() if len(–∫) > 3]
            –Ω–∞–π–¥–µ–Ω = False
            for –∫ in –∫–ª—é—á–µ–≤—ã–µ:
                if –∫ in —Ç–µ–∫—Å—Ç_upper:
                    –Ω–∞–π–¥–µ–Ω = True
                    break
            
            if –Ω–∞–π–¥–µ–Ω:
                –Ω–∞–π–¥–µ–Ω–Ω—ã–µ.append(—Ä–∞–∑–¥–µ–ª)
            else:
                –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ.append(—Ä–∞–∑–¥–µ–ª)
        
        return {
            "–Ω–∞–π–¥–µ–Ω–Ω—ã–µ": –Ω–∞–π–¥–µ–Ω–Ω—ã–µ,
            "–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ": –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ,
            "–ø—Ä–æ—Ü–µ–Ω—Ç": int(len(–Ω–∞–π–¥–µ–Ω–Ω—ã–µ) / len(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ) * 100) if –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ else 100
        }
    
    @classmethod
    def –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å(cls, —Ç–µ–∫—Å—Ç: str, –∫–æ–¥_—Ç—Ñ: str) -> dict:
        """
        –°–¢–†–û–ì–ò–ô –ê–ù–ê–õ–ò–ó –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø.
        
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê (–Ω—É–∂–Ω–æ –¥–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)
        """
        
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç = {
            "—É—Å–ø–µ—Ö": False,
            "–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç—Ñ": "",
            "–∑–æ–Ω–∞": "–∫—Ä–∞—Å–Ω–∞—è",  # –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ –ö–†–ê–°–ù–ê–Ø!
            "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è": [],
            "—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è": [],
            "–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ_—Ä–∞–∑–¥–µ–ª—ã": [],
            "–Ω–∞–π–¥–µ–Ω–Ω—ã–µ_—Ä–∞–∑–¥–µ–ª—ã": [],
            "–∫—Ä–∞—Å–Ω—ã—Ö": 0,
            "–∂—ë–ª—Ç—ã—Ö": 0,
            "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ": 0,
            "–≤–µ—Ä–¥–∏–∫—Ç": "–ù–ï_–°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢",
            "—Ä–µ–∑—é–º–µ": "",
            "–¥–µ—Ç–∞–ª–∏": [],
        }
        
        –≤—Å–µ_—Ç—Ñ = {**–¢–ò–ü–û–í–´–ï_–§–û–†–ú–´, **st.session_state.get("–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ_—Ç—Ñ", {})}
        
        if –∫–æ–¥_—Ç—Ñ not in –≤—Å–µ_—Ç—Ñ:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ä–µ–∑—é–º–µ"] = "‚ùå –¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            return —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        
        —Ç—Ñ = –≤—Å–µ_—Ç—Ñ[–∫–æ–¥_—Ç—Ñ]
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç—Ñ"] = —Ç—Ñ.get("–Ω–∞–∑–≤–∞–Ω–∏–µ", "")
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—É—Å–ø–µ—Ö"] = True
        
        # ========== 1. –ü–†–û–í–ï–†–Ø–ï–ú –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø ==========
        –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ = —Ç—Ñ.get("–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ", {})
        for –∫–ª—é—á, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ in –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ.items():
            –ø–∞—Ç—Ç–µ—Ä–Ω = —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("–ø–∞—Ç—Ç–µ—Ä–Ω", "")
            if not –ø–∞—Ç—Ç–µ—Ä–Ω:
                continue
            
            –Ω–∞—Ä—É—à–µ–Ω–∏–µ = cls.–Ω–∞–π—Ç–∏_–Ω–∞—Ä—É—à–µ–Ω–∏–µ(—Ç–µ–∫—Å—Ç, –ø–∞—Ç—Ç–µ—Ä–Ω)
            if –Ω–∞—Ä—É—à–µ–Ω–∏–µ and –Ω–∞—Ä—É—à–µ–Ω–∏–µ.get("–Ω–∞–π–¥–µ–Ω–æ"):
                —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è"].append({
                    "–∫–æ–¥": –∫–ª—é—á,
                    "–æ–ø–∏—Å–∞–Ω–∏–µ": —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("–æ–ø–∏—Å–∞–Ω–∏–µ", ""),
                    "—ç—Ç–∞–ª–æ–Ω": —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("—ç—Ç–∞–ª–æ–Ω", ""),
                    "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("–ø–æ—è—Å–Ω–µ–Ω–∏–µ", ""),
                    "–ø—É–Ω–∫—Ç": –Ω–∞—Ä—É—à–µ–Ω–∏–µ.get("–ø—É–Ω–∫—Ç"),
                    "–∫–æ–Ω—Ç–µ–∫—Å—Ç": –Ω–∞—Ä—É—à–µ–Ω–∏–µ.get("–∫–æ–Ω—Ç–µ–∫—Å—Ç", ""),
                })
        
        # ========== 2. –ü–†–û–í–ï–†–Ø–ï–ú –°–£–©–ï–°–¢–í–ï–ù–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø ==========
        —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ = —Ç—Ñ.get("—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ", {})
        for –∫–ª—é—á, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ in —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ.items():
            –ø–∞—Ç—Ç–µ—Ä–Ω = —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("–ø–∞—Ç—Ç–µ—Ä–Ω", "")
            if not –ø–∞—Ç—Ç–µ—Ä–Ω:
                continue
            
            –Ω–∞—Ä—É—à–µ–Ω–∏–µ = cls.–Ω–∞–π—Ç–∏_–Ω–∞—Ä—É—à–µ–Ω–∏–µ(—Ç–µ–∫—Å—Ç, –ø–∞—Ç—Ç–µ—Ä–Ω)
            if –Ω–∞—Ä—É—à–µ–Ω–∏–µ and –Ω–∞—Ä—É—à–µ–Ω–∏–µ.get("–Ω–∞–π–¥–µ–Ω–æ"):
                —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è"].append({
                    "–∫–æ–¥": –∫–ª—é—á,
                    "–æ–ø–∏—Å–∞–Ω–∏–µ": —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("–æ–ø–∏—Å–∞–Ω–∏–µ", ""),
                    "—ç—Ç–∞–ª–æ–Ω": —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("—ç—Ç–∞–ª–æ–Ω", ""),
                    "–ø–æ—è—Å–Ω–µ–Ω–∏–µ": —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.get("–ø–æ—è—Å–Ω–µ–Ω–∏–µ", ""),
                    "–ø—É–Ω–∫—Ç": –Ω–∞—Ä—É—à–µ–Ω–∏–µ.get("–ø—É–Ω–∫—Ç"),
                    "–∫–æ–Ω—Ç–µ–∫—Å—Ç": –Ω–∞—Ä—É—à–µ–Ω–∏–µ.get("–∫–æ–Ω—Ç–µ–∫—Å—Ç", ""),
                })
        
        # ========== 3. –ü–†–û–í–ï–†–Ø–ï–ú –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –†–ê–ó–î–ï–õ–´ ==========
        –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ = —Ç—Ñ.get("–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ_—Ä–∞–∑–¥–µ–ª—ã", [])
        —Ä–∞–∑–¥–µ–ª—ã = cls.–ø—Ä–æ–≤–µ—Ä–∏—Ç—å_—Ä–∞–∑–¥–µ–ª—ã(—Ç–µ–∫—Å—Ç, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–Ω–∞–π–¥–µ–Ω–Ω—ã–µ_—Ä–∞–∑–¥–µ–ª—ã"] = —Ä–∞–∑–¥–µ–ª—ã.get("–Ω–∞–π–¥–µ–Ω–Ω—ã–µ", [])
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ_—Ä–∞–∑–¥–µ–ª—ã"] = —Ä–∞–∑–¥–µ–ª—ã.get("–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ", [])
        
        # ========== 4. –ü–û–î–°–ß–Å–¢ –ò –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–û–ù–´ ==========
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∫—Ä–∞—Å–Ω—ã—Ö"] = len(—Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è"])
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∂—ë–ª—Ç—ã—Ö"] = len(—Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è"])
        
        # –†–∞—Å—á—ë—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (—Å—Ç—Ä–æ–≥–∏–π)
        # –ö–∞–∂–¥–æ–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ = -20%, –∫–∞–∂–¥–æ–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ = -10%
        # –ö–∞–∂–¥—ã–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª = -5%
        —à—Ç—Ä–∞—Ñ = (—Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∫—Ä–∞—Å–Ω—ã—Ö"] * 20) + (—Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∂—ë–ª—Ç—ã—Ö"] * 10) + (len(—Ä–µ–∑—É–ª—å—Ç–∞—Ç["–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ_—Ä–∞–∑–¥–µ–ª—ã"]) * 5)
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ"] = max(0, 100 - —à—Ç—Ä–∞—Ñ)
        
        # ========== 5. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–û–ù–´ (–°–¢–†–û–ì–û!) ==========
        
        # üî¥ –ö–†–ê–°–ù–ê–Ø: –õ—é–±–æ–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ò–õ–ò —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ < 50%
        if —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∫—Ä–∞—Å–Ω—ã—Ö"] > 0:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∑–æ–Ω–∞"] = "–∫—Ä–∞—Å–Ω–∞—è"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–≤–µ—Ä–¥–∏–∫—Ç"] = "–ù–ï_–°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ä–µ–∑—é–º–µ"] = f"‚ùå –ù–ï –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –¢–§. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {—Ä–µ–∑—É–ª—å—Ç–∞—Ç['–∫—Ä–∞—Å–Ω—ã—Ö']} –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π!"
        
        # üü° –ñ–Å–õ–¢–ê–Ø: –ï—Å—Ç—å —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ò–õ–ò —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 50-79%
        elif —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∂—ë–ª—Ç—ã—Ö"] > 0 or —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ"] < 80:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∑–æ–Ω–∞"] = "–∂—ë–ª—Ç–∞—è"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–≤–µ—Ä–¥–∏–∫—Ç"] = "–¢–†–ï–ë–£–ï–¢_–î–û–†–ê–ë–û–¢–ö–ò"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ä–µ–∑—é–º–µ"] = f"‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ –î–û–†–ê–ë–û–¢–ö–ò. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {—Ä–µ–∑—É–ª—å—Ç–∞—Ç['–∂—ë–ª—Ç—ã—Ö']} —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—á–∞–Ω–∏–π."
        
        # üü¢ –ó–ï–õ–Å–ù–ê–Ø: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –í–°–Å –≤ –ø–æ—Ä—è–¥–∫–µ!
        elif —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ"] >= 80 and len(—Ä–µ–∑—É–ª—å—Ç–∞—Ç["–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ_—Ä–∞–∑–¥–µ–ª—ã"]) == 0:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∑–æ–Ω–∞"] = "–∑–µ–ª—ë–Ω–∞—è"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–≤–µ—Ä–¥–∏–∫—Ç"] = "–°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ä–µ–∑—é–º–µ"] = f"‚úÖ –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –¢–§ ({—Ä–µ–∑—É–ª—å—Ç–∞—Ç['—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ']}%)"
        
        # –ò–Ω–∞—á–µ –∂—ë–ª—Ç–∞—è (–µ—Å—Ç—å –º–µ–ª–∫–∏–µ –Ω–µ–¥–æ—á—ë—Ç—ã)
        else:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–∑–æ–Ω–∞"] = "–∂—ë–ª—Ç–∞—è"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["–≤–µ—Ä–¥–∏–∫—Ç"] = "–£–°–õ–û–í–ù–û_–°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢"
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç["—Ä–µ–∑—é–º–µ"] = f"‚ö†Ô∏è –£—Å–ª–æ–≤–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã."
        
        return —Ä–µ–∑—É–ª—å—Ç–∞—Ç

# ============================================================================
# –≠–ö–°–¢–†–ê–ö–¢–û–† –î–ê–ù–ù–´–•
# ============================================================================

def –∏–∑–≤–ª–µ—á—å_–¥–∞—Ç—É(—Ç–µ–∫—Å—Ç: str):
    –º–µ—Å—è—Ü—ã = {'—è–Ω–≤–∞—Ä—è':1,'—Ñ–µ–≤—Ä–∞–ª—è':2,'–º–∞—Ä—Ç–∞':3,'–∞–ø—Ä–µ–ª—è':4,'–º–∞—è':5,'–∏—é–Ω—è':6,'–∏—é–ª—è':7,'–∞–≤–≥—É—Å—Ç–∞':8,'—Å–µ–Ω—Ç—è–±—Ä—è':9,'–æ–∫—Ç—è–±—Ä—è':10,'–Ω–æ—è–±—Ä—è':11,'–¥–µ–∫–∞–±—Ä—è':12}
    m = re.search(r'¬´?(\d{1,2})¬ª?\s*([–∞-—è—ë]+)\s*(\d{4})', —Ç–µ–∫—Å—Ç.lower())
    if m:
        try: return date(int(m.group(3)), –º–µ—Å—è—Ü—ã.get(m.group(2), 1), int(m.group(1)))
        except: pass
    m = re.search(r'(\d{1,2})\.(\d{1,2})\.(\d{4})', —Ç–µ–∫—Å—Ç)
    if m:
        try: return date(int(m.group(3)), int(m.group(2)), int(m.group(1)))
        except: pass
    return None

def –∏–∑–≤–ª–µ—á—å_–Ω–æ–º–µ—Ä(—Ç–µ–∫—Å—Ç: str):
    # –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å OCR)
    patterns = [
        r'‚Ññ\s*([A-Za-z–ê-–Ø–∞-—è–Å—ë0-9\-/]+)',
        r'[–î–¥]–æ–≥–æ–≤–æ—Ä[–∞]?\s+([A-Za-z–ê-–Ø–∞-—è–Å—ë0-9\-/]{3,})',
        r'[–ö–∫]–æ–Ω—Ç—Ä–∞–∫—Ç[–∞]?\s+([A-Za-z–ê-–Ø–∞-—è–Å—ë0-9\-/]{3,})',
    ]
    for pattern in patterns:
        m = re.search(pattern, —Ç–µ–∫—Å—Ç[:1000])
        if m and len(m.group(1).strip()) >= 3:
            return m.group(1).strip()
    return None

def –∏–∑–≤–ª–µ—á—å_—Å—É–º–º—É(—Ç–µ–∫—Å—Ç: str):
    # –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É–º–º—ã (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å OCR)
    patterns = [
        r'(\d[\d\s]*\d)\s*(?:\([^)]+\))?\s*(?:—Ä—É–±|‚ÇΩ|RUB)',
        r'[–°—Å]—É–º–º–∞[:\s]+(\d[\d\s]*\d)',
        r'[–°—Å]—Ç–æ–∏–º–æ—Å—Ç—å[:\s]+(\d[\d\s]*\d)',
        r'[–¶—Ü]–µ–Ω–∞[:\s]+(\d[\d\s]*\d)',
    ]
    for pattern in patterns:
        m = re.search(pattern, —Ç–µ–∫—Å—Ç, re.IGNORECASE)
        if m:
            try:
                return float(re.sub(r'\s', '', m.group(1)))
            except:
                pass
    return None

def –∏–∑–≤–ª–µ—á—å_—Å—Ç–æ—Ä–æ–Ω—ã(—Ç–µ–∫—Å—Ç: str) -> List[dict]:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –û–ë–ï —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞ —Å –∏—Ö —Ä–æ–ª—è–º–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫: [{"–Ω–∞–∑–≤–∞–Ω–∏–µ": "–û–û–û –†–æ–≥–∞", "—Ä–æ–ª—å": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–∏–Ω–Ω": "123..."}, ...]
    """
    —Å—Ç–æ—Ä–æ–Ω—ã = []
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Ç–æ—Ä–æ–Ω —Å —Ä–æ–ª—è–º–∏
    —Ä–æ–ª–∏_–ø–∞—Ç—Ç–µ—Ä–Ω—ã = [
        (r'(?:–∏–º–µ–Ω—É–µ–º\w*\s+–≤\s+–¥–∞–ª—å–Ω–µ–π—à–µ–º|–¥–∞–ª–µ–µ\s*[-‚Äì‚Äî]?\s*)[¬´"]?([–ê-–Ø–∞-—è–Å—ë]+)[¬ª"]?', '—Ä–æ–ª—å_–ø–æ—Å–ª–µ'),  # "–∏–º–µ–Ω—É–µ–º—ã–π –¥–∞–ª–µ–µ ¬´–ó–∞–∫–∞–∑—á–∏–∫¬ª"
        (r'([–ê-–Ø–∞-—è–Å—ë]+)[¬ª"]?\s*,?\s*—Å\s+(?:–æ–¥–Ω–æ–π|–¥—Ä—É–≥–æ–π)\s+—Å—Ç–æ—Ä–æ–Ω—ã', '—Ä–æ–ª—å_–¥–æ'),  # "–ó–∞–∫–∞–∑—á–∏–∫, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã"
    ]
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —é—Ä–ª–∏—Ü
    —é—Ä–ª–∏—Ü–∞_–ø–∞—Ç—Ç–µ—Ä–Ω = r'((?:–û–û–û|–û–ê–û|–ó–ê–û|–ü–ê–û|–ê–û|–ò–ü)\s*[¬´"]([^¬ª"]+)[¬ª"])'
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ò–ù–ù
    –∏–Ω–Ω_–ø–∞—Ç—Ç–µ—Ä–Ω = r'–ò–ù–ù\s*:?\s*(\d{10,12})'
    
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–æ–ª–∏
    –†–û–õ–ò = ['–ó–∞–∫–∞–∑—á–∏–∫', '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å', '–ü—Ä–æ–¥–∞–≤–µ—Ü', '–ü–æ—Å—Ç–∞–≤—â–∏–∫', 
            '–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä', '–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å', '–ü–æ–¥—Ä—è–¥—á–∏–∫', '–°—É–±–ø–æ–¥—Ä—è–¥—á–∏–∫', 
            '–ó–∞—ë–º—â–∏–∫', '–ó–∞–π–º–æ–¥–∞–≤–µ—Ü', '–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª', '–ê–≥–µ–Ω—Ç', '–õ–∏—Ü–µ–Ω–∑–∏–∞—Ä', '–õ–∏—Ü–µ–Ω–∑–∏–∞—Ç']
    
    # –ò—â–µ–º –±–ª–æ–∫–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç–æ—Ä–æ–Ω (–ø–µ—Ä–≤—ã–µ 3000 —Å–∏–º–≤–æ–ª–æ–≤)
    –ø—Ä–µ–∞–º–±—É–ª–∞ = —Ç–µ–∫—Å—Ç[:3000]
    
    # –ò—â–µ–º –≤—Å–µ —é—Ä–ª–∏—Ü–∞
    —é—Ä–ª–∏—Ü–∞ = re.findall(—é—Ä–ª–∏—Ü–∞_–ø–∞—Ç—Ç–µ—Ä–Ω, –ø—Ä–µ–∞–º–±—É–ª–∞)
    
    for –ø–æ–ª–Ω–æ–µ, –Ω–∞–∑–≤–∞–Ω–∏–µ in —é—Ä–ª–∏—Ü–∞:
        —Å—Ç–æ—Ä–æ–Ω–∞ = {"–Ω–∞–∑–≤–∞–Ω–∏–µ": –ø–æ–ª–Ω–æ–µ, "–∫–æ—Ä–æ—Ç–∫–æ–µ": –Ω–∞–∑–≤–∞–Ω–∏–µ, "—Ä–æ–ª—å": "", "–∏–Ω–Ω": ""}
        
        # –ò—â–µ–º —Ä–æ–ª—å —Ä—è–¥–æ–º —Å —é—Ä–ª–∏—Ü–æ–º
        –ø–æ–∑–∏—Ü–∏—è = –ø—Ä–µ–∞–º–±—É–ª–∞.find(–ø–æ–ª–Ω–æ–µ)
        –∫–æ–Ω—Ç–µ–∫—Å—Ç = –ø—Ä–µ–∞–º–±—É–ª–∞[max(0, –ø–æ–∑–∏—Ü–∏—è-50):min(len(–ø—Ä–µ–∞–º–±—É–ª–∞), –ø–æ–∑–∏—Ü–∏—è+len(–ø–æ–ª–Ω–æ–µ)+150)]
        
        # –ò—â–µ–º —Ä–æ–ª—å
        for —Ä–æ–ª—å in –†–û–õ–ò:
            if re.search(rf'(?:–∏–º–µ–Ω—É–µ–º\w*|–¥–∞–ª–µ–µ)\s*[¬´"]?{—Ä–æ–ª—å}[¬ª"]?', –∫–æ–Ω—Ç–µ–∫—Å—Ç, re.IGNORECASE):
                —Å—Ç–æ—Ä–æ–Ω–∞["—Ä–æ–ª—å"] = —Ä–æ–ª—å
                break
            if re.search(rf'{—Ä–æ–ª—å}\s*,?\s*—Å\s+(?:–æ–¥–Ω–æ–π|–¥—Ä—É–≥–æ–π)\s+—Å—Ç–æ—Ä–æ–Ω—ã', –∫–æ–Ω—Ç–µ–∫—Å—Ç, re.IGNORECASE):
                —Å—Ç–æ—Ä–æ–Ω–∞["—Ä–æ–ª—å"] = —Ä–æ–ª—å
                break
        
        # –ò—â–µ–º –ò–ù–ù —Ä—è–¥–æ–º
        –∏–Ω–Ω_match = re.search(–∏–Ω–Ω_–ø–∞—Ç—Ç–µ—Ä–Ω, –∫–æ–Ω—Ç–µ–∫—Å—Ç)
        if –∏–Ω–Ω_match:
            —Å—Ç–æ—Ä–æ–Ω–∞["–∏–Ω–Ω"] = –∏–Ω–Ω_match.group(1)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –Ω–µ –¥—É–±–ª–∏–∫–∞—Ç
        if not any(—Å["–∫–æ—Ä–æ—Ç–∫–æ–µ"] == –Ω–∞–∑–≤–∞–Ω–∏–µ for —Å in —Å—Ç–æ—Ä–æ–Ω—ã):
            —Å—Ç–æ—Ä–æ–Ω—ã.append(—Å—Ç–æ—Ä–æ–Ω–∞)
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ä–æ–ª–∏, –ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –ø–æ—Ä—è–¥–∫—É
    if len(—Å—Ç–æ—Ä–æ–Ω—ã) >= 2:
        if not —Å—Ç–æ—Ä–æ–Ω—ã[0]["—Ä–æ–ª—å"] and not —Å—Ç–æ—Ä–æ–Ω—ã[1]["—Ä–æ–ª—å"]:
            # –¢–∏–ø–∏—á–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: –ø–µ—Ä–≤—ã–π - –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å/–ü–æ—Å—Ç–∞–≤—â–∏–∫, –≤—Ç–æ—Ä–æ–π - –ó–∞–∫–∞–∑—á–∏–∫/–ü–æ–∫—É–ø–∞—Ç–µ–ª—å
            if any(w in —Ç–µ–∫—Å—Ç.lower() for w in ['—É—Å–ª—É–≥', '—Ç—ç–æ', '–ø–æ–¥—Ä—è–¥']):
                —Å—Ç–æ—Ä–æ–Ω—ã[0]["—Ä–æ–ª—å"] = "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"
                —Å—Ç–æ—Ä–æ–Ω—ã[1]["—Ä–æ–ª—å"] = "–ó–∞–∫–∞–∑—á–∏–∫"
            elif any(w in —Ç–µ–∫—Å—Ç.lower() for w in ['–ø–æ—Å—Ç–∞–≤–∫', '—Ç–æ–≤–∞—Ä']):
                —Å—Ç–æ—Ä–æ–Ω—ã[0]["—Ä–æ–ª—å"] = "–ü–æ—Å—Ç–∞–≤—â–∏–∫"
                —Å—Ç–æ—Ä–æ–Ω—ã[1]["—Ä–æ–ª—å"] = "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å"
            elif any(w in —Ç–µ–∫—Å—Ç.lower() for w in ['–∞—Ä–µ–Ω–¥']):
                —Å—Ç–æ—Ä–æ–Ω—ã[0]["—Ä–æ–ª—å"] = "–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å"
                —Å—Ç–æ—Ä–æ–Ω—ã[1]["—Ä–æ–ª—å"] = "–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä"
    
    return —Å—Ç–æ—Ä–æ–Ω—ã

def –∏–∑–≤–ª–µ—á—å_–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞(—Ç–µ–∫—Å—Ç: str):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ (–Ω–µ –Ω–∞—à—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é)"""
    —Å—Ç–æ—Ä–æ–Ω—ã = –∏–∑–≤–ª–µ—á—å_—Å—Ç–æ—Ä–æ–Ω—ã(—Ç–µ–∫—Å—Ç)
    –æ—Ä–≥ = st.session_state.get("–æ—Ä–≥", DEFAULT_ORG)
    –Ω–∞—à–∞_–æ—Ä–≥ = –æ—Ä–≥.get("short_name", "–°–ü–ö").upper()
    
    for —Å—Ç–æ—Ä–æ–Ω–∞ in —Å—Ç–æ—Ä–æ–Ω—ã:
        –Ω–∞–∑–≤–∞–Ω–∏–µ = —Å—Ç–æ—Ä–æ–Ω–∞.get("–∫–æ—Ä–æ—Ç–∫–æ–µ", "").upper()
        if –Ω–∞—à–∞_–æ—Ä–≥ not in –Ω–∞–∑–≤–∞–Ω–∏–µ and "–°–ü–ö" not in –Ω–∞–∑–≤–∞–Ω–∏–µ and "–°–¢–ê–†–ê–Ø" not in –Ω–∞–∑–≤–∞–Ω–∏–µ:
            return —Å—Ç–æ—Ä–æ–Ω–∞.get("–Ω–∞–∑–≤–∞–Ω–∏–µ", "")
    
    # Fallback - —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
    —é—Ä–ª–∏—Ü–∞ = re.findall(r'((?:–û–û–û|–û–ê–û|–ó–ê–û|–ü–ê–û|–ê–û)\s*[¬´"]([^¬ª"]+)[¬ª"])', —Ç–µ–∫—Å—Ç)
    for –ø–æ–ª–Ω–æ–µ, –Ω–∞–∑–≤–∞–Ω–∏–µ in —é—Ä–ª–∏—Ü–∞:
        if '–°–ü–ö' not in –Ω–∞–∑–≤–∞–Ω–∏–µ.upper() and '–°–¢–ê–†–ê–Ø' not in –Ω–∞–∑–≤–∞–Ω–∏–µ.upper():
            return –ø–æ–ª–Ω–æ–µ
    return None

def –∏–∑–≤–ª–µ—á—å_–≤—Å–µ_–¥–∞–Ω–Ω—ã–µ(—Ç–µ–∫—Å—Ç: str):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ –≤–∫–ª—é—á–∞—è –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã"""
    —Å—Ç–æ—Ä–æ–Ω—ã = –∏–∑–≤–ª–µ—á—å_—Å—Ç–æ—Ä–æ–Ω—ã(—Ç–µ–∫—Å—Ç)
    
    return {
        "–¥–∞—Ç–∞": –∏–∑–≤–ª–µ—á—å_–¥–∞—Ç—É(—Ç–µ–∫—Å—Ç),
        "–Ω–æ–º–µ—Ä": –∏–∑–≤–ª–µ—á—å_–Ω–æ–º–µ—Ä(—Ç–µ–∫—Å—Ç),
        "—Å—É–º–º–∞": –∏–∑–≤–ª–µ—á—å_—Å—É–º–º—É(—Ç–µ–∫—Å—Ç),
        "–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç": –∏–∑–≤–ª–µ—á—å_–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞(—Ç–µ–∫—Å—Ç),
        "—Å—Ç–æ—Ä–æ–Ω—ã": —Å—Ç–æ—Ä–æ–Ω—ã,  # –ù–æ–≤–æ–µ: —Å–ø–∏—Å–æ–∫ —Å—Ç–æ—Ä–æ–Ω —Å —Ä–æ–ª—è–º–∏
    }


# ============================================================================
# –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–û–ù–´
# ============================================================================

def –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å_–∑–æ–Ω—É(—Å—É–º–º–∞: float, —Ñ–æ—Ä–º–∞: str, —Ç–∏–ø_—Å–¥–µ–ª–∫–∏: str):
    –ø–æ—Ä–æ–≥–∏ = st.session_state.get("–ø–æ—Ä–æ–≥–∏", DEFAULT_THRESHOLDS)
    if —Ç–∏–ø_—Å–¥–µ–ª–∫–∏ in –ö–†–ê–°–ù–ê–Ø_–ó–û–ù–ê:
        return {"–∑–æ–Ω–∞": "–∫—Ä–∞—Å–Ω–∞—è", "–ø—Ä–∏—á–∏–Ω–∞": f"–¢–∏–ø: {—Ç–∏–ø_—Å–¥–µ–ª–∫–∏}", "—é–¥": True, "—Å—Ä–æ–∫": 10}
    if —Å—É–º–º–∞ > –ø–æ—Ä–æ–≥–∏.get("–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å", 5_000_000):
        return {"–∑–æ–Ω–∞": "–∫—Ä–∞—Å–Ω–∞—è", "–ø—Ä–∏—á–∏–Ω–∞": f"–°—É–º–º–∞ > {–ø–æ—Ä–æ–≥–∏['–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å']:,}‚ÇΩ", "—é–¥": True, "—Å—Ä–æ–∫": 10}
    if —Ç–∏–ø_—Å–¥–µ–ª–∫–∏ in –ñ–Å–õ–¢–ê–Ø_–ó–û–ù–ê:
        return {"–∑–æ–Ω–∞": "–∂—ë–ª—Ç–∞—è", "–ø—Ä–∏—á–∏–Ω–∞": f"–¢–∏–ø: {—Ç–∏–ø_—Å–¥–µ–ª–∫–∏}", "—é–¥": True, "—Å—Ä–æ–∫": 5}
    if —Ñ–æ—Ä–º–∞ == "–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ (–¢–§)":
        if —Å—É–º–º–∞ > –ø–æ—Ä–æ–≥–∏.get("–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å", 100_000):
            return {"–∑–æ–Ω–∞": "–∂—ë–ª—Ç–∞—è", "–ø—Ä–∏—á–∏–Ω–∞": f"–¢–§ > {–ø–æ—Ä–æ–≥–∏['–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å']:,}‚ÇΩ", "—é–¥": True, "—Å—Ä–æ–∫": 5}
    else:
        if —Å—É–º–º–∞ > –ø–æ—Ä–æ–≥–∏.get("–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å", 50_000):
            return {"–∑–æ–Ω–∞": "–∂—ë–ª—Ç–∞—è", "–ø—Ä–∏—á–∏–Ω–∞": f"–ù–µ—Ç–∏–ø–æ–≤–∞—è > {–ø–æ—Ä–æ–≥–∏['–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å']:,}‚ÇΩ", "—é–¥": True, "—Å—Ä–æ–∫": 5}
    return {"–∑–æ–Ω–∞": "–∑–µ–ª—ë–Ω–∞—è", "–ø—Ä–∏—á–∏–Ω–∞": "–ó–µ–ª—ë–Ω—ã–π –∫–æ—Ä–∏–¥–æ—Ä", "—é–¥": False, "—Å—Ä–æ–∫": 0}


# ============================================================================
# AI –ö–õ–ò–ï–ù–¢
# ============================================================================

def ai_–∞–Ω–∞–ª–∏–∑(—Ç–µ–∫—Å—Ç: str, –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ: dict, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: dict, rag: dict):
    api_–∫–ª—é—á–∏ = st.session_state.get("api_–∫–ª—é—á–∏", {})
    –æ—Ä–≥ = st.session_state.get("–æ—Ä–≥", DEFAULT_ORG)
    
    –ø—Ä–æ–≤–∞–π–¥–µ—Ä = None
    –∫–ª—é—á = ""
    for pid in ["openai", "anthropic", "yandexgpt"]:
        if api_–∫–ª—é—á–∏.get(pid):
            –ø—Ä–æ–≤–∞–π–¥–µ—Ä = pid
            –∫–ª—é—á = api_–∫–ª—é—á–∏[pid]
            break
    
    if not –ø—Ä–æ–≤–∞–π–¥–µ—Ä:
        return False, "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä"
    
    –Ω–∞—Ä—É—à–µ–Ω–∏—è_—Ç–µ–∫—Å—Ç = ""
    for i, –Ω in enumerate(rag.get("–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è", [])[:5], 1):
        –Ω–∞—Ä—É—à–µ–Ω–∏—è_—Ç–µ–∫—Å—Ç += f"\nüî¥ [{–Ω.get('–ø—É–Ω–∫—Ç', '?')}] {–Ω['–æ–ø–∏—Å–∞–Ω–∏–µ']}: {–Ω.get('–∫–æ–Ω—Ç–µ–∫—Å—Ç', '')[:100]}"
    for i, –Ω in enumerate(rag.get("—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è", [])[:5], 1):
        –Ω–∞—Ä—É—à–µ–Ω–∏—è_—Ç–µ–∫—Å—Ç += f"\nüü° [{–Ω.get('–ø—É–Ω–∫—Ç', '?')}] {–Ω['–æ–ø–∏—Å–∞–Ω–∏–µ']}: {–Ω.get('–∫–æ–Ω—Ç–µ–∫—Å—Ç', '')[:100]}"
    
    –ø—Ä–æ–º–ø—Ç = f"""–¢—ã ‚Äî –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —é—Ä–∏—Å—Ç {–æ—Ä–≥.get('short_name', '–ê–û –°–ü–ö')}.

–î–û–ö–£–ú–ï–ù–¢: {–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è.get('—Ç–∏–ø', '–î–æ–≥–æ–≤–æ—Ä')}
–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: {–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è.get('—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å', 0)}%
–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ.get('–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', '‚Äî')}
–°—É–º–º–∞: {–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ.get('—Å—É–º–º–∞', 0):,.0f}‚ÇΩ

–¢–ï–ö–°–¢:
{—Ç–µ–∫—Å—Ç[:5000]}

RAG-–ê–ù–ê–õ–ò–ó –í–´–Ø–í–ò–õ:
–ó–æ–Ω–∞: {rag.get('–∑–æ–Ω–∞', '–∫—Ä–∞—Å–Ω–∞—è').upper()}
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π: {rag.get('–∫—Ä–∞—Å–Ω—ã—Ö', 0)}
–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—á–∞–Ω–∏–π: {rag.get('–∂—ë–ª—Ç—ã—Ö', 0)}
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–§: {rag.get('—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ', 0)}%

–ù–ê–†–£–®–ï–ù–ò–Ø:
{–Ω–∞—Ä—É—à–µ–Ω–∏—è_—Ç–µ–∫—Å—Ç if –Ω–∞—Ä—É—à–µ–Ω–∏—è_—Ç–µ–∫—Å—Ç else "–ù–µ –≤—ã—è–≤–ª–µ–Ω–æ"}

–ó–ê–î–ê–ù–ò–ï:
1. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –∏–ª–∏ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è:
   - **–ü—É–Ω–∫—Ç X.X** ‚Äî –ø—Ä–æ–±–ª–µ–º–∞
   - –¢–µ–∫—Å—Ç: "—Ü–∏—Ç–∞—Ç–∞"
   - ‚ùå –†–∏—Å–∫: –ø–æ—è—Å–Ω–µ–Ω–∏–µ
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å: "–≥–æ—Ç–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞"
3. –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –°–û–ì–õ–ê–°–û–í–ê–¢–¨ / –° –ó–ê–ú–ï–ß–ê–ù–ò–Ø–ú–ò / –î–û–†–ê–ë–û–¢–ê–¢–¨ / –û–¢–ö–õ–û–ù–ò–¢–¨
"""

    try:
        if –ø—Ä–æ–≤–∞–π–¥–µ—Ä == "openai":
            response = requests.post(
                "https://api.openai.com/v1/chat/completions",
                headers={"Authorization": f"Bearer {–∫–ª—é—á}", "Content-Type": "application/json"},
                json={"model": "gpt-4o-mini", "messages": [{"role": "user", "content": –ø—Ä–æ–º–ø—Ç}], "max_tokens": 3000},
                timeout=90
            )
            if response.status_code == 200:
                return True, response.json()["choices"][0]["message"]["content"]
            return False, f"–û—à–∏–±–∫–∞: {response.status_code}"
        elif –ø—Ä–æ–≤–∞–π–¥–µ—Ä == "anthropic":
            response = requests.post(
                "https://api.anthropic.com/v1/messages",
                headers={"x-api-key": –∫–ª—é—á, "Content-Type": "application/json", "anthropic-version": "2023-06-01"},
                json={"model": "claude-3-haiku-20240307", "max_tokens": 3000, "messages": [{"role": "user", "content": –ø—Ä–æ–º–ø—Ç}]},
                timeout=90
            )
            if response.status_code == 200:
                return True, response.json()["content"][0]["text"]
            return False, f"–û—à–∏–±–∫–∞: {response.status_code}"
        return False, "–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω"
    except Exception as e:
        return False, str(e)


# ============================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï
# ============================================================================

def –∑–∞–≥—Ä—É–∑–∏—Ç—å_—Ñ–∞–π–ª(f):
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º OCR –¥–ª—è —Å–∫–∞–Ω–æ–≤ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
    
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
    - TXT (UTF-8, CP1251, CP866)
    - DOCX (python-docx) 
    - DOC (—á–µ—Ä–µ–∑ antiword –∏–ª–∏ textract –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
    - PDF (—Ç–µ–∫—Å—Ç–æ–≤—ã–π - PyPDF2, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π - OCR)
    - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (PNG, JPG, TIFF, BMP –∏ –¥—Ä. - OCR)
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—É—Å–ø–µ—Ö, —Ç–µ–∫—Å—Ç, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
    """
    if not f:
        return False, "", {}
    
    meta = {"–º–µ—Ç–æ–¥": "text", "—Å—Ç—Ä–∞–Ω–∏—Ü": 1, "ocr": False, "—Ñ–æ—Ä–º–∞—Ç": "", "—Ä–∞–∑–º–µ—Ä": 0}
    
    try:
        content = f.read()
        name = f.name.lower()
        meta["—Ñ–æ—Ä–º–∞—Ç"] = name.split('.')[-1].upper()
        meta["—Ä–∞–∑–º–µ—Ä"] = len(content)
        
        # ===== TXT =====
        if name.endswith('.txt'):
            for enc in ['utf-8', 'cp1251', 'cp866', 'latin-1']:
                try:
                    text = content.decode(enc)
                    return True, text, meta
                except:
                    pass
            return True, content.decode('utf-8', errors='replace'), meta
        
        # ===== DOCX =====
        elif name.endswith('.docx'):
            if not DOCX_AVAILABLE:
                return False, "python-docx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install python-docx", meta
            
            try:
                doc = DocxDocument(io.BytesIO(content))
                paragraphs = [p.text for p in doc.paragraphs if p.text.strip()]
                
                # –¢–∞–∫–∂–µ –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü
                for table in doc.tables:
                    for row in table.rows:
                        for cell in row.cells:
                            if cell.text.strip():
                                paragraphs.append(cell.text.strip())
                
                text = '\n'.join(paragraphs)
                if text:
                    return True, text, meta
                return False, "–î–æ–∫—É–º–µ–Ω—Ç DOCX –ø—É—Å—Ç–æ–π", meta
            except Exception as e:
                return False, f"–û—à–∏–±–∫–∞ DOCX: {e}", meta
        
        # ===== DOC (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) =====
        elif name.endswith('.doc'):
            # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ OCR –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞
            if OCR_AVAILABLE and PIL_AVAILABLE:
                try:
                    # DOC –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ —ç—Ç–æ —Å–∫–∞–Ω)
                    ok, text = OCRProcessor.ocr_image_bytes(content, name)
                    if ok and len(text) > 50:
                        meta["–º–µ—Ç–æ–¥"] = "ocr"
                        meta["ocr"] = True
                        return True, text, meta
                except:
                    pass
            return False, "–§–æ—Ä–º–∞—Ç DOC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ DOCX –∏–ª–∏ PDF.", meta
        
        # ===== PDF =====
        elif name.endswith('.pdf'):
            if not PDF_AVAILABLE:
                return False, "PyPDF2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install PyPDF2", meta
            
            try:
                reader = PdfReader(io.BytesIO(content))
                meta["—Å—Ç—Ä–∞–Ω–∏—Ü"] = len(reader.pages)
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
                all_text = []
                for page in reader.pages:
                    page_text = page.extract_text() or ''
                    all_text.append(page_text)
                
                text = '\n'.join(all_text)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º: —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π PDF –∏–ª–∏ —Å–∫–∞–Ω?
                avg_chars = len(text.strip()) / max(1, len(reader.pages))
                
                if avg_chars >= 100:
                    # –¢–µ–∫—Å—Ç–æ–≤—ã–π PDF - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–µ–∫—Å—Ç–∞
                    return True, text.strip(), meta
                else:
                    # –ú–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–Ω, –ø—Ä–æ–±—É–µ–º OCR
                    if OCR_AVAILABLE and PDF2IMAGE_AVAILABLE:
                        try:
                            ok, ocr_text = OCRProcessor.ocr_pdf(content)
                            if ok and len(ocr_text.strip()) > len(text.strip()):
                                meta["–º–µ—Ç–æ–¥"] = "ocr"
                                meta["ocr"] = True
                                return True, ocr_text, meta
                        except Exception as ocr_err:
                            # OCR –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á—Ç–æ –µ—Å—Ç—å
                            pass
                    
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á—Ç–æ –µ—Å—Ç—å
                    if text.strip():
                        return True, text.strip(), meta
                    
                    # PDF –ø—É—Å—Ç–æ–π
                    if OCR_AVAILABLE and PDF2IMAGE_AVAILABLE:
                        return False, "PDF –±–µ–∑ —Ç–µ–∫—Å—Ç–∞. OCR –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å.", meta
                    else:
                        return False, "PDF –±–µ–∑ —Ç–µ–∫—Å—Ç–∞. –î–ª—è OCR —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install pytesseract pdf2image", meta
                        
            except Exception as e:
                return False, f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PDF: {e}", meta
        
        # ===== –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (OCR) =====
        elif any(name.endswith(ext) for ext in IMAGE_EXTENSIONS):
            if not OCR_AVAILABLE:
                return False, "–î–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install pytesseract", meta
            if not PIL_AVAILABLE:
                return False, "–î–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install Pillow", meta
            
            try:
                ok, text = OCRProcessor.ocr_image_bytes(content, name)
                if ok and text.strip():
                    meta["–º–µ—Ç–æ–¥"] = "ocr"
                    meta["ocr"] = True
                    return True, text, meta
                return False, "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏", meta
            except Exception as e:
                return False, f"–û—à–∏–±–∫–∞ OCR: {e}", meta
        
        # ===== –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç =====
        else:
            return False, f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: {meta['—Ñ–æ—Ä–º–∞—Ç']}. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: TXT, DOCX, PDF, PNG, JPG, TIFF", meta
            
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}", meta

def —ç—Ç–æ_–∞–¥–º–∏–Ω(): return st.session_state.get("—Ä–æ–ª—å", "") == –†–û–õ–¨_–ê–î–ú–ò–ù

def –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è():
    defaults = {"–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω": False, "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å": None, "—Ä–æ–ª—å": –†–û–õ–¨_–Æ–ó–ï–†, "—Ç–µ–∫—Å—Ç": "", "–º–µ—Ç–æ–¥_–∑–∞–≥—Ä—É–∑–∫–∏": "",
                "–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è": None, "–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ": None, "–∑–æ–Ω–∞": None, "rag": None, "ai": "",
                "–æ—Ä–≥": DEFAULT_ORG.copy(), "–ø–æ—Ä–æ–≥–∏": DEFAULT_THRESHOLDS.copy(), "api_–∫–ª—é—á–∏": {}, 
                "yandex_folder": "", "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ_—Ç—Ñ": {}, "ocr_api": {}, "–Ω–∞—à–∞_—Ä–æ–ª—å": "–ó–∞–∫–∞–∑—á–∏–∫"}
    for k, v in defaults.items():
        if k not in st.session_state:
            st.session_state[k] = v

# ============================================================================
# –°–¢–ò–õ–ò
# ============================================================================

def –ø—Ä–∏–º–µ–Ω–∏—Ç—å_—Å—Ç–∏–ª–∏():
    st.markdown("""
<style>
:root { --npk-red: #c41e3a; --npk-black: #1a1a1a; --npk-gray: #666; --npk-light: #f5f5f5; --npk-border: #e0e0e0; }
.stApp { background: white !important; }
[data-testid="stSidebar"] { background: white !important; border-right: 1px solid #e0e0e0 !important; }

.npk-title { font-size: 2.5rem; font-weight: 300; color: #ddd; letter-spacing: 2px; margin-bottom: 20px; }
.npk-section { font-size: 1rem; font-weight: 600; color: #1a1a1a; border-bottom: 2px solid #c41e3a; padding-bottom: 8px; margin: 25px 0 15px 0; display: inline-block; }

/* –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è */
.id-card { border-radius: 8px; padding: 20px; margin: 15px 0; }
.id-card.–¥–æ–≥–æ–≤–æ—Ä { background: #f0fdf4; border: 2px solid #22c55e; }
.id-card.–Ω–µ-–¥–æ–≥–æ–≤–æ—Ä { background: #fef2f2; border: 2px solid #c41e3a; }
.id-card.–≤–æ–∑–º–æ–∂–Ω–æ { background: #fffbeb; border: 2px solid #f59e0b; }

.id-score { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
.id-score-item { background: white; padding: 8px 12px; border-radius: 4px; font-size: 0.85rem; }
.id-score-item.ok { border-left: 3px solid #22c55e; }
.id-score-item.fail { border-left: 3px solid #c41e3a; }

/* –ó–æ–Ω—ã */
.zone-card { border-radius: 8px; padding: 20px; margin: 15px 0; border-left: 5px solid; }
.zone-card.–∑–µ–ª—ë–Ω–∞—è { background: #f0fdf4; border-left-color: #22c55e; }
.zone-card.–∂—ë–ª—Ç–∞—è { background: #fffbeb; border-left-color: #f59e0b; }
.zone-card.–∫—Ä–∞—Å–Ω–∞—è { background: #fef2f2; border-left-color: #c41e3a; }

/* –ù–∞—Ä—É—à–µ–Ω–∏—è */
.violation-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin: 12px 0; border-left: 4px solid; }
.violation-card.critical { border-left-color: #c41e3a; background: #fef2f2; }
.violation-card.warning { border-left-color: #f59e0b; background: #fffbeb; }
.violation-context { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; font-style: italic; font-size: 0.9rem; color: #666; }
.violation-fix { color: #22c55e; font-weight: 500; }

/* –ú–µ—Ç—Ä–∏–∫–∏ */
.metrics { display: flex; gap: 15px; margin: 20px 0; }
.metric { flex: 1; text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px; }
.metric-value { font-size: 2rem; font-weight: 700; }
.metric-value.red { color: #c41e3a; }
.metric-value.yellow { color: #f59e0b; }
.metric-value.green { color: #22c55e; }
.metric-label { font-size: 0.85rem; color: #666; margin-top: 5px; }

/* –ö–Ω–æ–ø–∫–∏ */
.stButton > button { background: white !important; color: #1a1a1a !important; border: 1px solid #e0e0e0 !important; border-radius: 4px !important; }
.stButton > button:hover { border-color: #c41e3a !important; color: #c41e3a !important; }
.stButton > button[kind="primary"] { background: #c41e3a !important; color: white !important; border-color: #c41e3a !important; }

/* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ */
.blocked { opacity: 0.5; pointer-events: none; }
.block-message { background: #fef2f2; border: 1px solid #c41e3a; border-radius: 8px; padding: 15px; margin: 15px 0; color: #c41e3a; text-align: center; }

/* –ó–∞–≥—Ä—É–∑–∫–∞ */
.loading { text-align: center; padding: 40px; background: #f5f5f5; border-radius: 8px; }
.loading .train { font-size: 2.5rem; animation: move 2s ease-in-out infinite; }
@keyframes move { 0%,100% { transform: translateX(-20px); } 50% { transform: translateX(20px); } }

/* AI */
.ai-result { background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 15px; line-height: 1.7; }

/* –°–≤–µ—Ç–æ—Ñ–æ—Ä */
.traffic-light { display: flex; gap: 8px; }
.traffic-light span { width: 16px; height: 16px; border-radius: 50%; }
.tl-red { background: #c41e3a; }
.tl-yellow { background: #f59e0b; }
.tl-green { background: #22c55e; }

.admin-badge { background: #c41e3a; color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; }
.user-badge { background: #666; color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; }
</style>
""", unsafe_allow_html=True)


# ============================================================================
# –°–¢–†–ê–ù–ò–¶–ê –í–•–û–î–ê
# ============================================================================

def —Å—Ç—Ä–∞–Ω–∏—Ü–∞_–≤—Ö–æ–¥–∞():
    st.markdown('''
    <div style="text-align:center;padding:50px;">
        <div class="traffic-light" style="justify-content:center;margin-bottom:15px;">
            <span class="tl-red"></span><span class="tl-yellow"></span><span class="tl-green"></span>
        </div>
        <div class="npk-title">–†–ï–ì–õ–ê–ú–ï–ù–¢ –°–í–ï–¢–û–§–û–†</div>
        <p style="color:#c41e3a;font-weight:600;">–ê–û ¬´–°–ü–ö¬ª</p>
        <p style="color:#666;">–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ v7.11</p>
    </div>
    ''', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        tab1, tab2 = st.tabs(["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"])
        
        with tab1:
            with st.form("user_form"):
                –∏–º—è = st.text_input("–§–ò–û")
                –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ = st.selectbox("–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ", ["‚Äî"] + –ü–û–î–†–ê–ó–î–ï–õ–ï–ù–ò–Ø)
                –¥–æ–ª–∂–Ω–æ—Å—Ç—å = st.selectbox("–î–æ–ª–∂–Ω–æ—Å—Ç—å", ["‚Äî"] + –î–û–õ–ñ–ù–û–°–¢–ò)
                c1, c2 = st.columns(2)
                with c1:
                    if st.form_submit_button("–í–æ–π—Ç–∏", use_container_width=True):
                        if –∏–º—è and –¥–æ–ª–∂–Ω–æ—Å—Ç—å != "‚Äî" and –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ != "‚Äî":
                            st.session_state.–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω = True
                            st.session_state.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = {"–∏–º—è": –∏–º—è, "–¥–æ–ª–∂–Ω–æ—Å—Ç—å": –¥–æ–ª–∂–Ω–æ—Å—Ç—å, "–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ": –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ}
                            st.session_state.—Ä–æ–ª—å = –†–û–õ–¨_–Æ–ó–ï–†
                            st.rerun()
                        elif –∏–º—è and (–¥–æ–ª–∂–Ω–æ—Å—Ç—å == "‚Äî" or –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ == "‚Äî"):
                            st.error("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å")
                with c2:
                    if st.form_submit_button("–î–µ–º–æ", use_container_width=True):
                        st.session_state.–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω = True
                        st.session_state.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = {"–∏–º—è": "–î–µ–º–æ", "–¥–æ–ª–∂–Ω–æ—Å—Ç—å": "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ": "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"}
                        st.session_state.—Ä–æ–ª—å = –†–û–õ–¨_–Æ–ó–ï–†
                        st.session_state.—Ç–µ–∫—Å—Ç = –î–ï–ú–û_–î–û–ì–û–í–û–†
                        st.session_state.–º–µ—Ç–æ–¥_–∑–∞–≥—Ä—É–∑–∫–∏ = "text"
                        st.rerun()
        
        with tab2:
            with st.form("admin_form"):
                –ª–æ–≥–∏–Ω = st.text_input("–õ–æ–≥–∏–Ω")
                –ø–∞—Ä–æ–ª—å = st.text_input("–ü–∞—Ä–æ–ª—å", type="password")
                if st.form_submit_button("–í–æ–π—Ç–∏", use_container_width=True):
                    if –ª–æ–≥–∏–Ω in –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò and –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò[–ª–æ–≥–∏–Ω]["—Ö–µ—à"] == hashlib.sha256(–ø–∞—Ä–æ–ª—å.encode()).hexdigest():
                        st.session_state.–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω = True
                        st.session_state.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = {"–∏–º—è": –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò[–ª–æ–≥–∏–Ω]["–∏–º—è"], "–¥–æ–ª–∂–Ω–æ—Å—Ç—å": "–ê–¥–º–∏–Ω", "–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è"}
                        st.session_state.—Ä–æ–ª—å = –†–û–õ–¨_–ê–î–ú–ò–ù
                        st.rerun()
            st.caption("admin/admin123")


def –±–æ–∫–æ–≤–∞—è_–ø–∞–Ω–µ–ª—å():
    with st.sidebar:
        user = st.session_state.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        is_admin = —ç—Ç–æ_–∞–¥–º–∏–Ω()
        badge = "admin-badge" if is_admin else "user-badge"
        –ø–æ–¥—Ä = user.get("–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ", "")
        st.markdown(f'''
        <div style="padding:15px;background:#f5f5f5;border-radius:8px;margin-bottom:20px;">
            <div style="font-weight:600;">{user["–∏–º—è"]}</div>
            <div style="font-size:0.85rem;color:#666;">{–ø–æ–¥—Ä}</div>
            <div style="font-size:0.8rem;color:#888;">{user.get("–¥–æ–ª–∂–Ω–æ—Å—Ç—å", "")}</div>
            <span class="{badge}">{"–ê–î–ú–ò–ù" if is_admin else "–Æ–ó–ï–†"}</span>
        </div>
        ''', unsafe_allow_html=True)
        
        if st.button("–í—ã–π—Ç–∏", use_container_width=True):
            for k in list(st.session_state.keys()): del st.session_state[k]
            st.rerun()
        
        st.markdown("---")
        –ø–æ—Ä–æ–≥–∏ = st.session_state.get("–ø–æ—Ä–æ–≥–∏", DEFAULT_THRESHOLDS)
        st.markdown(f"üü¢ –¢–§ ‚â§ {–ø–æ—Ä–æ–≥–∏['–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å']:,}‚ÇΩ")
        st.markdown(f"üü° –¥–æ {–ø–æ—Ä–æ–≥–∏['–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å']:,}‚ÇΩ")
        st.markdown(f"üî¥ > {–ø–æ—Ä–æ–≥–∏['–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å']:,}‚ÇΩ")
        
        api = st.session_state.get("api_–∫–ª—é—á–∏", {})
        st.markdown("---")
        st.markdown(f"ü§ñ AI: {len([p for p in AI_–ü–†–û–í–ê–ô–î–ï–†–´ if api.get(p)])} –ø—Ä–æ–≤–∞–π–¥–µ—Ä(–∞)")
        
        # OCR —Å—Ç–∞—Ç—É—Å
        ocr_status = OCRProcessor.get_ocr_status()
        st.markdown(f"üîç OCR: {'‚úÖ' if ocr_status['available'] else '‚ùå'}")

# ============================================================================
# –í–ö–õ–ê–î–ö–ê –ê–ù–ê–õ–ò–ó–ê
# ============================================================================

def –≤–∫–ª–∞–¥–∫–∞_–∞–Ω–∞–ª–∏–∑–∞():
    st.markdown('<div class="npk-title">–ê–ù–ê–õ–ò–ó –î–û–ö–£–ú–ï–ù–¢–ê</div>', unsafe_allow_html=True)
    
    # –ó–∞–≥—Ä—É–∑–∫–∞
    st.markdown('<div class="npk-section">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>', unsafe_allow_html=True)
    
    # OCR —Å—Ç–∞—Ç—É—Å
    ocr_status = OCRProcessor.get_ocr_status()
    if ocr_status["available"]:
        st.info(f"üîç **OCR –≤–∫–ª—é—á—ë–Ω** ‚Äî –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–∫–∞–Ω—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (rus+eng)")
        file_types = ["txt", "docx", "pdf", "png", "jpg", "jpeg", "tiff", "tif", "bmp"]
        formats_hint = "DOCX, PDF, TXT, PNG, JPG, TIFF (OCR)"
    else:
        st.warning(f"‚ö†Ô∏è OCR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {ocr_status['message']}")
        file_types = ["txt", "docx", "pdf"]
        formats_hint = "DOCX, PDF, TXT"
    
    —Ñ–∞–π–ª = st.file_uploader(f"–§–∞–π–ª ({formats_hint})", type=file_types, label_visibility="collapsed")
    
    c1, c2, c3 = st.columns(3)
    with c1:
        if st.button("üìù –î–µ–º–æ-–¥–æ–≥–æ–≤–æ—Ä", use_container_width=True):
            st.session_state.—Ç–µ–∫—Å—Ç = –î–ï–ú–û_–î–û–ì–û–í–û–†
            st.session_state.–º–µ—Ç–æ–¥_–∑–∞–≥—Ä—É–∑–∫–∏ = "text"
            st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è = –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–î–æ–≥–æ–≤–æ—Ä–∞.–ø–æ–ª–Ω–∞—è_–ø—Ä–æ–≤–µ—Ä–∫–∞(–î–ï–ú–û_–î–û–ì–û–í–û–†)
            st.session_state.–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ = –∏–∑–≤–ª–µ—á—å_–≤—Å–µ_–¥–∞–Ω–Ω—ã–µ(–î–ï–ú–û_–î–û–ì–û–í–û–†)
            st.session_state.rag = None
            st.session_state.ai = ""
            st.rerun()
    with c2:
        if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å", use_container_width=True):
            st.session_state.—Ç–µ–∫—Å—Ç = ""
            st.session_state.–º–µ—Ç–æ–¥_–∑–∞–≥—Ä—É–∑–∫–∏ = ""
            st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è = None
            st.session_state.–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ = None
            st.session_state.–∑–æ–Ω–∞ = None
            st.session_state.rag = None
            st.session_state.ai = ""
            st.rerun()
    
    if —Ñ–∞–π–ª:
        ok, —Ç–µ–∫—Å—Ç, meta = –∑–∞–≥—Ä—É–∑–∏—Ç—å_—Ñ–∞–π–ª(—Ñ–∞–π–ª)
        if ok and —Ç–µ–∫—Å—Ç != st.session_state.—Ç–µ–∫—Å—Ç:
            st.session_state.—Ç–µ–∫—Å—Ç = —Ç–µ–∫—Å—Ç[:300000]
            st.session_state.–º–µ—Ç–æ–¥_–∑–∞–≥—Ä—É–∑–∫–∏ = meta.get("–º–µ—Ç–æ–¥", "text")
            st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è = –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–î–æ–≥–æ–≤–æ—Ä–∞.–ø–æ–ª–Ω–∞—è_–ø—Ä–æ–≤–µ—Ä–∫–∞(—Ç–µ–∫—Å—Ç)
            st.session_state.–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ = –∏–∑–≤–ª–µ—á—å_–≤—Å–µ_–¥–∞–Ω–Ω—ã–µ(—Ç–µ–∫—Å—Ç)
            st.session_state.rag = None
            st.session_state.ai = ""
            –º–µ—Ç–æ–¥ = "üîç OCR" if meta.get("ocr") else "üìÑ –¢–µ–∫—Å—Ç"
            —Å—Ç—Ä–∞–Ω–∏—Ü = f", {meta.get('—Å—Ç—Ä–∞–Ω–∏—Ü', 1)} —Å—Ç—Ä." if meta.get('—Å—Ç—Ä–∞–Ω–∏—Ü', 1) > 1 else ""
            st.success(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(—Ç–µ–∫—Å—Ç):,} —Å–∏–º–≤–æ–ª–æ–≤ | {–º–µ—Ç–æ–¥} | {meta.get('—Ñ–æ—Ä–º–∞—Ç', '')}{—Å—Ç—Ä–∞–Ω–∏—Ü}")
            st.rerun()
        elif not ok:
            st.error(—Ç–µ–∫—Å—Ç)
    
    # ========== –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–ê ==========
    if st.session_state.—Ç–µ–∫—Å—Ç and st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
        –∏–¥–µ–Ω—Ç = st.session_state.–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        –∏–∑–≤–ª = st.session_state.–∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ or {}
        
        st.markdown('<div class="npk-section">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>', unsafe_allow_html=True)
        
        # OCR –±–µ–π–¥–∂
        ocr_badge = ' <span style="background:#3b82f6;color:white;padding:2px 8px;border-radius:4px;font-size:0.75rem;">üîç OCR</span>' if st.session_state.get("–º–µ—Ç–æ–¥_–∑–∞–≥—Ä—É–∑–∫–∏") == "ocr" else ""
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if –∏–¥–µ–Ω—Ç.get("—ç—Ç–æ_–¥–æ–≥–æ–≤–æ—Ä") and –∏–¥–µ–Ω—Ç.get("—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", 0) >= 60:
            css_class = "–¥–æ–≥–æ–≤–æ—Ä"
            emoji = "‚úÖ"
            –∑–∞–≥–æ–ª–æ–≤–æ–∫ = f"–î–û–ì–û–í–û–†: {–∏–¥–µ–Ω—Ç.get('—Ç–∏–ø', '–¢–∏–ø –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω')}"
        elif –∏–¥–µ–Ω—Ç.get("—ç—Ç–æ_–¥–æ–≥–æ–≤–æ—Ä"):
            css_class = "–≤–æ–∑–º–æ–∂–Ω–æ"
            emoji = "‚ö†Ô∏è"
            –∑–∞–≥–æ–ª–æ–≤–æ–∫ = f"–í–û–ó–ú–û–ñ–ù–û –î–û–ì–û–í–û–†: {–∏–¥–µ–Ω—Ç.get('—Ç–∏–ø', '')}"
        else:
            css_class = "–Ω–µ-–¥–æ–≥–æ–≤–æ—Ä"
            emoji = "‚ùå"
            –∑–∞–≥–æ–ª–æ–≤–æ–∫ = f"–ù–ï –î–û–ì–û–í–û–†: {–∏–¥–µ–Ω—Ç.get('—Ç–∏–ø', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç')}"
        
        # –î–µ—Ç–∞–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        –¥–µ—Ç–∞–ª–∏ = –∏–¥–µ–Ω—Ç.get("–¥–µ—Ç–∞–ª–∏", {})
        score_html = ""
        for –∫–ª—é—á, –¥–∞–Ω–Ω—ã–µ in –¥–µ—Ç–∞–ª–∏.items():
            css = "ok" if –¥–∞–Ω–Ω—ã–µ.get("ok") else "fail"
            score_html += f'<div class="id-score-item {css}">{–∫–ª—é—á}: {–¥–∞–Ω–Ω—ã–µ.get("score", 0)}/{–¥–∞–Ω–Ω—ã–µ.get("–º–∞–∫—Å", 0)}</div>'
        
        st.markdown(f'''
        <div class="id-card {css_class}">
            <h3 style="margin:0;">{emoji} {–∑–∞–≥–æ–ª–æ–≤–æ–∫}{ocr_badge}</h3>
            <p style="margin:10px 0;color:#666;">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <strong>{–∏–¥–µ–Ω—Ç.get("—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", 0)}%</strong></p>
            <p style="margin:0;">{–∏–¥–µ–Ω—Ç.get("–ø—Ä–∏—á–∏–Ω–∞", "")}</p>
            <div class="id-score">{score_html}</div>
        </div>
        ''', unsafe_allow_html=True)
        
        # ========== –ë–õ–û–ö–ò–†–û–í–ö–ê –î–õ–Ø –ù–ï-–î–û–ì–û–í–û–†–û–í ==========
        –º–æ–∂–Ω–æ_–ø—Ä–æ–≤–µ—Ä—è—Ç—å = –∏–¥–µ–Ω—Ç.get("–º–æ–∂–Ω–æ_–ø—Ä–æ–≤–µ—Ä—è—Ç—å", False)
        
        if not –º–æ–∂–Ω–æ_–ø—Ä–æ–≤–µ—Ä—è—Ç—å:
            st.markdown('''
            <div class="block-message">
                <strong>‚õî –ü–†–û–í–ï–†–ö–ê –ù–ï–î–û–°–¢–£–ü–ù–ê</strong><br>
                –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä. RAG-—Å–ª–∏—á–µ–Ω–∏–µ –∏ AI-—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –ø—Ä–∏–º–µ–Ω–∏–º—ã —Ç–æ–ª—å–∫–æ –∫ –¥–æ–≥–æ–≤–æ—Ä–∞–º.
            </div>
            ''', unsafe_allow_html=True)
            return  # –í–´–•–û–î - –¥–∞–ª—å—à–µ –Ω–µ –∏–¥—ë–º!
        
        # ========== –ò–ó–í–õ–ï–ß–Å–ù–ù–´–ï –î–ê–ù–ù–´–ï ==========
        st.markdown('<div class="npk-section">–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>', unsafe_allow_html=True)
        
        # –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞
        —Å—Ç–æ—Ä–æ–Ω—ã = –∏–∑–≤–ª.get("—Å—Ç–æ—Ä–æ–Ω—ã", [])
        –æ—Ä–≥ = st.session_state.get("–æ—Ä–≥", DEFAULT_ORG)
        –Ω–∞—à–∞_–æ—Ä–≥ = –æ—Ä–≥.get("short_name", "–°–ü–ö").upper()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—à—É —Ä–æ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        –Ω–∞—à–∞_—Ä–æ–ª—å_–∞–≤—Ç–æ = ""
        –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_—Ä–æ–ª—å = ""
        –Ω–∞—à–∞_—Å—Ç–æ—Ä–æ–Ω–∞ = None
        –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_—Å—Ç–æ—Ä–æ–Ω–∞ = None
        
        for —Å in —Å—Ç–æ—Ä–æ–Ω—ã:
            –Ω–∞–∑–≤–∞–Ω–∏–µ = —Å.get("–∫–æ—Ä–æ—Ç–∫–æ–µ", "").upper()
            if –Ω–∞—à–∞_–æ—Ä–≥ in –Ω–∞–∑–≤–∞–Ω–∏–µ or "–°–ü–ö" in –Ω–∞–∑–≤–∞–Ω–∏–µ:
                –Ω–∞—à–∞_—Ä–æ–ª—å_–∞–≤—Ç–æ = —Å.get("—Ä–æ–ª—å", "")
                –Ω–∞—à–∞_—Å—Ç–æ—Ä–æ–Ω–∞ = —Å
            else:
                –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_—Ä–æ–ª—å = —Å.get("—Ä–æ–ª—å", "")
                –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_—Å—Ç–æ—Ä–æ–Ω–∞ = —Å
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ—Ä–æ–Ω—ã —Å –ø–æ–º–µ—Ç–∫–æ–π "–ú–´"
        if —Å—Ç–æ—Ä–æ–Ω—ã:
            st.markdown("**–°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞:**")
            cols = st.columns(len(—Å—Ç–æ—Ä–æ–Ω—ã)) if len(—Å—Ç–æ—Ä–æ–Ω—ã) <= 3 else st.columns(2)
            for i, —Å—Ç–æ—Ä–æ–Ω–∞ in enumerate(—Å—Ç–æ—Ä–æ–Ω—ã[:4]):
                with cols[i % len(cols)]:
                    —Ä–æ–ª—å = —Å—Ç–æ—Ä–æ–Ω–∞.get("—Ä–æ–ª—å", "–°—Ç–æ—Ä–æ–Ω–∞")
                    –Ω–∞–∑–≤–∞–Ω–∏–µ = —Å—Ç–æ—Ä–æ–Ω–∞.get("–∫–æ—Ä–æ—Ç–∫–æ–µ", —Å—Ç–æ—Ä–æ–Ω–∞.get("–Ω–∞–∑–≤–∞–Ω–∏–µ", ""))
                    –∏–Ω–Ω = —Å—Ç–æ—Ä–æ–Ω–∞.get("–∏–Ω–Ω", "")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –Ω–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è?
                    —ç—Ç–æ_–º—ã = –Ω–∞—à–∞_–æ—Ä–≥ in –Ω–∞–∑–≤–∞–Ω–∏–µ.upper() or "–°–ü–ö" in –Ω–∞–∑–≤–∞–Ω–∏–µ.upper()
                    
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ —Ä–æ–ª–∏
                    if —ç—Ç–æ_–º—ã:
                        —Ü–≤–µ—Ç = "#22c55e"  # –ó–µ–ª—ë–Ω—ã–π –¥–ª—è –Ω–∞—Å
                        –º–µ—Ç–∫–∞ = " üëà –ú–´"
                    else:
                        —Ü–≤–µ—Ç = "#3b82f6"  # –°–∏–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
                        –º–µ—Ç–∫–∞ = ""
                    
                    st.markdown(f'''
                    <div style="background:#f5f5f5;padding:12px;border-radius:8px;border-left:4px solid {—Ü–≤–µ—Ç};">
                        <div style="font-size:0.85rem;color:{—Ü–≤–µ—Ç};font-weight:600;">{—Ä–æ–ª—å}{–º–µ—Ç–∫–∞}</div>
                        <div style="font-weight:500;">{–Ω–∞–∑–≤–∞–Ω–∏–µ}</div>
                        {"<div style='font-size:0.8rem;color:#666;'>–ò–ù–ù: " + –∏–Ω–Ω + "</div>" if –∏–Ω–Ω else ""}
                    </div>
                    ''', unsafe_allow_html=True)
        
        st.markdown("")  # –û—Ç—Å—Ç—É–ø
        
        # –í—ã–±–æ—Ä –Ω–∞—à–µ–π —Ä–æ–ª–∏ –≤ –¥–æ–≥–æ–≤–æ—Ä–µ
        –†–û–õ–ò_–í_–î–û–ì–û–í–û–†–ï = ["–ó–∞–∫–∞–∑—á–∏–∫", "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å", "–ü—Ä–æ–¥–∞–≤–µ—Ü", "–ü–æ—Å—Ç–∞–≤—â–∏–∫", 
                          "–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä", "–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å", "–ü–æ–¥—Ä—è–¥—á–∏–∫", "–ó–∞—ë–º—â–∏–∫", "–ó–∞–π–º–æ–¥–∞–≤–µ—Ü"]
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        default_role_idx = 0
        if –Ω–∞—à–∞_—Ä–æ–ª—å_–∞–≤—Ç–æ in –†–û–õ–ò_–í_–î–û–ì–û–í–û–†–ï:
            default_role_idx = –†–û–õ–ò_–í_–î–û–ì–û–í–û–†–ï.index(–Ω–∞—à–∞_—Ä–æ–ª—å_–∞–≤—Ç–æ)
        
        c1, c2 = st.columns(2)
        with c1:
            –Ω–∞—à–∞_—Ä–æ–ª—å = st.selectbox(
                "üè¢ –ù–∞—à–∞ —Ä–æ–ª—å –≤ –¥–æ–≥–æ–≤–æ—Ä–µ", 
                –†–û–õ–ò_–í_–î–û–ì–û–í–û–†–ï, 
                index=default_role_idx,
                help="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ —ç—Ç–æ–º –¥–æ–≥–æ–≤–æ—Ä–µ"
            )
            –Ω–æ–º–µ—Ä = st.text_input("‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞", value=–∏–∑–≤–ª.get("–Ω–æ–º–µ—Ä") or "")
            –¥–∞—Ç–∞_–¥–æ–≥ = –∏–∑–≤–ª.get("–¥–∞—Ç–∞")
            –¥–∞—Ç–∞_str = st.text_input("–î–∞—Ç–∞", value=–¥–∞—Ç–∞_–¥–æ–≥.strftime("%d.%m.%Y") if –¥–∞—Ç–∞_–¥–æ–≥ else "")
        with c2:
            –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç = st.text_input("–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç", value=–∏–∑–≤–ª.get("–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç") or "")
            —Å—É–º–º–∞_str = st.text_input("–°—É–º–º–∞ (‚ÇΩ)", value=f"{–∏–∑–≤–ª['—Å—É–º–º–∞']:,.0f}".replace(",", " ") if –∏–∑–≤–ª.get("—Å—É–º–º–∞") else "")
            —Ñ–æ—Ä–º–∞ = st.selectbox("–§–æ—Ä–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞", –§–û–†–ú–´_–î–û–ö–£–ú–ï–ù–¢–ê)
        
        —Ç–∏–ø_—Å–¥–µ–ª–∫–∏ = st.selectbox("–¢–∏–ø —Å–¥–µ–ª–∫–∏", ["‚Äî –û–±—ã—á–Ω—ã–π ‚Äî"] + –ö–†–ê–°–ù–ê–Ø_–ó–û–ù–ê + –ñ–Å–õ–¢–ê–Ø_–ó–û–ù–ê)
        
        —Å—É–º–º–∞ = float(re.sub(r'[^\d]', '', —Å—É–º–º–∞_str)) if —Å—É–º–º–∞_str else 0
        if —Ç–∏–ø_—Å–¥–µ–ª–∫–∏ == "‚Äî –û–±—ã—á–Ω—ã–π ‚Äî": —Ç–∏–ø_—Å–¥–µ–ª–∫–∏ = ""
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—à—É —Ä–æ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        st.session_state["–Ω–∞—à–∞_—Ä–æ–ª—å"] = –Ω–∞—à–∞_—Ä–æ–ª—å
        
        # ========== –ö–ù–û–ü–ö–ò –ê–ù–ê–õ–ò–ó–ê ==========
        st.markdown('<div class="npk-section">–ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</div>', unsafe_allow_html=True)
        
        c1, c2, c3 = st.columns(3)
        
        with c1:
            if st.button("üö¶ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–æ–Ω—É", type="primary", use_container_width=True):
                st.session_state.–∑–æ–Ω–∞ = –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å_–∑–æ–Ω—É(—Å—É–º–º–∞, —Ñ–æ—Ä–º–∞, —Ç–∏–ø_—Å–¥–µ–ª–∫–∏)
                st.rerun()
        
        with c2:
            –≤—Å–µ_—Ç—Ñ = {**–¢–ò–ü–û–í–´–ï_–§–û–†–ú–´, **st.session_state.get("–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ_—Ç—Ñ", {})}
            —Ç—Ñ_–æ–ø—Ü–∏–∏ = list(–≤—Å–µ_—Ç—Ñ.keys())
            —Ç—Ñ_–Ω–∞–∑–≤–∞–Ω–∏—è = {k: v["–Ω–∞–∑–≤–∞–Ω–∏–µ"] for k, v in –≤—Å–µ_—Ç—Ñ.items()}
            
            # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¢–§ –ø–æ —Ç–∏–ø—É –¥–æ–≥–æ–≤–æ—Ä–∞
            —Ç–∏–ø_–¥–æ–≥–æ–≤–æ—Ä–∞ = –∏–¥–µ–Ω—Ç.get("—Ç–∏–ø", "").lower()
            default_idx = 0
            if "—É—Å–ª—É–≥" in —Ç–∏–ø_–¥–æ–≥–æ–≤–æ—Ä–∞ or "—Ç—ç–æ" in —Ç–∏–ø_–¥–æ–≥–æ–≤–æ—Ä–∞:
                default_idx = —Ç—Ñ_–æ–ø—Ü–∏–∏.index("—É—Å–ª—É–≥–∏_—Ç—ç–æ") if "—É—Å–ª—É–≥–∏_—Ç—ç–æ" in —Ç—Ñ_–æ–ø—Ü–∏–∏ else 0
            elif "–ø–æ—Å—Ç–∞–≤–∫" in —Ç–∏–ø_–¥–æ–≥–æ–≤–æ—Ä–∞:
                default_idx = —Ç—Ñ_–æ–ø—Ü–∏–∏.index("–ø–æ—Å—Ç–∞–≤–∫–∞") if "–ø–æ—Å—Ç–∞–≤–∫–∞" in —Ç—Ñ_–æ–ø—Ü–∏–∏ else 0
            
            –∫–æ–¥_—Ç—Ñ = st.selectbox("–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞", —Ç—Ñ_–æ–ø—Ü–∏–∏, index=default_idx, format_func=lambda x: —Ç—Ñ_–Ω–∞–∑–≤–∞–Ω–∏—è.get(x, x))
        
        with c3:
            if st.button("üìä RAG-—Å–ª–∏—á–µ–Ω–∏–µ", type="primary", use_container_width=True):
                st.session_state.rag = –°—Ç—Ä–æ–≥–∏–πRAG.–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å(st.session_state.—Ç–µ–∫—Å—Ç, –∫–æ–¥_—Ç—Ñ)
                st.rerun()
        
        # AI
        api = st.session_state.get("api_–∫–ª—é—á–∏", {})
        if any(api.get(p) for p in AI_–ü–†–û–í–ê–ô–î–ï–†–´):
            if st.button("ü§ñ AI-—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞", type="primary", use_container_width=True):
                placeholder = st.empty()
                placeholder.markdown('<div class="loading"><div class="train">üöÇüöÉüöÉüöÉ</div><p>AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç...</p></div>', unsafe_allow_html=True)
                rag = st.session_state.get("rag") or {"–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è": [], "—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è": [], "–∑–æ–Ω–∞": "–∫—Ä–∞—Å–Ω–∞—è", "–∫—Ä–∞—Å–Ω—ã—Ö": 0, "–∂—ë–ª—Ç—ã—Ö": 0, "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ": 0}
                ok, —Ä–µ–∑—É–ª—å—Ç–∞—Ç = ai_–∞–Ω–∞–ª–∏–∑(st.session_state.—Ç–µ–∫—Å—Ç, –∏–∑–≤–ª, –∏–¥–µ–Ω—Ç, rag)
                placeholder.empty()
                if ok:
                    st.session_state.ai = —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    st.rerun()
                else:
                    st.error(—Ä–µ–∑—É–ª—å—Ç–∞—Ç)
        else:
            st.info("–î–ª—è AI –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö")
        
        # ========== –†–ï–ó–£–õ–¨–¢–ê–¢–´ ==========
        
        # –ó–æ–Ω–∞
        if st.session_state.–∑–æ–Ω–∞:
            –∑ = st.session_state.–∑–æ–Ω–∞
            emoji = {"–∑–µ–ª—ë–Ω–∞—è": "üü¢", "–∂—ë–ª—Ç–∞—è": "üü°", "–∫—Ä–∞—Å–Ω–∞—è": "üî¥"}.get(–∑["–∑–æ–Ω–∞"], "‚ö™")
            st.markdown(f'''
            <div class="zone-card {–∑["–∑–æ–Ω–∞"]}">
                <h3>{emoji} {–∑["–∑–æ–Ω–∞"].upper()} –ó–û–ù–ê</h3>
                <p>{–∑["–ø—Ä–∏—á–∏–Ω–∞"]}</p>
                <p><strong>–¢—Ä–µ–±—É–µ—Ç—Å—è –Æ–î:</strong> {"–î–∞" if –∑["—é–¥"] else "–ù–µ—Ç"} | <strong>–°—Ä–æ–∫:</strong> {–∑["—Å—Ä–æ–∫"]} –¥–Ω.</p>
            </div>
            ''', unsafe_allow_html=True)
        
        # RAG
        if st.session_state.rag:
            –ø–æ–∫–∞–∑–∞—Ç—å_rag()
        
        # AI
        if st.session_state.ai:
            st.markdown('<div class="npk-section">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ AI</div>', unsafe_allow_html=True)
            st.markdown(f'<div class="ai-result">{st.session_state.ai}</div>', unsafe_allow_html=True)


def –ø–æ–∫–∞–∑–∞—Ç—å_rag():
    """–ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ RAG"""
    rag = st.session_state.rag
    
    st.markdown(f'<div class="npk-section">RAG-—Å–ª–∏—á–µ–Ω–∏–µ: {rag.get("–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç—Ñ", "")}</div>', unsafe_allow_html=True)
    
    # –ú–µ—Ç—Ä–∏–∫–∏
    —Å–æ–æ—Ç–≤ = rag.get("—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ", 0)
    —Ü–≤–µ—Ç = "green" if —Å–æ–æ—Ç–≤ >= 80 else ("yellow" if —Å–æ–æ—Ç–≤ >= 50 else "red")
    –∑–æ–Ω–∞_css = rag.get("–∑–æ–Ω–∞", "–∫—Ä–∞—Å–Ω–∞—è")
    –∑–æ–Ω–∞_emoji = {"–∑–µ–ª—ë–Ω–∞—è": "‚úÖ", "–∂—ë–ª—Ç–∞—è": "‚ö†Ô∏è", "–∫—Ä–∞—Å–Ω–∞—è": "‚ùå"}.get(–∑–æ–Ω–∞_css, "‚ùå")
    
    st.markdown(f'''
    <div class="metrics">
        <div class="metric">
            <div class="metric-value {—Ü–≤–µ—Ç}">{—Å–æ–æ—Ç–≤}%</div>
            <div class="metric-label">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
        </div>
        <div class="metric">
            <div class="metric-value red">{rag.get("–∫—Ä–∞—Å–Ω—ã—Ö", 0)}</div>
            <div class="metric-label">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö</div>
        </div>
        <div class="metric">
            <div class="metric-value yellow">{rag.get("–∂—ë–ª—Ç—ã—Ö", 0)}</div>
            <div class="metric-label">üü° –ó–∞–º–µ—á–∞–Ω–∏–π</div>
        </div>
        <div class="metric">
            <div class="metric-value">{–∑–æ–Ω–∞_emoji}</div>
            <div class="metric-label">{rag.get("–≤–µ—Ä–¥–∏–∫—Ç", "")}</div>
        </div>
    </div>
    ''', unsafe_allow_html=True)
    
    # –ó–æ–Ω–∞ RAG
    st.markdown(f'''
    <div class="zone-card {–∑–æ–Ω–∞_css}">
        <strong>{rag.get("—Ä–µ–∑—é–º–µ", "")}</strong>
    </div>
    ''', unsafe_allow_html=True)
    
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
    –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ = rag.get("–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è", [])
    if –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:
        st.markdown("#### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è")
        for –Ω in –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:
            –ø—É–Ω–∫—Ç = f"**–ü—É–Ω–∫—Ç {–Ω['–ø—É–Ω–∫—Ç']}**" if –Ω.get("–ø—É–Ω–∫—Ç") else ""
            st.markdown(f'''
            <div class="violation-card critical">
                {–ø—É–Ω–∫—Ç} <strong>{–Ω.get("–æ–ø–∏—Å–∞–Ω–∏–µ", "")}</strong><br>
                <div class="violation-context">{–Ω.get("–∫–æ–Ω—Ç–µ–∫—Å—Ç", "")}</div>
                <strong>‚ùå –ü—Ä–æ–±–ª–µ–º–∞:</strong> {–Ω.get("–ø–æ—è—Å–Ω–µ–Ω–∏–µ", "")}<br>
                <span class="violation-fix">‚úÖ –≠—Ç–∞–ª–æ–Ω –¢–§:</span> {–Ω.get("—ç—Ç–∞–ª–æ–Ω", "")}
            </div>
            ''', unsafe_allow_html=True)
    
    # –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ
    —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ = rag.get("—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ_–Ω–∞—Ä—É—à–µ–Ω–∏—è", [])
    if —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ:
        with st.expander(f"üü° –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è ({len(—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ)})"):
            for –Ω in —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ:
                –ø—É–Ω–∫—Ç = f"–ø.{–Ω['–ø—É–Ω–∫—Ç']} ‚Äî " if –Ω.get("–ø—É–Ω–∫—Ç") else ""
                st.markdown(f'''
                <div class="violation-card warning">
                    <strong>{–ø—É–Ω–∫—Ç}{–Ω.get("–æ–ø–∏—Å–∞–Ω–∏–µ", "")}</strong><br>
                    <small>{–Ω.get("–∫–æ–Ω—Ç–µ–∫—Å—Ç", "")[:150]}</small><br>
                    <span class="violation-fix">‚úÖ –≠—Ç–∞–ª–æ–Ω:</span> {–Ω.get("—ç—Ç–∞–ª–æ–Ω", "")}
                </div>
                ''', unsafe_allow_html=True)
    
    # –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã
    –æ—Ç—Å—É—Ç—Å—Ç–≤ = rag.get("–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ_—Ä–∞–∑–¥–µ–ª—ã", [])
    if –æ—Ç—Å—É—Ç—Å—Ç–≤:
        with st.expander(f"üìã –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã ({len(–æ—Ç—Å—É—Ç—Å—Ç–≤)})"):
            for —Ä in –æ—Ç—Å—É—Ç—Å—Ç–≤:
                st.markdown(f"- ‚ö†Ô∏è {—Ä}")

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================================================

def –≤–∫–ª–∞–¥–∫–∞_–Ω–∞—Å—Ç—Ä–æ–µ–∫():
    st.markdown('<div class="npk-title">–ù–ê–°–¢–†–û–ô–ö–ò</div>', unsafe_allow_html=True)
    
    tabs = st.tabs(["–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "–ü–æ—Ä–æ–≥–∏", "AI API", "OCR"])
    
    # ===== –û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø =====
    with tabs[0]:
        st.markdown("### –î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏")
        –æ—Ä–≥ = st.session_state.get("–æ—Ä–≥", DEFAULT_ORG)
        
        new_full = st.text_input("–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", value=–æ—Ä–≥.get("full_name", ""))
        new_short = st.text_input("–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", value=–æ—Ä–≥.get("short_name", ""))
        new_inn = st.text_input("–ò–ù–ù", value=–æ—Ä–≥.get("inn", ""))
        
        if st.button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é", key="save_org"):
            st.session_state.–æ—Ä–≥ = {"full_name": new_full, "short_name": new_short, "inn": new_inn}
            st.success("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
        
        st.markdown("---")
        st.caption("–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ (–∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –≤–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)")
    
    # ===== –ü–û–†–û–ì–ò =====
    with tabs[1]:
        st.markdown("### –ü–æ—Ä–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –¥–ª—è –∑–æ–Ω")
        –ø–æ—Ä–æ–≥–∏ = st.session_state.get("–ø–æ—Ä–æ–≥–∏", DEFAULT_THRESHOLDS)
        
        new_tf = st.number_input("üü¢ –ó–µ–ª—ë–Ω–∞—è –¢–§ –º–∞–∫—Å (‚ÇΩ)", value=–ø–æ—Ä–æ–≥–∏.get("–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å", 100000), step=10000)
        new_ntf = st.number_input("üü¢ –ó–µ–ª—ë–Ω–∞—è –Ω–µ—Ç–∏–ø–æ–≤–∞—è –º–∞–∫—Å (‚ÇΩ)", value=–ø–æ—Ä–æ–≥–∏.get("–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å", 50000), step=10000)
        new_yellow = st.number_input("üü°‚Üíüî¥ –ñ—ë–ª—Ç–∞—è ‚Üí –ö—Ä–∞—Å–Ω–∞—è (‚ÇΩ)", value=–ø–æ—Ä–æ–≥–∏.get("–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å", 5000000), step=100000)
        
        if st.button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä–æ–≥–∏", key="save_thresh"):
            st.session_state.–ø–æ—Ä–æ–≥–∏ = {"–∑–µ–ª—ë–Ω–∞—è_—Ç—Ñ_–º–∞–∫—Å": new_tf, "–∑–µ–ª—ë–Ω–∞—è_–Ω–µ—Ç—Ñ_–º–∞–∫—Å": new_ntf, "–∂—ë–ª—Ç–∞—è_–º–∞–∫—Å": new_yellow}
            st.success("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
    
    # ===== AI API =====
    with tabs[2]:
        st.markdown("### API-–∫–ª—é—á–∏ –¥–ª—è AI-—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã")
        st.caption("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–ª—é—á –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤")
        
        api = st.session_state.get("api_–∫–ª—é—á–∏", {})
        
        for pid, info in AI_–ü–†–û–í–ê–ô–î–ï–†–´.items():
            col1, col2 = st.columns([3, 1])
            with col1:
                st.markdown(f"**{info['–Ω–∞–∑–≤–∞–Ω–∏–µ']}**")
            with col2:
                if api.get(pid):
                    st.markdown("‚úÖ –ê–∫—Ç–∏–≤–µ–Ω")
                else:
                    st.markdown("‚ùå –ù–µ –∑–∞–¥–∞–Ω")
            
            –Ω–æ–≤—ã–π = st.text_input(
                f"–ö–ª—é—á {info['–Ω–∞–∑–≤–∞–Ω–∏–µ']}", 
                type="password", 
                value=api.get(pid, ""), 
                key=f"api_{pid}",
                placeholder=f"–ü–æ–ª—É—á–∏—Ç—å: {info['url']}"
            )
            if –Ω–æ–≤—ã–π != api.get(pid, ""):
                if "api_–∫–ª—é—á–∏" not in st.session_state: 
                    st.session_state.api_–∫–ª—é—á–∏ = {}
                st.session_state.api_–∫–ª—é—á–∏[pid] = –Ω–æ–≤—ã–π
                st.success(f"‚úÖ {info['–Ω–∞–∑–≤–∞–Ω–∏–µ']} —Å–æ—Ö—Ä–∞–Ω—ë–Ω")
            st.markdown("---")
    
    # ===== OCR =====
    with tabs[3]:
        st.markdown("### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OCR")
        
        ocr_status = OCRProcessor.get_ocr_status()
        
        # –°—Ç–∞—Ç—É—Å –±–∞–∑–æ–≤–æ–≥–æ OCR
        st.markdown("#### üîç –ë–∞–∑–æ–≤—ã–π OCR (Tesseract)")
        if ocr_status["available"]:
            st.success(f"‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç: {ocr_status['message']}")
        else:
            st.error(f"‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {ocr_status['message']}")
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.markdown(f"pytesseract: {'‚úÖ' if ocr_status['pytesseract'] else '‚ùå'}")
        with col2:
            st.markdown(f"Pillow: {'‚úÖ' if ocr_status['pillow'] else '‚ùå'}")
        with col3:
            st.markdown(f"pdf2image: {'‚úÖ' if ocr_status['pdf2image'] else '‚ùå'}")
        
        st.markdown("---")
        
        # –û–±–ª–∞—á–Ω—ã–µ OCR API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        st.markdown("#### ‚òÅÔ∏è –û–±–ª–∞—á–Ω—ã–µ OCR API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")
        st.caption("–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Tesseract. –û–±–ª–∞—á–Ω—ã–µ API –º–æ–≥—É—Ç –¥–∞—Ç—å –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ.")
        
        ocr_api = st.session_state.get("ocr_api", {})
        
        # Yandex Vision
        st.markdown("**Yandex Vision OCR**")
        yandex_ocr = st.text_input(
            "API Key Yandex Vision", 
            type="password", 
            value=ocr_api.get("yandex_vision", ""),
            key="ocr_yandex",
            placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"
        )
        yandex_folder = st.text_input(
            "Folder ID", 
            value=ocr_api.get("yandex_folder", ""),
            key="ocr_yandex_folder",
            placeholder="ID –∫–∞—Ç–∞–ª–æ–≥–∞ Yandex Cloud"
        )
        if yandex_ocr != ocr_api.get("yandex_vision", "") or yandex_folder != ocr_api.get("yandex_folder", ""):
            if "ocr_api" not in st.session_state:
                st.session_state.ocr_api = {}
            st.session_state.ocr_api["yandex_vision"] = yandex_ocr
            st.session_state.ocr_api["yandex_folder"] = yandex_folder
        
        st.markdown("---")
        
        # Google Vision
        st.markdown("**Google Cloud Vision**")
        google_ocr = st.text_input(
            "API Key Google Vision", 
            type="password", 
            value=ocr_api.get("google_vision", ""),
            key="ocr_google",
            placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"
        )
        if google_ocr != ocr_api.get("google_vision", ""):
            if "ocr_api" not in st.session_state:
                st.session_state.ocr_api = {}
            st.session_state.ocr_api["google_vision"] = google_ocr
        
        st.markdown("---")
        
        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
        with st.expander("üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Tesseract"):
            st.code("""# Ubuntu/Debian:
sudo apt-get install tesseract-ocr tesseract-ocr-rus

# macOS:
brew install tesseract tesseract-lang

# Windows:
# –°–∫–∞—á–∞—Ç—å: https://github.com/UB-Mannheim/tesseract/wiki
# –î–æ–±–∞–≤–∏—Ç—å –≤ PATH

# Python –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
pip install pytesseract pdf2image Pillow""", language="bash")
        
        st.markdown("---")
        st.markdown("#### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:")
        st.markdown("""
        | –§–æ—Ä–º–∞—Ç | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
        |--------|-------|----------|
        | TXT, DOCX | –¢–µ–∫—Å—Ç | –ü—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ |
        | PDF (—Ç–µ–∫—Å—Ç) | –¢–µ–∫—Å—Ç | PyPDF2 |
        | PDF (—Å–∫–∞–Ω) | OCR | –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
        | PNG, JPG, TIFF, BMP | OCR | –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è |
        """)


# ============================================================================
# –ì–õ–ê–í–ù–ê–Ø
# ============================================================================

def –≥–ª–∞–≤–Ω–∞—è():
    st.markdown('''
    <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
        <div class="traffic-light"><span class="tl-red"></span><span class="tl-yellow"></span><span class="tl-green"></span></div>
        <div style="font-size:1.3rem;font-weight:600;">–†–µ–≥–ª–∞–º–µ–Ω—Ç –°–≤–µ—Ç–æ—Ñ–æ—Ä <span style="color:#666;font-weight:normal;">v7.11</span></div>
    </div>
    ''', unsafe_allow_html=True)
    
    –±–æ–∫–æ–≤–∞—è_–ø–∞–Ω–µ–ª—å()
    
    if —ç—Ç–æ_–∞–¥–º–∏–Ω():
        tabs = st.tabs(["–ê–ù–ê–õ–ò–ó", "–ù–ê–°–¢–†–û–ô–ö–ò"])
        with tabs[0]: –≤–∫–ª–∞–¥–∫–∞_–∞–Ω–∞–ª–∏–∑–∞()
        with tabs[1]: –≤–∫–ª–∞–¥–∫–∞_–Ω–∞—Å—Ç—Ä–æ–µ–∫()
    else:
        –≤–∫–ª–∞–¥–∫–∞_–∞–Ω–∞–ª–∏–∑–∞()


def main():
    –ø—Ä–∏–º–µ–Ω–∏—Ç—å_—Å—Ç–∏–ª–∏()
    –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è()
    if not st.session_state.–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:
        —Å—Ç—Ä–∞–Ω–∏—Ü–∞_–≤—Ö–æ–¥–∞()
    else:
        –≥–ª–∞–≤–Ω–∞—è()


if __name__ == "__main__":
    main()
