# Legal Traffic Light v3.0 - Streamlit Edition
import streamlit as st
import re
import json
import html
from datetime import datetime
from typing import Dict, List, Tuple
from enum import Enum
import math
–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –†–µ–≥–ª–∞–º–µ–Ω—Ç—É –ê–û ¬´–ù–ü–ö¬ª

–†–µ–≥–ª–∞–º–µ–Ω—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π —Å –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–º
–ø—Ä–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Ä–µ—à–µ–Ω–∏–∏ —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ v3

–ó–∞–ø—É—Å–∫: streamlit run app.py
"""

import streamlit as st
import re
import json
import html
from datetime import datetime, date
from typing import Dict, List, Tuple, Optional
from dataclasses import dataclass, field
from enum import Enum
import math

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´
# ============================================================================

st.set_page_config(
    page_title="Legal Traffic Light v3.2 | –ê–û –ù–ü–ö",
    page_icon="üö¶",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ============================================================================
# –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ó –†–ï–ì–õ–ê–ú–ï–ù–¢–ê
# ============================================================================

class RiskZone(Enum):
    GREEN = "green"      # –ó–µ–ª–µ–Ω—ã–π –∫–æ—Ä–∏–¥–æ—Ä - —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
    YELLOW = "yellow"    # –ñ–µ–ª—Ç—ã–π –∫–æ—Ä–∏–¥–æ—Ä - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –Æ–î
    RED = "red"          # –ö—Ä–∞—Å–Ω—ã–π –∫–æ—Ä–∏–¥–æ—Ä - –ø–æ–ª–Ω–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ

class DocumentForm(Enum):
    TYPICAL = "typical"           # –¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ (–¢–§)
    COUNTERPARTY = "counterparty" # –§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
    FREE = "free"                 # –°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞
    MODIFIED_TF = "modified_tf"   # –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫ –¢–§
    SELF_DEVELOPED = "self"       # –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

# –ü–æ—Ä–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –∏–∑ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞
class Thresholds:
    GREEN_TF_MAX = 100_000           # –¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    GREEN_NON_TF_MAX = 50_000        # –ù–µ—Ç–∏–ø–æ–≤—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã
    YELLOW_MAX = 5_000_000           # –ñ–µ–ª—Ç–∞—è –∑–æ–Ω–∞
    RED_MIN = 5_000_001              # –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞
    TENDER_RED = 3_000_000           # –¢–µ–Ω–¥–µ—Ä—ã –≤ –∫—Ä–∞—Å–Ω–æ–π –∑–æ–Ω–µ
    SINGLE_SUPPLIER_YELLOW = 100_000 # –ó–∞–∫—É–ø–∫–∞ —É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    CONTRACT_CONTROL_YEARS = 3       # –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å—Ä–æ–∫ –≤ –≥–æ–¥–∞—Ö

# –°—Ä–æ–∫–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
class Deadlines:
    STANDARD = 5        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ - 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
    EXTENDED = 10       # –°–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏ (–í–≠–î, –ª–∏–∑–∏–Ω–≥) - –¥–æ 10 –¥–Ω–µ–π
    URGENT = 1          # –°—Ä–æ—á–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ

# –¢–∏–ø—ã —Å–¥–µ–ª–æ–∫, –í–°–ï–ì–î–ê —Ç—Ä–µ–±—É—é—â–∏–µ –∫—Ä–∞—Å–Ω–æ–π –∑–æ–Ω—ã (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—É–º–º—ã)
RED_ZONE_ALWAYS = [
    "–ê—Ä–µ–Ω–¥–∞ –≤–∞–≥–æ–Ω–æ–≤",
    "–õ–∏–∑–∏–Ω–≥ –≤–∞–≥–æ–Ω–æ–≤",
    "–ü–æ–∫—É–ø–∫–∞/–ø—Ä–æ–¥–∞–∂–∞ –≤–∞–≥–æ–Ω–æ–≤",
    "–ê—Ä–µ–Ω–¥–∞ –ª–æ–∫–æ–º–æ—Ç–∏–≤–æ–≤",
    "–õ–∏–∑–∏–Ω–≥ –ª–æ–∫–æ–º–æ—Ç–∏–≤–æ–≤",
    "–ü–æ–∫—É–ø–∫–∞/–ø—Ä–æ–¥–∞–∂–∞ –ª–æ–∫–æ–º–æ—Ç–∏–≤–æ–≤",
    "–ê—Ä–µ–Ω–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤",
    "–õ–∏–∑–∏–Ω–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤",
    "–ü–æ–∫—É–ø–∫–∞/–ø—Ä–æ–¥–∞–∂–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤",
    "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–í–≠–î)",
    "–†–∞—Å—á–µ—Ç—ã –≤ –≤–∞–ª—é—Ç–µ",
    "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –ü–û",
    "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ü–û",
    "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –ü–û",
    "–°–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç",
    "–ê—Ä–µ–Ω–¥–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
    "–ü–æ–∫—É–ø–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
    "–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä",
    "–î–æ–≥–æ–≤–æ—Ä –∑–∞–π–º–∞",
    "–î–æ–≥–æ–≤–æ—Ä –∑–∞–ª–æ–≥–∞",
    "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Ä—É—á–∏—Ç–µ–ª—å—Å—Ç–≤–∞",
    "–î–æ–≥–æ–≤–æ—Ä —Å –û–ê–û –†–ñ–î",
    "–°–µ—Ä–≤–∏—Å–Ω—ã–π (–≥–ª–æ–±–∞–ª—å–Ω—ã–π) –¥–æ–≥–æ–≤–æ—Ä",
    "–î–æ–≥–æ–≤–æ—Ä, —Ç—Ä–µ–±—É—é—â–∏–π –æ–¥–æ–±—Ä–µ–Ω–∏—è –°–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤",
    "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä —Å –¢–û–ü-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–æ–º",
    "–õ–æ–∫–∞–ª—å–Ω—ã–π –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –∞–∫—Ç (–õ–ù–ê)",
    "–ü–æ–ª–æ–∂–µ–Ω–∏–µ/–ü—Ä–∞–≤–∏–ª–∞/–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
    "–ü—Ä–∏–∫–∞–∑ –æ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π —Ç–∞–π–Ω–µ",
    "–ü—Ä–∏–∫–∞–∑ –æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–æ–º –≤–∑—ã—Å–∫–∞–Ω–∏–∏",
    "–ü—Ä–∏–∫–∞–∑ –æ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏",
]

# –¢–∏–ø—ã —Å–¥–µ–ª–æ–∫ –¥–ª—è –∂–µ–ª—Ç–æ–π –∑–æ–Ω—ã
YELLOW_ZONE_TYPES = [
    "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ (—Ä–∞–º–æ—á–Ω—ã–µ) –ø–µ—Ä–µ–≤–æ–∑–∫–∏",
    "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –≥–æ–¥–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏",
    "–î–æ–≥–æ–≤–æ—Ä –¢–≠–£ (—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ-—ç–∫—Å–ø–µ–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏)",
    "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –æ–ø–∞—Å–Ω–æ–≥–æ –≥—Ä—É–∑–∞",
    "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –Ω–µ–≥–∞–±–∞—Ä–∏—Ç–Ω–æ–≥–æ –≥—Ä—É–∑–∞",
    "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ —Ç—è–∂–µ–ª–æ–≤–µ—Å–Ω–æ–≥–æ –≥—Ä—É–∑–∞",
    "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â–µ–≥–æ –≥—Ä—É–∑–∞",
    "–ó–∞–∫—É–ø–∫–∞ —É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞",
]

# –î–æ–∫—É–º–µ–Ω—Ç—ã, –í–°–ï–ì–î–ê —Ç—Ä–µ–±—É—é—â–∏–µ –∫—Ä–∞—Å–Ω–æ–π –∑–æ–Ω—ã
RED_DOCUMENTS_ALWAYS = [
    "–ü—Ä–µ—Ç–µ–Ω–∑–∏—è (–≤—Ö–æ–¥—è—â–∞—è)",
    "–ü—Ä–µ—Ç–µ–Ω–∑–∏—è (–∏—Å—Ö–æ–¥—è—â–∞—è)",
    "–ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ",
    "–°—É–¥–µ–±–Ω—ã–π –ø—Ä–∏–∫–∞–∑",
    "–ó–∞–ø—Ä–æ—Å –§–ù–°",
    "–ó–∞–ø—Ä–æ—Å –§–ê–°",
    "–ó–∞–ø—Ä–æ—Å –ü—Ä–æ–∫—É—Ä–∞—Ç—É—Ä—ã",
    "–ó–∞–ø—Ä–æ—Å –†–æ—Å—Ç—Ä–∞–Ω—Å–Ω–∞–¥–∑–æ—Ä–∞",
    "–ó–∞–ø—Ä–æ—Å –ì–ò–¢ (—Ç—Ä—É–¥–æ–≤–∞—è –∏–Ω—Å–ø–µ–∫—Ü–∏—è)",
    "–ó–∞–ø—Ä–æ—Å –∏–Ω–æ–≥–æ –≥–æ—Å–æ—Ä–≥–∞–Ω–∞",
    "–ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ –≥–æ—Å–æ—Ä–≥–∞–Ω–∞",
    "–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≥–æ—Å–æ—Ä–≥–∞–Ω–∞",
    "–î–¢–ü —Å —É—á–∞—Å—Ç–∏–µ–º –¢–° –∫–æ–º–ø–∞–Ω–∏–∏",
    "–£—Ç–µ—Ä—è –≥—Ä—É–∑–∞",
    "–ü–æ—Ä—á–∞ –≥—Ä—É–∑–∞",
    "–ü—Ä–æ—Å—Ç–æ–π, —Ç—Ä–µ–±—É—é—â–∏–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏",
]

# –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏
DEPARTMENTS = [
    "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç",
    "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–∞—Ä–∫–æ–º",
    "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∑–∞–∫—É–ø–æ–∫",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —Ä–µ–º–æ–Ω—Ç–∞",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç IT",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç HR",
    "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç",
    "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è",
    "–î—Ä—É–≥–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ"
]

POSITIONS = [
    "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
    "–í–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
    "–ì–ª–∞–≤–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
    "–ù–∞—á–∞–ª—å–Ω–∏–∫ –æ—Ç–¥–µ–ª–∞",
    "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
    "–ù–∞—á–∞–ª—å–Ω–∏–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
    "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞",
    "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞",
    "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞",
    "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä"
]

# ============================================================================
# –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –í–ê–õ–ò–î–ê–¶–ò–Ø
# ============================================================================

class SecurityValidator:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    
    ALLOWED_EXTENSIONS = {'.txt', '.docx', '.pdf', '.doc'}
    MAX_FILE_SIZE = 10 * 1024 * 1024
    MAX_TEXT_LENGTH = 500_000
    
    DANGEROUS_PATTERNS = [
        r'<script[^>]*>.*?</script>',
        r'javascript:',
        r'on\w+\s*=',
        r'<iframe[^>]*>',
        r'eval\s*\(',
    ]
    
    @classmethod
    def sanitize_text(cls, text: str) -> str:
        if not text:
            return ""
        text = html.escape(text)
        for pattern in cls.DANGEROUS_PATTERNS:
            text = re.sub(pattern, '', text, flags=re.IGNORECASE | re.DOTALL)
        return text[:cls.MAX_TEXT_LENGTH]
    
    @classmethod
    def validate_file(cls, uploaded_file) -> Tuple[bool, str]:
        if not uploaded_file:
            return False, "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω"
        if uploaded_file.size > cls.MAX_FILE_SIZE:
            return False, f"–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {cls.MAX_FILE_SIZE // 1024 // 1024} MB"
        ext = '.' + uploaded_file.name.split('.')[-1].lower()
        if ext not in cls.ALLOWED_EXTENSIONS:
            return False, f"–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: {', '.join(cls.ALLOWED_EXTENSIONS)}"
        return True, "OK"
    
    @classmethod
    def validate_user(cls, name: str, position: str, department: str) -> Tuple[bool, str]:
        if not name or len(name.strip()) < 5:
            return False, "–§–ò–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤"
        if not position:
            return False, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å"
        if not department:
            return False, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ"
        if re.search(r'[<>"\'\\/;{}]', name):
            return False, "–§–ò–û —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã"
        return True, "OK"
    
    @classmethod
    def validate_amount(cls, value: str) -> Tuple[bool, float, str]:
        try:
            cleaned = re.sub(r'[^\d.,]', '', value).replace(',', '.')
            if not cleaned:
                return False, 0, "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
            amount = float(cleaned)
            if amount < 0:
                return False, 0, "–°—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π"
            if amount > 100_000_000_000_000:
                return False, 0, "–°—É–º–º–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è"
            return True, amount, "OK"
        except ValueError:
            return False, 0, "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã"

# ============================================================================
# –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ó–û–ù–´ –†–ò–°–ö–ê
# ============================================================================

@dataclass
class AnalysisInput:
    amount: float = 0
    document_form: DocumentForm = DocumentForm.TYPICAL
    document_type: str = "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥"
    deal_type: str = ""
    is_single_supplier: bool = False
    is_tender: bool = False
    tender_amount: float = 0
    contract_years: int = 0
    changes_essential: bool = False
    original_amount: float = 0
    is_urgent: bool = False
    contract_text: str = ""

@dataclass
class AnalysisResult:
    zone: RiskZone
    zone_reason: str
    deadline_days: int
    requires_legal: bool
    responsible: str
    recommendations: List[str]
    warnings: List[str]
    red_flags: List[str]
    yellow_flags: List[str]
    green_flags: List[str]
    required_documents: List[str]
    approval_route: List[str]

def determine_risk_zone(inp: AnalysisInput) -> AnalysisResult:
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω—ã —Ä–∏—Å–∫–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –†–µ–≥–ª–∞–º–µ–Ω—Ç—É –ê–û –ù–ü–ö"""
    
    result = AnalysisResult(
        zone=RiskZone.GREEN,
        zone_reason="",
        deadline_days=0,
        requires_legal=False,
        responsible="–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä",
        recommendations=[],
        warnings=[],
        red_flags=[],
        yellow_flags=[],
        green_flags=[],
        required_documents=[],
        approval_route=[]
    )
    
    # –≠–¢–ê–ü 1: –ö–†–ê–°–ù–ê–Ø –∑–æ–Ω–∞ –ø–æ —Ç–∏–ø—É —Å–¥–µ–ª–∫–∏ (–ù–ï–ó–ê–í–ò–°–ò–ú–û –û–¢ –°–£–ú–ú–´)
    if inp.deal_type in RED_ZONE_ALWAYS:
        result.zone = RiskZone.RED
        result.zone_reason = f"–¢–∏–ø —Å–¥–µ–ª–∫–∏ '{inp.deal_type}' –í–°–ï–ì–î–ê —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è (–ø. 4.3 –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞)"
        result.red_flags.append(f"–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è —Å–¥–µ–ª–∫–∞: {inp.deal_type}")
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = Deadlines.EXTENDED
        result.approval_route = ["–Æ–î (–Ω–∞ —ç—Ç–∞–ø–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)", "–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞"]
        result.required_documents = [
            "–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏",
            "–ü—Ä–æ–µ–∫—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏)",
            "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ",
            "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
            "–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –≤ –°–≠–î"
        ]
        return result
    
    # –î–æ–∫—É–º–µ–Ω—Ç—ã, –≤—Å–µ–≥–¥–∞ —Ç—Ä–µ–±—É—é—â–∏—Ö –∫—Ä–∞—Å–Ω–æ–π –∑–æ–Ω—ã
    if inp.document_type in RED_DOCUMENTS_ALWAYS:
        result.zone = RiskZone.RED
        result.zone_reason = f"–î–æ–∫—É–º–µ–Ω—Ç '{inp.document_type}' –í–°–ï–ì–î–ê —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –Æ–î (–ø. 4.3 –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞)"
        result.red_flags.append(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç: {inp.document_type}")
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = Deadlines.URGENT
        result.approval_route = ["–Æ–î –ù–ï–ó–ê–ú–ï–î–õ–ò–¢–ï–õ–¨–ù–û"]
        result.warnings.append("‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –Æ–î!")
        return result
    
    # –¢–µ–Ω–¥–µ—Ä—ã —Å–≤—ã—à–µ 3 –º–ª–Ω
    if inp.is_tender and inp.tender_amount > Thresholds.TENDER_RED:
        result.zone = RiskZone.RED
        result.zone_reason = f"–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –∑–∞–∫—É–ø–∫–∞ (—Ç–µ–Ω–¥–µ—Ä) –Ω–∞ —Å—É–º–º—É —Å–≤—ã—à–µ 3 000 000 —Ä—É–±. (–ø. 4.3 –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞)"
        result.red_flags.append(f"–¢–µ–Ω–¥–µ—Ä –Ω–∞ —Å—É–º–º—É {inp.tender_amount:,.0f} —Ä—É–±. > 3 000 000 —Ä—É–±.")
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = Deadlines.EXTENDED
        return result
    
    # –≠–¢–ê–ü 2: –ö–†–ê–°–ù–ê–Ø –∑–æ–Ω–∞ –ø–æ –°–£–ú–ú–ï
    if inp.amount > Thresholds.YELLOW_MAX:
        result.zone = RiskZone.RED
        result.zone_reason = f"–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ {inp.amount:,.0f} —Ä—É–±. –ø—Ä–µ–≤—ã—à–∞–µ—Ç 5 000 000 —Ä—É–±. (–ø. 4.3 –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞)"
        result.red_flags.append(f"–°—É–º–º–∞ {inp.amount:,.0f} —Ä—É–±. > 5 000 000 —Ä—É–±.")
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
        result.deadline_days = Deadlines.EXTENDED
        result.approval_route = ["–Æ–î (–Ω–∞ —ç—Ç–∞–ø–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)", "–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞"]
        return result
    
    # –≠–¢–ê–ü 3: –ñ–ï–õ–¢–ê–Ø –∑–æ–Ω–∞
    yellow_reasons = []
    
    if inp.deal_type in YELLOW_ZONE_TYPES:
        yellow_reasons.append(f"–¢–∏–ø —Å–¥–µ–ª–∫–∏: {inp.deal_type}")
        result.yellow_flags.append(inp.deal_type)
    
    if inp.is_single_supplier and inp.amount > Thresholds.SINGLE_SUPPLIER_YELLOW:
        yellow_reasons.append(f"–ó–∞–∫—É–ø–∫–∞ —É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –Ω–∞ —Å—É–º–º—É > 100 000 —Ä—É–±.")
        result.yellow_flags.append("–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫ > 100 000 —Ä—É–±.")
    
    if inp.contract_years > Thresholds.CONTRACT_CONTROL_YEARS:
        yellow_reasons.append(f"–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å—Ä–æ–∫: –¥–æ–≥–æ–≤–æ—Ä –¥–µ–π—Å—Ç–≤—É–µ—Ç –±–æ–ª–µ–µ {Thresholds.CONTRACT_CONTROL_YEARS} –ª–µ—Ç (–ø. 3.6 –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞)")
        result.yellow_flags.append(f"–ü—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –±–æ–ª–µ–µ {inp.contract_years} –ª–µ—Ç")
    
    # –ü–æ —Ñ–æ—Ä–º–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Å—É–º–º–µ
    if inp.document_form == DocumentForm.TYPICAL:
        if inp.amount > Thresholds.GREEN_TF_MAX:
            yellow_reasons.append(f"–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –Ω–∞ —Å—É–º–º—É {inp.amount:,.0f} —Ä—É–±. > 100 000 —Ä—É–±.")
            result.yellow_flags.append(f"–¢–§: {inp.amount:,.0f} —Ä—É–±. > 100 000 —Ä—É–±.")
        else:
            result.green_flags.append(f"–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–æ 100 000 —Ä—É–±.")
    
    elif inp.document_form == DocumentForm.COUNTERPARTY:
        if inp.amount > Thresholds.GREEN_NON_TF_MAX:
            yellow_reasons.append(f"–§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –Ω–∞ —Å—É–º–º—É {inp.amount:,.0f} —Ä—É–±. > 50 000 —Ä—É–±.")
            result.yellow_flags.append(f"–§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ > 50 000 —Ä—É–±.")
        else:
            result.green_flags.append("–§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –¥–æ 50 000 —Ä—É–±.")
    
    elif inp.document_form == DocumentForm.FREE:
        if inp.amount > Thresholds.GREEN_NON_TF_MAX:
            yellow_reasons.append(f"–°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞ –Ω–∞ —Å—É–º–º—É {inp.amount:,.0f} —Ä—É–±. > 50 000 —Ä—É–±.")
            result.yellow_flags.append("–°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞ > 50 000 —Ä—É–±.")
        else:
            result.green_flags.append("–°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–æ 50 000 —Ä—É–±.")
    
    elif inp.document_form == DocumentForm.MODIFIED_TF:
        if inp.changes_essential:
            yellow_reasons.append("–ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞")
            result.yellow_flags.append("–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¢–§")
        elif inp.amount > Thresholds.GREEN_NON_TF_MAX:
            yellow_reasons.append(f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –∫ –¢–§ –Ω–∞ —Å—É–º–º—É > 50 000 —Ä—É–±.")
            result.yellow_flags.append("–ò–∑–º–µ–Ω–µ–Ω–∏—è –∫ –¢–§ > 50 000 —Ä—É–±.")
        else:
            result.green_flags.append("–ò–∑–º–µ–Ω–µ–Ω–∏—è –∫ –¢–§ –¥–æ 50 000 —Ä—É–±. (–Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ)")
    
    elif inp.document_form == DocumentForm.SELF_DEVELOPED:
        if inp.amount > Thresholds.GREEN_NON_TF_MAX:
            yellow_reasons.append(f"–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å—É–º–º—É > 50 000 —Ä—É–±.")
            result.yellow_flags.append("–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ > 50 000 —Ä—É–±.")
        else:
            result.green_flags.append("–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¥–æ 50 000 —Ä—É–±.")
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥–ª—è –∂–µ–ª—Ç–æ–π –∑–æ–Ω—ã
    if yellow_reasons:
        result.zone = RiskZone.YELLOW
        result.zone_reason = "; ".join(yellow_reasons)
        result.requires_legal = True
        result.responsible = "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç (—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞)"
        result.deadline_days = Deadlines.STANDARD
        result.approval_route = ["–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä ‚Üí –°–≠–î ‚Üí –Æ–î (5 —Ä–∞–±. –¥–Ω–µ–π) ‚Üí –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ"]
        result.required_documents = [
            "–ü—Ä–æ–µ–∫—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏",
            "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏)",
            "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞",
            "–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –≤ –°–≠–î"
        ]
        result.warnings.append("‚ö†Ô∏è –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–∑—ã –Æ–î!")
        return result
    
    # –≠–¢–ê–ü 4: –ó–ï–õ–ï–ù–ê–Ø –∑–æ–Ω–∞
    result.zone = RiskZone.GREEN
    result.zone_reason = "–û–ø–µ—Ä–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º –ó–µ–ª–µ–Ω–æ–≥–æ –∫–æ—Ä–∏–¥–æ—Ä–∞ (–ø. 4.1 –†–µ–≥–ª–∞–º–µ–Ω—Ç–∞)"
    result.requires_legal = False
    result.responsible = "–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∏ –µ–≥–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å"
    result.deadline_days = 0
    result.approval_route = ["–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä ‚Üí –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å ‚Üí –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ"]
    result.recommendations.append("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¢–∏–ø–æ–≤—É—é –§–æ—Ä–º—É (–¢–§) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π")
    result.recommendations.append("–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ª–µ–∂–∏—Ç –Ω–∞ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä–µ")
    
    return result

# ============================================================================
# RAG-–ê–ù–ê–õ–ò–ó –¢–ï–ö–°–¢–ê
# ============================================================================

class ContractAnalyzer:
    RED_PATTERNS = {
        "–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": r'(?:–ø–æ–ª–Ω\w+|–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω\w+)\s+(?:–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω\w+\s+)?–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç',
        "–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –æ—Ç–∫–∞–∑ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞": r'(?:–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å|–ø–æ—Å—Ç–∞–≤—â–∏–∫|–ø–æ–¥—Ä—è–¥—á–∏–∫|–∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å)\s+(?:–≤–ø—Ä–∞–≤–µ|–∏–º–µ–µ—Ç\s+–ø—Ä–∞–≤–æ)\s+(?:–≤\s+)?–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω',
        "–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã": r'–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω\w+\s+(?:–ø–æ—Ä—è–¥–∫\w+\s+)?–∏–∑–º–µ–Ω–µ–Ω\w+\s+(?:—Ü–µ–Ω|—Å—Ç–æ–∏–º–æ—Å—Ç|—Ç–∞—Ä–∏—Ñ)',
        "–ê–≤—Ç–æ–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è –±–µ–∑ –ø—Ä–∞–≤–∞ –æ—Ç–∫–∞–∑–∞": r'–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫\w+\s+(?:–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü|–ø—Ä–æ–¥–ª–µ–Ω).*?(?:–±–µ–∑|–Ω–µ\s+—Ç—Ä–µ–±—É–µ—Ç)',
        "–ü—Ä–∞–≤–∞ –Ω–∞ –ò–° —É –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞": r'(?:–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω\w+\s+)?–ø—Ä–∞–≤\w+\s+(?:–Ω–∞\s+)?(?:—Ä–µ–∑—É–ª—å—Ç–∞—Ç|–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω).*?(?:–ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç?|–æ—Å—Ç–∞—é—Ç?—Å—è|–ø–µ—Ä–µ—Ö–æ–¥—è—Ç?)\s+(?:–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª|–ø–æ–¥—Ä—è–¥—á–∏–∫)',
        "–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—Å–≤–µ–Ω–Ω—ã—Ö —É–±—ã—Ç–∫–æ–≤": r'–Ω–µ\s+(?:–Ω–µ—Å–µ—Ç|–æ—Ç–≤–µ—á–∞–µ—Ç).*?(?:–∫–æ—Å–≤–µ–Ω–Ω|—É–ø—É—â–µ–Ω–Ω)',
        "–í–∞–ª—é—Ç–Ω–∞—è –æ–≥–æ–≤–æ—Ä–∫–∞": r'(?:–ø–æ\s+–∫—É—Ä—Å—É|–≤\s+(?:–¥–æ–ª–ª–∞—Ä–∞—Ö|–µ–≤—Ä–æ|–≤–∞–ª—é—Ç–µ)|—É\.–µ\.|USD|EUR)',
        "–û–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ > 30%": r'(?:–æ–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω|–∞–≤–∞–Ω—Å|–ø—Ä–µ–¥–æ–ø–ª–∞—Ç).*?(?:[3-9]\d|100)\s*%',
    }
    
    YELLOW_PATTERNS = {
        "–í—ã—Å–æ–∫–∞—è –Ω–µ—É—Å—Ç–æ–π–∫–∞": r'–Ω–µ—É—Å—Ç–æ–π–∫\w*.*?(?:0[,.]?[4-9]|[1-9][,.]?\d*)\s*%',
        "–ü–æ–¥—Å—É–¥–Ω–æ—Å—Ç—å –Ω–µ –ø–æ –º–µ—Å—Ç—É –∑–∞–∫–∞–∑—á–∏–∫–∞": r'(?:–∞—Ä–±–∏—Ç—Ä–∞–∂–Ω\w+\s+—Å—É–¥\w*|–ø–æ–¥—Å—É–¥–Ω–æ—Å—Ç).*?(?:—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–ø–∏—Ç–µ—Ä)',
        "–°—É–±–ø–æ–¥—Ä—è–¥ –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è": r'(?:—Å—É–±–ø–æ–¥—Ä—è–¥|—Ç—Ä–µ—Ç—å–∏\w+\s+–ª–∏—Ü).*?–±–µ–∑\s+(?:—Å–æ–≥–ª–∞—Å–∏|—É–≤–µ–¥–æ–º–ª–µ–Ω–∏)',
        "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Å—É–º–º–æ–π": r'(?:–º–∞–∫—Å–∏–º–∞–ª—å–Ω\w+\s+)?–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç.*?–æ–≥—Ä–∞–Ω–∏—á–µ–Ω.*?(?:—Å—É–º–º|—Ä–∞–∑–º–µ—Ä)',
        "–®—Ç—Ä–∞—Ñ –∑–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å": r'(?:—à—Ç—Ä–∞—Ñ|–Ω–µ—É—Å—Ç–æ–π–∫).*?–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç',
        "–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –±–æ–ª–µ–µ 10%": r'–∏–Ω–¥–µ–∫—Å–∞—Ü.*?(?:1[1-9]|[2-9]\d)\s*%',
    }
    
    REQUIRED_SECTIONS = {
        "–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞": r'–ø—Ä–µ–¥–º–µ—Ç\s+–¥–æ–≥–æ–≤–æ—Ä',
        "–¶–µ–Ω–∞ –∏ –ø–æ—Ä—è–¥–æ–∫ —Ä–∞—Å—á—ë—Ç–æ–≤": r'(?:—Ü–µ–Ω–∞|—Å—Ç–æ–∏–º–æ—Å—Ç—å|–ø–æ—Ä—è–¥–æ–∫\s+—Ä–∞—Å—á–µ—Ç)',
        "–°—Ä–æ–∫–∏": r'—Å—Ä–æ–∫\w*\s+(?:–æ–∫–∞–∑–∞–Ω–∏|–≤—ã–ø–æ–ª–Ω–µ–Ω–∏|–ø–æ—Å—Ç–∞–≤–∫|–¥–µ–π—Å—Ç–≤–∏)',
        "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": r'–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å\s+—Å—Ç–æ—Ä–æ–Ω',
        "–ü–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–ø–æ—Ä–æ–≤": r'(?:—Ä–∞–∑—Ä–µ—à–µ–Ω–∏\w+\s+—Å–ø–æ—Ä|–∞—Ä–±–∏—Ç—Ä–∞–∂|–ø–æ–¥—Å—É–¥–Ω–æ—Å—Ç)',
        "–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å—Ç–æ—Ä–æ–Ω": r'—Ä–µ–∫–≤–∏–∑–∏—Ç\w+\s+(?:–∏\s+)?–ø–æ–¥–ø–∏—Å',
    }
    
    @classmethod
    def analyze(cls, text: str) -> Dict:
        if not text or len(text) < 100:
            return {"error": "–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"}
        
        text_lower = text.lower()
        results = {
            "red_flags": [],
            "yellow_flags": [],
            "missing_sections": [],
            "found_sections": [],
            "recommendations": [],
            "risk_score": 0
        }
        
        for name, pattern in cls.RED_PATTERNS.items():
            if re.search(pattern, text_lower):
                results["red_flags"].append({
                    "title": name,
                    "description": f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: {name}",
                    "recommendation": "–¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç—å –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å"
                })
        
        for name, pattern in cls.YELLOW_PATTERNS.items():
            if re.search(pattern, text_lower):
                results["yellow_flags"].append({
                    "title": name,
                    "description": f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: {name}",
                    "recommendation": "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                })
        
        for name, pattern in cls.REQUIRED_SECTIONS.items():
            if re.search(pattern, text_lower):
                results["found_sections"].append(name)
            else:
                results["missing_sections"].append(name)
                results["recommendations"].append(f"–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª: {name}")
        
        results["risk_score"] = min(10, 
            len(results["red_flags"]) * 2.0 + 
            len(results["yellow_flags"]) * 0.7 + 
            len(results["missing_sections"]) * 0.5
        )
        
        return results

# ============================================================================
# –î–ï–ú–û-–î–ê–ù–ù–´–ï
# ============================================================================

DEMO_CONTRACT = """–î–û–ì–û–í–û–† –û–ö–ê–ó–ê–ù–ò–Ø –£–°–õ–£–ì ‚Ññ 2025/IT-001

–≥. –ú–æ—Å–∫–≤–∞                                                                    ¬´10¬ª —è–Ω–≤–∞—Ä—è 2025 –≥.

–û–û–û ¬´–ò–¢-–†–µ—à–µ–Ω–∏—è¬ª (–ò–ù–ù 7707083893), –∏–º–µ–Ω—É–µ–º–æ–µ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å¬ª, –≤ –ª–∏—Ü–µ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ü–µ—Ç—Ä–æ–≤–∞ –ü.–ü., –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –£—Å—Ç–∞–≤–∞, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏ –ê–û ¬´–ù–æ–≤–∞—è –ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è¬ª, –∏–º–µ–Ω—É–µ–º–æ–µ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ó–∞–∫–∞–∑—á–∏–∫¬ª, –≤ –ª–∏—Ü–µ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—è –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –°–∏–¥–æ—Ä–æ–≤–∞ –°.–°., –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ ‚Ññ 15 –æ—Ç 01.01.2025, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –î–æ–≥–æ–≤–æ—Ä:

1. –ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê
1.1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –æ–∫–∞–∑–∞—Ç—å –ó–∞–∫–∞–∑—á–∏–∫—É —É—Å–ª—É–≥–∏ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (–¥–∞–ª–µ–µ ‚Äî ¬´–£—Å–ª—É–≥–∏¬ª), –∞ –ó–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –£—Å–ª—É–≥–∏.

2. –°–¢–û–ò–ú–û–°–¢–¨ –£–°–õ–£–ì –ò –ü–û–†–Ø–î–û–ö –†–ê–°–ß–ï–¢–û–í
2.1. –°—Ç–æ–∏–º–æ—Å—Ç—å –£—Å–ª—É–≥ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 6 000 000 (—à–µ—Å—Ç—å –º–∏–ª–ª–∏–æ–Ω–æ–≤) —Ä—É–±–ª–µ–π.
2.2. –û–ø–ª–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –ê–∫—Ç–∞.
2.3. –ù–µ—É—Å—Ç–æ–π–∫–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É: 0,5% –≤ –¥–µ–Ω—å.

3. –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨ –°–¢–û–†–û–ù
3.1. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ —Å—É–º–º–æ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü.
3.2. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ —É–±—ã—Ç–∫–∏, —É–ø—É—â–µ–Ω–Ω—É—é –≤—ã–≥–æ–¥—É.

4. –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û–°–¢–¨
4.1. –°—Ä–æ–∫: 5 –ª–µ—Ç –ø–æ—Å–ª–µ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è.
4.2. –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ: 10 000 000 —Ä—É–±–ª–µ–π.

5. –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–ê–Ø –°–û–ë–°–¢–í–ï–ù–ù–û–°–¢–¨
5.1. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç ‚Äî –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
5.2. –ó–∞–∫–∞–∑—á–∏–∫—É ‚Äî –Ω–µ–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è.

6. –°–†–û–ö –ò –†–ê–°–¢–û–†–ñ–ï–ù–ò–ï
6.1. –î–æ 31.12.2025.
6.2. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ –∑–∞ 5 –¥–Ω–µ–π.
6.3. –ó–∞–∫–∞–∑—á–∏–∫ ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –Ω–∞—Ä—É—à–µ–Ω–∏–∏.

7. –°–ü–û–†–´
7.1. –ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π —Å—É–¥ –≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞.

8. –ü–†–û–ß–ï–ï
8.1. –°—É–±–ø–æ–¥—Ä—è–¥ –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è –ó–∞–∫–∞–∑—á–∏–∫–∞.
8.2. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ –∑–∞ 10 –¥–Ω–µ–π.

–†–ï–ö–í–ò–ó–ò–¢–´ –ò –ü–û–î–ü–ò–°–ò –°–¢–û–†–û–ù"""

DEMO_USER = {
    "name": "–î–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    "position": "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
    "department": "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"
}

# ============================================================================
# –°–¢–ò–õ–ò CSS
# ============================================================================

def apply_styles():
    st.markdown("""
    <style>
        :root {
            --red: #dc3545;
            --yellow: #ffc107;
            --green: #28a745;
            --blue: #0d6efd;
            --purple: #6f42c1;
        }
        
        .main-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            color: white;
        }
        
        .traffic-light {
            display: flex;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        
        .traffic-light span {
            width: 18px;
            height: 18px;
            border-radius: 50%;
        }
        
        .tl-red { background: var(--red); box-shadow: 0 0 10px var(--red); }
        .tl-yellow { background: var(--yellow); box-shadow: 0 0 10px var(--yellow); }
        .tl-green { background: var(--green); box-shadow: 0 0 10px var(--green); }
        
        .version-badge {
            background: var(--purple);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 10px;
        }
        
        .zone-card {
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 5px solid;
        }
        
        .zone-card.green {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left-color: var(--green);
        }
        
        .zone-card.yellow {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border-left-color: var(--yellow);
        }
        
        .zone-card.red {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left-color: var(--red);
        }
        
        .zone-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--blue);
        }
        
        .risk-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-left: 3px solid;
        }
        
        .risk-item.red { border-left-color: var(--red); background: #fff5f5; }
        .risk-item.yellow { border-left-color: var(--yellow); background: #fffcf0; }
        .risk-item.green { border-left-color: var(--green); background: #f0fff4; }
        
        footer { visibility: hidden; }
    </style>
    """, unsafe_allow_html=True)

# ============================================================================
# SESSION STATE
# ============================================================================

def init_session_state():
    defaults = {
        "authenticated": False,
        "user": None,
        "demo_mode": False,
        "contract_text": "",
        "analysis_result": None,
        "zone_result": None,
    }
    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

# ============================================================================
# –°–¢–†–ê–ù–ò–¶–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
# ============================================================================

def render_auth_page():
    st.markdown("""
    <div style="text-align: center; padding: 2rem;">
        <div class="traffic-light" style="justify-content: center;">
            <span class="tl-red"></span>
            <span class="tl-yellow"></span>
            <span class="tl-green"></span>
        </div>
        <h1>üö¶ Legal Traffic Light</h1>
        <p style="color: #6c757d; font-size: 1.1rem;">
            –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤<br>
            <strong>–ê–û ¬´–ù–æ–≤–∞—è –ø–µ—Ä–µ–≤–æ–∑–æ—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è¬ª</strong>
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        st.markdown("### üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É")
        
        with st.form("auth_form"):
            name = st.text_input("–§–ò–û *", placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á")
            position = st.selectbox("–î–æ–ª–∂–Ω–æ—Å—Ç—å *", options=[""] + POSITIONS)
            department = st.selectbox("–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ *", options=[""] + DEPARTMENTS)
            
            st.markdown("---")
            
            col_a, col_b = st.columns(2)
            
            with col_a:
                submitted = st.form_submit_button("üöÄ –í–æ–π—Ç–∏", use_container_width=True, type="primary")
            
            with col_b:
                demo = st.form_submit_button("üìã –î–µ–º–æ-—Ä–µ–∂–∏–º", use_container_width=True)
        
        if submitted:
            valid, msg = SecurityValidator.validate_user(name, position, department)
            if valid:
                st.session_state.authenticated = True
                st.session_state.user = {
                    "name": SecurityValidator.sanitize_text(name),
                    "position": position,
                    "department": department
                }
                st.session_state.demo_mode = False
                st.rerun()
            else:
                st.error(f"‚ùå {msg}")
        
        if demo:
            st.session_state.authenticated = True
            st.session_state.user = DEMO_USER.copy()
            st.session_state.demo_mode = True
            st.rerun()
        
        st.caption("* ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è | ¬© –ê–û ¬´–ù–ü–ö¬ª 2025")

# ============================================================================
# –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨
# ============================================================================

def render_sidebar():
    with st.sidebar:
        st.markdown("### üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
        
        if st.session_state.demo_mode:
            st.info("üéØ **–î–µ–º–æ-—Ä–µ–∂–∏–º**")
        
        user = st.session_state.user
        st.markdown(f"**{user['name']}**\n\n{user['position']}\n\n_{user['department']}_")
        
        if st.button("üö™ –í—ã–π—Ç–∏", use_container_width=True):
            for key in list(st.session_state.keys()):
                del st.session_state[key]
            st.rerun()
        
        st.markdown("---")
        st.markdown("### üìã –ú–∞—Ç—Ä–∏—Ü–∞ —Ä–∏—Å–∫–æ–≤")
        st.markdown("""
        üü¢ **–ó–ï–õ–ï–ù–ê–Ø**  
        –¢–§ –¥–æ 100–ö / –ù–µ—Ç–∏–ø. –¥–æ 50–ö  
        _–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ_
        
        üü° **–ñ–ï–õ–¢–ê–Ø**  
        –î–æ 5 000 000 ‚ÇΩ  
        _–Æ–î 5 –¥–Ω–µ–π_
        
        üî¥ **–ö–†–ê–°–ù–ê–Ø**  
        > 5 000 000 ‚ÇΩ –∏–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ  
        _–ü–æ–ª–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ_
        """)
        
        st.markdown("---")
        st.markdown("### ‚ö†Ô∏è –í—Å–µ–≥–¥–∞ –ö–†–ê–°–ù–ê–Ø")
        st.markdown("‚Ä¢ –í–∞–≥–æ–Ω—ã/–ª–æ–∫–æ–º–æ—Ç–∏–≤—ã\n‚Ä¢ –¢–µ–Ω–¥–µ—Ä—ã > 3–ú\n‚Ä¢ –í–≠–î\n‚Ä¢ –ü–û/–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å\n‚Ä¢ –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏/–ì–æ—Å–æ—Ä–≥–∞–Ω—ã")

# ============================================================================
# –í–ö–õ–ê–î–ö–ê –ê–ù–ê–õ–ò–ó–ê
# ============================================================================

def render_analysis_tab():
    st.markdown("### üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞")
    
    col1, col2 = st.columns(2)
    
    with col1:
        doc_type = st.selectbox(
            "–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞",
            ["–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥", "–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏", "–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã", 
             "–î–æ–≥–æ–≤–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–∫–∏", "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–î—Ä—É–≥–æ–π –¥–æ–≥–æ–≤–æ—Ä"]
        )
        
        doc_form_options = [
            ("–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ (–¢–§) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π", DocumentForm.TYPICAL),
            ("–§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞", DocumentForm.COUNTERPARTY),
            ("–°–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞", DocumentForm.FREE),
            ("–¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏", DocumentForm.MODIFIED_TF),
            ("–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞", DocumentForm.SELF_DEVELOPED),
        ]
        doc_form = st.selectbox("–§–æ—Ä–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞", doc_form_options, format_func=lambda x: x[0])[1]
        
        amount_str = st.text_input("–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ (‚ÇΩ)", value="6000000" if st.session_state.demo_mode else "", placeholder="1500000")
        valid_amount, amount, amount_msg = SecurityValidator.validate_amount(amount_str) if amount_str else (True, 0, "")
        if amount_str and not valid_amount:
            st.error(amount_msg)
    
    with col2:
        deal_type = st.selectbox(
            "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø —Å–¥–µ–ª–∫–∏",
            ["–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ"] + RED_ZONE_ALWAYS + YELLOW_ZONE_TYPES
        )
        if deal_type == "–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ":
            deal_type = ""
        
        is_single_supplier = st.checkbox("–ó–∞–∫—É–ø–∫–∞ —É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞")
        
        is_tender = st.checkbox("–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –∑–∞–∫—É–ø–∫–∞ (—Ç–µ–Ω–¥–µ—Ä)")
        tender_amount = 0
        if is_tender:
            tender_str = st.text_input("–°—É–º–º–∞ —Ç–µ–Ω–¥–µ—Ä–∞ (‚ÇΩ)", value="")
            if tender_str:
                _, tender_amount, _ = SecurityValidator.validate_amount(tender_str)
    
    with st.expander("üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"):
        col_a, col_b = st.columns(2)
        with col_a:
            contract_years = st.number_input("–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ (–ª–µ—Ç)", 0, 50, 0)
            changes_essential = st.checkbox("–ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è")
        with col_b:
            is_urgent = st.checkbox("üö® –°—Ä–æ—á–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ")
            if is_urgent:
                st.warning("‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ! –ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ ‚Üí –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–æ–µ –≤–∑—ã—Å–∫–∞–Ω–∏–µ.")
    
    st.markdown("---")
    
    col_btn1, col_btn2, col_btn3 = st.columns(3)
    
    with col_btn1:
        analyze_zone = st.button("üö¶ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–æ–Ω—É", type="primary", use_container_width=True)
    with col_btn2:
        if st.button("üìù –î–µ–º–æ-–¥–æ–≥–æ–≤–æ—Ä", use_container_width=True):
            st.session_state.contract_text = DEMO_CONTRACT
            st.rerun()
    with col_btn3:
        if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å", use_container_width=True):
            st.session_state.zone_result = None
            st.session_state.analysis_result = None
            st.session_state.contract_text = ""
            st.rerun()
    
    if analyze_zone and valid_amount:
        inp = AnalysisInput(
            amount=amount,
            document_form=doc_form,
            document_type=doc_type,
            deal_type=deal_type,
            is_single_supplier=is_single_supplier,
            is_tender=is_tender,
            tender_amount=tender_amount,
            contract_years=contract_years,
            changes_essential=changes_essential,
            is_urgent=is_urgent
        )
        result = determine_risk_zone(inp)
        st.session_state.zone_result = result
        st.rerun()
    
    if st.session_state.zone_result:
        render_zone_result(st.session_state.zone_result, amount)
    
    st.markdown("---")
    st.markdown("### üìÑ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞")
    
    uploaded = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª", type=["txt", "docx", "pdf"])
    if uploaded:
        valid, msg = SecurityValidator.validate_file(uploaded)
        if valid and uploaded.name.endswith('.txt'):
            try:
                st.session_state.contract_text = SecurityValidator.sanitize_text(uploaded.read().decode('utf-8'))
                st.success(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(st.session_state.contract_text):,} —Å–∏–º–≤–æ–ª–æ–≤")
            except:
                st.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è")
        elif not valid:
            st.error(f"‚ùå {msg}")
        else:
            st.warning("‚ö†Ô∏è DOCX/PDF —Ç—Ä–µ–±—É—é—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏. –í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.")
    
    contract_text = st.text_area("–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç:", value=st.session_state.contract_text, height=250)
    if contract_text != st.session_state.contract_text:
        st.session_state.contract_text = SecurityValidator.sanitize_text(contract_text)
    
    if st.button("üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç", use_container_width=True):
        if len(st.session_state.contract_text) < 100:
            st.error("‚ùå –ú–∏–Ω–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤")
        else:
            with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º..."):
                st.session_state.analysis_result = ContractAnalyzer.analyze(st.session_state.contract_text)
            st.rerun()
    
    if st.session_state.analysis_result:
        render_text_analysis(st.session_state.analysis_result)

def render_zone_result(result: AnalysisResult, amount: float):
    zone_config = {
        RiskZone.GREEN: ("green", "üü¢ –ó–ï–õ–ï–ù–ê–Ø –ó–û–ù–ê", "–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞"),
        RiskZone.YELLOW: ("yellow", "üü° –ñ–ï–õ–¢–ê–Ø –ó–û–ù–ê", "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –Æ–î"),
        RiskZone.RED: ("red", "üî¥ –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê", "–ü–æ–ª–Ω–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ"),
    }
    
    zone_class, zone_title, zone_subtitle = zone_config[result.zone]
    
    st.markdown(f"""
    <div class="zone-card {zone_class}">
        <div class="zone-title">{zone_title}</div>
        <div style="font-size: 1rem; margin-bottom: 0.5rem;">{zone_subtitle}</div>
        <div style="font-size: 0.9rem; color: #555;">{result.zone_reason}</div>
    </div>
    """, unsafe_allow_html=True)
    
    cols = st.columns(4)
    cols[0].metric("üí∞ –°—É–º–º–∞", f"{amount:,.0f} ‚ÇΩ".replace(",", " "))
    cols[1].metric("‚è±Ô∏è –°—Ä–æ–∫", f"{result.deadline_days} –¥–Ω." if result.deadline_days else "‚Äî")
    cols[2].metric("üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π", result.responsible[:20])
    cols[3].metric("‚öñÔ∏è –Æ–î", "–î–∞" if result.requires_legal else "–ù–µ—Ç")
    
    if result.approval_route:
        st.info("üìç **–ú–∞—Ä—à—Ä—É—Ç:** " + " ‚Üí ".join(result.approval_route))
    
    for w in result.warnings:
        st.warning(w)
    
    if result.required_documents:
        with st.expander("üìã –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã"):
            for doc in result.required_documents:
                st.write(f"‚Ä¢ {doc}")
    
    col_f = st.columns(3)
    with col_f[0]:
        if result.red_flags:
            st.markdown("**üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:**")
            for f in result.red_flags:
                st.markdown(f'<div class="risk-item red">‚ö†Ô∏è {f}</div>', unsafe_allow_html=True)
    with col_f[1]:
        if result.yellow_flags:
            st.markdown("**üü° –í–Ω–∏–º–∞–Ω–∏–µ:**")
            for f in result.yellow_flags:
                st.markdown(f'<div class="risk-item yellow">‚ö° {f}</div>', unsafe_allow_html=True)
    with col_f[2]:
        if result.green_flags:
            st.markdown("**üü¢ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ:**")
            for f in result.green_flags:
                st.markdown(f'<div class="risk-item green">‚úì {f}</div>', unsafe_allow_html=True)

def render_text_analysis(result: Dict):
    if "error" in result:
        st.error(result["error"])
        return
    
    st.markdown("---")
    st.markdown("### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞")
    
    cols = st.columns(4)
    score = result["risk_score"]
    color = "#dc3545" if score >= 6 else "#ffc107" if score >= 3 else "#28a745"
    
    cols[0].markdown(f"""
    <div class="metric-card" style="border-left-color: {color};">
        <div style="font-size: 1.8rem; font-weight: bold; color: {color};">{score:.1f}/10</div>
        <div style="color: #6c757d;">–†–∏—Å–∫-—Å–∫–æ—Ä</div>
    </div>
    """, unsafe_allow_html=True)
    cols[1].metric("üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö", len(result["red_flags"]))
    cols[2].metric("üü° –í–Ω–∏–º–∞–Ω–∏–µ", len(result["yellow_flags"]))
    cols[3].metric("‚úÖ –†–∞–∑–¥–µ–ª–æ–≤", f"{len(result['found_sections'])}/{len(result['found_sections'])+len(result['missing_sections'])}")
    
    if result["red_flags"]:
        with st.expander(f"üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï ({len(result['red_flags'])})", expanded=True):
            for item in result["red_flags"]:
                st.markdown(f'<div class="risk-item red"><strong>‚ö†Ô∏è {item["title"]}</strong><br><small>üí° {item["recommendation"]}</small></div>', unsafe_allow_html=True)
    
    if result["yellow_flags"]:
        with st.expander(f"üü° –í–ù–ò–ú–ê–ù–ò–ï ({len(result['yellow_flags'])})"):
            for item in result["yellow_flags"]:
                st.markdown(f'<div class="risk-item yellow"><strong>‚ö° {item["title"]}</strong><br><small>üí° {item["recommendation"]}</small></div>', unsafe_allow_html=True)
    
    if result["missing_sections"]:
        with st.expander(f"‚ùå –û–¢–°–£–¢–°–¢–í–£–Æ–¢ ({len(result['missing_sections'])})"):
            for s in result["missing_sections"]:
                st.markdown(f'<div class="risk-item red">–ù–µ –Ω–∞–π–¥–µ–Ω: {s}</div>', unsafe_allow_html=True)
    
    st.download_button(
        "üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç",
        json.dumps({"date": datetime.now().isoformat(), "risk_score": score, **result}, ensure_ascii=False, indent=2),
        f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    )

# ============================================================================
# –í–ö–õ–ê–î–ö–ê –†–ï–ì–õ–ê–ú–ï–ù–¢–ê
# ============================================================================

def render_regulation_tab():
    st.markdown("""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 1.5rem; border-radius: 12px; color: white; margin-bottom: 1rem;">
        <h3 style="margin: 0;">üìã –†–µ–≥–ª–∞–º–µ–Ω—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –Æ–î</h3>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">–ê–û ¬´–ù–ü–ö¬ª | –í–µ—Ä—Å–∏—è 3.0 –æ—Ç 24.11.2025</p>
    </div>
    """, unsafe_allow_html=True)
    
    # –ó–µ–ª–µ–Ω–∞—è
    st.markdown("""
    <div class="zone-card green">
        <div class="zone-title">üü¢ –ó–ï–õ–ï–ù–ê–Ø –ó–û–ù–ê ‚Äî –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ</div>
        <p><strong>–Æ–î –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø</strong> | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä</p>
    </div>
    """, unsafe_allow_html=True)
    st.markdown("""
    | –£—Å–ª–æ–≤–∏–µ | –°—É–º–º–∞ |
    |---------|-------|
    | –¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ **–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π** | –î–æ **100 000** ‚ÇΩ |
    | –§–æ—Ä–º–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ / –°–≤–æ–±–æ–¥–Ω–∞—è / –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫ –¢–§ / –°–∞–º–æ—Å—Ç. —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ | –î–æ **50 000** ‚ÇΩ |
    """)
    
    # –ñ–µ–ª—Ç–∞—è
    st.markdown("""
    <div class="zone-card yellow">
        <div class="zone-title">üü° –ñ–ï–õ–¢–ê–Ø –ó–û–ù–ê ‚Äî –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –Æ–î</div>
        <p><strong>–°—Ä–æ–∫: 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</strong> | –°–ª–æ–∂–Ω—ã–µ: –¥–æ 10 –¥–Ω–µ–π</p>
    </div>
    """, unsafe_allow_html=True)
    st.markdown("""
    | –£—Å–ª–æ–≤–∏–µ | –°—É–º–º–∞ |
    |---------|-------|
    | –¢–∏–ø–æ–≤–∞—è —Ñ–æ—Ä–º–∞ | **100 001** ‚Äî **5 000 000** ‚ÇΩ |
    | –ù–µ—Ç–∏–ø–æ–≤—ã–µ | –û—Ç **50 001** ‚ÇΩ |
    | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫ | > **100 000** ‚ÇΩ |
    | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å—Ä–æ–∫ > 3 –ª–µ—Ç | –õ—é–±–∞—è |
    | –†–∞–º–æ—á–Ω—ã–µ/–≥–æ–¥–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏, –¢–≠–£, –æ–ø–∞—Å–Ω—ã–µ –≥—Ä—É–∑—ã | –õ—é–±–∞—è |
    """)
    st.warning("‚ö†Ô∏è –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –¥–æ –≤–∏–∑—ã –Æ–î!")
    
    # –ö—Ä–∞—Å–Ω–∞—è
    st.markdown("""
    <div class="zone-card red">
        <div class="zone-title">üî¥ –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê ‚Äî –ü–æ–ª–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</div>
        <p><strong>–Æ–î –ù–ï–ó–ê–ú–ï–î–õ–ò–¢–ï–õ–¨–ù–û</strong> (–Ω–∞ —ç—Ç–∞–ø–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)</p>
    </div>
    """, unsafe_allow_html=True)
    st.markdown("""
    **–ü–æ —Å—É–º–º–µ:** > 5 000 000 ‚ÇΩ | –¢–µ–Ω–¥–µ—Ä—ã > 3 000 000 ‚ÇΩ
    
    **–í—Å–µ–≥–¥–∞ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—É–º–º—ã):**
    - –í–∞–≥–æ–Ω—ã/–ª–æ–∫–æ–º–æ—Ç–∏–≤—ã/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–∞—Ä–µ–Ω–¥–∞/–ª–∏–∑–∏–Ω–≥/–ø–æ–∫—É–ø–∫–∞)
    - –í–≠–î, –≤–∞–ª—é—Ç–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
    - –ü–û, –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –∫—Ä–µ–¥–∏—Ç—ã, –∑–∞–ª–æ–≥–∏
    - –î–æ–≥–æ–≤–æ—Ä—ã —Å –†–ñ–î, –°–æ–≤–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤
    - –õ–ù–ê, —Ç—Ä—É–¥–æ–≤—ã–µ —Å –¢–û–ü-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–æ–º
    - –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏, –∏—Å–∫–∏, –∑–∞–ø—Ä–æ—Å—ã –≥–æ—Å–æ—Ä–≥–∞–Ω–æ–≤
    """)

# ============================================================================
# –í–ö–õ–ê–î–ö–ê –ù–ê–°–¢–†–û–ï–ö
# ============================================================================

def render_settings_tab():
    st.markdown("### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    st.warning("‚ö†Ô∏è API-–∫–ª—é—á–∏ **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è**. –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏.")
    
    with st.expander("üîë API-–∫–ª—é—á–∏"):
        openai_key = st.text_input("OpenAI", type="password", placeholder="sk-...")
        anthropic_key = st.text_input("Anthropic", type="password", placeholder="sk-ant-...")
        if st.button("–ü—Ä–∏–º–µ–Ω–∏—Ç—å"):
            st.success("‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –¥–ª—è —Å–µ—Å—Å–∏–∏")
    
    st.markdown("---")
    st.markdown("""
    **Legal Traffic Light v3.2**  
    –†–µ–≥–ª–∞–º–µ–Ω—Ç v3.0 –æ—Ç 24.11.2025  
    ¬© –ê–û ¬´–ù–ü–ö¬ª 2025
    """)

# ============================================================================
# –ì–õ–ê–í–ù–ê–Ø
# ============================================================================

def render_main_page():
    st.markdown("""
    <div class="main-header">
        <div class="traffic-light">
            <span class="tl-red"></span>
            <span class="tl-yellow"></span>
            <span class="tl-green"></span>
        </div>
        <h2 style="margin: 0;">üö¶ Legal Traffic Light <span class="version-badge">v3.2</span></h2>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.8;">–ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–æ –†–µ–≥–ª–∞–º–µ–Ω—Ç—É –ê–û ¬´–ù–ü–ö¬ª</p>
    </div>
    """, unsafe_allow_html=True)
    
    render_sidebar()
    
    tab1, tab2, tab3 = st.tabs(["üìù –ê–Ω–∞–ª–∏–∑", "üìã –†–µ–≥–ª–∞–º–µ–Ω—Ç", "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"])
    
    with tab1:
        render_analysis_tab()
    with tab2:
        render_regulation_tab()
    with tab3:
        render_settings_tab()
    
    st.markdown("---")
    st.caption("Legal Traffic Light v3.2 | –ê–û ¬´–ù–ü–ö¬ª ¬© 2025 | –†–µ–≥–ª–∞–º–µ–Ω—Ç v3.0")

# ============================================================================
# –ó–ê–ü–£–°–ö
# ============================================================================

def main():
    apply_styles()
    init_session_state()
    
    if not st.session_state.authenticated:
        render_auth_page()
    else:
        render_main_page()

if __name__ == "__main__":
    main()

class RiskZone(Enum):
    GREEN = "green"
    YELLOW = "yellow"
    RED = "red"

st.set_page_config(page_title="Legal Traffic Light v3.0", page_icon="üö¶", layout="wide")

st.markdown("# üö¶ Legal Traffic Light v3.0")
st.markdown("### System for analyzing legal documents against corporate regulations")

if "authenticated" not in st.session_state:
    st.session_state.authenticated = False

if not st.session_state.authenticated:
    st.markdown("### üîê Login")
    col1, col2 = st.columns([1, 1])
    with col1:
        name = st.text_input("Full Name")
        position = st.selectbox("Position", ["Specialist", "Senior Specialist", "Head of Department"])
    with col2:
        department = st.text_input("Department")
        demo_mode = st.button("Demo Mode")
    
    if st.button("Login"):
        if name and position and department:
            st.session_state.authenticated = True
            st.session_state.user_name = name
            st.session_state.user_position = position
            st.session_state.user_department = department
            st.session_state.demo_mode = False
            st.rerun()
    
    if demo_mode:
        st.session_state.authenticated = True
        st.session_state.user_name = "Demo User"
        st.session_state.user_position = "Specialist"
        st.session_state.user_department = "Legal Department"
        st.session_state.demo_mode = True
        st.rerun()
else:
    st.sidebar.markdown(f"### üë§ {st.session_state.user_name}")
    st.sidebar.markdown(f"{st.session_state.user_position} | {st.session_state.user_department}")
    if st.session_state.demo_mode:
        st.sidebar.info("Demo Mode")
    if st.sidebar.button("Logout"):
        st.session_state.authenticated = False
        st.rerun()
    
    tab1, tab2, tab3 = st.tabs(["Document Analysis", "Regulations", "Settings"])
    
    with tab1:
        st.markdown("### Document Analysis")
        col1, col2 = st.columns([2, 1])
        with col1:
            contract_text = st.text_area("Enter contract text", height=300, placeholder="Paste contract text here...")
        with col2:
            doc_type = st.selectbox("Document Type", ["Service Agreement", "Supply Contract", "Rent Agreement", "Other"])
            contract_sum = st.number_input("Contract Sum (RUB)", min_value=0, value=1000000)
            if st.button("Analyze"):
                if contract_text:
                    st.success("Demo Analysis Complete")
                    st.markdown("#### Results")
                    col_red, col_yellow, col_green = st.columns(3)
                    with col_red:
                        st.metric("Critical Issues", 2)
                    with col_yellow:
                        st.metric("Warnings", 1)
                    with col_green:
                        st.metric("OK", 3)
    
    with tab2:
        st.markdown("### Regulation Matrix")
        regulations_data = {
            "Amount": ["0-100K", "100K-5M", "5M+"],
            "Zone": ["Green", "Yellow", "Red"],
            "Approver": ["Department Head", "Director", "Board"]
        }
        st.table(regulations_data)
    
    with tab3:
        st.markdown("### Settings")
        st.info("API keys stored securely (session only)")
        openai_key = st.text_input("OpenAI API Key", type="password", placeholder="sk-...")
